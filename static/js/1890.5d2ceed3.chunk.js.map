{"version":3,"file":"static/js/1890.5d2ceed3.chunk.js","mappings":"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","sources":["webpack://@jbrowse/web/../../plugins/variants/src/MultiLinearVariantMatrixRenderer/makeImageData.ts","webpack://@jbrowse/web/../../plugins/variants/src/shared/drawAlleleCount.ts","webpack://@jbrowse/web/../../plugins/variants/src/shared/drawPhased.ts"],"sourcesContent":["import { updateStatus } from '@jbrowse/core/util'\nimport { checkStopToken2 } from '@jbrowse/core/util/stopToken'\n\nimport { f2 } from '../shared/constants.ts'\nimport {\n  drawColorAlleleCount,\n  getAlleleColor,\n} from '../shared/drawAlleleCount.ts'\nimport { drawPhased } from '../shared/drawPhased.ts'\nimport { getFeaturesThatPassMinorAlleleFrequencyFilter } from '../shared/minorAlleleFrequencyUtils.ts'\n\nimport type { RenderArgsDeserialized } from './types.ts'\nimport type { Source } from '../shared/types.ts'\nimport type { Feature, LastStopTokenCheck } from '@jbrowse/core/util'\n\ntype SampleGenotype = Record<string, string[]>\n\ninterface Maf {\n  feature: Feature\n  mostFrequentAlt: string\n}\n\ninterface DrawContext {\n  ctx: CanvasRenderingContext2D\n  sources: Source[]\n  startRow: number\n  endRow: number\n  h: number\n  w: number\n  scrollTop: number\n  splitCache: Record<string, string[]>\n  colorCache: Record<string, string | undefined>\n  genotypesCache: Map<string, Record<string, string>>\n  stopTokenCheck?: LastStopTokenCheck\n}\n\nfunction drawPhasedMode(drawCtx: DrawContext, mafs: Maf[]) {\n  const {\n    ctx,\n    sources,\n    startRow,\n    endRow,\n    h,\n    w,\n    scrollTop,\n    splitCache,\n    genotypesCache,\n    stopTokenCheck,\n  } = drawCtx\n\n  const arr = [] as string[][]\n  for (let idx = 0, l = mafs.length; idx < l; idx++) {\n    const { feature } = mafs[idx]!\n    const arr2 = [] as string[]\n    const hasPhaseSet = (feature.get('FORMAT') as string | undefined)?.includes(\n      'PS',\n    )\n    const x = idx * w\n\n    if (hasPhaseSet) {\n      const samp = feature.get('samples') as Record<string, SampleGenotype>\n      for (let j = startRow; j < endRow; j++) {\n        const y = j * h - scrollTop\n        const source = sources[j]!\n        const { name, HP, baseName } = source\n        const sampleName = baseName ?? name\n        const s = samp[sampleName]\n        if (s) {\n          const genotype = s.GT?.[0]\n          if (genotype) {\n            arr2.push(genotype)\n            const isPhased = genotype.includes('|')\n            if (isPhased) {\n              const PS = s.PS?.[0]\n              const alleles =\n                splitCache[genotype] ??\n                (splitCache[genotype] = genotype.split('|'))\n              drawPhased(alleles, ctx, x, y, w, h, HP!, PS)\n            } else {\n              ctx.fillStyle = 'black'\n              ctx.fillRect(x - f2, y - f2, w + f2, h + f2)\n            }\n          }\n        }\n      }\n    } else {\n      const featureId = feature.id()\n      let samp = genotypesCache.get(featureId)\n      if (!samp) {\n        samp = feature.get('genotypes') as Record<string, string>\n        genotypesCache.set(featureId, samp)\n      }\n      for (let j = startRow; j < endRow; j++) {\n        const y = j * h - scrollTop\n        const source = sources[j]!\n        const { name, HP, baseName } = source\n        const sampleName = baseName ?? name\n        const genotype = samp[sampleName]\n        if (genotype) {\n          arr2.push(genotype)\n          const isPhased = genotype.includes('|')\n          if (isPhased) {\n            const alleles =\n              splitCache[genotype] ??\n              (splitCache[genotype] = genotype.split('|'))\n            drawPhased(alleles, ctx, x, y, w, h, HP!)\n          } else {\n            ctx.fillStyle = 'black'\n            ctx.fillRect(x - f2, y - f2, w + f2, h + f2)\n          }\n        }\n      }\n    }\n    arr.push(arr2)\n    checkStopToken2(stopTokenCheck)\n  }\n\n  return arr\n}\n\nfunction drawAlleleCountMode(drawCtx: DrawContext, mafs: Maf[]) {\n  const {\n    ctx,\n    sources,\n    startRow,\n    endRow,\n    h,\n    w,\n    scrollTop,\n    splitCache,\n    stopTokenCheck,\n    colorCache,\n    genotypesCache,\n  } = drawCtx\n\n  const arr = [] as string[][]\n\n  for (let idx = 0, l = mafs.length; idx < l; idx++) {\n    const { feature, mostFrequentAlt } = mafs[idx]!\n    const arr2 = [] as string[]\n    const hasPhaseSet = (feature.get('FORMAT') as string | undefined)?.includes(\n      'PS',\n    )\n    const x = idx * w\n\n    if (hasPhaseSet) {\n      const samp = feature.get('samples') as Record<string, SampleGenotype>\n      for (let j = startRow; j < endRow; j++) {\n        const y = j * h - scrollTop\n        const source = sources[j]!\n        const sampleName = source.baseName ?? source.name\n        const s = samp[sampleName]\n        if (s) {\n          const genotype = s.GT?.[0]\n          if (genotype) {\n            arr2.push(genotype)\n            const c = getAlleleColor(\n              genotype,\n              mostFrequentAlt,\n              colorCache,\n              splitCache,\n              true,\n            )\n            if (c) {\n              drawColorAlleleCount(c, ctx, x, y, w, h)\n            }\n          }\n        }\n      }\n    } else {\n      const featureId = feature.id()\n      let samp = genotypesCache.get(featureId)\n      if (!samp) {\n        samp = feature.get('genotypes') as Record<string, string>\n        genotypesCache.set(featureId, samp)\n      }\n      for (let j = startRow; j < endRow; j++) {\n        const y = j * h - scrollTop\n        const source = sources[j]!\n        const sampleName = source.baseName ?? source.name\n        const genotype = samp[sampleName]\n        if (genotype) {\n          arr2.push(genotype)\n          const c = getAlleleColor(\n            genotype,\n            mostFrequentAlt,\n            colorCache,\n            splitCache,\n            true,\n          )\n          if (c) {\n            drawColorAlleleCount(c, ctx, x, y, w, h)\n          }\n        }\n      }\n    }\n    arr.push(arr2)\n    checkStopToken2(stopTokenCheck)\n  }\n\n  return arr\n}\n\nexport async function makeImageData({\n  ctx,\n  canvasWidth,\n  canvasHeight,\n  renderArgs,\n}: {\n  ctx: CanvasRenderingContext2D\n  canvasWidth: number\n  canvasHeight: number\n  renderArgs: RenderArgsDeserialized\n}) {\n  const {\n    renderingMode,\n    minorAlleleFrequencyFilter,\n    sources,\n    features,\n    stopTokenCheck,\n    lengthCutoffFilter,\n    rowHeight,\n    scrollTop,\n    statusCallback = () => {},\n  } = renderArgs\n  const h = rowHeight\n  const startRow = Math.floor(scrollTop / h)\n  const endRow = Math.min(\n    sources.length,\n    Math.ceil((scrollTop + canvasHeight) / h),\n  )\n  const genotypesCache = new Map<string, Record<string, string>>()\n  const colorCache = {} as Record<string, string | undefined>\n  const splitCache = {} as Record<string, string[]>\n\n  const mafs = await updateStatus('Calculating stats', statusCallback, () =>\n    getFeaturesThatPassMinorAlleleFrequencyFilter({\n      stopTokenCheck,\n      features: features.values(),\n      minorAlleleFrequencyFilter,\n      lengthCutoffFilter,\n      genotypesCache,\n      splitCache,\n    }),\n  )\n\n  const m = mafs.length\n  const w = canvasWidth / m\n\n  const drawCtx: DrawContext = {\n    ctx,\n    sources,\n    startRow,\n    endRow,\n    h,\n    w,\n    scrollTop,\n    splitCache,\n    colorCache,\n    genotypesCache,\n    stopTokenCheck,\n  }\n\n  const arr = await updateStatus(\n    'Drawing variant matrix',\n    statusCallback,\n    () =>\n      renderingMode === 'phased'\n        ? drawPhasedMode(drawCtx, mafs)\n        : drawAlleleCountMode(drawCtx, mafs),\n  )\n\n  const featureData = mafs.map(({ feature }) => ({\n    alt: feature.get('ALT') as string[],\n    ref: feature.get('REF') as string,\n    name: feature.get('name') as string,\n    description: feature.get('description') as string,\n    length: feature.get('end') - feature.get('start'),\n  }))\n\n  return {\n    mafs,\n    arr,\n    featureData,\n  }\n}\n","import { colord } from '@jbrowse/core/util/colord'\n\nimport {\n  ALT_COLOR_HUE,\n  ALT_COLOR_SATURATION,\n  NO_CALL_COLOR,\n  REFERENCE_COLOR,\n  f2,\n} from './constants.ts'\n\nexport function getAlleleColor(\n  genotype: string,\n  mostFrequentAlt: string,\n  colorCache: Record<string, string | undefined>,\n  splitCache: Record<string, string[]>,\n  drawRef: boolean,\n) {\n  const cacheKey = `${genotype}:${mostFrequentAlt}`\n  let c = colorCache[cacheKey]\n  if (c === undefined) {\n    let alt = 0\n    let uncalled = 0\n    let alt2 = 0\n    let ref = 0\n    const alleles =\n      splitCache[genotype] ?? (splitCache[genotype] = genotype.split(/[/|]/))\n    const total = alleles.length\n\n    for (let i = 0; i < total; i++) {\n      const allele = alleles[i]!\n      if (allele === mostFrequentAlt) {\n        alt++\n      } else if (allele === '0') {\n        ref++\n      } else if (allele === '.') {\n        uncalled++\n      } else {\n        alt2++\n      }\n    }\n    c = getColorAlleleCount(ref, alt, alt2, uncalled, total, drawRef)\n    colorCache[cacheKey] = c\n  }\n  return c\n}\n\nexport function getColorAlleleCount(\n  ref: number,\n  alt: number,\n  alt2: number,\n  uncalled: number,\n  total: number,\n  drawReference = true,\n) {\n  if (ref === total) {\n    return drawReference ? REFERENCE_COLOR : ''\n  }\n\n  if (!(alt || alt2 || uncalled)) {\n    return ''\n  }\n\n  let a1\n  if (alt) {\n    const lightness = 80 - (alt / total) * 50\n    a1 = colord(`hsl(${ALT_COLOR_HUE},${ALT_COLOR_SATURATION}%,${lightness}%)`)\n  }\n  if (alt2) {\n    const alpha = alt2 / total\n    const l = `hsla(0,100%,20%,${alpha})`\n    a1 = a1 ? a1.mix(l) : colord(l)\n  }\n  if (uncalled) {\n    const alpha = uncalled / total\n    const l = NO_CALL_COLOR.replace(')', `,${alpha})`).replace('hsl', 'hsla')\n    a1 = a1 ? a1.mix(l) : colord(l)\n  }\n  return a1?.toHex() || 'black'\n}\n\nexport function drawColorAlleleCount(\n  c: string,\n  ctx: CanvasRenderingContext2D,\n  x: number,\n  y: number,\n  w: number,\n  h: number,\n  featureType = '',\n  featureStrand?: number,\n  alpha = 1,\n) {\n  ctx.fillStyle = alpha !== 1 ? colord(c).alpha(alpha).toHex() : c\n  if (featureType === 'inversion') {\n    if (featureStrand === 1) {\n      ctx.beginPath()\n      ctx.moveTo(x - f2, y - f2)\n      ctx.lineTo(x - f2, y + h + f2)\n      ctx.lineTo(x + w + f2, y + h / 2)\n      ctx.closePath()\n      ctx.fill()\n    } else {\n      ctx.beginPath()\n      ctx.moveTo(x + w + f2, y - f2)\n      ctx.lineTo(x + w + f2, y + h + f2)\n      ctx.lineTo(x - f2, y + h / 2)\n      ctx.closePath()\n      ctx.fill()\n    }\n  } else if (featureType === 'insertion') {\n    const widthExtension = 3\n    ctx.beginPath()\n    ctx.moveTo(x - f2 - widthExtension, y - f2)\n    ctx.lineTo(x + w + f2 + widthExtension, y - f2)\n    ctx.lineTo(x + w / 2, y + h + f2)\n    ctx.closePath()\n    ctx.fill()\n  } else {\n    ctx.fillRect(x - f2, y - f2, w + f2, h + f2)\n  }\n}\n","import { set1 } from '@jbrowse/core/ui/colors'\nimport { colord } from '@jbrowse/core/util/colord'\n\nimport { REFERENCE_COLOR, UNPHASED_COLOR, f2 } from './constants.ts'\n\nfunction colorify(n: number) {\n  return `hsl(${n % 255}, 50%, 50%)`\n}\n\nexport function drawPhased(\n  alleles: string[],\n  ctx: CanvasRenderingContext2D,\n  x: number,\n  y: number,\n  w: number,\n  h: number,\n  HP: number,\n  PS?: string,\n  drawReference = true,\n  alpha = 1,\n  featureType = '',\n  featureStrand?: number,\n) {\n  const allele = +alleles[HP]!\n  const c = allele\n    ? PS !== undefined\n      ? colorify(+PS) || UNPHASED_COLOR\n      : set1[allele - 1] || UNPHASED_COLOR\n    : drawReference\n      ? REFERENCE_COLOR\n      : undefined\n  if (c) {\n    ctx.fillStyle = alpha !== 1 ? colord(c).alpha(alpha).toHex() : c\n    if (featureType === 'inversion') {\n      if (featureStrand === 1) {\n        ctx.beginPath()\n        ctx.moveTo(x - f2, y - f2)\n        ctx.lineTo(x - f2, y + h + f2)\n        ctx.lineTo(x + w + f2, y + h / 2)\n        ctx.closePath()\n        ctx.fill()\n      } else {\n        ctx.beginPath()\n        ctx.moveTo(x + w + f2, y - f2)\n        ctx.lineTo(x + w + f2, y + h + f2)\n        ctx.lineTo(x - f2, y + h / 2)\n        ctx.closePath()\n        ctx.fill()\n      }\n    } else if (featureType === 'insertion') {\n      const widthExtension = 3\n      ctx.beginPath()\n      ctx.moveTo(x - f2 - widthExtension, y - f2)\n      ctx.lineTo(x + w + f2 + widthExtension, y - f2)\n      ctx.lineTo(x + w / 2, y + h + f2)\n      ctx.closePath()\n      ctx.fill()\n    } else {\n      ctx.fillRect(x - f2, y - f2, w + f2, h + f2)\n    }\n  }\n  return c\n}\n"],"names":["async","makeImageData","ctx","canvasWidth","canvasHeight","renderArgs","renderingMode","minorAlleleFrequencyFilter","sources","features","stopTokenCheck","lengthCutoffFilter","rowHeight","scrollTop","statusCallback","h","startRow","Math","floor","endRow","min","length","ceil","genotypesCache","Map","splitCache","mafs","updateStatus","getFeaturesThatPassMinorAlleleFrequencyFilter","values","drawCtx","w","colorCache","arr","idx","l","feature","arr2","hasPhaseSet","get","includes","x","samp","j","y","source","name","HP","baseName","s","genotype","GT","push","PS","alleles","split","drawPhased","fillStyle","fillRect","f2","featureId","id","set","checkStopToken2","drawPhasedMode","mostFrequentAlt","c","getAlleleColor","drawColorAlleleCount","drawAlleleCountMode","featureData","map","alt","ref","description","drawRef","cacheKey","undefined","uncalled","alt2","total","i","allele","drawReference","REFERENCE_COLOR","a1","lightness","colord","ALT_COLOR_HUE","ALT_COLOR_SATURATION","mix","alpha","NO_CALL_COLOR","replace","toHex","getColorAlleleCount","featureType","featureStrand","beginPath","moveTo","lineTo","closePath","fill","widthExtension","UNPHASED_COLOR","set1"],"sourceRoot":""}