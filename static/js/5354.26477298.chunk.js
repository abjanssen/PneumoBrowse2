"use strict";(globalThis.webpackChunk_jbrowse_web=globalThis.webpackChunk_jbrowse_web||[]).push([[5354],{28933(t,e,n){n.d(e,{h:()=>s});var o=n(13469);function s(t,e){let n=0,s=0,r=0;const a=[];for(let i=0,c=t.length,l=e.length;i<c&&r<l;i++){const c=t[i],h=c>>4,f=15&c;if(f===o.hN||f===o.hE){for(let t=0;t<h&&r<l;t++)e[r]===n+t&&r++;n+=h}else if(f===o.aT||f===o.a2)s+=h;else if(f===o.hK||f===o.oE||f===o.C4){for(let t=0;t<h&&r<l;t++)e[r]===n+t&&(a.push({ref:s+t,idx:r}),r++);n+=h,s+=h}}return a}},82437(t,e,n){n.d(e,{P:()=>i});var o=n(11605),s=n(26570),r=n(28933),a=n(52301);function i(t,e){const n=t.get("start"),i=t.get("end"),c=t.get("strand"),l=i-n,h=(0,a.c$)(t,"MM","Mm")||"",f=[],u=[],d=[],g=[],p=t.get("seq");if(p){const n=(0,s.Y)(t),a=(0,o.Z)(h,p,c);let i=0;for(const{type:t,positions:o}of a){for(const{ref:s,idx:a}of(0,r.h)(e,o)){if(s<0||s>=l)continue;const e=i+(-1===c?o.length-1-a:a),r=n?.[e]||0;"m"===t?(f[s]=1,d[s]=r):"h"===t&&(u[s]=1,g[s]=r)}i+=o.length}}return{methBins:f,hydroxyMethBins:u,methProbs:d,hydroxyMethProbs:g}}},11605(t,e,n){n.d(e,{Z:()=>r});var o=n(23886),s=n(2165);function r(t,e,n){const r=-1===n?(0,o.revcom)(e):e,a=r.length,i=t.split(";"),c=[];for(const t of i){if(""===t)continue;const e=t.split(","),o=e[0],i=s.k.exec(o);if(!i)throw new Error(`bad format for MM tag: "${t}"`);const[,l,h,f]=i,u=f.split(/(\d+|.)/);for(const t of u){if(""===t)continue;const o=e.length;let s=0;const i=-1===n?new Array(o-1):[];let f=-1===n?o-2:0;for(let t=1;t<o;t++){let o=+e[t];do{"N"!==l&&l!==r[s]||o--,s++}while(o>=0&&s<a);if(-1===n){const t=a-s;t>=0&&(i[f--]=t)}else i[f++]=s-1}const u=-1===n?i.slice(f+1):i;c.push({type:t,base:l,strand:h,positions:u})}}return c}},26570(t,e,n){n.d(e,{Y:()=>s});var o=n(52301);function s(t){const e=(0,o.c$)(t,"ML","Ml")||[];if(e){const t=[];if("string"==typeof e){const n=e.split(",");for(let e=0,o=n.length;e<o;e++)t.push(+n[e]/255)}else for(let n=0,o=e.length;n<o;n++)t.push(e[n]/255);return t}{const e=(0,o.c$)(t,"MP","Mp");if(e){const t=[];for(let n=0,o=e.length;n<o;n++){const o=e.charCodeAt(n)-33;t.push(Math.min(1,o/50))}return t}return}}},13469(t,e,n){n.d(e,{A_:()=>g,C4:()=>h,El:()=>p,Tr:()=>u,a2:()=>i,aT:()=>a,hE:()=>r,hK:()=>s,hN:()=>c,oE:()=>f,og:()=>l,q7:()=>d,sO:()=>b,tQ:()=>m});var o=n(153);const s=0,r=1,a=2,i=3,c=4,l=5,h=7,f=8,u=129,d=389,g="=ACMGRSVTWYHKDBN",p=new Uint8Array([61,97,99,109,103,114,115,118,116,119,121,104,107,100,98,110]),b=Array.from({length:128},(t,e)=>String.fromCharCode(e));function m(t){return"string"==typeof t?(0,o.YJ)(t):t||[]}},45354(t,e,n){n.d(e,{default:()=>R});var o=n(90946),s=n(43921),r=n(57379),a=n(47664),i=n(25529),c=n(43102),l=n(88068),h=n(90013),f=n(52301),u=n(29458);const d=new Int32Array(1000001),g=new Int32Array(1000001),p=new Int32Array(1000001);var b=n(23886),m=n(63692);function y(t,e,n,o,s){const r=t[n][o]??={entryDepth:0,probabilityTotal:0,probabilityCount:0,lengthTotal:0,lengthCount:0,lengthMin:1/0,lengthMax:-1/0,"-1":0,0:0,1:0};r.entryDepth++,r.probabilityTotal+=s,r.probabilityCount++,r[e]++}var M=n(153),C=n(98682);function v({feature:t,colorBy:e,region:n,bins:o,regionSequence:s}){const r=t.get("start"),a=t.get("strand"),i=t.get("end"),c=e?.modifications?.twoColor,l=e?.modifications?.isolatedModification,h=t.get("seq"),f=(e?.modifications?.threshold??10)/100;if(!h)return;const u=t.get("NUMERIC_CIGAR")??(0,M.YJ)(t.get("CIGAR")),d=n.start,g=n.end;(0,C.r)(t,u)?.forEach(({allProbs:t,prob:e,type:n},h)=>{const u=h+r;if(u<d||u>=i)return;const p=u-d;if(p<0||p>=g-d)return;if(l&&n!==l)return;if(e<f)return;const m=o[p]??={depth:0,readsCounted:0,snps:{},ref:{entryDepth:0,probabilityTotal:0,probabilityCount:0,lengthTotal:0,lengthCount:0,lengthMin:1/0,lengthMax:-1/0,"-1":0,0:0,1:0},mods:{},nonmods:{},delskips:{},noncov:{}};m.refbase=s[p];const M=1-(0,b.sum)(t);c&&M>(0,b.max)(t)?y(m,a,"nonmods",`nonmod_${n}`,M):y(m,a,"mods",`mod_${n}`,e)})}var S=n(82437);function w(t,e,n,o,s,r){if(o){const o=t[e]??={depth:0,readsCounted:0,snps:{},ref:{entryDepth:0,probabilityTotal:0,probabilityCount:0,lengthTotal:0,lengthCount:0,lengthMin:1/0,lengthMax:-1/0,"-1":0,0:0,1:0},mods:{},nonmods:{},delskips:{},noncov:{}};y(o,n,"mods","cpg_meth",s),o.ref.entryDepth--,o.ref[n]--}else if(!r){const o=t[e]??={depth:0,readsCounted:0,snps:{},ref:{entryDepth:0,probabilityTotal:0,probabilityCount:0,lengthTotal:0,lengthCount:0,lengthMin:1/0,lengthMax:-1/0,"-1":0,0:0,1:0},mods:{},nonmods:{},delskips:{},noncov:{}};y(o,n,"nonmods","cpg_unmeth",1-s),o.ref.entryDepth--,o.ref[n]--}}function A({feature:t,region:e,bins:n,regionSequence:o}){const s=t.get("start"),r=t.get("end"),a=t.get("strand"),i=t.get("seq"),c=o.toLowerCase();if(i){const o=t.get("NUMERIC_CIGAR")??(0,M.YJ)(t.get("CIGAR")),{methBins:i,methProbs:l}=(0,S.P)(t,o),h=new Array(i.length).fill(!1);t.forEachMismatch((t,e,n)=>{if(t===m.YX){const t=e+n;for(let n=e;n<t;n++)h[n]=!0}});const f=e.start,u=e.end,d=Math.max(0,f-s),g=Math.min(r-s,u-s);for(let t=d;t<g;t++){const e=t+s,o=c[e-f+1],r=c[e-f+2];if("c"===o&&"g"===r){const o=e-f,s=e-f+1,r=i[t],c=i[t+1],u=l[t]||0,d=l[t+1]||0,g=!!(r&&u>.5||c&&d>.5),p=h[t],b=h[t+1];w(n,o,a,g,u,!!p),w(n,s,a,g,d,!!b)}}}}var x=n(13469);function q(t){return t.snps??={},t.mods??={},t.nonmods??={},t.delskips??={},t.noncov??={},t}const $=new Int32Array(1000001);function T(t){const{probabilityTotal:e,probabilityCount:n,lengthTotal:o,lengthCount:s}=t;if(n&&(t.avgProbability=e/n),s&&(t.avgLength=o/s,t.minLength=t.lengthMin,t.maxLength=t.lengthMax),t.sequenceCounts?.size){let e,n=0;for(const[o,s]of t.sequenceCounts)s>n&&(n=s,e=o);t.topSequence=e,t.sequenceCounts=void 0}}async function E({fetchSequence:t,features:e,region:n,opts:o}){const{stopToken:s,colorBy:r,statsEstimationMode:a}=o,i=n.start,c=n.end,l=c-i;(0,u.SW)(s);const h=function(t,e){const n=e.start,o=e.end,s=o-n;if(s>1e6)throw new Error(`Region size ${s} exceeds maximum 1000000`);d.fill(0,0,s+1),g.fill(0,0,s+1),p.fill(0,0,s+1);for(const e of t){const t=e.get("start"),s=e.get("end"),r=e.get("strand"),a=Math.max(t,n)-n,i=Math.min(s,o)-n;a<i&&(d[a]++,d[i]--,1===r?(g[a]++,g[i]--):-1===r&&(p[a]++,p[i]--))}const r=new Int32Array(s),a=new Int32Array(s),i=new Int32Array(s);let c=0,l=0,h=0;for(let t=0;t<s;t++)c+=d[t],l+=g[t],h+=p[t],r[t]=c,a[t]=l,i[t]=h;return{regionStart:n,regionSize:s,depth:r,strandPlus:a,strandMinus:i}}(e,n);if(a){const t=[];for(let e=0;e<l;e++){const n=h.depth[e];0!==n&&(t[e]={depth:n,readsCounted:n,ref:{entryDepth:n,"-1":h.strandMinus[e],0:0,1:h.strandPlus[e],probabilityTotal:0,probabilityCount:0,lengthTotal:0,lengthCount:0,lengthMin:1/0,lengthMax:-1/0}})}return{bins:t,regionStart:i,skipmap:{}}}(0,u.SW)(s),$.fill(0,0,l+1);const f=[],b=[],m={};for(let t=0,o=e.length;t<o;t++)N(n,e[t],m,b,f);P.feature=void 0;const y=new Int32Array(l);let M,C=0;for(let t=0;t<l;t++)C+=$[t],y[t]=C;const S=[],w=Math.max(0,i-1),x=i-w;if("modifications"===r?.type&&t){(0,u.SW)(s),M=await t({...n,start:w,end:c+1})||"";const o=M.slice(x);for(const t of e)v({feature:t,colorBy:r,bins:S,region:n,regionSequence:o})}else if("methylation"===r?.type&&t){(0,u.SW)(s),M??=await t({...n,start:w,end:c+1})||"";for(const t of e)A({feature:t,bins:S,region:n,regionSequence:M})}(0,u.SW)(s);const q=[];for(let t=0;t<l;t++){const e=h.depth[t],n=y[t];0===e&&0===n||(q[t]={depth:e-n,readsCounted:e,ref:{entryDepth:e,"-1":h.strandMinus[t],0:0,1:h.strandPlus[t],probabilityTotal:0,probabilityCount:0,lengthTotal:0,lengthCount:0,lengthMin:1/0,lengthMax:-1/0},delskips:n>0?{deletion:k(n)}:void 0})}for(let t=0,e=f.length;t<e;t++){const e=f[t],n=e.pos,o=e.entry;let s=q[n];s||(s={depth:0,readsCounted:0,ref:{entryDepth:0,"-1":0,0:0,1:0,probabilityTotal:0,probabilityCount:0,lengthTotal:0,lengthCount:0,lengthMin:1/0,lengthMax:-1/0}},q[n]=s);const r=o.base,a=o.strand,i=s.snps??={};let c=i[r];c||(c={entryDepth:0,"-1":0,0:0,1:0,probabilityTotal:0,probabilityCount:0,lengthTotal:0,lengthCount:0,lengthMin:1/0,lengthMax:-1/0},i[r]=c),c.entryDepth++,c[a]++,s.ref.entryDepth--,s.ref[a]--,o.altbase&&(s.refbase=o.altbase)}for(let t=0,e=b.length;t<e;t++){const e=b[t],n=e.pos,o=e.entry;let s=q[n];s||(s={depth:0,readsCounted:0,ref:{entryDepth:0,"-1":0,0:0,1:0,probabilityTotal:0,probabilityCount:0,lengthTotal:0,lengthCount:0,lengthMin:1/0,lengthMax:-1/0}},q[n]=s);const r=o.strand,a=o.type,i=o.length,c=s.noncov??={};let l=c[a];l||(l={entryDepth:0,"-1":0,0:0,1:0,probabilityTotal:0,probabilityCount:0,lengthTotal:0,lengthCount:0,lengthMin:1/0,lengthMax:-1/0},c[a]=l),l.entryDepth++,l[r]++,l.lengthTotal+=i,l.lengthCount++,l.lengthMin=Math.min(l.lengthMin,i),l.lengthMax=Math.max(l.lengthMax,i);const h=o.sequence;void 0!==h&&(l.sequenceCounts??=new Map,l.sequenceCounts.set(h,(l.sequenceCounts.get(h)??0)+1))}for(let t=0,e=S.length;t<e;t++){const e=S[t];if(e){const n=q[t];n&&(Object.keys(e.mods).length>0&&(n.mods=Object.assign(n.mods??{},e.mods)),Object.keys(e.nonmods).length>0&&(n.nonmods=Object.assign(n.nonmods??{},e.nonmods)),void 0!==e.refbase&&(n.refbase=e.refbase))}}for(let t=0,e=q.length;t<e;t++){const e=q[t];if(e){if(e.mods)for(const t in e.mods)T(e.mods[t]);if(e.nonmods)for(const t in e.nonmods)T(e.nonmods[t]);if(e.noncov)for(const t in e.noncov)T(e.noncov[t])}}return{bins:q,regionStart:i,skipmap:m}}function k(t){return{entryDepth:t,"-1":0,0:0,1:0,probabilityTotal:0,probabilityCount:0,lengthTotal:0,lengthCount:0,lengthMin:1/0,lengthMax:-1/0}}const P={fstart:0,fstrand:0,regionStart:0,regionEnd:0,regionSize:0,feature:void 0,skipmap:void 0,noncovEvents:void 0,snpEvents:void 0};function D(t,e,n,o,s,r,a){const{fstart:i,fstrand:c,regionStart:l,regionEnd:h,regionSize:f,feature:u,skipmap:d,noncovEvents:g,snpEvents:p}=P,b=i+e,y=function(t,e){return 1<<t&m.xi?1:e}(t,n),M=b+y;if(1<<t&m.Q6){const e=Math.max(b,l)-l,n=Math.min(M,h)-l;if(e<n&&($[e]++,$[n]--),t===m.D){const t=u.get("tags"),e=t?.XS||t?.TS,n=t?.ts,o="+"===e?1:"-"===e?-1:("+"===n?1:"-"===n?-1:0)*c,s=`${b}_${M}_${o}`;void 0===d[s]&&(d[s]={start:b,end:M,strand:c,effectiveStrand:o,score:0}),d[s].score++}}else if(t===m.jm){const t=b-l;t>=0&&t<f&&g.push({pos:t,entry:{strand:c,type:"insertion",length:a,sequence:o}})}else if(function(t){return!!(1<<t&m.xi)}(t)){const e=b-l;e>=0&&e<f&&g.push({pos:e,entry:{strand:c,type:m.i2[t],length:a}})}else{const t=b-l;t>=0&&t<f&&p.push({pos:t,entry:{base:o,strand:c,altbase:x.sO[r]}})}}function N(t,e,n,o,s){if(P.fstart=e.get("start"),P.fstrand=e.get("strand"),P.regionStart=t.start,P.regionEnd=t.end,P.regionSize=t.end-t.start,P.feature=e,P.skipmap=n,P.noncovEvents=o,P.snpEvents=s,"forEachMismatch"in e)e.forEachMismatch(D);else{const t=e.get("mismatches");if(t)for(const e of t){let t,n;"mismatch"===e.type?t=e.base:"insertion"===e.type?(t=e.insertedBases??"",n=e.insertlen):"softclip"===e.type||"hardclip"===e.type?(t="",n=e.cliplen):t="",D(m.iz[e.type],e.start,e.length,t,"mismatch"===e.type&&e.qual,"mismatch"===e.type?e.altbase?.charCodeAt(0):void 0,n)}}}function I(t,e){return`${t.refName}:${t.start}-${t.end}|${n=e.filterBy,n?`${n.flagExclude}|${n.flagInclude}|${n.readName??""}|${n.tagFilter?.tag??""}|${n.tagFilter?.value??""}`:""}|${e.trackInstanceId||""}`;var n}class R extends o.L{cache=new a.A({maxSize:50,maxAge:3e5});setSequenceAdapterConfig(t){super.setSequenceAdapterConfig(t),this.subadapterRef&&this.subadapterRef.setSequenceAdapterConfig(t)}async configure(){const t=this.getConf("subadapter");this.sequenceAdapterConfig??=this.getConf("sequenceAdapter");const e=await(this.getSubAdapter?.(t));if(!e)throw new Error("Failed to get subadapter");const n=e.dataAdapter;return this.subadapterRef=n,this.sequenceAdapterConfig&&n.setSequenceAdapterConfig(this.sequenceAdapterConfig),{subadapter:n}}async getSequenceAdapter(){const t=this.sequenceAdapterConfig??this.getConf("sequenceAdapter");if(t&&this.getSubAdapter)return this.sequenceAdapterP??=this.getSubAdapter(t).then(t=>{const e=t.dataAdapter;return"getSequence"in e?e:void 0}).catch(t=>{throw this.sequenceAdapterP=void 0,t}),this.sequenceAdapterP}getFeatures(t,e={}){return(0,i.ObservableCreate)(async n=>{const{bins:o,regionStart:s,skipmap:r}=await this.getCoverageBins(t,e),{refName:a}=t,i=this.id;for(let t=0,e=o.length;t<e;t++){const e=o[t];if(e){const o=s+t,r=q(e),c=e.depth;n.next({get:t=>{switch(t){case"start":return o;case"end":return o+1;case"score":return c;case"snpinfo":return r;case"refName":return a;default:return}},id:()=>`${i}-${o}`,toJSON:()=>({uniqueId:`${i}-${o}`,start:o,end:o+1,score:c,snpinfo:r,refName:a})})}}for(const[t,e]of Object.entries(r))n.next(new c.A({id:t,data:{type:"skip",refName:a,start:e.start,end:e.end,strand:e.strand,score:e.score,effectiveStrand:e.effectiveStrand}}));n.complete()},e.stopToken)}async getCoverageBins(t,e={}){const{bpPerPx:n,statsEstimationMode:o}=e;if(void 0!==n&&void 0!==this.lastBpPerPx&&this.lastBpPerPx!==n&&this.cache.clear(),void 0!==n&&(this.lastBpPerPx=n),o){const n=I(t,e);for(const t of this.cache.keys())if(t.startsWith(`${n}|`)){const e=this.cache.get(t);if(e)return e}const{subadapter:o}=await this.configure(),s=await(0,l._)(o.getFeatures(t,e).pipe((0,h.$)())),r=await E({features:s,region:t,opts:e}),a=`${n}|`;return this.cache.set(a,r),r}const s=function(t,e){const{colorBy:n}=e,o=n?`${n.type}|${n.tag??""}|${n.modifications?.twoColor??""}|${n.modifications?.isolatedModification??""}|${n.modifications?.threshold??""}`:"";return`${I(t,e)}|${o}`}(t,e),r=this.cache.get(s);if(r)return r;const{subadapter:a}=await this.configure(),i=await this.getSequenceAdapter(),c=await(0,l._)(a.getFeatures(t,e).pipe((0,h.$)())),u=await E({features:c,region:t,opts:e,fetchSequence:i?t=>(0,f.Iw)(t,i):void 0});return this.cache.set(s,u),u}async getMultiRegionFeatureDensityStats(t,e){const{subadapter:n}=await this.configure();return n.getMultiRegionFeatureDensityStats(t,e)}async getMultiRegionQuantitativeStats(t=[],e={}){if(!t.length)return(0,s.Yv)();const{staticBlocks:n}=e;if(n?.length){const o=await Promise.all(n.map(t=>this.getCoverageBins(t,{...e,statsEstimationMode:!0}).then(e=>({block:t,bins:e})))),a=t.map(t=>{const e=o.filter(({block:e})=>e.refName===t.refName&&e.start<t.end&&e.end>t.start);if(0===e.length)return(0,s.WD)({scoreMin:0,scoreMax:0,scoreSum:0,scoreSumSquares:0,featureCount:0,basesCovered:0});const n=e.map(({bins:e})=>(0,s.WD)(function(t,e,n){const{bins:o,regionStart:s}=t;let r=Number.MAX_VALUE,a=Number.MIN_VALUE,i=0,c=0,l=0;for(let t=0,h=o.length;t<h;t++){const h=o[t];if(h){const o=s+t;if(o>=e&&o<n){const t=h.depth;r=Math.min(r,t),a=Math.max(a,t),i+=t,c+=t*t,l++}}}return{scoreMin:l>0?r:0,scoreMax:l>0?a:0,scoreSum:i,scoreSumSquares:c,featureCount:l,basesCovered:l}}(e,t.start,t.end)));return(0,r.iz)(n)});return(0,r.iz)(a)}const o=await Promise.all(t.map(t=>this.getRegionQuantitativeStats(t,e)));return(0,r.iz)(o)}async getRefNames(t={}){const{subadapter:e}=await this.configure();return e.getRefNames(t)}freeResources(t){const e=`${t.refName}:`;for(const t of this.cache.keys())t.startsWith(e)&&this.cache.delete(t)}}},98682(t,e,n){n.d(e,{r:()=>i});var o=n(28933),s=n(11605),r=n(26570),a=n(52301);function i(t,e){const n=t.get("strand"),i=t.get("seq"),c=(0,a.c$)(t,"MM","Mm")||"";if(i){const a=(0,s.Z)(c,i,n),l=(0,r.Y)(t),h=[];let f=0;for(const{type:t,positions:s}of a){for(const{ref:r,idx:a}of(0,o.h)(e,s)){const e=l?.[f+(-1===n?s.length-1-a:a)]||0;if(h[r]){const n=h[r];h[r]={allProbs:[...n.allProbs,e],prob:Math.max(n.prob,e),type:n.prob>e?n.type:t}}else h[r]={type:t,prob:e,allProbs:[e]}}f+=s.length}return h}}}}]);
//# sourceMappingURL=5354.26477298.chunk.js.map