{"version":3,"file":"static/js/8856.8ed10890.chunk.js","mappings":"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","sources":["../../../plugins/linear-comparative-view/src/LinearSyntenyDisplay/afterAttach.ts"],"sourcesContent":["import { getContainingView, getSession } from '@jbrowse/core/util'\nimport { bpToPx } from '@jbrowse/core/util/Base1DUtils'\nimport { MismatchParser } from '@jbrowse/plugin-alignments'\nimport { autorun, reaction } from 'mobx'\nimport { addDisposer, getSnapshot } from 'mobx-state-tree'\n\nimport {\n  drawCigarClickMap,\n  drawMouseoverClickMap,\n  drawRef,\n} from './drawSynteny'\n\nimport type { LinearSyntenyDisplayModel } from './model'\nimport type { LinearSyntenyViewModel } from '../LinearSyntenyView/model'\nimport type { Feature } from '@jbrowse/core/util'\n\ninterface Pos {\n  offsetPx: number\n}\n\ninterface FeatPos {\n  p11: Pos\n  p12: Pos\n  p21: Pos\n  p22: Pos\n  f: Feature\n  cigar: string[]\n}\n\ntype LSV = LinearSyntenyViewModel\n\nexport function doAfterAttach(self: LinearSyntenyDisplayModel) {\n  addDisposer(\n    self,\n    autorun(() => {\n      const view = getContainingView(self) as LinearSyntenyViewModel\n      if (\n        !view.initialized ||\n        !view.views.every(a => a.displayedRegions.length > 0 && a.initialized)\n      ) {\n        return\n      }\n\n      const ctx1 = self.mainCanvas?.getContext('2d')\n      const ctx3 = self.cigarClickMapCanvas?.getContext('2d')\n      if (!ctx1 || !ctx3) {\n        return\n      }\n\n      // Access alpha to make autorun react to alpha changes\n      // eslint-disable-next-line @typescript-eslint/no-unused-vars\n      const { alpha } = self\n      const height = self.height\n      const width = view.width\n      ctx1.clearRect(0, 0, width, height)\n\n      // Draw main canvas immediately\n      drawRef(self, ctx1)\n\n      drawCigarClickMap(self, ctx3)\n    }),\n  )\n\n  addDisposer(\n    self,\n    autorun(() => {\n      const view = getContainingView(self) as LinearSyntenyViewModel\n      if (\n        !view.initialized ||\n        !view.views.every(a => a.displayedRegions.length > 0 && a.initialized)\n      ) {\n        return\n      }\n      // Access reactive properties so autorun is triggered when they change\n      // eslint-disable-next-line @typescript-eslint/no-unused-vars\n      const { clickId, mouseoverId } = self\n      drawMouseoverClickMap(self)\n    }),\n  )\n\n  // this attempts to reduce recalculation of feature positions drawn by the\n  // synteny view\n  //\n  // uses a reaction to say \"we know the positions don't change in any relevant\n  // way unless bpPerPx changes or displayedRegions changes\"\n  addDisposer(\n    self,\n    reaction(\n      () => {\n        const view = getContainingView(self) as LSV\n        return {\n          bpPerPx: view.views.map(v => v.bpPerPx),\n\n          // stringifying 'deeply' accesses the displayed regions, see\n          // issue #3456\n          displayedRegions: JSON.stringify(\n            view.views.map(v => v.displayedRegions),\n          ),\n          features: self.features,\n          initialized:\n            view.initialized &&\n            view.views.every(\n              a => a.displayedRegions.length > 0 && a.initialized,\n            ),\n        }\n      },\n      ({ initialized }) => {\n        if (!initialized) {\n          return\n        }\n        const { level } = self\n        const { assemblyManager } = getSession(self)\n        const view = getContainingView(self) as LSV\n        const viewSnaps = view.views.map(view => ({\n          ...getSnapshot(view),\n          width: view.width,\n          staticBlocks: view.staticBlocks,\n          interRegionPaddingWidth: view.interRegionPaddingWidth,\n          minimumBlockWidth: view.minimumBlockWidth,\n        }))\n\n        const map = [] as FeatPos[]\n        const feats = self.features || []\n\n        for (const f of feats) {\n          const mate = f.get('mate')\n          let f1s = f.get('start')\n          let f1e = f.get('end')\n          const f2s = mate.start\n          const f2e = mate.end\n\n          if (f.get('strand') === -1) {\n            ;[f1e, f1s] = [f1s, f1e]\n          }\n          const a1 = assemblyManager.get(f.get('assemblyName'))\n          const a2 = assemblyManager.get(mate.assemblyName)\n          const r1 = f.get('refName')\n          const r2 = mate.refName\n          const ref1 = a1?.getCanonicalRefName(r1) || r1\n          const ref2 = a2?.getCanonicalRefName(r2) || r2\n          const v1 = viewSnaps[level]!\n          const v2 = viewSnaps[level + 1]!\n          const p11 = bpToPx({ self: v1, refName: ref1, coord: f1s })\n          const p12 = bpToPx({ self: v1, refName: ref1, coord: f1e })\n          const p21 = bpToPx({ self: v2, refName: ref2, coord: f2s })\n          const p22 = bpToPx({ self: v2, refName: ref2, coord: f2e })\n\n          if (\n            p11 === undefined ||\n            p12 === undefined ||\n            p21 === undefined ||\n            p22 === undefined\n          ) {\n            continue\n          }\n\n          const cigar = f.get('CIGAR') as string | undefined\n          map.push({\n            p11,\n            p12,\n            p21,\n            p22,\n            f,\n            cigar: MismatchParser.parseCigar(cigar),\n          })\n        }\n\n        self.setFeatPositions(map)\n      },\n      { fireImmediately: true },\n    ),\n  )\n}\n"],"names":["doAfterAttach","self","addDisposer","autorun","view","getContainingView","initialized","views","every","a","displayedRegions","length","ctx1","mainCanvas","getContext","ctx3","cigarClickMapCanvas","alpha","height","width","clearRect","drawRef","drawCigarClickMap","clickId","mouseoverId","drawMouseoverClickMap","reaction","bpPerPx","map","v","JSON","stringify","features","level","assemblyManager","getSession","viewSnaps","getSnapshot","staticBlocks","interRegionPaddingWidth","minimumBlockWidth","feats","f","mate","get","f1s","f1e","f2s","start","f2e","end","a1","a2","assemblyName","r1","r2","refName","ref1","getCanonicalRefName","ref2","v1","v2","p11","bpToPx","coord","p12","p21","p22","undefined","cigar","push","MismatchParser","setFeatPositions","fireImmediately"],"sourceRoot":""}