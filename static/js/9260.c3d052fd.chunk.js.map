{"version":3,"file":"static/js/9260.c3d052fd.chunk.js","mappings":"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","sources":["../../../plugins/variants/src/MultiLinearVariantRenderer/components/util.ts","../../../plugins/variants/src/MultiLinearVariantRenderer/components/MultiLinearVariantRendering.tsx","../../../plugins/variants/src/VcfFeature/util.ts"],"sourcesContent":["export function minElt<T>(arr: Iterable<T>, cb: (arg: T) => number) {\n  let min = Infinity\n  let minElement: T | undefined\n  for (const entry of arr) {\n    const val = cb(entry)\n\n    if (val < min) {\n      min = val\n      minElement = entry\n    }\n  }\n  return minElement\n}\n","import { useCallback, useMemo, useRef } from 'react'\n\nimport { PrerenderedCanvas } from '@jbrowse/core/ui'\nimport { getBpDisplayStr } from '@jbrowse/core/util'\nimport Flatbush from '@jbrowse/core/util/flatbush'\nimport { observer } from 'mobx-react'\n\nimport { minElt } from './util.ts'\nimport { makeSimpleAltString } from '../../VcfFeature/util.ts'\n\nimport type { Source } from '../../shared/types.ts'\nimport type { Feature } from '@jbrowse/core/util'\nimport type { Region } from '@jbrowse/core/util/types'\n\ninterface Item {\n  name: string\n  genotype: string\n  featureId: string\n  bpLen: number\n}\n\ninterface MinimizedVariantRecord {\n  alt: string[]\n  ref: string\n  name: string\n  description: string\n  length: number\n}\n\ninterface MultiVariantDisplayModel {\n  setHoveredGenotype?: (genotype?: Record<string, unknown>) => void\n}\n\ninterface RenderingProps {\n  onFeatureClick?: (event: React.MouseEvent, featureId: string) => void\n}\n\nconst MultiVariantRendering = observer(function MultiVariantRendering(props: {\n  regions: Region[]\n  features: Map<string, Feature>\n  bpPerPx: number\n  width: number\n  height: number\n  sources: Source[]\n  origScrollTop: number\n  featureGenotypeMap: Record<string, MinimizedVariantRecord>\n  totalHeight: number\n  flatbush: any\n  items: Item[]\n  displayModel: MultiVariantDisplayModel\n  renderingProps?: RenderingProps\n}) {\n  const {\n    flatbush,\n    items,\n    displayModel,\n    featureGenotypeMap,\n    totalHeight,\n    origScrollTop,\n    renderingProps,\n  } = props\n  const ref = useRef<HTMLDivElement>(null)\n  const lastHoveredRef = useRef<string | undefined>(undefined)\n  const flatbush2 = useMemo(() => Flatbush.from(flatbush), [flatbush])\n\n  const getFeatureUnderMouse = useCallback(\n    (eventClientX: number, eventClientY: number) => {\n      if (!ref.current) {\n        return\n      }\n      const rect = ref.current.getBoundingClientRect()\n      const offsetX = eventClientX - rect.left\n      const offsetY = eventClientY - rect.top\n\n      // Canvas is positioned at top=origScrollTop, so adjust mouse position\n      // relative to canvas top for Flatbush lookup\n      const canvasOffsetY = offsetY - origScrollTop\n      const x = flatbush2.search(\n        offsetX,\n        canvasOffsetY,\n        offsetX + 1,\n        canvasOffsetY + 1,\n      )\n      if (x.length) {\n        const res = minElt(x, idx => items[idx]?.bpLen ?? 0)!\n        const { bpLen, genotype, featureId, ...rest } = items[res] ?? {}\n        const ret =\n          featureId !== undefined ? featureGenotypeMap[featureId] : undefined\n        if (ret && genotype) {\n          const { ref, alt, name, description, length } = ret\n          const alleles = makeSimpleAltString(genotype, ref, alt)\n          return {\n            ...rest,\n            genotype,\n            alleles,\n            featureName: name,\n            description: alt.length >= 3 ? 'multiple ALT alleles' : description,\n            length: getBpDisplayStr(length),\n          }\n        }\n      }\n      return undefined\n    },\n    [flatbush2, items, featureGenotypeMap, origScrollTop],\n  )\n\n  const handleMouseMove = useCallback(\n    (e: React.MouseEvent) => {\n      const result = getFeatureUnderMouse(e.clientX, e.clientY)\n      const key = result ? `${result.name}:${result.genotype}` : undefined\n      if (key !== lastHoveredRef.current) {\n        lastHoveredRef.current = key\n        displayModel.setHoveredGenotype?.(result)\n      }\n    },\n    [getFeatureUnderMouse, displayModel],\n  )\n\n  const handleMouseLeave = useCallback(() => {\n    if (lastHoveredRef.current !== undefined) {\n      lastHoveredRef.current = undefined\n      displayModel.setHoveredGenotype?.(undefined)\n    }\n  }, [displayModel])\n\n  const getFeatureIdUnderMouse = useCallback(\n    (eventClientX: number, eventClientY: number) => {\n      if (!ref.current) {\n        return undefined\n      }\n      const rect = ref.current.getBoundingClientRect()\n      const offsetX = eventClientX - rect.left\n      const offsetY = eventClientY - rect.top\n      const canvasOffsetY = offsetY - origScrollTop\n      const x = flatbush2.search(\n        offsetX,\n        canvasOffsetY,\n        offsetX + 1,\n        canvasOffsetY + 1,\n      )\n      if (x.length) {\n        const res = minElt(x, idx => items[idx]?.bpLen ?? 0)!\n        return items[res]?.featureId\n      }\n      return undefined\n    },\n    [flatbush2, items, origScrollTop],\n  )\n\n  const handleClick = useCallback(\n    (e: React.MouseEvent) => {\n      const featureId = getFeatureIdUnderMouse(e.clientX, e.clientY)\n      if (featureId) {\n        renderingProps?.onFeatureClick?.(e, featureId)\n      }\n    },\n    [getFeatureIdUnderMouse, renderingProps],\n  )\n\n  return (\n    <div\n      ref={ref}\n      onMouseMove={handleMouseMove}\n      onMouseLeave={handleMouseLeave}\n      onMouseOut={handleMouseLeave}\n      onClick={handleClick}\n      style={{\n        overflow: 'visible',\n        position: 'relative',\n        height: totalHeight,\n      }}\n    >\n      <PrerenderedCanvas\n        {...props}\n        style={{\n          position: 'absolute',\n          left: 0,\n          top: origScrollTop,\n        }}\n      />\n    </div>\n  )\n})\n\nexport default MultiVariantRendering\n","import { parseBreakend } from '@gmod/vcf'\nimport { getBpDisplayStr } from '@jbrowse/core/util'\n\nimport type VCF from '@gmod/vcf'\n\nconst genotypeDelimRegex = /[/|]/\n\nfunction isBreakend(alt: string) {\n  return (\n    alt.includes('[') ||\n    alt.includes(']') ||\n    alt.startsWith('.') ||\n    alt.endsWith('.')\n  )\n}\n\nfunction isSymbolic(alt: string) {\n  return alt.startsWith('<') || isBreakend(alt)\n}\n\nfunction isInversion(ref: string, alt: string) {\n  return ref.split('').reverse().join('') === alt\n}\n\nconst altTypeToSO: Record<string, string> = {\n  '<DEL>': 'deletion',\n  '<INS>': 'insertion',\n  '<DUP>': 'duplication',\n  '<INV>': 'inversion',\n  '<INVDUP>': 'inverted_duplication',\n  '<CNV>': 'copy_number_variation',\n  '<TRA>': 'translocation',\n  '<DUP:TANDEM>': 'tandem_duplication',\n  '<NON_REF>': 'sequence_variant',\n  '<*>': 'sequence_variant',\n}\n\nexport function getSOTermAndDescription(\n  ref: string,\n  alt: string[] | undefined,\n  parser: VCF,\n): string[] {\n  if (!alt || alt.length === 0) {\n    return ['remark', 'no alternative alleles']\n  }\n\n  const soTerms = alt.map(a => getSOTerm(a, ref, parser))\n  const uniqueSoTerms = [...new Set(soTerms)]\n  const description = formatGroupDescription(ref, alt)\n\n  return [uniqueSoTerms.join(','), description]\n}\n\nfunction getSOTerm(alt: string, ref: string, parser: VCF): string {\n  // Symbolic alleles\n  if (alt.startsWith('<')) {\n    return findSOTerm(alt, parser) ?? 'variant'\n  }\n\n  // Breakends\n  if (isBreakend(alt) && parseBreakend(alt)) {\n    return 'breakend'\n  }\n\n  const lenRef = ref.length\n  const lenAlt = alt.length\n\n  if (lenRef === 1 && lenAlt === 1) {\n    return 'SNV'\n  } else if (lenRef === lenAlt) {\n    return isInversion(ref, alt) ? 'inversion' : 'substitution'\n  } else {\n    return lenRef < lenAlt ? 'insertion' : 'deletion'\n  }\n}\n\nfunction formatGroupDescription(ref: string, alts: string[]): string {\n  if (alts.every(isSymbolic)) {\n    return alts.join(',')\n  }\n\n  const lenRef = ref.length\n\n  return `${ref.length > 10 ? getBpDisplayStr(lenRef) : ref} -> ${alts.map(a => (a.length > 10 ? getBpDisplayStr(a.length) : a)).join(',')}`\n}\n\nfunction findSOTerm(alt: string, parser: VCF): string | undefined {\n  if (altTypeToSO[alt]) {\n    return altTypeToSO[alt]\n  }\n  if (parser.getMetadata('ALT', alt)) {\n    return 'sequence_variant'\n  }\n  // Try parent term by stripping last component, e.g. '<INS:ME>' -> '<INS>'\n  const parts = alt.slice(1, -1).split(':')\n  return parts.length > 1\n    ? findSOTerm(`<${parts.slice(0, -1).join(':')}>`, parser)\n    : undefined\n}\n\nexport function getSOAndDescFromAltDefs(alt: string, parser: VCF): string[] {\n  if (!alt.startsWith('<')) {\n    return []\n  }\n\n  const soTerm = findSOTerm(alt, parser)\n  return [soTerm ?? 'variant', alt]\n}\n\nexport function getMinimalDesc(ref: string, alt: string) {\n  if (isSymbolic(alt) || (ref.length === 1 && alt.length === 1)) {\n    return alt\n  }\n\n  const lenRef = ref.length\n  const lenAlt = alt.length\n  const isLong = lenRef > 5 || lenAlt > 5\n\n  return isLong\n    ? `${getBpDisplayStr(lenRef)} -> ${getBpDisplayStr(lenAlt)}`\n    : `${ref} -> ${alt}`\n}\n\nexport function makeSimpleAltString(\n  genotype: string,\n  ref: string,\n  alt: string[],\n) {\n  return genotype\n    .split(genotypeDelimRegex)\n    .map(r =>\n      r === '.'\n        ? '.'\n        : +r === 0\n          ? `ref(${ref.length < 10 ? ref : getBpDisplayStr(ref.length)})`\n          : getMinimalDesc(ref, alt[+r - 1] || ''),\n    )\n    .join(genotype.includes('|') ? '|' : '/')\n}\n"],"names":["minElt","arr","cb","minElement","min","Infinity","entry","val","observer","props","flatbush","items","displayModel","featureGenotypeMap","totalHeight","origScrollTop","renderingProps","ref","useRef","lastHoveredRef","undefined","flatbush2","useMemo","Flatbush","from","getFeatureUnderMouse","useCallback","eventClientX","eventClientY","current","rect","getBoundingClientRect","offsetX","left","canvasOffsetY","top","x","search","length","res","idx","bpLen","genotype","featureId","rest","ret","alt","name","description","alleles","makeSimpleAltString","featureName","getBpDisplayStr","handleMouseMove","e","result","clientX","clientY","key","setHoveredGenotype","handleMouseLeave","getFeatureIdUnderMouse","handleClick","onFeatureClick","_jsx","onMouseMove","onMouseLeave","onMouseOut","onClick","style","overflow","position","height","children","PrerenderedCanvas","genotypeDelimRegex","isBreakend","includes","startsWith","endsWith","isSymbolic","altTypeToSO","getSOTermAndDescription","parser","soTerms","map","a","findSOTerm","parseBreakend","lenRef","lenAlt","split","reverse","join","isInversion","getSOTerm","uniqueSoTerms","Set","alts","every","formatGroupDescription","getMetadata","parts","slice","getMinimalDesc","r"],"ignoreList":[],"sourceRoot":""}