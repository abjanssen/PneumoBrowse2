{"version":3,"file":"static/js/5009.c78c11b2.chunk.js","mappings":"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","sources":["../../../plugins/hic/src/HicRenderer/viridis.ts","../../../plugins/hic/src/HicRenderer/makeImageData.ts","../../../node_modules/.pnpm/d3-scale@4.0.2/node_modules/d3-scale/src/sequential.js"],"sourcesContent":["// @ts-nocheck\n// vendored from\n// https://github.com/d3/d3-scale-chromatic/blob/main/src/sequential-multi/viridis.js,\n// license reproduced below\n//\n// Copyright 2010-2024 Mike Bostock\n\n// Permission to use, copy, modify, and/or distribute this software for any purpose\n// with or without fee is hereby granted, provided that the above copyright notice\n// and this permission notice appear in all copies.\n//\n// THE SOFTWARE IS PROVIDED \"AS IS\" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH\n// REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY AND\n// FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,\n// INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS\n// OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER\n// TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR PERFORMANCE OF\n// THIS SOFTWARE.\nfunction colors(specifier) {\n  const n = (specifier.length / 6) | 0\n  const colors = new Array(n)\n  let i = 0\n  while (i < n) {\n    colors[i] = `#${specifier.slice(i * 6, ++i * 6)}`\n  }\n  return colors\n}\n\nfunction ramp(range) {\n  const n = range.length\n  return function (t) {\n    return range[Math.max(0, Math.min(n - 1, Math.floor(t * n)))]\n  }\n}\n\nexport default ramp(\n  colors(\n    '44015444025645045745055946075a46085c460a5d460b5e470d60470e6147106347116447136548146748166848176948186a481a6c481b6d481c6e481d6f481f70482071482173482374482475482576482677482878482979472a7a472c7a472d7b472e7c472f7d46307e46327e46337f463480453581453781453882443983443a83443b84433d84433e85423f854240864241864142874144874045884046883f47883f48893e49893e4a893e4c8a3d4d8a3d4e8a3c4f8a3c508b3b518b3b528b3a538b3a548c39558c39568c38588c38598c375a8c375b8d365c8d365d8d355e8d355f8d34608d34618d33628d33638d32648e32658e31668e31678e31688e30698e306a8e2f6b8e2f6c8e2e6d8e2e6e8e2e6f8e2d708e2d718e2c718e2c728e2c738e2b748e2b758e2a768e2a778e2a788e29798e297a8e297b8e287c8e287d8e277e8e277f8e27808e26818e26828e26828e25838e25848e25858e24868e24878e23888e23898e238a8d228b8d228c8d228d8d218e8d218f8d21908d21918c20928c20928c20938c1f948c1f958b1f968b1f978b1f988b1f998a1f9a8a1e9b8a1e9c891e9d891f9e891f9f881fa0881fa1881fa1871fa28720a38620a48621a58521a68522a78522a88423a98324aa8325ab8225ac8226ad8127ad8128ae8029af7f2ab07f2cb17e2db27d2eb37c2fb47c31b57b32b67a34b67935b77937b87838b9773aba763bbb753dbc743fbc7340bd7242be7144bf7046c06f48c16e4ac16d4cc26c4ec36b50c46a52c56954c56856c66758c7655ac8645cc8635ec96260ca6063cb5f65cb5e67cc5c69cd5b6ccd5a6ece5870cf5773d05675d05477d1537ad1517cd2507fd34e81d34d84d44b86d54989d5488bd6468ed64590d74393d74195d84098d83e9bd93c9dd93ba0da39a2da37a5db36a8db34aadc32addc30b0dd2fb2dd2db5de2bb8de29bade28bddf26c0df25c2df23c5e021c8e020cae11fcde11dd0e11cd2e21bd5e21ad8e219dae319dde318dfe318e2e418e5e419e7e419eae51aece51befe51cf1e51df4e61ef6e620f8e621fbe723fde725',\n  ),\n)\n","import { readConfObject } from '@jbrowse/core/configuration'\nimport { getAdapter } from '@jbrowse/core/data_adapters/dataAdapterCache'\nimport { colord } from '@jbrowse/core/util/colord'\nimport Flatbush from '@jbrowse/core/util/flatbush'\nimport {\n  checkStopToken2,\n  checkStopToken,\n  createStopTokenChecker,\n} from '@jbrowse/core/util/stopToken'\nimport { interpolateRgbBasis } from '@mui/x-charts-vendor/d3-interpolate'\nimport {\n  scaleSequential,\n  scaleSequentialLog,\n} from '@mui/x-charts-vendor/d3-scale'\n\nimport interpolateViridis from './viridis.ts'\n\nimport type { RenderArgsDeserializedWithFeatures } from './HicRenderer.tsx'\nimport type { HicFlatbushItem } from './types.ts'\nimport type PluginManager from '@jbrowse/core/PluginManager'\nimport type { BaseFeatureDataAdapter } from '@jbrowse/core/data_adapters/BaseAdapter'\nimport type { RenderArgs as ServerSideRenderArgs } from '@jbrowse/core/pluggableElementTypes/renderers/ServerSideRendererType'\nimport type { Region } from '@jbrowse/core/util/types'\n\nexport interface MakeImageDataResult {\n  flatbush: ArrayBufferLike\n  items: HicFlatbushItem[]\n  maxScore: number\n  w: number\n}\n\ninterface HicDataAdapter extends BaseFeatureDataAdapter {\n  getResolution: (bp: number) => Promise<number>\n}\n\nexport interface RenderArgs extends ServerSideRenderArgs {\n  regions: Region[]\n}\n\nexport async function makeImageData(\n  ctx: CanvasRenderingContext2D,\n  props: RenderArgsDeserializedWithFeatures & {\n    yScalar: number\n    pluginManager: PluginManager\n  },\n): Promise<MakeImageDataResult | undefined> {\n  const {\n    features,\n    config,\n    bpPerPx,\n    stopToken,\n    resolution,\n    sessionId,\n    adapterConfig,\n    useLogScale,\n    colorScheme,\n    regions,\n    pluginManager,\n    yScalar,\n  } = props\n\n  const { statusCallback = () => {} } = props\n  statusCallback('Drawing Hi-C matrix')\n  const { dataAdapter } = await getAdapter(\n    pluginManager,\n    sessionId,\n    adapterConfig,\n  )\n  const res = await (dataAdapter as HicDataAdapter).getResolution(\n    bpPerPx / resolution,\n  )\n\n  const lastCheck = createStopTokenChecker(stopToken)\n  const w = res / (bpPerPx * Math.sqrt(2))\n  const baseColor = colord(readConfObject(config, 'baseColor'))\n\n  // Calculate pixel offset for each region (cumulative)\n  const regionPixelOffsets: number[] = []\n  let cumulativePixelOffset = 0\n  for (const region of regions) {\n    regionPixelOffsets.push(cumulativePixelOffset)\n    cumulativePixelOffset += (region.end - region.start) / bpPerPx\n  }\n\n  // Calculate bin offset within each region\n  const regionBinOffsets = regions.map(region => Math.floor(region.start / res))\n\n  if (!features.length) {\n    return undefined\n  }\n\n  let maxScore = 0\n  checkStopToken(stopToken)\n  for (const { counts } of features) {\n    if (counts > maxScore) {\n      maxScore = counts\n    }\n  }\n  checkStopToken(stopToken)\n  const colorSchemes = {\n    juicebox: ['rgba(0,0,0,0)', 'red'],\n    fall: interpolateRgbBasis([\n      'rgb(255, 255, 255)',\n      'rgb(255, 255, 204)',\n      'rgb(255, 237, 160)',\n      'rgb(254, 217, 118)',\n      'rgb(254, 178, 76)',\n      'rgb(253, 141, 60)',\n      'rgb(252, 78, 42)',\n      'rgb(227, 26, 28)',\n      'rgb(189, 0, 38)',\n      'rgb(128, 0, 38)',\n      'rgb(0, 0, 0)',\n    ]),\n    viridis: interpolateViridis,\n  }\n  const m = useLogScale ? maxScore : maxScore / 20\n\n  // @ts-expect-error\n  const x1 = colorSchemes[colorScheme] || colorSchemes.juicebox\n  const scale = useLogScale\n    ? scaleSequentialLog(x1).domain([1, m])\n    : scaleSequential(x1).domain([0, m])\n  if (yScalar) {\n    ctx.scale(1, yScalar)\n  }\n  ctx.save()\n\n  // TODO: handle reversed regions for multi-region case\n  ctx.rotate(-Math.PI / 4)\n\n  // Precompute combined offsets for each region (bin offset + pixel-to-bin conversion)\n  const pxToBinFactor = bpPerPx / res\n  const regionCombinedOffsets = regionBinOffsets.map(\n    (binOffset, i) => (regionPixelOffsets[i] ?? 0) * pxToBinFactor - binOffset,\n  )\n\n  // Build Flatbush index and items array\n  // Store coordinates in the unrotated space (before -45Â° rotation)\n  // Client will transform mouse coords with inverse rotation to query\n  const coords: number[] = []\n  const items: HicFlatbushItem[] = []\n  for (let i = 0, l = features.length; i < l; i++) {\n    const { bin1, bin2, counts, region1Idx, region2Idx } = features[i]!\n    ctx.fillStyle = readConfObject(config, 'color', {\n      count: counts,\n      maxScore,\n      baseColor,\n      scale,\n      useLogScale,\n    })\n\n    const x = (bin1 + (regionCombinedOffsets[region1Idx] ?? 0)) * w\n    const y = (bin2 + (regionCombinedOffsets[region2Idx] ?? 0)) * w\n    ctx.fillRect(x, y, w, w)\n\n    // Store the unrotated rectangle coordinates for Flatbush\n    coords.push(x, y, x + w, y + w)\n    items.push({ bin1, bin2, counts, region1Idx, region2Idx })\n    checkStopToken2(lastCheck)\n  }\n  ctx.restore()\n\n  // Build Flatbush spatial index\n  const flatbush = new Flatbush(Math.max(items.length, 1))\n  if (coords.length) {\n    for (let i = 0; i < coords.length; i += 4) {\n      flatbush.add(coords[i]!, coords[i + 1]!, coords[i + 2], coords[i + 3])\n    }\n  } else {\n    flatbush.add(0, 0)\n  }\n  flatbush.finish()\n\n  return {\n    flatbush: flatbush.data,\n    items,\n    maxScore,\n    w,\n  }\n}\n","import {interpolate, interpolateRound} from \"d3-interpolate\";\nimport {identity} from \"./continuous.js\";\nimport {initInterpolator} from \"./init.js\";\nimport {linearish} from \"./linear.js\";\nimport {loggish} from \"./log.js\";\nimport {symlogish} from \"./symlog.js\";\nimport {powish} from \"./pow.js\";\n\nfunction transformer() {\n  var x0 = 0,\n      x1 = 1,\n      t0,\n      t1,\n      k10,\n      transform,\n      interpolator = identity,\n      clamp = false,\n      unknown;\n\n  function scale(x) {\n    return x == null || isNaN(x = +x) ? unknown : interpolator(k10 === 0 ? 0.5 : (x = (transform(x) - t0) * k10, clamp ? Math.max(0, Math.min(1, x)) : x));\n  }\n\n  scale.domain = function(_) {\n    return arguments.length ? ([x0, x1] = _, t0 = transform(x0 = +x0), t1 = transform(x1 = +x1), k10 = t0 === t1 ? 0 : 1 / (t1 - t0), scale) : [x0, x1];\n  };\n\n  scale.clamp = function(_) {\n    return arguments.length ? (clamp = !!_, scale) : clamp;\n  };\n\n  scale.interpolator = function(_) {\n    return arguments.length ? (interpolator = _, scale) : interpolator;\n  };\n\n  function range(interpolate) {\n    return function(_) {\n      var r0, r1;\n      return arguments.length ? ([r0, r1] = _, interpolator = interpolate(r0, r1), scale) : [interpolator(0), interpolator(1)];\n    };\n  }\n\n  scale.range = range(interpolate);\n\n  scale.rangeRound = range(interpolateRound);\n\n  scale.unknown = function(_) {\n    return arguments.length ? (unknown = _, scale) : unknown;\n  };\n\n  return function(t) {\n    transform = t, t0 = t(x0), t1 = t(x1), k10 = t0 === t1 ? 0 : 1 / (t1 - t0);\n    return scale;\n  };\n}\n\nexport function copy(source, target) {\n  return target\n      .domain(source.domain())\n      .interpolator(source.interpolator())\n      .clamp(source.clamp())\n      .unknown(source.unknown());\n}\n\nexport default function sequential() {\n  var scale = linearish(transformer()(identity));\n\n  scale.copy = function() {\n    return copy(scale, sequential());\n  };\n\n  return initInterpolator.apply(scale, arguments);\n}\n\nexport function sequentialLog() {\n  var scale = loggish(transformer()).domain([1, 10]);\n\n  scale.copy = function() {\n    return copy(scale, sequentialLog()).base(scale.base());\n  };\n\n  return initInterpolator.apply(scale, arguments);\n}\n\nexport function sequentialSymlog() {\n  var scale = symlogish(transformer());\n\n  scale.copy = function() {\n    return copy(scale, sequentialSymlog()).constant(scale.constant());\n  };\n\n  return initInterpolator.apply(scale, arguments);\n}\n\nexport function sequentialPow() {\n  var scale = powish(transformer());\n\n  scale.copy = function() {\n    return copy(scale, sequentialPow()).exponent(scale.exponent());\n  };\n\n  return initInterpolator.apply(scale, arguments);\n}\n\nexport function sequentialSqrt() {\n  return sequentialPow.apply(null, arguments).exponent(0.5);\n}\n"],"names":["range","n","length","t","Math","max","min","floor","specifier","colors","Array","i","slice","async","makeImageData","ctx","props","features","config","bpPerPx","stopToken","resolution","sessionId","adapterConfig","useLogScale","colorScheme","regions","pluginManager","yScalar","statusCallback","dataAdapter","getAdapter","res","getResolution","lastCheck","createStopTokenChecker","w","sqrt","baseColor","colord","readConfObject","regionPixelOffsets","cumulativePixelOffset","region","push","end","start","regionBinOffsets","map","maxScore","checkStopToken","counts","colorSchemes","juicebox","fall","interpolateRgbBasis","viridis","interpolateViridis","m","x1","scale","scaleSequentialLog","domain","scaleSequential","save","rotate","PI","pxToBinFactor","regionCombinedOffsets","binOffset","coords","items","l","bin1","bin2","region1Idx","region2Idx","fillStyle","count","x","y","fillRect","checkStopToken2","restore","flatbush","Flatbush","add","finish","data","transformer","t0","t1","k10","transform","unknown","x0","interpolator","identity","clamp","isNaN","interpolate","_","r0","r1","arguments","rangeRound","interpolateRound","copy","source","target","sequential","linearish","initInterpolator","apply","sequentialLog","loggish","base"],"ignoreList":[],"sourceRoot":""}