{"version":3,"file":"static/js/8955.76c72bd7.chunk.js","mappings":"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","sources":["../../../plugins/alignments/src/PileupRenderer/layoutFeature.ts","../../../plugins/alignments/src/PileupRenderer/renderers/getAlignmentShapeColor.ts","../../../plugins/alignments/src/PileupRenderer/colorBy.ts","../../../plugins/alignments/src/PileupRenderer/renderers/renderAlignmentShape.ts","../../../plugins/alignments/src/PileupRenderer/renderers/renderMethylation.ts","../../../plugins/alignments/src/PileupRenderer/renderers/renderPerBaseQuality.ts","../../../plugins/alignments/src/PileupRenderer/renderers/renderAlignment.ts","../../../plugins/alignments/src/PileupRenderer/renderers/renderPerBaseLettering.ts","../../../plugins/alignments/src/PileupRenderer/renderers/renderSoftClipping.ts","../../../plugins/alignments/src/PileupRenderer/makeImageData.ts","../../../plugins/alignments/src/PileupRenderer/layoutFeatures.ts","../../../plugins/alignments/src/PileupRenderer/sortUtil.ts","../../../plugins/alignments/src/ModificationParser/getMethBins.ts"],"sourcesContent":["import type { LayoutFeature } from './types.ts'\nimport type { Mismatch } from '../shared/types.ts'\nimport type { Feature } from '@jbrowse/core/util'\nimport type { BaseLayout } from '@jbrowse/core/util/layouts'\n\nexport function layoutFeature({\n  feature,\n  layout,\n  showSoftClip,\n  heightPx,\n  displayMode,\n}: {\n  feature: Feature\n  layout: BaseLayout<Feature>\n  showSoftClip?: boolean\n  heightPx: number\n  displayMode: string\n}): LayoutFeature | null {\n  // Cache start/end to avoid multiple get() calls\n  const featureStart = feature.get('start')\n  const featureEnd = feature.get('end')\n\n  let s = featureStart\n  let e = featureEnd\n\n  // Expand the start and end of feature when softclipping enabled\n  if (showSoftClip) {\n    const mismatches = feature.get('mismatches') as Mismatch[] | undefined\n    if (mismatches) {\n      for (const mismatch of mismatches) {\n        if (mismatch.type === 'softclip') {\n          const cliplen = mismatch.cliplen\n          if (mismatch.start === 0) {\n            s -= cliplen\n          } else {\n            e += cliplen\n          }\n        }\n      }\n    }\n  }\n\n  if (displayMode === 'compact') {\n    heightPx /= 3\n  }\n\n  const topPx = layout.addRect(feature.id(), s, e, heightPx, feature)\n  if (topPx === null) {\n    return null\n  }\n\n  return {\n    feature,\n    topPx: displayMode === 'collapse' ? 0 : topPx,\n    heightPx,\n  }\n}\n","import { readConfObject } from '@jbrowse/core/configuration'\n\nimport { fillColor } from '../../shared/color.ts'\nimport {\n  colorByInsertSize,\n  colorByMappingQuality,\n  colorByOrientation,\n  colorByStrand,\n  colorByStrandedRnaSeq,\n} from '../colorBy.ts'\n\nimport type { AnyConfigurationModel } from '@jbrowse/core/configuration'\nimport type { Feature } from '@jbrowse/core/util'\n\nexport function getAlignmentShapeColor({\n  colorType,\n  tag,\n  feature,\n  config,\n  defaultColor,\n  colorTagMap,\n}: {\n  colorType: string\n  tag: string\n  feature: Feature\n  defaultColor: boolean\n  config: AnyConfigurationModel\n  colorTagMap: Record<string, string>\n}) {\n  // first pass for simple color changes that change the color of the\n  // alignment\n  switch (colorType) {\n    case 'insertSize':\n      return colorByInsertSize(feature)\n    case 'strand':\n      return colorByStrand(feature)\n    case 'mappingQuality':\n      return colorByMappingQuality(feature)\n    case 'pairOrientation':\n      return colorByOrientation(feature, config)\n    case 'stranded':\n      return colorByStrandedRnaSeq(feature)\n    case 'xs':\n    case 'tag': {\n      const tags = feature.get('tags')\n      const val = tags ? tags[tag] : feature.get(tag)\n\n      if (tag === 'XS' || tag === 'TS') {\n        if (val === '-') {\n          return fillColor.color_rev_strand\n        } else if (val === '+') {\n          return fillColor.color_fwd_strand\n        } else {\n          return fillColor.color_nostrand\n        }\n      }\n      if (tag === 'ts') {\n        if (val === '-') {\n          return feature.get('strand') === -1\n            ? fillColor.color_fwd_strand\n            : fillColor.color_rev_strand\n        } else if (val === '+') {\n          return feature.get('strand') === -1\n            ? fillColor.color_rev_strand\n            : fillColor.color_fwd_strand\n        } else {\n          return fillColor.color_nostrand\n        }\n      }\n      return colorTagMap[val] || fillColor.color_nostrand\n    }\n    case 'insertSizeAndPairOrientation':\n      break\n\n    case 'modifications':\n    case 'methylation':\n      // this coloring is similar to igv.js, and is helpful to color negative\n      // strand reads differently because their c-g will be flipped (e.g. g-c\n      // read right to left)\n      return feature.get('flags') & 16 ? '#c8dcc8' : '#c8c8c8'\n\n    default:\n      return defaultColor\n        ? 'lightgrey'\n        : readConfObject(config, 'color', { feature })\n  }\n}\n","import { readConfObject } from '@jbrowse/core/configuration'\n\nimport { fillColor } from '../shared/color.ts'\nimport { orientationTypes } from '../util.ts'\n\nimport type { AnyConfigurationModel } from '@jbrowse/core/configuration'\nimport type { Feature } from '@jbrowse/core/util'\n\nexport function colorByInsertSize(feature: Feature) {\n  return feature.get('is_paired') &&\n    feature.get('refName') !== feature.get('next_ref')\n    ? '#555'\n    : `hsl(${Math.abs(feature.get('template_length')) / 10},50%,50%)`\n}\n\nexport function colorByMappingQuality(feature: Feature) {\n  return `hsl(${feature.get('score')},50%,50%)`\n}\n\nfunction getOrientation(feature: Feature, config: AnyConfigurationModel) {\n  const orientationType = readConfObject(config, 'orientationType') as\n    | 'fr'\n    | 'ff'\n    | 'rf'\n  const type = orientationTypes[orientationType]\n  const orientation = type[feature.get('pair_orientation') as string]!\n  return {\n    LR: 'color_pair_lr' as const,\n    RR: 'color_pair_rr' as const,\n    RL: 'color_pair_rl' as const,\n    LL: 'color_pair_ll' as const,\n  }[orientation]\n}\n\nexport function colorByStrand(feature: Feature) {\n  return feature.get('strand') === -1 ? '#8F8FD8' : '#EC8B8B'\n}\n\nexport function colorByOrientation(\n  feature: Feature,\n  config: AnyConfigurationModel,\n) {\n  return fillColor[getOrientation(feature, config) || 'color_nostrand']\n}\nfunction getStranded(feature: Feature) {\n  const flags = feature.get('flags')\n  const strand = feature.get('strand')\n\n  // is paired\n  if (flags & 1) {\n    // first-of-pair?\n    const flipper = flags & 64 ? -1 : 1\n\n    // proper pairing\n    if (flags & 2) {\n      return strand * flipper === 1 ? 'color_rev_strand' : 'color_fwd_strand'\n    }\n    // mate missing, separate color\n    if (flags & 8) {\n      return strand * flipper === 1\n        ? 'color_rev_missing_mate'\n        : 'color_fwd_missing_mate'\n    }\n    // same chrom without proper pairing gets separate color\n    if (feature.get('refName') === feature.get('next_ref')) {\n      return strand * flipper === 1\n        ? 'color_rev_strand_not_proper'\n        : 'color_fwd_strand_not_proper'\n    }\n    // abberant chrom\n\n    return strand === 1 ? 'color_fwd_diff_chr' : 'color_rev_diff_chr'\n  }\n  return 'color_unknown'\n}\n\nexport function colorByStrandedRnaSeq(feature: Feature) {\n  return fillColor[getStranded(feature)]\n}\n","import { CIGAR_N, CIGAR_REF_CONSUMING_MASK } from './cigarUtil.ts'\nimport { CHEVRON_WIDTH } from '../../shared/util.ts'\n\nimport type { ProcessedRenderArgs } from '../types.ts'\nimport type { LayoutFeature } from '../util.ts'\n\n// Helper to draw forward strand chevron\nfunction drawForwardChevron(\n  ctx: CanvasRenderingContext2D,\n  leftPx: number,\n  rightPx: number,\n  topPx: number,\n  heightPx: number,\n  midY: number,\n) {\n  ctx.beginPath()\n  ctx.moveTo(leftPx, topPx)\n  ctx.lineTo(leftPx, topPx + heightPx)\n  ctx.lineTo(rightPx, topPx + heightPx)\n  ctx.lineTo(rightPx + CHEVRON_WIDTH, midY)\n  ctx.lineTo(rightPx, topPx)\n  ctx.closePath()\n  ctx.fill()\n}\n\n// Helper to draw reverse strand chevron\nfunction drawReverseChevron(\n  ctx: CanvasRenderingContext2D,\n  leftPx: number,\n  rightPx: number,\n  topPx: number,\n  heightPx: number,\n  midY: number,\n) {\n  ctx.beginPath()\n  ctx.moveTo(leftPx - CHEVRON_WIDTH, midY)\n  ctx.lineTo(leftPx, topPx + heightPx)\n  ctx.lineTo(rightPx, topPx + heightPx)\n  ctx.lineTo(rightPx, topPx)\n  ctx.lineTo(leftPx, topPx)\n  ctx.closePath()\n  ctx.fill()\n}\n\nexport function renderAlignmentShape({\n  ctx,\n  feat,\n  renderArgs,\n  canvasWidth,\n  color,\n  cigarOps,\n}: {\n  ctx: CanvasRenderingContext2D\n  feat: LayoutFeature\n  renderArgs: ProcessedRenderArgs\n  canvasWidth: number\n  color: string\n  cigarOps: ArrayLike<number>\n}) {\n  const { regions, bpPerPx } = renderArgs\n  const { heightPx, topPx, feature } = feat\n  const region = regions[0]!\n  const regionStart = region.start\n  const regionEnd = region.end\n  const reversed = region.reversed\n  const invBpPerPx = 1 / bpPerPx\n  const s = feature.get('start')\n  const e = feature.get('end')\n\n  const flip = region.reversed ? -1 : 1\n  const strand = feature.get('strand') * flip\n  const renderChevrons = bpPerPx < 10 && heightPx > 5\n\n  ctx.fillStyle = color\n\n  let hasSkips = false\n  for (let i = 0, l = cigarOps.length; i < l; i++) {\n    if ((cigarOps[i]! & 0xf) === CIGAR_N) {\n      hasSkips = true\n      break\n    }\n  }\n\n  // Check for skips (N operations)\n  if (hasSkips) {\n    const midY = topPx + heightPx / 2\n\n    if (strand === 1) {\n      let drawLen = 0\n      let drawStart = s\n      const opsLen = cigarOps.length\n\n      for (let i = 0; i < opsLen; i++) {\n        const packed = cigarOps[i]!\n        const opLen = packed >> 4\n        const op = packed & 0xf\n\n        if ((1 << op) & CIGAR_REF_CONSUMING_MASK) {\n          drawLen += opLen\n        } else if (op === CIGAR_N) {\n          if (drawLen) {\n            const drawEnd = drawStart + drawLen\n            const leftPx = reversed\n              ? (regionEnd - drawEnd) * invBpPerPx\n              : (drawStart - regionStart) * invBpPerPx\n            const rightPx = reversed\n              ? (regionEnd - drawStart) * invBpPerPx\n              : (drawEnd - regionStart) * invBpPerPx\n            const w = rightPx - leftPx\n            if (leftPx + w > 0 && leftPx < canvasWidth) {\n              ctx.fillRect(leftPx, topPx, w, heightPx)\n            }\n          }\n          drawStart += drawLen + opLen\n          drawLen = 0\n        }\n      }\n\n      if (drawLen) {\n        const drawEnd = drawStart + drawLen\n        const leftPx = reversed\n          ? (regionEnd - drawEnd) * invBpPerPx\n          : (drawStart - regionStart) * invBpPerPx\n        const rightPx = reversed\n          ? (regionEnd - drawStart) * invBpPerPx\n          : (drawEnd - regionStart) * invBpPerPx\n\n        if (renderChevrons) {\n          drawForwardChevron(ctx, leftPx, rightPx, topPx, heightPx, midY)\n        } else {\n          const w = rightPx - leftPx\n          if (leftPx + w > 0 && leftPx < canvasWidth) {\n            ctx.fillRect(leftPx, topPx, w, heightPx)\n          }\n        }\n      }\n    } else if (strand === -1) {\n      let drawLen = 0\n      let drawStart = e\n\n      for (let i = cigarOps.length - 1; i >= 0; i--) {\n        const packed = cigarOps[i]!\n        const opLen = packed >> 4\n        const op = packed & 0xf\n\n        if ((1 << op) & CIGAR_REF_CONSUMING_MASK) {\n          drawLen += opLen\n        } else if (op === CIGAR_N) {\n          if (drawLen) {\n            const drawBegin = drawStart - drawLen\n            const leftPx = reversed\n              ? (regionEnd - drawStart) * invBpPerPx\n              : (drawBegin - regionStart) * invBpPerPx\n            const rightPx = reversed\n              ? (regionEnd - drawBegin) * invBpPerPx\n              : (drawStart - regionStart) * invBpPerPx\n            const w = rightPx - leftPx\n            if (leftPx + w > 0 && leftPx < canvasWidth) {\n              ctx.fillRect(leftPx, topPx, w, heightPx)\n            }\n          }\n          drawStart -= drawLen + opLen\n          drawLen = 0\n        }\n      }\n\n      if (drawLen) {\n        const drawBegin = drawStart - drawLen\n        const leftPx = reversed\n          ? (regionEnd - drawStart) * invBpPerPx\n          : (drawBegin - regionStart) * invBpPerPx\n        const rightPx = reversed\n          ? (regionEnd - drawBegin) * invBpPerPx\n          : (drawStart - regionStart) * invBpPerPx\n\n        if (renderChevrons) {\n          drawReverseChevron(ctx, leftPx, rightPx, topPx, heightPx, midY)\n        } else {\n          const w = rightPx - leftPx\n          if (leftPx + w > 0 && leftPx < canvasWidth) {\n            ctx.fillRect(leftPx, topPx, w, heightPx)\n          }\n        }\n      }\n    }\n  } else {\n    const leftPx = reversed\n      ? (regionEnd - e) * invBpPerPx\n      : (s - regionStart) * invBpPerPx\n    const rightPx = reversed\n      ? (regionEnd - s) * invBpPerPx\n      : (e - regionStart) * invBpPerPx\n    const midY = topPx + heightPx / 2\n\n    if (renderChevrons) {\n      if (strand === -1) {\n        drawReverseChevron(ctx, leftPx, rightPx, topPx, heightPx, midY)\n      } else {\n        drawForwardChevron(ctx, leftPx, rightPx, topPx, heightPx, midY)\n      }\n    } else {\n      const w = rightPx - leftPx\n      if (leftPx + w > 0 && leftPx < canvasWidth) {\n        ctx.fillRect(leftPx, topPx, w, heightPx)\n      }\n    }\n  }\n}\n","import { colord } from '@jbrowse/core/util/colord'\n\nimport { getMethBins } from '../../ModificationParser/getMethBins.ts'\nimport { buildMismatchMap } from '../../shared/util.ts'\n\nimport type { FlatbushItem, ProcessedRenderArgs } from '../types.ts'\nimport type { LayoutFeature } from '../util.ts'\nimport type { Region } from '@jbrowse/core/util'\n\n// Pre-compute colord objects for methylation colors\nconst RED_COLORD = colord('red')\nconst BLUE_COLORD = colord('blue')\nconst PINK_COLORD = colord('pink')\nconst PURPLE_COLORD = colord('purple')\n\n// Color by methylation is slightly modified version of color by modifications\n// at reference CpG sites, with non-methylated CpG colored (looking only at the\n// MM tag can not tell you where reference CpG sites are)\nexport function renderMethylation({\n  ctx,\n  feat,\n  region,\n  bpPerPx,\n  renderArgs,\n  cigarOps,\n}: {\n  ctx: CanvasRenderingContext2D\n  feat: LayoutFeature\n  region: Region\n  bpPerPx: number\n  renderArgs: ProcessedRenderArgs\n  cigarOps: ArrayLike<number>\n}) {\n  const items = [] as FlatbushItem[]\n  const coords = [] as number[]\n  const { regionSequence } = renderArgs\n  const { feature, topPx, heightPx } = feat\n  const bottomPx = topPx + heightPx\n  if (!regionSequence) {\n    throw new Error('region sequence required for methylation')\n  }\n\n  const seq = feature.get('seq') as string | undefined\n  if (!seq) {\n    return { items, coords }\n  }\n  const fstart = feature.get('start')\n  const fend = feature.get('end')\n  const { methBins, methProbs, hydroxyMethBins, hydroxyMethProbs } =\n    getMethBins(feature, cigarOps)\n  const mismatchMap = buildMismatchMap(feature, fstart)\n\n  function getColAndProb(\n    k: number,\n  ): { color: string; prob: number; type: string } | undefined {\n    if (methBins[k]) {\n      const p = methProbs[k] || 0\n      return {\n        color: (p > 0.5\n          ? RED_COLORD.alpha((p - 0.5) * 2)\n          : BLUE_COLORD.alpha(1 - p * 2)\n        ).toHslString(),\n        prob: p,\n        type: 'm (5mC)',\n      }\n    }\n    if (hydroxyMethBins[k]) {\n      const p = hydroxyMethProbs[k] || 0\n      return {\n        color: (p > 0.5\n          ? PINK_COLORD.alpha((p - 0.5) * 2)\n          : PURPLE_COLORD.alpha(1 - p * 2)\n        ).toHslString(),\n        prob: p,\n        type: 'h (5hmC)',\n      }\n    }\n    return undefined\n  }\n\n  const regionStart = region.start\n  const regionEnd = region.end\n  const reversed = region.reversed\n  const invBpPerPx = 1 / bpPerPx\n  const r = regionSequence.toLowerCase()\n\n  function drawBase(\n    start: number,\n    end: number,\n    info: { color: string; prob: number; type: string } | undefined,\n    label: string,\n  ) {\n    const leftPx = reversed\n      ? (regionEnd - end) * invBpPerPx\n      : (start - regionStart) * invBpPerPx\n    const rightPx = reversed\n      ? (regionEnd - start) * invBpPerPx\n      : (end - regionStart) * invBpPerPx\n    const w = rightPx - leftPx + 0.5\n    ctx.fillStyle = info?.color || 'blue'\n    ctx.fillRect(leftPx, topPx, w, heightPx)\n\n    if (rightPx - leftPx >= 0.2) {\n      const prob = info?.prob ?? 0\n      const modType = info?.type ?? 'unmethylated'\n      const mismatchBase = mismatchMap.get(start)\n      items.push({\n        type: 'modification',\n        info: `${label} ${modType} (${(prob * 100).toFixed(1)}%)`,\n        modType: 'methylation',\n        probability: prob,\n        start,\n        mismatch: mismatchBase,\n      })\n      coords.push(leftPx, topPx, rightPx, bottomPx)\n    }\n  }\n\n  // Calculate visible range within feature\n  const visStart = Math.max(0, regionStart - fstart)\n  const visEnd = Math.min(fend - fstart, regionEnd - fstart)\n\n  for (let i = visStart; i < visEnd; i++) {\n    const j = i + fstart\n\n    const l1 = r[j - regionStart + 1]\n    const l2 = r[j - regionStart + 2]\n\n    if (l1 === 'c' && l2 === 'g') {\n      const info1 = getColAndProb(i)\n      const info2 = getColAndProb(i + 1)\n\n      if (bpPerPx > 2) {\n        drawBase(j, j + 2, info1 || info2, 'CpG')\n      } else {\n        drawBase(j, j + 1, info1, 'CpG C')\n        drawBase(j + 1, j + 2, info2, 'CpG G')\n      }\n    }\n  }\n\n  return { items, coords }\n}\n","import {\n  CIGAR_D,\n  CIGAR_EQ,\n  CIGAR_I,\n  CIGAR_M,\n  CIGAR_N,\n  CIGAR_S,\n  CIGAR_X,\n} from './cigarUtil.ts'\n\nimport type { LayoutFeature } from '../util.ts'\nimport type { Region } from '@jbrowse/core/util'\n\n// Pre-cached HSL color strings for quality scores 0-255\nconst qualityColors: string[] = Array.from(\n  { length: 256 },\n  (_, score) => `hsl(${score === 255 ? 150 : score * 1.5},55%,50%)`,\n)\n\nexport function renderPerBaseQuality({\n  ctx,\n  feat,\n  region,\n  bpPerPx,\n  cigarOps,\n}: {\n  ctx: CanvasRenderingContext2D\n  feat: LayoutFeature\n  region: Region\n  bpPerPx: number\n  cigarOps: ArrayLike<number>\n}) {\n  const { feature, topPx, heightPx } = feat\n  const qual: string = feature.get('qual') || ''\n  const scores = qual.split(' ').map(val => +val)\n  const invBpPerPx = 1 / bpPerPx\n  const w = invBpPerPx\n  const start = feature.get('start')\n  let soffset = 0\n  let roffset = 0\n\n  const regionStart = region.start\n  const regionEnd = region.end\n  const reversed = region.reversed\n\n  for (let i = 0, l = cigarOps.length; i < l; i++) {\n    const packed = cigarOps[i]!\n    const len = packed >> 4\n    const opIdx = packed & 0xf\n    if (opIdx === CIGAR_S || opIdx === CIGAR_I) {\n      soffset += len\n    } else if (opIdx === CIGAR_D || opIdx === CIGAR_N) {\n      roffset += len\n    } else if (opIdx === CIGAR_M || opIdx === CIGAR_X || opIdx === CIGAR_EQ) {\n      const opStart = start + roffset\n      const opEnd = opStart + len\n\n      if (opStart >= regionEnd) {\n        break\n      }\n\n      if (opEnd > regionStart) {\n        const visStart = Math.max(0, regionStart - opStart)\n        const visEnd = Math.min(len, regionEnd - opStart)\n\n        for (let m = visStart; m < visEnd; m++) {\n          const score = scores[soffset + m]!\n          const refPos = opStart + m\n          const leftPx = reversed\n            ? (regionEnd - refPos - 1) * invBpPerPx\n            : (refPos - regionStart) * invBpPerPx\n          ctx.fillStyle = qualityColors[score] || qualityColors[0]!\n          ctx.fillRect(leftPx, topPx, w + 0.5, heightPx)\n        }\n      }\n      soffset += len\n      roffset += len\n    }\n  }\n}\n","import { getCigarOps } from './cigarUtil.ts'\nimport { getAlignmentShapeColor } from './getAlignmentShapeColor.ts'\nimport { renderAlignmentShape } from './renderAlignmentShape.ts'\nimport { renderMethylation } from './renderMethylation.ts'\nimport { renderModifications } from './renderModifications.ts'\nimport { renderPerBaseLettering } from './renderPerBaseLettering.ts'\nimport { renderPerBaseQuality } from './renderPerBaseQuality.ts'\n\nimport type { FlatbushItem, ProcessedRenderArgs } from '../types.ts'\nimport type { LayoutFeature } from '../util.ts'\n\nfunction collectResults(\n  ret: { coords: number[]; items: FlatbushItem[] },\n  coords: number[],\n  items: FlatbushItem[],\n) {\n  for (let i = 0, l = ret.coords.length; i < l; i++) {\n    coords.push(ret.coords[i]!)\n  }\n  for (let i = 0, l = ret.items.length; i < l; i++) {\n    items.push(ret.items[i]!)\n  }\n}\n\nexport function renderAlignment({\n  ctx,\n  feat,\n  renderArgs,\n  colorMap,\n  colorContrastMap,\n  charWidth,\n  charHeight,\n  defaultColor,\n  canvasWidth,\n}: {\n  ctx: CanvasRenderingContext2D\n  feat: LayoutFeature\n  renderArgs: ProcessedRenderArgs\n  colorMap: Record<string, string>\n  colorContrastMap: Record<string, string>\n  charWidth: number\n  charHeight: number\n  defaultColor: boolean\n  canvasWidth: number\n}) {\n  const items = [] as FlatbushItem[]\n  const coords = [] as number[]\n  const { config, bpPerPx, regions, colorBy, colorTagMap = {} } = renderArgs\n  const { tag = '', type: colorType = '' } = colorBy || {}\n  const { feature } = feat\n  const region = regions[0]!\n\n  const alignmentColor = getAlignmentShapeColor({\n    feature,\n    config,\n    tag,\n    defaultColor,\n    colorType,\n    colorTagMap,\n  })\n  const cigarOps = getCigarOps(\n    feature.get('NUMERIC_CIGAR') || feature.get('CIGAR'),\n  )\n  renderAlignmentShape({\n    ctx,\n    feat,\n    renderArgs,\n    canvasWidth,\n    color: alignmentColor,\n    cigarOps,\n  })\n\n  // second pass for color types that render per-base things that go over the\n  // existing drawing\n  switch (colorType) {\n    case 'perBaseQuality': {\n      renderPerBaseQuality({\n        ctx,\n        feat,\n        region,\n        bpPerPx,\n        cigarOps,\n      })\n      break\n    }\n\n    case 'perBaseLettering': {\n      renderPerBaseLettering({\n        ctx,\n        feat,\n        region,\n        bpPerPx,\n        colorMap,\n        colorContrastMap,\n        charWidth,\n        charHeight,\n        canvasWidth,\n        cigarOps,\n      })\n      break\n    }\n\n    case 'modifications': {\n      collectResults(\n        renderModifications({\n          ctx,\n          feat,\n          region,\n          bpPerPx,\n          renderArgs,\n          cigarOps,\n        }),\n        coords,\n        items,\n      )\n      break\n    }\n\n    case 'methylation': {\n      collectResults(\n        renderMethylation({ ctx, feat, region, bpPerPx, renderArgs, cigarOps }),\n        coords,\n        items,\n      )\n      break\n    }\n  }\n\n  return { coords, items }\n}\n","import {\n  CIGAR_D,\n  CIGAR_EQ,\n  CIGAR_I,\n  CIGAR_M,\n  CIGAR_N,\n  CIGAR_S,\n  CIGAR_X,\n} from './cigarUtil.ts'\n\nimport type { LayoutFeature } from '../util.ts'\nimport type { Region } from '@jbrowse/core/util'\n\nexport function renderPerBaseLettering({\n  ctx,\n  feat,\n  region,\n  bpPerPx,\n  colorMap,\n  colorContrastMap,\n  charWidth,\n  charHeight,\n  canvasWidth,\n  cigarOps,\n}: {\n  ctx: CanvasRenderingContext2D\n  feat: LayoutFeature\n  region: Region\n  bpPerPx: number\n  colorMap: Record<string, string>\n  colorContrastMap: Record<string, string>\n  charWidth: number\n  charHeight: number\n  canvasWidth: number\n  cigarOps: ArrayLike<number>\n}) {\n  const heightLim = charHeight - 2\n  const { feature, topPx, heightPx } = feat\n  const seq = feature.get('seq') as string | undefined\n  const invBpPerPx = 1 / bpPerPx\n  const w = invBpPerPx\n  const start = feature.get('start')\n  let soffset = 0\n  let roffset = 0\n\n  if (!seq) {\n    return\n  }\n\n  const regionStart = region.start\n  const regionEnd = region.end\n  const reversed = region.reversed\n\n  for (let i = 0, l = cigarOps.length; i < l; i++) {\n    const packed = cigarOps[i]!\n    const len = packed >> 4\n    const op = packed & 0xf\n    if (op === CIGAR_S || op === CIGAR_I) {\n      soffset += len\n    } else if (op === CIGAR_D || op === CIGAR_N) {\n      roffset += len\n    } else if (op === CIGAR_M || op === CIGAR_X || op === CIGAR_EQ) {\n      const opStart = start + roffset\n      const opEnd = opStart + len\n\n      // Early exit if we've passed the visible region\n      if (opStart >= regionEnd) {\n        break\n      }\n\n      // Skip if this op is entirely before visible region\n      if (opEnd > regionStart) {\n        // Calculate visible portion of this op\n        const visStart = Math.max(0, regionStart - opStart)\n        const visEnd = Math.min(len, regionEnd - opStart)\n\n        for (let m = visStart; m < visEnd; m++) {\n          const letter = seq[soffset + m]!\n          const r = opStart + m\n          const leftPx = reversed\n            ? (regionEnd - r - 1) * invBpPerPx\n            : (r - regionStart) * invBpPerPx\n          ctx.fillStyle = colorMap[letter]!\n          ctx.fillRect(leftPx, topPx, w + 0.5, heightPx)\n\n          if (w >= charWidth && heightPx >= heightLim) {\n            const x = leftPx + (w - charWidth) / 2 + 1\n            const y = topPx + heightPx\n            const color = colorContrastMap[letter]\n            if (x >= 0 && x <= canvasWidth && color) {\n              ctx.fillStyle = color\n              ctx.fillText(letter, x, y)\n            }\n          }\n        }\n      }\n      soffset += len\n      roffset += len\n    }\n  }\n}\n","import { readConfObject } from '@jbrowse/core/configuration'\n\nimport {\n  CIGAR_D,\n  CIGAR_EQ,\n  CIGAR_I,\n  CIGAR_M,\n  CIGAR_N,\n  CIGAR_S,\n  CIGAR_X,\n  getCigarOps,\n} from './cigarUtil.ts'\nimport { getCharWidthHeight } from '../../shared/util.ts'\n\nimport type { Mismatch } from '../../shared/types.ts'\nimport type { ProcessedRenderArgs } from '../types.ts'\nimport type { LayoutFeature } from '../util.ts'\nimport type { AnyConfigurationModel } from '@jbrowse/core/configuration'\nimport type { Theme } from '@mui/material'\n\nexport function renderSoftClipping({\n  ctx,\n  feat,\n  renderArgs,\n  config,\n  theme,\n  colorMap,\n  canvasWidth,\n}: {\n  ctx: CanvasRenderingContext2D\n  feat: LayoutFeature\n  renderArgs: ProcessedRenderArgs\n  config: AnyConfigurationModel\n  colorMap: Record<string, string>\n  theme: Theme\n  canvasWidth: number\n}) {\n  const { feature, topPx, heightPx } = feat\n  const { regions, bpPerPx } = renderArgs\n  const region = regions[0]!\n  const minFeatWidth = readConfObject(config, 'minSubfeatureWidth')\n  const mismatches = feature.get('mismatches') as Mismatch[] | undefined\n  const seq = feature.get('seq') as string | undefined\n  const { charWidth, charHeight } = getCharWidthHeight()\n\n  // Display all bases softclipped off in lightened colors\n  if (!(seq && mismatches)) {\n    return\n  }\n\n  const heightLim = charHeight - 2\n  let seqOffset = 0\n  let refOffset = 0\n  const CIGAR =\n    feature.get('NUMERIC_CIGAR') || (feature.get('CIGAR') as string | undefined)\n  const ops = getCigarOps(CIGAR)\n  const featStart = feature.get('start')\n  const regionStart = region.start\n  const regionEnd = region.end\n  const reversed = region.reversed\n  const invBpPerPx = 1 / bpPerPx\n\n  for (let i = 0, l = ops.length; i < l; i++) {\n    const packed = ops[i]!\n    const len = packed >> 4\n    const op = packed & 0xf\n    if (op === CIGAR_S) {\n      // Calculate soft clip region bounds\n      const clipStart = featStart - (i === 0 ? len : 0) + refOffset\n      const clipEnd = clipStart + len\n\n      // Skip if entirely outside visible region\n      if (clipEnd > regionStart && clipStart < regionEnd) {\n        const visStart = Math.max(0, regionStart - clipStart)\n        const visEnd = Math.min(len, regionEnd - clipStart)\n\n        for (let k = visStart; k < visEnd; k++) {\n          const base = seq[seqOffset + k]!\n          const s0 = clipStart + k\n          const leftPx = reversed\n            ? (regionEnd - s0 - 1) * invBpPerPx\n            : (s0 - regionStart) * invBpPerPx\n          const rightPx = reversed\n            ? (regionEnd - s0) * invBpPerPx\n            : (s0 + 1 - regionStart) * invBpPerPx\n          const widthPx = Math.max(minFeatWidth, rightPx - leftPx)\n\n          // Black accounts for IUPAC ambiguity code bases such as N that\n          // show in soft clipping\n          const baseColor = colorMap[base] || '#000000'\n          ctx.fillStyle = baseColor\n          ctx.fillRect(leftPx, topPx, widthPx, heightPx)\n\n          if (widthPx >= charWidth && heightPx >= heightLim) {\n            const x = leftPx + (widthPx - charWidth) / 2 + 1\n            const y = topPx + heightPx\n            const color = theme.palette.getContrastText(baseColor)\n            if (x >= 0 && x <= canvasWidth && color) {\n              ctx.fillStyle = color\n              ctx.fillText(base, x, y)\n            }\n          }\n        }\n      }\n      seqOffset += len\n    } else if (op === CIGAR_N) {\n      refOffset += len\n    } else if (op === CIGAR_M || op === CIGAR_EQ || op === CIGAR_X) {\n      refOffset += len\n      seqOffset += len\n    } else if (op === CIGAR_D) {\n      refOffset += len\n    } else if (op === CIGAR_I) {\n      seqOffset += len\n    }\n  }\n}\n","import { readConfObject } from '@jbrowse/core/configuration'\nimport { getAdapter } from '@jbrowse/core/data_adapters/dataAdapterCache'\nimport { createJBrowseTheme } from '@jbrowse/core/ui'\nimport { renderToAbstractCanvas } from '@jbrowse/core/util'\nimport Flatbush from '@jbrowse/core/util/flatbush'\nimport {\n  checkStopToken2,\n  createStopTokenChecker,\n} from '@jbrowse/core/util/stopToken'\n\nimport { layoutFeats } from './layoutFeatures.ts'\nimport { renderAlignment } from './renderers/renderAlignment.ts'\nimport { renderMismatchesCallback } from './renderers/renderMismatchesCallback.ts'\nimport { renderSoftClipping } from './renderers/renderSoftClipping.ts'\nimport {\n  getCharWidthHeight,\n  getColorBaseMap,\n  getContrastBaseMap,\n  setAlignmentFont,\n  shouldDrawIndels,\n  shouldDrawSNPsMuted,\n} from '../shared/util.ts'\n\nimport type {\n  FlatbushItem,\n  LayoutFeature,\n  PreProcessedRenderArgs,\n  ProcessedRenderArgs,\n} from './types.ts'\nimport type PluginManager from '@jbrowse/core/PluginManager'\nimport type { BaseSequenceAdapter } from '@jbrowse/core/data_adapters/BaseAdapter'\n\nasync function fetchRegionSequence(\n  renderArgs: PreProcessedRenderArgs,\n  pluginManager: PluginManager,\n) {\n  const { colorBy, features, sessionId, regions, adapterConfig } = renderArgs\n  if (colorBy?.type !== 'methylation' || !features.size) {\n    return undefined\n  }\n  // Get the BAM/CRAM adapter to access its cached sequenceAdapterConfig\n  const { dataAdapter } = await getAdapter(\n    pluginManager,\n    sessionId,\n    adapterConfig,\n  )\n  const sequenceAdapterConfig = (\n    dataAdapter as { sequenceAdapterConfig?: Record<string, unknown> }\n  ).sequenceAdapterConfig\n  if (!sequenceAdapterConfig) {\n    return undefined\n  }\n  const { dataAdapter: seqAdapter } = await getAdapter(\n    pluginManager,\n    sessionId,\n    sequenceAdapterConfig,\n  )\n  const region = regions[0]!\n  return (seqAdapter as BaseSequenceAdapter).getSequence({\n    ...region,\n    refName: region.originalRefName || region.refName,\n    start: Math.max(0, region.start - 1),\n    end: region.end + 1,\n  })\n}\n\nfunction renderFeatures({\n  ctx,\n  layoutRecords,\n  canvasWidth,\n  renderArgs,\n}: {\n  ctx: CanvasRenderingContext2D\n  canvasWidth: number\n  layoutRecords: LayoutFeature[]\n  renderArgs: ProcessedRenderArgs\n}) {\n  const {\n    stopToken,\n    config,\n    showSoftClip,\n    colorBy,\n    theme: configTheme,\n  } = renderArgs\n  const mismatchAlpha = readConfObject(config, 'mismatchAlpha')\n  const minSubfeatureWidth = readConfObject(config, 'minSubfeatureWidth')\n  const largeInsertionIndicatorScale = readConfObject(\n    config,\n    'largeInsertionIndicatorScale',\n  )\n  const hideSmallIndels = readConfObject(config, 'hideSmallIndels') as boolean\n  const hideMismatches = readConfObject(config, 'hideMismatches') as boolean\n  const hideLargeIndels = readConfObject(config, 'hideLargeIndels') as boolean\n  const defaultColor = readConfObject(config, 'color') === '#f0f'\n  const theme = createJBrowseTheme(configTheme)\n  const colorMap = getColorBaseMap(theme)\n  const colorContrastMap = getContrastBaseMap(theme)\n  setAlignmentFont(ctx)\n\n  const { charWidth, charHeight } = getCharWidthHeight()\n  const drawSNPsMuted = shouldDrawSNPsMuted(colorBy?.type)\n  const drawIndels = shouldDrawIndels()\n  const coords = [] as number[]\n  const items = [] as FlatbushItem[]\n  const lastCheck = createStopTokenChecker(stopToken)\n\n  for (const feat of layoutRecords) {\n    const alignmentRet = renderAlignment({\n      ctx,\n      feat,\n      renderArgs,\n      defaultColor,\n      colorMap,\n      colorContrastMap,\n      charWidth,\n      charHeight,\n      canvasWidth,\n    })\n    for (let i = 0, l = alignmentRet.coords.length; i < l; i++) {\n      coords.push(alignmentRet.coords[i]!)\n    }\n    for (let i = 0, l = alignmentRet.items.length; i < l; i++) {\n      items.push(alignmentRet.items[i]!)\n    }\n    const ret = renderMismatchesCallback({\n      ctx,\n      feat,\n      bpPerPx: renderArgs.bpPerPx,\n      regions: renderArgs.regions,\n      hideSmallIndels,\n      hideMismatches,\n      hideLargeIndels,\n      mismatchAlpha,\n      drawSNPsMuted,\n      drawIndels,\n      largeInsertionIndicatorScale,\n      minSubfeatureWidth,\n      charWidth,\n      charHeight,\n      colorMap,\n      colorContrastMap,\n      canvasWidth,\n    })\n    for (let i = 0, l = ret.coords.length; i < l; i++) {\n      coords.push(ret.coords[i]!)\n    }\n    for (let i = 0, l = ret.items.length; i < l; i++) {\n      items.push(ret.items[i]!)\n    }\n    if (showSoftClip) {\n      renderSoftClipping({\n        ctx,\n        feat,\n        renderArgs,\n        colorMap,\n        config,\n        theme,\n        canvasWidth,\n      })\n    }\n    checkStopToken2(lastCheck)\n  }\n\n  const flatbush = new Flatbush(Math.max(items.length, 1))\n  if (coords.length) {\n    for (let i = 0; i < coords.length; i += 4) {\n      flatbush.add(coords[i]!, coords[i + 1]!, coords[i + 2], coords[i + 3])\n    }\n  } else {\n    flatbush.add(0, 0)\n  }\n  flatbush.finish()\n\n  return {\n    flatbush: flatbush.data,\n    items,\n  }\n}\n\nexport async function makeImageData({\n  width,\n  renderArgs,\n  pluginManager,\n}: {\n  width: number\n  renderArgs: PreProcessedRenderArgs\n  pluginManager: PluginManager\n}) {\n  const { statusCallback = () => {}, features } = renderArgs\n\n  statusCallback('Creating layout')\n  const { layoutRecords, height } = layoutFeats(renderArgs)\n\n  statusCallback('Fetching sequence')\n  const regionSequence = await fetchRegionSequence(renderArgs, pluginManager)\n\n  statusCallback('Rendering alignments')\n  const result = await renderToAbstractCanvas(width, height, renderArgs, ctx =>\n    renderFeatures({\n      ctx,\n      layoutRecords,\n      canvasWidth: width,\n      renderArgs: {\n        ...renderArgs,\n        regionSequence,\n      },\n    }),\n  )\n\n  const featureNames: Record<string, string> = {}\n  for (const [id, feature] of features) {\n    const name = feature.get('name')\n    if (name) {\n      featureNames[id] = name\n    }\n  }\n\n  return { result, height, featureNames }\n}\n","import { readConfObject } from '@jbrowse/core/configuration'\n\nimport { layoutFeature } from './layoutFeature.ts'\nimport { sortFeature } from './sortUtil.ts'\n\nimport type { LayoutFeature, PreProcessedRenderArgs } from './types.ts'\n\n// layout determines the height of the canvas that we use to render\nexport function layoutFeats(props: PreProcessedRenderArgs) {\n  const { layout, features, sortedBy, config, showSoftClip, regions } = props\n  const region = regions[0]!\n  const hasSortedBy = sortedBy?.type && region.start === sortedBy.pos\n  const featureMap = hasSortedBy ? sortFeature(features, sortedBy) : features\n\n  const heightPx = readConfObject(config, 'height')\n  const displayMode = readConfObject(config, 'displayMode')\n\n  // Sort features by start position for PileupLayout's built-in hint optimization,\n  // but only when not using explicit sorting (which has its own order)\n  const featureArr = hasSortedBy\n    ? [...featureMap.values()]\n    : [...featureMap.values()].sort((a, b) => a.get('start') - b.get('start'))\n\n  const layoutRecords: LayoutFeature[] = []\n\n  for (const feature of featureArr) {\n    const result = layoutFeature({\n      feature,\n      layout,\n      showSoftClip,\n      heightPx,\n      displayMode,\n    })\n\n    if (result) {\n      layoutRecords.push(result)\n    }\n  }\n\n  return {\n    layoutRecords,\n    height: Math.max(layout.getTotalHeight(), 1),\n  }\n}\n","import { doesIntersect2 } from '@jbrowse/core/util'\n\nimport type { Mismatch, SortedBy } from '../shared/types.ts'\nimport type { Feature } from '@jbrowse/core/util'\n\nexport function sortFeature(\n  features: Map<string, Feature>,\n  sortedBy: SortedBy,\n) {\n  const featuresInCenterLine: Feature[] = []\n  const featuresOutsideCenter: Feature[] = []\n  const { pos, type } = sortedBy\n\n  // Partition features directly from map iterator (avoids intermediate array)\n  let firstFeature: Feature | undefined\n  for (const feature of features.values()) {\n    if (!firstFeature) {\n      firstFeature = feature\n    }\n    const start = feature.get('start')\n    const end = feature.get('end')\n    if (doesIntersect2(pos - 1, pos, start, end)) {\n      featuresInCenterLine.push(feature)\n    } else {\n      featuresOutsideCenter.push(feature)\n    }\n  }\n\n  const isCram = firstFeature ? firstFeature.get('tags') : false\n  switch (type) {\n    case 'Start location': {\n      featuresInCenterLine.sort((a, b) => a.get('start') - b.get('start'))\n      break\n    }\n\n    case 'tag': {\n      const tag = sortedBy.tag!\n      const getTag = (f: Feature, t: string) => {\n        return isCram ? f.get('tags')[t] : f.get(t)\n      }\n      const isString =\n        featuresInCenterLine[0] &&\n        typeof getTag(featuresInCenterLine[0], tag) === 'string'\n      if (isString) {\n        featuresInCenterLine.sort((a, b) =>\n          getTag(b, tag).localeCompare(getTag(a, tag)),\n        )\n      } else {\n        featuresInCenterLine.sort(\n          (a, b) => (getTag(b, tag) || 0) - (getTag(a, tag) || 0),\n        )\n      }\n      break\n    }\n\n    // first sort all mismatches, then all reference bases at the end\n    case 'Base pair': {\n      const baseMap = new Map<string, Mismatch>()\n      for (const feature of featuresInCenterLine) {\n        const mismatches: Mismatch[] = feature.get('mismatches')\n        const start = feature.get('start')\n        for (const m of mismatches) {\n          const offset = start + m.start + 1\n          const consuming = m.type === 'insertion' || m.type === 'softclip'\n          const len = consuming ? 0 : m.length\n          if (pos >= offset && pos < offset + len) {\n            baseMap.set(feature.id(), m)\n          }\n        }\n      }\n\n      featuresInCenterLine.sort((a, b) => {\n        const aMismatch = baseMap.get(a.id())\n        const bMismatch = baseMap.get(b.id())\n        const acode =\n          aMismatch?.type === 'mismatch'\n            ? aMismatch.base.toUpperCase()\n            : aMismatch?.type === 'deletion'\n              ? '*'\n              : undefined\n        const bcode =\n          bMismatch?.type === 'mismatch'\n            ? bMismatch.base.toUpperCase()\n            : bMismatch?.type === 'deletion'\n              ? '*'\n              : undefined\n        return acode === bcode && acode === '*'\n          ? (bMismatch?.length ?? 0) - (aMismatch?.length ?? 0)\n          : (bcode ? bcode.charCodeAt(0) : 0) -\n              (acode ? acode.charCodeAt(0) : 0)\n      })\n\n      break\n    }\n\n    // sorts positive strands then negative strands\n    case 'Read strand': {\n      featuresInCenterLine.sort((a, b) =>\n        a.get('strand') <= b.get('strand') ? 1 : -1,\n      )\n      break\n    }\n  }\n\n  // Build result map directly without intermediate array spread\n  const result = new Map<string, Feature>()\n  for (const feature of featuresInCenterLine) {\n    result.set(feature.id(), feature)\n  }\n  for (const feature of featuresOutsideCenter) {\n    result.set(feature.id(), feature)\n  }\n  return result\n}\n","import { getModPositions } from './getModPositions.ts'\nimport { getModProbabilities } from './getModProbabilities.ts'\nimport { getNextRefPos } from '../MismatchParser/index.ts'\nimport { getTagAlt } from '../util.ts'\n\nimport type { Feature } from '@jbrowse/core/util'\n\nexport function getMethBins(feature: Feature, cigarOps: ArrayLike<number>) {\n  const fstart = feature.get('start')\n  const fend = feature.get('end')\n  const fstrand = feature.get('strand') as -1 | 0 | 1\n  const flen = fend - fstart\n  const mm = (getTagAlt(feature, 'MM', 'Mm') as string | undefined) || ''\n  const methBins = []\n  const hydroxyMethBins = []\n  const methProbs = []\n  const hydroxyMethProbs = []\n  const seq = feature.get('seq') as string | undefined\n  if (seq) {\n    const probabilities = getModProbabilities(feature)\n    const modifications = getModPositions(mm, seq, fstrand)\n    let probIndex = 0\n\n    for (const { type, positions } of modifications) {\n      for (const { ref, idx } of getNextRefPos(cigarOps, positions)) {\n        // Skip positions outside the feature bounds\n        if (ref < 0 || ref >= flen) {\n          continue\n        }\n\n        // Calculate probability index based on strand\n        const isReverseStrand = fstrand === -1\n        const idx2 =\n          probIndex + (isReverseStrand ? positions.length - 1 - idx : idx)\n        const prob = probabilities?.[idx2] || 0\n\n        // Store modification data in appropriate bins\n        if (type === 'm') {\n          methBins[ref] = 1\n          methProbs[ref] = prob\n        } else if (type === 'h') {\n          hydroxyMethBins[ref] = 1\n          hydroxyMethProbs[ref] = prob\n        }\n      }\n      probIndex += positions.length\n    }\n  }\n  return {\n    methBins,\n    hydroxyMethBins,\n    methProbs,\n    hydroxyMethProbs,\n  }\n}\n"],"names":["layoutFeature","feature","layout","showSoftClip","heightPx","displayMode","s","get","e","mismatches","mismatch","type","cliplen","start","topPx","addRect","id","getAlignmentShapeColor","colorType","tag","config","defaultColor","colorTagMap","Math","abs","colorByInsertSize","colorByStrand","colorByMappingQuality","fillColor","orientationType","readConfObject","LR","RR","RL","LL","orientationTypes","getOrientation","colorByOrientation","flags","strand","flipper","getStranded","colorByStrandedRnaSeq","tags","val","color_rev_strand","color_fwd_strand","color_nostrand","drawForwardChevron","ctx","leftPx","rightPx","midY","beginPath","moveTo","lineTo","CHEVRON_WIDTH","closePath","fill","drawReverseChevron","RED_COLORD","colord","BLUE_COLORD","PINK_COLORD","PURPLE_COLORD","qualityColors","Array","from","length","_","score","collectResults","ret","coords","items","i","l","push","renderAlignment","feat","renderArgs","colorMap","colorContrastMap","charWidth","charHeight","canvasWidth","bpPerPx","regions","colorBy","region","alignmentColor","cigarOps","getCigarOps","color","regionStart","regionEnd","end","reversed","invBpPerPx","flip","renderChevrons","fillStyle","hasSkips","CIGAR_N","drawLen","drawStart","opsLen","packed","opLen","op","CIGAR_REF_CONSUMING_MASK","drawEnd","w","fillRect","drawBegin","renderAlignmentShape","scores","split","map","soffset","roffset","len","opIdx","CIGAR_S","CIGAR_I","CIGAR_D","CIGAR_M","CIGAR_X","CIGAR_EQ","opStart","opEnd","visStart","max","visEnd","min","m","refPos","renderPerBaseQuality","heightLim","seq","letter","r","x","y","fillText","renderPerBaseLettering","renderModifications","regionSequence","bottomPx","Error","fstart","fend","methBins","methProbs","hydroxyMethBins","hydroxyMethProbs","getMethBins","mismatchMap","buildMismatchMap","getColAndProb","k","p","alpha","toHslString","prob","toLowerCase","drawBase","info","label","modType","mismatchBase","toFixed","probability","j","l1","l2","info1","info2","renderMethylation","renderSoftClipping","theme","minFeatWidth","getCharWidthHeight","seqOffset","refOffset","CIGAR","ops","featStart","clipStart","base","s0","widthPx","baseColor","palette","getContrastText","async","makeImageData","width","pluginManager","statusCallback","features","layoutRecords","height","props","sortedBy","hasSortedBy","pos","featureMap","featuresInCenterLine","featuresOutsideCenter","firstFeature","values","doesIntersect2","isCram","sort","a","b","getTag","f","t","localeCompare","baseMap","Map","offset","set","aMismatch","bMismatch","acode","toUpperCase","undefined","bcode","charCodeAt","result","sortFeature","featureArr","getTotalHeight","layoutFeats","sessionId","adapterConfig","size","dataAdapter","getAdapter","sequenceAdapterConfig","seqAdapter","getSequence","refName","originalRefName","fetchRegionSequence","renderToAbstractCanvas","stopToken","configTheme","mismatchAlpha","minSubfeatureWidth","largeInsertionIndicatorScale","hideSmallIndels","hideMismatches","hideLargeIndels","createJBrowseTheme","getColorBaseMap","getContrastBaseMap","setAlignmentFont","drawSNPsMuted","shouldDrawSNPsMuted","drawIndels","shouldDrawIndels","lastCheck","createStopTokenChecker","alignmentRet","renderMismatchesCallback","checkStopToken2","flatbush","Flatbush","add","finish","data","renderFeatures","featureNames","name","fstrand","flen","mm","getTagAlt","probabilities","getModProbabilities","modifications","getModPositions","probIndex","positions","ref","idx","getNextRefPos","idx2"],"ignoreList":[],"sourceRoot":""}