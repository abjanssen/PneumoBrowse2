{"version":3,"file":"static/js/1777.110c7346.chunk.js","mappings":"mOA2BO,SAASA,EAAcC,GAG3B,WACC,IACE,MAAM,WAAEC,IAAeC,EAAAA,EAAAA,YAAWF,GAC5BG,GAAeC,EAAAA,EAAAA,iBAAgBJ,IAC/B,MAAEK,SAAiBJ,EAAWK,KAAKH,EAAc,cAAe,CACpEI,cAAeP,EAAKO,iBAElBC,EAAAA,EAAAA,SAAQR,IAASK,GACnBL,EAAKS,2BAA2BJ,EAEpC,CAAE,MAAOK,GACPC,QAAQC,MAAMF,IACVF,EAAAA,EAAAA,SAAQR,KACVE,EAAAA,EAAAA,YAAWF,GAAMa,YAAY,GAAGH,IAAKA,EAEzC,CACD,EAhBA,IA6FDI,EAAAA,EAAAA,aACEd,GACAe,EAAAA,EAAAA,SACE,KACE,GAAIf,EAAKgB,YACP,OAEF,MAAMC,GAAOC,EAAAA,EAAAA,mBAAkBlB,GAC/B,IAAKiB,EAAKE,YACR,OAEF,MAAM,cAAEC,GAAkBH,EACpBI,EAAUD,EAAcE,cAI9BtB,EAAKuB,WACLvB,EAAKwB,YACLxB,EAAKyB,YACLzB,EAAK0B,oBACL1B,EAAK2B,KACL3B,EAAK4B,SAGDC,EAAAA,EAAAA,WAAU,IAAM7B,EAAKY,QAAWS,EAAQS,QAnG5BC,WACpB,GAAI/B,EAAKgB,YACP,OAEF,MAAMC,GAAOC,EAAAA,EAAAA,mBAAkBlB,IACzB,QAAEgC,EAAO,cAAEZ,GAAkBH,EAC7BI,EAAUD,EAAcE,cAE9B,IAAKD,EAAQS,OACX,OAGF,MAAM,cAAEvB,GAAkBP,EACpBiC,EAAcjC,EAAKiC,cAEzB,IACE,MAAMC,GAAUhC,EAAAA,EAAAA,YAAWF,IACrB,WAAEC,GAAeiC,EACjB/B,GAAeC,EAAAA,EAAAA,iBAAgBJ,GAE/BmC,GAAgBN,EAAAA,EAAAA,WAAU,IAAM7B,EAAKoC,oBACvCD,IACFE,EAAAA,EAAAA,IAAcF,GAGhB,MAAMG,GAAYC,EAAAA,EAAAA,MAClBvC,EAAKwC,sBAAsBF,GAC3BtC,EAAKyC,YAAW,GAEhB,MAAMC,QAAgBzC,EAAWK,KAC/BH,EACA,aACA,CACEwC,UAAWxC,EACXyC,aAAc,cACdvB,QAAS,IAAIA,GACbd,gBACAyB,UACAM,eACGL,GAEL,CACEY,eAAiBC,KACXtC,EAAAA,EAAAA,SAAQR,IACVA,EAAK+C,iBAAiBD,MAM1BJ,EAAOM,YACThD,EAAKiD,sBAAsBP,EAAOM,WAClChD,EAAKkD,qBAAqBjC,EAAKkC,WAGjCnD,EAAKoD,gBACHV,EAAOW,SACPX,EAAOY,OAAS,GAChBZ,EAAOa,UAAY,EACnBb,EAAOc,SAAW,EAEtB,CAAE,MAAO5C,IACF6C,EAAAA,EAAAA,IAAiB7C,KAChBJ,EAAAA,EAAAA,SAAQR,IACVA,EAAK0D,SAAS9C,EAGpB,CAAE,SACIJ,EAAAA,EAAAA,SAAQR,KACVA,EAAKwC,2BAAsBmB,GAC3B3D,EAAKyC,YAAW,GAEpB,GAgCImB,IAEF,CACEC,MAAO,IACPC,KAAM,6BAKZhD,EAAAA,EAAAA,aACEd,GACAe,EAAAA,EAAAA,SACE,KACMf,EAAKgB,cAGIE,EAAAA,EAAAA,mBAAkBlB,GACrBmB,cAGV4C,EAAAA,EAAAA,IAAoB/D,EAAKgE,IAAKhE,EAAKiE,qBAErC,CACEH,KAAM,2BAId,C","sources":["../../../plugins/hic/src/LinearHicDisplay/afterAttach.ts"],"sourcesContent":["import {\n  getContainingView,\n  getRpcSessionId,\n  getSession,\n  isAbortException,\n} from '@jbrowse/core/util'\nimport { createStopToken, stopStopToken } from '@jbrowse/core/util/stopToken'\nimport { addDisposer, isAlive } from '@jbrowse/mobx-state-tree'\nimport { drawCanvasImageData } from '@jbrowse/plugin-linear-genome-view'\nimport { autorun, untracked } from 'mobx'\n\nimport type { LinearHicDisplayModel } from './model.ts'\nimport type { HicFlatbushItem } from '../HicRenderer/types.ts'\nimport type { LinearGenomeViewModel } from '@jbrowse/plugin-linear-genome-view'\n\ntype LGV = LinearGenomeViewModel\n\ninterface RenderResult {\n  imageData?: ImageBitmap\n  flatbush?: ArrayBufferLike\n  items?: HicFlatbushItem[]\n  maxScore?: number\n  yScalar?: number\n  width: number\n  height: number\n}\n\nexport function doAfterAttach(self: LinearHicDisplayModel) {\n  // Fetch available normalizations\n  // eslint-disable-next-line @typescript-eslint/no-floating-promises\n  ;(async () => {\n    try {\n      const { rpcManager } = getSession(self)\n      const rpcSessionId = getRpcSessionId(self)\n      const { norms } = (await rpcManager.call(rpcSessionId, 'CoreGetInfo', {\n        adapterConfig: self.adapterConfig,\n      })) as { norms?: string[] }\n      if (isAlive(self) && norms) {\n        self.setAvailableNormalizations(norms)\n      }\n    } catch (e) {\n      console.error(e)\n      if (isAlive(self)) {\n        getSession(self).notifyError(`${e}`, e)\n      }\n    }\n  })()\n\n  const performRender = async () => {\n    if (self.isMinimized) {\n      return\n    }\n    const view = getContainingView(self) as LGV\n    const { bpPerPx, dynamicBlocks } = view\n    const regions = dynamicBlocks.contentBlocks\n\n    if (!regions.length) {\n      return\n    }\n\n    const { adapterConfig } = self\n    const renderProps = self.renderProps()\n\n    try {\n      const session = getSession(self)\n      const { rpcManager } = session\n      const rpcSessionId = getRpcSessionId(self)\n\n      const previousToken = untracked(() => self.renderingStopToken)\n      if (previousToken) {\n        stopStopToken(previousToken)\n      }\n\n      const stopToken = createStopToken()\n      self.setRenderingStopToken(stopToken)\n      self.setLoading(true)\n\n      const result = (await rpcManager.call(\n        rpcSessionId,\n        'CoreRender',\n        {\n          sessionId: rpcSessionId,\n          rendererType: 'HicRenderer',\n          regions: [...regions],\n          adapterConfig,\n          bpPerPx,\n          stopToken,\n          ...renderProps,\n        },\n        {\n          statusCallback: (msg: string) => {\n            if (isAlive(self)) {\n              self.setStatusMessage(msg)\n            }\n          },\n        },\n      )) as RenderResult\n\n      if (result.imageData) {\n        self.setRenderingImageData(result.imageData)\n        self.setLastDrawnOffsetPx(view.offsetPx)\n      }\n      // Store flatbush data for mouseover\n      self.setFlatbushData(\n        result.flatbush,\n        result.items ?? [],\n        result.maxScore ?? 0,\n        result.yScalar ?? 1,\n      )\n    } catch (error) {\n      if (!isAbortException(error)) {\n        if (isAlive(self)) {\n          self.setError(error)\n        }\n      }\n    } finally {\n      if (isAlive(self)) {\n        self.setRenderingStopToken(undefined)\n        self.setLoading(false)\n      }\n    }\n  }\n\n  addDisposer(\n    self,\n    autorun(\n      () => {\n        if (self.isMinimized) {\n          return\n        }\n        const view = getContainingView(self) as LGV\n        if (!view.initialized) {\n          return\n        }\n        const { dynamicBlocks } = view\n        const regions = dynamicBlocks.contentBlocks\n\n        /* eslint-disable @typescript-eslint/no-unused-expressions */\n        // access these to trigger autorun on changes\n        self.resolution\n        self.useLogScale\n        self.colorScheme\n        self.activeNormalization\n        self.mode\n        self.height\n        /* eslint-enable @typescript-eslint/no-unused-expressions */\n\n        if (untracked(() => self.error) || !regions.length) {\n          return\n        }\n\n        // eslint-disable-next-line @typescript-eslint/no-floating-promises\n        performRender()\n      },\n      {\n        delay: 1000,\n        name: 'LinearHicDisplayRender',\n      },\n    ),\n  )\n\n  addDisposer(\n    self,\n    autorun(\n      () => {\n        if (self.isMinimized) {\n          return\n        }\n        const view = getContainingView(self) as LGV\n        if (!view.initialized) {\n          return\n        }\n        drawCanvasImageData(self.ref, self.renderingImageData)\n      },\n      {\n        name: 'LinearHicDisplayCanvas',\n      },\n    ),\n  )\n}\n"],"names":["doAfterAttach","self","rpcManager","getSession","rpcSessionId","getRpcSessionId","norms","call","adapterConfig","isAlive","setAvailableNormalizations","e","console","error","notifyError","addDisposer","autorun","isMinimized","view","getContainingView","initialized","dynamicBlocks","regions","contentBlocks","resolution","useLogScale","colorScheme","activeNormalization","mode","height","untracked","length","async","bpPerPx","renderProps","session","previousToken","renderingStopToken","stopStopToken","stopToken","createStopToken","setRenderingStopToken","setLoading","result","sessionId","rendererType","statusCallback","msg","setStatusMessage","imageData","setRenderingImageData","setLastDrawnOffsetPx","offsetPx","setFlatbushData","flatbush","items","maxScore","yScalar","isAbortException","setError","undefined","performRender","delay","name","drawCanvasImageData","ref","renderingImageData"],"ignoreList":[],"sourceRoot":""}