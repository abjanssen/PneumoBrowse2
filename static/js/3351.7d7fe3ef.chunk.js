(globalThis.webpackChunk_jbrowse_web=globalThis.webpackChunk_jbrowse_web||[]).push([[3351],{14587:(e,t,r)=>{"use strict";r.r(t),r.d(t,{default:()=>j});var n={};r.r(n),r.d(n,{escape:()=>h,escapeColumn:()=>p,formatAttributes:()=>v,formatComment:()=>T,formatDirective:()=>S,formatFeature:()=>k,formatItem:()=>O,formatSequence:()=>$,parseAttributes:()=>m,parseDirective:()=>_,parseFeature:()=>b,unescape:()=>f});var s=r(46377),a=r(99834),i=r(66885),o=r(32598),c=r(99546),u=r(7706);const l=["seq_name","source","featureType","start","end","score","strand","frame","attributes"];function f(e){return null===e?null:String(e).replace(/%([0-9A-Fa-f]{2})/g,((e,t)=>String.fromCharCode(parseInt(t,16))))}function d(e,t){return String(t).replace(e,(e=>{let t=e.charCodeAt(0).toString(16).toUpperCase();return t.length<2&&(t=`0${t}`),`%${t}`}))}function h(e){return d(/[\n;\r\t=%&,\x00-\x1f\x7f-\xff]/g,e)}function p(e){return d(/[\n\r\t%\x00-\x1f\x7f-\xff]/g,e)}function m(e){if(!e||!e.length||"."===e)return{};const t={};return e.replace(/\r?\n$/,"").slice(0,-1).split(";").forEach((e=>{if(!e)return;const r=e.trim().split(" ");if(!r[1]||!r[1].length)return;r[0]=r[0].trim();let n=t[r[0].trim()];n||(n=[],t[r[0]]=n),n.push(...r[1].split(",").map((e=>e.trim())).map(f))})),t}function b(e){const t=e.split("\t").map((e=>"."===e?null:e));t[0]=f(t[0]),t[1]=f(t[1]),t[2]=f(t[2]),t[8]=m(t[8]);const r={};for(let e=0;e<l.length;e+=1)r[l[e]]="."===t[e]?null:t[e];return null!==r.start&&(r.start=parseInt(r.start,10)),null!==r.end&&(r.end=parseInt(r.end,10)),null!==r.score&&(r.score=parseFloat(r.score,10)),null!=r.strand&&(r.strand=r.strand),r}function _(e){const t=/^\s*##\s*(\S+)\s*(.*)/.exec(e);if(!t)return null;const r=t[1];let n=t[2];const s={directive:r};if(n.length&&(n=n.replace(/\r?\n$/,""),s.value=n),"sequence-region"===r){const[e,t,r]=n.split(/\s+/,3);s.seq_id=e,s.start=t&&t.replace(/\D/g,""),s.end=r&&r.replace(/\D/g,"")}else if("genome-build"===r){const[e,t]=n.split(/\s+/,2);s.source=e,s.buildname=t}return s}function v(e){const t=[];return Object.keys(e).forEach((r=>{const n=e[r];let s;s=n.hasOwnProperty("toString")?h(n.toString()):Array.isArray(n.values)?n.values.map(h).join(","):Array.isArray(n)?n.map(h).join(","):h(n),t.push(`${h(r)} ${s}`)})),t.length?t.join("; ").concat(";"):"."}const C=["-",".","+"];function g(e,t){const r=null===e.attributes||void 0===e.attributes?".":v(e.attributes),n=[];for(let t=0;t<8;t+=1){const r=e[l[t]];n[t]=6===t?null==r?".":C[r+1]||r:null==r?".":p(String(r))}n[8]=r;const s=`${n.join("\t")}\n`;return t[s]?"":(t[s]=!0,s)}function y(e,t){if(Array.isArray(e))return e.map((e=>y(e,t))).join("");const r=[g(e,t)];return["child_features","derived_features"].forEach((n=>{e[n]&&r.push(...e[n].map((e=>y(e,t))))})),r.join("")}function k(e){return y(e,{})}function S(e){let t=`##${e.directive}`;return e.value&&(t+=` ${e.value}`),t+="\n",t}function T(e){return`# ${e.comment}\n`}function $(e){return`>${e.id}${e.description?` ${e.description}`:""}\n${e.sequence}\n`}function O(e){function t(e){return e[0]||e.attributes?k(e):e.directive?S(e):e.sequence?$(e):e.comment?T(e):"# (invalid item found during format)\n"}return Array.isArray(e)?e.map((e=>t(e))):t(e)}const w={Parent:"child_features",Derives_from:"derived_features"};class I{constructor(e){const t=()=>{};Object.assign(this,{featureCallback:e.featureCallback||t,endCallback:e.endCallback||t,commentCallback:e.commentCallback||t,errorCallback:e.errorCallback||t,directiveCallback:e.directiveCallback||t,sequenceCallback:e.sequenceCallback||t,bufferSize:void 0===e.bufferSize?1e3:e.bufferSize,_underConstructionTopLevel:[],_underConstructionById:{},_completedReferences:{},_underConstructionOrphans:{},eof:!1,lineNumber:0})}addLine(e){if(this.eof)return;if(this.lineNumber+=1,/^\s*[^#\s>]/.test(e))return void this._bufferLine(e);const t=/^\s*(#+)(.*)/.exec(e);if(t){let[,r,n]=t;if(3===r.length)this._emitAllUnderConstructionFeatures();else if(2===r.length){const t=_(e);this._emitItem(t)}else n=n.replace(/\s*/,""),this._emitItem({comment:n})}else if(!/^\s*$/.test(e)){const t=e.replace(/\r?\n?$/g,"");throw new Error(`GTF parse error.  Cannot parse '${t}'.`)}}_emitItem(e){e[0]?this.featureCallback(e):e.directive?this.directiveCallback(e):e.comment&&this.commentCallback(e)}finish(){this._emitAllUnderConstructionFeatures(),this.endCallback()}_enforceBufferSizeLimit(e=0){const t=e=>{e&&e[0]&&e[0].attributes&&e[0].attributes.ID&&e[0].attributes.ID[0]&&(e[0].attributes.ID.forEach((e=>{delete this._underConstructionById[e],delete this._completedReferences[e]})),e.forEach((e=>{e.child_features&&e.child_features.forEach((e=>t(e))),e.derived_features&&e.derived_features.forEach((e=>t(e)))})))};for(;this._underConstructionTopLevel.length+e>this.bufferSize;){const e=this._underConstructionTopLevel.shift();this._emitItem(e),t(e)}}_emitAllUnderConstructionFeatures(){if(this._underConstructionTopLevel.forEach(this._emitItem.bind(this)),this._underConstructionTopLevel=[],this._underConstructionById={},this._completedReferences={},Object.values(this._underConstructionOrphans).filter((e=>Object.keys(e).length)).length)throw new Error(`some features reference other features that do not exist in the file (or in the same '###' scope). ${JSON.stringify(this._underConstructionOrphans)}`)}_bufferLine(e){const t=b(e);t.child_features=[],t.derived_features=[];const r=this.lineNumber,n="transcript"===t.featureType,s=n?t.attributes.transcript_id||[]:[r],a=n?[]:t.attributes.transcript_id||[],i=t.attributes.Derives_from||[];if(!s.length&&!a.length&&!i.length)return void this._emitItem([t]);let o;a.forEach((e=>{this._underConstructionById[e]||this._bufferLine(function(e){const t=JSON.parse(JSON.stringify(e));return t.featureType="transcript",k(t)}(t))})),s.forEach((e=>{const r=this._underConstructionById[e];r?(r.push(t),o=r):(o=[t],this._enforceBufferSizeLimit(1),a.length||i.length||this._underConstructionTopLevel.push(o),this._underConstructionById[e]=o,this._resolveReferencesTo(o,e))})),this._resolveReferencesFrom(o||[t],{Parent:a,Derives_from:i},s)}_resolveReferencesTo(e,t){const r=this._underConstructionOrphans[t];r&&Object.keys(r).forEach((t=>{const n=w[t]||t.toLowerCase();e.forEach((e=>{e[n].push(...r[t]),delete r[t]}))}))}_parseError(e){this.eof=!0,this.errorCallback(`${this.lineNumber}: ${e}`)}_resolveReferencesFrom(e,t,r){Object.entries(t).forEach((([t,n])=>{let s;n.forEach((n=>{const a=this._underConstructionById[n];var i,o;a?(o=e,(i=a)[0].start=Math.min(i[0].start,o[0].start),i[0].end=Math.max(i[0].end,o[0].end),s||(s=w[t]||t.toLowerCase()),r.filter((e=>function(e,t,r){let n=e[t];n||(n={},e[t]=n);const s=n[r]||!1;return n[r]=!0,s}(this._completedReferences,e,`${t},${n}`))).length||a.forEach((t=>{t[s].push(e)}))):(this._underConstructionOrphans[n]||(this._underConstructionOrphans[n]={}),this._underConstructionOrphans[n][t]||(this._underConstructionOrphans[n][t]=[]),this._underConstructionOrphans[n][t].push(e))}))}))}}var D=r(506);r(90961);function F(e,t={}){const r=Object.assign({parseFeatures:!0,parseDirectives:!1,parseSequences:!0,parseComments:!1},t,e);return e.parseAll&&(r.parseFeatures=!0,r.parseDirectives=!0,r.parseComments=!0,r.parseSequences=!0),r}D.Transform;D.Transform;const E=function(e,t={}){if(!e)return[];const r=F(t),n=[],s=n.push.bind(n),a=new I({featureCallback:r.parseFeatures?s:null,directiveCallback:r.parseDirectives?s:null,commentCallback:r.parseComments?s:null,sequenceCallback:r.parseSequences?s:null,bufferSize:1/0,errorCallback:e=>{throw e}});return e.split(/\r?\n/).forEach(a.addLine.bind(a)),a.finish(),n};function A(e){const t={...e};t.start-=1,t.strand={"+":1,"-":-1,".":0,"?":void 0}[e.strand],t.phase=Number(e.frame),t.refName=e.seq_name,null===e.score&&(t.score=void 0),null===e.frame&&(t.score=void 0);const r=new Set(["start","end","seq_name","score","featureType","source","frame","strand"]);for(const n of Object.keys(e.attributes)){let s=n.toLowerCase();if(r.has(s)&&(s+="2"),e.attributes[n]){let r=e.attributes[n];Array.isArray(r)&&1===r.length&&(r=r[0].replaceAll(/^"|"$/g,"")),t[s]=r}}return t.refName=t.seq_name,t.type=t.featureType,e.child_features&&e.child_features.length>0&&(t.subfeatures=e.child_features.flatMap((e=>e.map((e=>A(e)))))),t.child_features=void 0,t.data=void 0,t.derived_features=void 0,t._linehash=void 0,t.attributes=void 0,t.seq_name=void 0,t.featureType=void 0,t.frame=void 0,t.transcript_id&&(t.name=t.transcript_id),t}const L="undefined"!=typeof TextDecoder?new TextDecoder("utf8"):void 0;class j extends s.BaseFeatureDataAdapter{calculatedIntervalTreeMap={};async loadDataP(e){const{statusCallback:t=()=>{}}=e||{},r=await(0,a.openLocation)(this.getConf("gtfLocation"),this.pluginManager).readFile(e),n=(0,c.isGzip)(r)?await(0,c.updateStatus)("Unzipping",t,(()=>(0,u.unzip)(r))):r,s=[],i={};let l=0,f=0;for(;l<n.length;){const e=n.indexOf("\n",l),r=-1===e?n.subarray(l):n.subarray(l,e),a=(L?.decode(r)||r.toString()).trim();if(a)if(a.startsWith("#"))s.push(a);else{if(a.startsWith(">"))break;{const e=a.indexOf("\t"),t=a.slice(0,e);i[t]||(i[t]=""),i[t]+=`${a}\n`}}f++%1e4==0&&t(`Loading ${Math.floor(l/1e6).toLocaleString("en-US")}/${Math.floor(n.length/1e6).toLocaleString("en-US")} MB`),l=e+1}const d=Object.fromEntries(Object.entries(i).map((([e,t])=>[e,r=>{if(!this.calculatedIntervalTreeMap[e]){r?.("Parsing GTF data");const n=new o.Ay;E(t,{parseFeatures:!0,parseComments:!1,parseDirectives:!1,parseSequences:!1}).flat().map(((t,r)=>new c.SimpleFeature({data:A(t),id:`${this.id}-${e}-${r}`}))).forEach((e=>n.insert([e.get("start"),e.get("end")],e))),this.calculatedIntervalTreeMap[e]=n}return this.calculatedIntervalTreeMap[e]}])));return{header:s.join("\n"),intervalTreeMap:d}}async loadData(e={}){return this.gtfFeatures||(this.gtfFeatures=this.loadDataP(e).catch((e=>{throw this.gtfFeatures=void 0,e}))),this.gtfFeatures}async getRefNames(e={}){const{intervalTreeMap:t}=await this.loadData(e);return Object.keys(t)}async getHeader(e={}){const{header:t}=await this.loadData(e);return t}getFeatures(e,t={}){return(0,i.ObservableCreate)((async r=>{try{const{start:n,end:s,refName:a}=e,{intervalTreeMap:i}=await this.loadData(t);i[a]?.(t.statusCallback).search([n,s]).forEach((e=>{r.next(e)})),r.complete()}catch(e){r.error(e)}}),t.signal)}freeResources(){}}},85392:()=>{},43951:()=>{}}]);
//# sourceMappingURL=3351.7d7fe3ef.chunk.js.map