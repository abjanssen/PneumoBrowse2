{"version":3,"file":"static/js/9533.3d4ec955.chunk.js","mappings":"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","sources":["../../../plugins/alignments/src/SNPCoverageRenderer/types.ts","../../../plugins/alignments/src/SNPCoverageRenderer/components/SNPCoverageRendering.tsx"],"sourcesContent":["import { reducePrecision } from '@jbrowse/core/util'\n\nimport type {\n  BaseCoverageBin,\n  ColorBy,\n  ModificationTypeWithColor,\n} from '../shared/types.ts'\nimport type { RenderArgsDeserialized as FeatureRenderArgsDeserialized } from '@jbrowse/core/pluggableElementTypes/renderers/FeatureRendererType'\nimport type { Feature } from '@jbrowse/core/util'\nimport type { ScaleOpts } from '@jbrowse/plugin-wiggle'\n\nexport interface InterbaseIndicatorItem {\n  type: 'insertion' | 'softclip' | 'hardclip'\n  base: string\n  count: number\n  total: number\n  avgLength?: number\n  minLength?: number\n  maxLength?: number\n  topSequence?: string\n  start: number\n}\n\nexport interface SNPItem {\n  type: 'snp'\n  base: string\n  count: number\n  total: number\n  refbase?: string\n  avgQual?: number\n  fwdCount: number\n  revCount: number\n  bin?: BaseCoverageBin\n  start: number\n  end: number\n}\n\nexport interface ModificationItem {\n  type: 'modification'\n  modType: string\n  base: string\n  count: number\n  total: number\n  avgProb?: number\n  fwdCount: number\n  revCount: number\n  isUnmodified: boolean\n  start: number\n}\n\nexport type ClickMapItem = InterbaseIndicatorItem | SNPItem | ModificationItem\n\nconst typeLabels: Record<string, string> = {\n  insertion: 'Insertion',\n  softclip: 'Soft clip',\n  hardclip: 'Hard clip',\n  snp: 'SNP',\n  modification: 'Modification',\n}\n\nexport function getInterbaseTypeLabel(type: string) {\n  return typeLabels[type] ?? type\n}\n\nfunction formatStrandCounts(entry: { '1'?: number; '-1'?: number }) {\n  const neg = entry['-1'] ? `${entry['-1']}(-)` : ''\n  const pos = entry['1'] ? `${entry['1']}(+)` : ''\n  return neg + pos || '-'\n}\n\nfunction pct(n: number, total = 1) {\n  return `${((n / (total || 1)) * 100).toFixed(1)}%`\n}\n\ninterface TableRow {\n  base: string\n  count: number\n  percent: string\n  strands: string\n  prob?: string\n}\n\nexport function formatBinAsTableRows(bin: BaseCoverageBin) {\n  const { readsCounted, ref, refbase, snps, mods } = bin\n  const rows: TableRow[] = [\n    {\n      base: 'Total',\n      count: readsCounted,\n      percent: '-',\n      strands: '-',\n    },\n    {\n      base: refbase ? `REF (${refbase.toUpperCase()})` : 'REF',\n      count: ref.entryDepth,\n      percent: pct(ref.entryDepth, readsCounted),\n      strands: formatStrandCounts(ref),\n    },\n  ]\n\n  for (const [snpBase, entry] of Object.entries(snps)) {\n    rows.push({\n      base: snpBase.toUpperCase(),\n      count: entry.entryDepth,\n      percent: pct(entry.entryDepth, readsCounted),\n      strands: formatStrandCounts(entry),\n      prob:\n        entry.avgProbability !== undefined\n          ? `qual:${reducePrecision(entry.avgProbability)}`\n          : undefined,\n    })\n  }\n\n  for (const [modKey, entry] of Object.entries(mods)) {\n    rows.push({\n      base: modKey,\n      count: entry.entryDepth,\n      percent: pct(entry.entryDepth, readsCounted),\n      strands: formatStrandCounts(entry),\n      prob:\n        entry.avgProbability !== undefined\n          ? `${(entry.avgProbability * 100).toFixed(1)}%`\n          : undefined,\n    })\n  }\n\n  return rows\n}\n\nexport function clickMapItemToFeatureData(\n  item: ClickMapItem,\n  refName?: string,\n): Record<string, unknown> {\n  if (item.type === 'snp') {\n    return {\n      uniqueId: `snp-${item.base}-${item.start}`,\n      type: 'snp',\n      refName,\n      start: item.start,\n      end: item.end,\n      details: item.bin ? formatBinAsTableRows(item.bin) : undefined,\n    }\n  }\n  if (item.type === 'modification') {\n    const pctVal =\n      item.total > 0 ? ((item.count / item.total) * 100).toFixed(1) : '0'\n    const label = item.isUnmodified\n      ? `Unmodified ${item.base}`\n      : `${item.modType} (${item.base})`\n    return {\n      uniqueId: `mod-${item.modType}-${item.base}`,\n      type: 'modification',\n      refName,\n      start: item.start,\n      end: item.start + 1,\n      label,\n      count: `${item.count}/${item.total} (${pctVal}%)`,\n      strands: `${item.fwdCount}(+) ${item.revCount}(-)`,\n      probability:\n        item.avgProb !== undefined\n          ? `${(item.avgProb * 100).toFixed(1)}%`\n          : undefined,\n    }\n  }\n  // interbase indicators (insertion, softclip, hardclip)\n  const pctVal =\n    item.total > 0 ? ((item.count / item.total) * 100).toFixed(1) : '0'\n  return {\n    uniqueId: `${item.type}-${item.base}`,\n    type: item.type,\n    refName,\n    start: item.start,\n    end: item.start + 1,\n    count: `${item.count}/${item.total} (${pctVal}%)`,\n    size:\n      item.minLength === item.maxLength\n        ? `${item.minLength}bp`\n        : `${item.minLength}-${item.maxLength}bp (avg ${item.avgLength?.toFixed(1)}bp)`,\n    sequence: item.topSequence,\n  }\n}\n\nexport interface RenderArgsDeserialized extends FeatureRenderArgsDeserialized {\n  bpPerPx: number\n  height: number\n  highResolutionScaling: number\n  scaleOpts: ScaleOpts\n  ticks: { values: number[] }\n  displayCrossHatches: boolean\n  visibleModifications?: Record<string, ModificationTypeWithColor>\n  simplexModifications?: string[]\n  colorBy: ColorBy\n  statusCallback?: (arg: string) => void\n  offset?: number\n}\n\nexport interface RenderArgsDeserializedWithFeatures extends RenderArgsDeserialized {\n  features: Map<string, Feature>\n}\n","import { useMemo, useRef, useState } from 'react'\n\nimport { PrerenderedCanvas } from '@jbrowse/core/ui'\nimport {\n  getContainingTrack,\n  getContainingView,\n  getSession,\n  isSessionModelWithWidgets,\n} from '@jbrowse/core/util'\nimport Flatbush from '@jbrowse/core/util/flatbush'\nimport { observer } from 'mobx-react'\n\nimport { clickMapItemToFeatureData } from '../types.ts'\n\nimport type { ClickMapItem } from '../types.ts'\nimport type { Feature } from '@jbrowse/core/util'\nimport type { Region } from '@jbrowse/core/util/types'\nimport type { BaseLinearDisplayModel } from '@jbrowse/plugin-linear-genome-view'\n\nfunction getItemDataJson(item: ClickMapItem | undefined, refName?: string) {\n  if (!item) {\n    return undefined\n  }\n  return JSON.stringify({ item, refName })\n}\n\nfunction getFeatureRefName(features: Map<string, Feature>) {\n  for (const feature of features.values()) {\n    const refName = feature.get('refName')\n    if (refName) {\n      return refName\n    }\n  }\n  return undefined\n}\n\nconst SNPCoverageRendering = observer(function SNPCoverageRendering(props: {\n  regions: Region[]\n  features: Map<string, Feature>\n  bpPerPx: number\n  width: number\n  height: number\n  blockKey: string\n  displayModel?: BaseLinearDisplayModel\n  clickMap?: {\n    flatbush: ArrayBuffer\n    items: ClickMapItem[]\n  }\n}) {\n  const { regions, features, bpPerPx, width, height, clickMap, displayModel } =\n    props\n  const region = regions[0]!\n  const ref = useRef<HTMLDivElement>(null)\n  const [isOverIndicator, setIsOverIndicator] = useState(false)\n\n  const flatbush = useMemo(\n    () => (clickMap?.flatbush ? Flatbush.from(clickMap.flatbush) : undefined),\n    [clickMap?.flatbush],\n  )\n  const items = clickMap?.items\n\n  function getFeatureUnderMouse(eventClientX: number) {\n    let offset = 0\n    if (ref.current) {\n      offset = ref.current.getBoundingClientRect().left\n    }\n    const offsetX = eventClientX - offset\n    const px = region.reversed ? width - offsetX : offsetX\n    const clientBp = region.start + bpPerPx * px\n    let featureUnderMouse: Feature | undefined\n    for (const feature of features.values()) {\n      if (\n        clientBp <= feature.get('end') + bpPerPx &&\n        clientBp >= feature.get('start')\n      ) {\n        featureUnderMouse = feature\n        break\n      }\n    }\n    return featureUnderMouse\n  }\n\n  function getInterbaseItemUnderMouse(clientX: number, clientY: number) {\n    if (!flatbush || !items || !ref.current) {\n      return undefined\n    }\n    const rect = ref.current.getBoundingClientRect()\n    const offsetX = clientX - rect.left\n    const offsetY = clientY - rect.top\n    // Use a small search box around the cursor for better hit detection\n    const search = flatbush.search(\n      offsetX,\n      offsetY,\n      offsetX + 1.5,\n      offsetY + 1.5,\n    )\n    if (search.length === 0) {\n      return undefined\n    }\n    if (search.length === 1) {\n      return items[search[0]!]\n    }\n    // When multiple items overlap, prioritize those with higher read percentage\n    const sorted = search\n      .map(idx => items[idx]!)\n      .sort((a, b) => b.count / b.total - a.count / a.total)\n    return sorted[0]\n  }\n\n  return (\n    <div\n      ref={ref}\n      data-testid=\"snpcoverage-rendering-test\"\n      onMouseMove={e => {\n        const item = getInterbaseItemUnderMouse(e.clientX, e.clientY)\n        const itemData = getItemDataJson(\n          item,\n          getFeatureRefName(features) ?? region.refName,\n        )\n        setIsOverIndicator(!!item)\n        if (itemData) {\n          displayModel?.setFeatureIdUnderMouse(undefined)\n          displayModel?.setMouseoverExtraInformation(itemData)\n        } else {\n          displayModel?.setFeatureIdUnderMouse(\n            getFeatureUnderMouse(e.clientX)?.id(),\n          )\n          displayModel?.setMouseoverExtraInformation(undefined)\n        }\n      }}\n      onClick={e => {\n        const item = getInterbaseItemUnderMouse(e.clientX, e.clientY)\n        if (item && displayModel) {\n          const session = getSession(displayModel)\n          const view = getContainingView(displayModel)\n          const featureData = clickMapItemToFeatureData(\n            item,\n            getFeatureRefName(features) ?? region.refName,\n          )\n          if (isSessionModelWithWidgets(session)) {\n            const featureWidget = session.addWidget(\n              'BaseFeatureWidget',\n              'baseFeature',\n              {\n                featureData,\n                view,\n                track: getContainingTrack(displayModel),\n              },\n            )\n            session.showWidget(featureWidget)\n          }\n        } else {\n          const featureId = getFeatureUnderMouse(e.clientX)?.id()\n          if (featureId) {\n            displayModel?.selectFeatureById(featureId).catch((e: unknown) => {\n              console.error(e)\n              getSession(displayModel).notifyError(`${e}`, e)\n            })\n          }\n        }\n      }}\n      onMouseLeave={() => {\n        setIsOverIndicator(false)\n        displayModel?.setFeatureIdUnderMouse(undefined)\n        displayModel?.setMouseoverExtraInformation(undefined)\n      }}\n      style={{\n        overflow: 'visible',\n        position: 'relative',\n        height,\n        cursor: isOverIndicator ? 'pointer' : undefined,\n      }}\n    >\n      <PrerenderedCanvas {...props} />\n    </div>\n  )\n})\n\nexport default SNPCoverageRendering\n"],"names":["typeLabels","insertion","softclip","hardclip","snp","modification","getInterbaseTypeLabel","type","formatStrandCounts","entry","pct","n","total","toFixed","formatBinAsTableRows","bin","readsCounted","ref","refbase","snps","mods","rows","base","count","percent","strands","toUpperCase","entryDepth","snpBase","Object","entries","push","prob","undefined","avgProbability","reducePrecision","modKey","clickMapItemToFeatureData","item","refName","uniqueId","start","end","details","pctVal","label","isUnmodified","modType","fwdCount","revCount","probability","avgProb","size","minLength","maxLength","avgLength","sequence","topSequence","getFeatureRefName","features","feature","values","get","observer","props","regions","bpPerPx","width","height","clickMap","displayModel","region","useRef","isOverIndicator","setIsOverIndicator","useState","flatbush","useMemo","Flatbush","from","items","getFeatureUnderMouse","eventClientX","offset","current","getBoundingClientRect","left","offsetX","px","reversed","clientBp","featureUnderMouse","getInterbaseItemUnderMouse","clientX","clientY","rect","offsetY","top","search","length","map","idx","sort","a","b","_jsx","onMouseMove","e","itemData","JSON","stringify","getItemDataJson","setFeatureIdUnderMouse","setMouseoverExtraInformation","id","onClick","session","getSession","view","getContainingView","featureData","isSessionModelWithWidgets","featureWidget","addWidget","track","getContainingTrack","showWidget","featureId","selectFeatureById","catch","console","error","notifyError","onMouseLeave","style","overflow","position","cursor","children","PrerenderedCanvas"],"ignoreList":[],"sourceRoot":""}