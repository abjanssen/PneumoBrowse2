{"version":3,"file":"static/js/7761.98bfb8ec.chunk.js","mappings":"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","sources":["../../../plugins/variants/src/shared/drawPhased.ts","../../../plugins/variants/src/MultiLinearVariantMatrixRenderer/makeImageData.ts","../../../plugins/variants/src/shared/drawAlleleCount.ts"],"sourcesContent":["import { set1 } from '@jbrowse/core/ui/colors'\nimport { colord } from '@jbrowse/core/util/colord'\n\nimport { REFERENCE_COLOR, UNPHASED_COLOR, f2 } from './constants.ts'\n\nfunction colorify(n: number) {\n  return `hsl(${n % 255}, 50%, 50%)`\n}\n\nexport function drawPhased(\n  alleles: string[],\n  ctx: CanvasRenderingContext2D,\n  x: number,\n  y: number,\n  w: number,\n  h: number,\n  HP: number,\n  PS?: string,\n  drawReference = true,\n  alpha = 1,\n  featureType = '',\n  featureStrand?: number,\n) {\n  const allele = +alleles[HP]!\n  const c = allele\n    ? PS !== undefined\n      ? colorify(+PS) || UNPHASED_COLOR\n      : set1[allele - 1] || UNPHASED_COLOR\n    : drawReference\n      ? REFERENCE_COLOR\n      : undefined\n  if (c) {\n    ctx.fillStyle = alpha !== 1 ? colord(c).alpha(alpha).toHex() : c\n    if (featureType === 'inversion') {\n      if (featureStrand === 1) {\n        ctx.beginPath()\n        ctx.moveTo(x - f2, y - f2)\n        ctx.lineTo(x - f2, y + h + f2)\n        ctx.lineTo(x + w + f2, y + h / 2)\n        ctx.closePath()\n        ctx.fill()\n      } else {\n        ctx.beginPath()\n        ctx.moveTo(x + w + f2, y - f2)\n        ctx.lineTo(x + w + f2, y + h + f2)\n        ctx.lineTo(x - f2, y + h / 2)\n        ctx.closePath()\n        ctx.fill()\n      }\n    } else if (featureType === 'insertion') {\n      const widthExtension = 3\n      ctx.beginPath()\n      ctx.moveTo(x - f2 - widthExtension, y - f2)\n      ctx.lineTo(x + w + f2 + widthExtension, y - f2)\n      ctx.lineTo(x + w / 2, y + h + f2)\n      ctx.closePath()\n      ctx.fill()\n    } else {\n      ctx.fillRect(x - f2, y - f2, w + f2, h + f2)\n    }\n  }\n  return c\n}\n","import { updateStatus } from '@jbrowse/core/util'\nimport { checkStopToken2 } from '@jbrowse/core/util/stopToken'\n\nimport { f2 } from '../shared/constants.ts'\nimport {\n  drawColorAlleleCount,\n  getAlleleColor,\n} from '../shared/drawAlleleCount.ts'\nimport { drawPhased } from '../shared/drawPhased.ts'\nimport { getFeaturesThatPassMinorAlleleFrequencyFilter } from '../shared/minorAlleleFrequencyUtils.ts'\n\nimport type { RenderArgsDeserialized } from './types.ts'\nimport type { Source } from '../shared/types.ts'\nimport type { Feature, LastStopTokenCheck } from '@jbrowse/core/util'\n\ntype SampleGenotype = Record<string, string[]>\n\ninterface Maf {\n  feature: Feature\n  mostFrequentAlt: string\n}\n\ninterface DrawContext {\n  ctx: CanvasRenderingContext2D\n  sources: Source[]\n  startRow: number\n  endRow: number\n  h: number\n  w: number\n  scrollTop: number\n  splitCache: Record<string, string[]>\n  colorCache: Record<string, string | undefined>\n  genotypesCache: Map<string, Record<string, string>>\n  stopTokenCheck?: LastStopTokenCheck\n}\n\nfunction drawPhasedMode(drawCtx: DrawContext, mafs: Maf[]) {\n  const {\n    ctx,\n    sources,\n    startRow,\n    endRow,\n    h,\n    w,\n    scrollTop,\n    splitCache,\n    genotypesCache,\n    stopTokenCheck,\n  } = drawCtx\n\n  const arr = [] as string[][]\n  for (let idx = 0, l = mafs.length; idx < l; idx++) {\n    const { feature } = mafs[idx]!\n    const arr2 = [] as string[]\n    const hasPhaseSet = (feature.get('FORMAT') as string | undefined)?.includes(\n      'PS',\n    )\n    const x = idx * w\n\n    if (hasPhaseSet) {\n      const samp = feature.get('samples') as Record<string, SampleGenotype>\n      for (let j = startRow; j < endRow; j++) {\n        const y = j * h - scrollTop\n        const source = sources[j]!\n        const { name, HP, baseName } = source\n        const sampleName = baseName ?? name\n        const s = samp[sampleName]\n        if (s) {\n          const genotype = s.GT?.[0]\n          if (genotype) {\n            arr2.push(genotype)\n            const isPhased = genotype.includes('|')\n            if (isPhased) {\n              const PS = s.PS?.[0]\n              const alleles =\n                splitCache[genotype] ??\n                (splitCache[genotype] = genotype.split('|'))\n              drawPhased(alleles, ctx, x, y, w, h, HP!, PS)\n            } else {\n              ctx.fillStyle = 'black'\n              ctx.fillRect(x - f2, y - f2, w + f2, h + f2)\n            }\n          }\n        }\n      }\n    } else {\n      const featureId = feature.id()\n      let samp = genotypesCache.get(featureId)\n      if (!samp) {\n        samp = feature.get('genotypes') as Record<string, string>\n        genotypesCache.set(featureId, samp)\n      }\n      for (let j = startRow; j < endRow; j++) {\n        const y = j * h - scrollTop\n        const source = sources[j]!\n        const { name, HP, baseName } = source\n        const sampleName = baseName ?? name\n        const genotype = samp[sampleName]\n        if (genotype) {\n          arr2.push(genotype)\n          const isPhased = genotype.includes('|')\n          if (isPhased) {\n            const alleles =\n              splitCache[genotype] ??\n              (splitCache[genotype] = genotype.split('|'))\n            drawPhased(alleles, ctx, x, y, w, h, HP!)\n          } else {\n            ctx.fillStyle = 'black'\n            ctx.fillRect(x - f2, y - f2, w + f2, h + f2)\n          }\n        }\n      }\n    }\n    arr.push(arr2)\n    checkStopToken2(stopTokenCheck)\n  }\n\n  return arr\n}\n\nfunction drawAlleleCountMode(drawCtx: DrawContext, mafs: Maf[]) {\n  const {\n    ctx,\n    sources,\n    startRow,\n    endRow,\n    h,\n    w,\n    scrollTop,\n    splitCache,\n    stopTokenCheck,\n    colorCache,\n    genotypesCache,\n  } = drawCtx\n\n  const arr = [] as string[][]\n\n  for (let idx = 0, l = mafs.length; idx < l; idx++) {\n    const { feature, mostFrequentAlt } = mafs[idx]!\n    const arr2 = [] as string[]\n    const hasPhaseSet = (feature.get('FORMAT') as string | undefined)?.includes(\n      'PS',\n    )\n    const x = idx * w\n\n    if (hasPhaseSet) {\n      const samp = feature.get('samples') as Record<string, SampleGenotype>\n      for (let j = startRow; j < endRow; j++) {\n        const y = j * h - scrollTop\n        const source = sources[j]!\n        const sampleName = source.baseName ?? source.name\n        const s = samp[sampleName]\n        if (s) {\n          const genotype = s.GT?.[0]\n          if (genotype) {\n            arr2.push(genotype)\n            const c = getAlleleColor(\n              genotype,\n              mostFrequentAlt,\n              colorCache,\n              splitCache,\n              true,\n            )\n            if (c) {\n              drawColorAlleleCount(c, ctx, x, y, w, h)\n            }\n          }\n        }\n      }\n    } else {\n      const featureId = feature.id()\n      let samp = genotypesCache.get(featureId)\n      if (!samp) {\n        samp = feature.get('genotypes') as Record<string, string>\n        genotypesCache.set(featureId, samp)\n      }\n      for (let j = startRow; j < endRow; j++) {\n        const y = j * h - scrollTop\n        const source = sources[j]!\n        const sampleName = source.baseName ?? source.name\n        const genotype = samp[sampleName]\n        if (genotype) {\n          arr2.push(genotype)\n          const c = getAlleleColor(\n            genotype,\n            mostFrequentAlt,\n            colorCache,\n            splitCache,\n            true,\n          )\n          if (c) {\n            drawColorAlleleCount(c, ctx, x, y, w, h)\n          }\n        }\n      }\n    }\n    arr.push(arr2)\n    checkStopToken2(stopTokenCheck)\n  }\n\n  return arr\n}\n\nexport async function makeImageData({\n  ctx,\n  canvasWidth,\n  canvasHeight,\n  renderArgs,\n}: {\n  ctx: CanvasRenderingContext2D\n  canvasWidth: number\n  canvasHeight: number\n  renderArgs: RenderArgsDeserialized\n}) {\n  const {\n    renderingMode,\n    minorAlleleFrequencyFilter,\n    sources,\n    features,\n    stopTokenCheck,\n    lengthCutoffFilter,\n    rowHeight,\n    scrollTop,\n    statusCallback = () => {},\n  } = renderArgs\n  const h = rowHeight\n  const startRow = Math.floor(scrollTop / h)\n  const endRow = Math.min(\n    sources.length,\n    Math.ceil((scrollTop + canvasHeight) / h),\n  )\n  const genotypesCache = new Map<string, Record<string, string>>()\n  const colorCache = {} as Record<string, string | undefined>\n  const splitCache = {} as Record<string, string[]>\n\n  const mafs = await updateStatus('Calculating stats', statusCallback, () =>\n    getFeaturesThatPassMinorAlleleFrequencyFilter({\n      stopTokenCheck,\n      features: features.values(),\n      minorAlleleFrequencyFilter,\n      lengthCutoffFilter,\n      genotypesCache,\n      splitCache,\n    }),\n  )\n\n  const m = mafs.length\n  const w = canvasWidth / m\n\n  const drawCtx: DrawContext = {\n    ctx,\n    sources,\n    startRow,\n    endRow,\n    h,\n    w,\n    scrollTop,\n    splitCache,\n    colorCache,\n    genotypesCache,\n    stopTokenCheck,\n  }\n\n  const arr = await updateStatus(\n    'Drawing variant matrix',\n    statusCallback,\n    () =>\n      renderingMode === 'phased'\n        ? drawPhasedMode(drawCtx, mafs)\n        : drawAlleleCountMode(drawCtx, mafs),\n  )\n\n  const featureData = mafs.map(({ feature }) => ({\n    alt: feature.get('ALT') as string[],\n    ref: feature.get('REF') as string,\n    name: feature.get('name') as string,\n    description: feature.get('description') as string,\n    length: feature.get('end') - feature.get('start'),\n  }))\n\n  return {\n    mafs,\n    arr,\n    featureData,\n  }\n}\n","import { colord } from '@jbrowse/core/util/colord'\n\nimport {\n  ALT_COLOR_HUE,\n  ALT_COLOR_SATURATION,\n  NO_CALL_COLOR,\n  REFERENCE_COLOR,\n  f2,\n} from './constants.ts'\n\nexport function getAlleleColor(\n  genotype: string,\n  mostFrequentAlt: string,\n  colorCache: Record<string, string | undefined>,\n  splitCache: Record<string, string[]>,\n  drawRef: boolean,\n) {\n  const cacheKey = `${genotype}:${mostFrequentAlt}`\n  let c = colorCache[cacheKey]\n  if (c === undefined) {\n    let alt = 0\n    let uncalled = 0\n    let alt2 = 0\n    let ref = 0\n    const alleles =\n      splitCache[genotype] ?? (splitCache[genotype] = genotype.split(/[/|]/))\n    const total = alleles.length\n\n    for (let i = 0; i < total; i++) {\n      const allele = alleles[i]!\n      if (allele === mostFrequentAlt) {\n        alt++\n      } else if (allele === '0') {\n        ref++\n      } else if (allele === '.') {\n        uncalled++\n      } else {\n        alt2++\n      }\n    }\n    c = getColorAlleleCount(ref, alt, alt2, uncalled, total, drawRef)\n    colorCache[cacheKey] = c\n  }\n  return c\n}\n\nexport function getColorAlleleCount(\n  ref: number,\n  alt: number,\n  alt2: number,\n  uncalled: number,\n  total: number,\n  drawReference = true,\n) {\n  if (ref === total) {\n    return drawReference ? REFERENCE_COLOR : ''\n  }\n\n  if (!(alt || alt2 || uncalled)) {\n    return ''\n  }\n\n  let a1\n  if (alt) {\n    const lightness = 80 - (alt / total) * 50\n    a1 = colord(`hsl(${ALT_COLOR_HUE},${ALT_COLOR_SATURATION}%,${lightness}%)`)\n  }\n  if (alt2) {\n    const alpha = alt2 / total\n    const l = `hsla(0,100%,20%,${alpha})`\n    a1 = a1 ? a1.mix(l) : colord(l)\n  }\n  if (uncalled) {\n    const alpha = uncalled / total\n    const l = NO_CALL_COLOR.replace(')', `,${alpha})`).replace('hsl', 'hsla')\n    a1 = a1 ? a1.mix(l) : colord(l)\n  }\n  return a1?.toHex() || 'black'\n}\n\nexport function drawColorAlleleCount(\n  c: string,\n  ctx: CanvasRenderingContext2D,\n  x: number,\n  y: number,\n  w: number,\n  h: number,\n  featureType = '',\n  featureStrand?: number,\n  alpha = 1,\n) {\n  ctx.fillStyle = alpha !== 1 ? colord(c).alpha(alpha).toHex() : c\n  if (featureType === 'inversion') {\n    if (featureStrand === 1) {\n      ctx.beginPath()\n      ctx.moveTo(x - f2, y - f2)\n      ctx.lineTo(x - f2, y + h + f2)\n      ctx.lineTo(x + w + f2, y + h / 2)\n      ctx.closePath()\n      ctx.fill()\n    } else {\n      ctx.beginPath()\n      ctx.moveTo(x + w + f2, y - f2)\n      ctx.lineTo(x + w + f2, y + h + f2)\n      ctx.lineTo(x - f2, y + h / 2)\n      ctx.closePath()\n      ctx.fill()\n    }\n  } else if (featureType === 'insertion') {\n    const widthExtension = 3\n    ctx.beginPath()\n    ctx.moveTo(x - f2 - widthExtension, y - f2)\n    ctx.lineTo(x + w + f2 + widthExtension, y - f2)\n    ctx.lineTo(x + w / 2, y + h + f2)\n    ctx.closePath()\n    ctx.fill()\n  } else {\n    ctx.fillRect(x - f2, y - f2, w + f2, h + f2)\n  }\n}\n"],"names":["drawPhased","alleles","ctx","x","y","w","h","HP","PS","drawReference","alpha","featureType","featureStrand","allele","c","undefined","UNPHASED_COLOR","set1","REFERENCE_COLOR","fillStyle","colord","toHex","beginPath","moveTo","f2","lineTo","closePath","fill","widthExtension","fillRect","async","makeImageData","canvasWidth","canvasHeight","renderArgs","renderingMode","minorAlleleFrequencyFilter","sources","features","stopTokenCheck","lengthCutoffFilter","rowHeight","scrollTop","statusCallback","startRow","Math","floor","endRow","min","length","ceil","genotypesCache","Map","splitCache","mafs","updateStatus","getFeaturesThatPassMinorAlleleFrequencyFilter","values","drawCtx","colorCache","arr","idx","l","feature","arr2","hasPhaseSet","get","includes","samp","j","source","name","baseName","s","genotype","GT","push","split","featureId","id","set","checkStopToken2","drawPhasedMode","mostFrequentAlt","getAlleleColor","drawColorAlleleCount","drawAlleleCountMode","featureData","map","alt","ref","description","drawRef","cacheKey","uncalled","alt2","total","i","a1","lightness","ALT_COLOR_HUE","ALT_COLOR_SATURATION","mix","NO_CALL_COLOR","replace","getColorAlleleCount"],"ignoreList":[],"sourceRoot":""}