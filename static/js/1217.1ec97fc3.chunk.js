"use strict";(globalThis.webpackChunk_jbrowse_web=globalThis.webpackChunk_jbrowse_web||[]).push([[1217],{41217(t,e,n){n.d(e,{executeRenderLinearReadArcsDisplay:()=>B});var a=n(95548),r=n(23886),s=n(1259),o=n(40907),i=n(23638),c=n(89147),g=n(64152),d=n(31508),l=n(29458),f=n(10533),h=n(88068),u=n(90013),p=n(153),m=n(2381);function w(t){return 2*Math.random()*t-t}function x(t,e,n,a){t.strokeStyle=a,t.beginPath(),t.moveTo(e,0),t.lineTo(e,n),t.stroke()}function k(t){return{refName:t.get("refName"),start:t.get("start"),end:t.get("end"),strand:t.get("strand"),tlen:t.get("template_length"),pair_orientation:t.get("pair_orientation"),next_ref:t.get("next_ref")}}function b(t){return{refName:t.get("refName"),start:t.get("start"),end:t.get("end"),strand:t.get("strand")}}function S(t){return"get"in t?t.get("clipLengthAtStartOfRead"):t.clipLengthAtStartOfRead}function y(t){return"get"in t?k(t):t}function v(t){return"get"in t?b(t):t}var P=n(32272),A=n(89579);function R(t,e,n){const a=-1===t.strand;return e?a?t.start:t.end:n?a?t.end:t.start:a?t.start:t.end}function T(t){const{ctx:e,height:n,chainData:a,colorBy:r,drawInter:s,drawLongRange:o,lineWidth:i,jitter:c,view:g,offsetPx:d,stopTokenCheck:f}=t,{chains:h,stats:u}=a,T=r.type,_=(0,A.dv)(a);function B(t,a,r){const o=t.strand,l=a.strand,f=R(t,_,!1),h=R(a,_,!0),p=g.bpToPx({refName:t.refName,coord:f})?.offsetPx,m=g.bpToPx({refName:a.refName,coord:h})?.offsetPx;if(void 0!==p&&void 0!==m){const a=(m-p)/2,s=Math.abs(a),g=p-d,f=m-d,h=s>1e4;e.strokeStyle=function(t){const{longRange:e,drawArcInsteadOfBezier:n,hasPaired:a,colorByType:r,k1:s,s1:o,s2:i,absrad:c,stats:g}=t;return e&&n?"red":a?"insertSizeAndOrientation"===r?(0,P.sY)(s,g)[0]:"orientation"===r?(0,P.DW)(s)[0]:"insertSize"===r?(0,P.L9)(s,g)?.[0]||"grey":"gradient"===r?`hsl(${10*Math.log10(c)},50%,50%)`:"grey":"orientation"===r||"insertSizeAndOrientation"===r?-1===o&&1===i?"navy":1===o&&-1===i?"green":"grey":"gradient"===r?`hsl(${10*Math.log10(c)},50%,50%)`:"grey"}({longRange:r,drawArcInsteadOfBezier:h,hasPaired:_,colorByType:T,k1:t,s1:o,s2:l,absrad:s,stats:u});const k=Math.min(n+w(c),s);s<1?(e.fillStyle=e.strokeStyle,e.fillRect(g,0,f-g,Math.max(s,i))):r&&s>1e5?(x(e,g+w(c),n,"red"),x(e,f+w(c),n,"red")):r&&h?(e.moveTo(g,0),e.beginPath(),e.arc(g+a+w(c),0,s,0,Math.PI),e.stroke()):function(t,e,n,a,r){t.beginPath(),t.moveTo(e,0),t.bezierCurveTo(e+w(r),a,n,a,n+w(r),0),t.stroke()}(e,g,g+2*a,k,c)}else p&&s&&x(e,p-d,n,"purple")}function N(t){B(k(t),function(t){const e=(t.get("flags")||0)&m.KS?-1:1;return{refName:t.get("next_ref")||"",start:t.get("next_pos")||0,end:t.get("next_pos")||0,strand:e}}(t),!0)}function M(t){const e=[t,...(0,p.Cu)((0,p.bH)(t,"SA"),t.id(),t.get("strand"),t.get("name"))].toSorted((t,e)=>S(t)-S(e));for(let t=0,n=e.length;t<n-1;t++)B(y(e[t]),v(e[t+1]),!0)}function C(t){const e=_?function(t){const e=[];for(const n of t){const t=n.get("flags");t&m.fs||t&m.q3||e.push(n)}return e}(t):function(t){const e=[];for(const n of t)n.get("flags")&m.ap||e.push(n);return e.sort((t,e)=>t.get("clipLengthAtStartOfRead")-e.get("clipLengthAtStartOfRead")),e}(t);for(let t=0,n=e.length;t<n-1;t++)B(k(e[t]),b(e[t+1]),!1)}e.lineWidth=i;for(const t of h){if(1===t.length&&o){const e=t[0],n=e.get("flags")&m.q3;_&&!n?N(e):M(e)}else C(t);(0,l.As)(f)}}var _=n(19996);async function B({pluginManager:t,args:e}){const{sessionId:n,view:p,adapterConfig:m,sequenceAdapter:w,colorBy:x,drawInter:k,drawLongRange:b,lineWidth:S,jitter:y,height:v,highResolutionScaling:P,exportSVG:A,statusCallback:R=()=>{},stopToken:B}=e,N=(0,l.jL)(B),M=g.A.create(p);p.width&&M.setVolatileWidth(p.width);const{offsetPx:C}=M,L=M.staticBlocks.totalWidthPx,O=M.staticBlocks.contentBlocks,W={...(0,f.getSnapshot)(M),width:M.width,staticBlocks:M.staticBlocks,bpToPx(t){const e=(0,c.eB)({self:this,refName:t.refName,coord:t.coord});return void 0!==e?{offsetPx:e.offsetPx,index:e.index}:void 0}},I=(await(0,a.cK)(t,n,m)).dataAdapter;w&&!I.sequenceAdapterConfig&&I.setSequenceAdapterConfig(w);const j=await(0,r.updateStatus)("Fetching alignments",R,()=>(0,h._)(I.getFeaturesInMultipleRegions(O,e).pipe((0,u.$)())));(0,l.As)(N);const{chains:q,stats:z}=await(0,r.updateStatus)("Processing alignments",R,async()=>{const t=(0,s.Q)(j,t=>t.id()),e=t.filter(t=>{const e=t.get("flags");return!!(2&e)&&!(256&e||2048&e)});let n;if(e.length){const t=e.filter(t=>{const e=t.get("template_length");return 0!==e&&!Number.isNaN(e)});if(t.length>0){const e=t.map(t=>Math.abs(t.get("template_length")));n={...(0,_.W)(e),max:(0,r.max)(e),min:(0,r.min)(e)}}}return{chains:Object.values((0,r.groupBy)(t,t=>t.get("name"))),stats:n}}),D={chains:q,stats:z};(0,l.As)(N);const V={highResolutionScaling:P,exportSVG:A},$=await(0,r.updateStatus)("Rendering arcs",R,()=>(0,o.u)(L,v,V,t=>{T({ctx:t,width:L,height:v,chainData:D,colorBy:x,drawInter:k,drawLongRange:b,lineWidth:S,jitter:y,view:W,offsetPx:C,stopTokenCheck:N})})),F={...$,offsetPx:C};return(0,d.lk)(F,(0,i.X)($))}},19996(t,e,n){n.d(e,{W:()=>r});var a=n(23886);function r(t){const e=t.length,n=(0,a.sum)(t);let r=0;for(let n=0;n<e;n++){const e=t[n];r+=e*e}const s=n/e,o=Math.sqrt((e*r-n*n)/(e*e));return{upper:s+3*o,lower:s-3*o,avg:s,sd:o}}}}]);
//# sourceMappingURL=1217.1ec97fc3.chunk.js.map