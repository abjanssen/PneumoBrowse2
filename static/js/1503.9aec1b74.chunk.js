"use strict";(globalThis.webpackChunk_jbrowse_web=globalThis.webpackChunk_jbrowse_web||[]).push([[1503],{18340:(e,t,r)=>{r.d(t,{P:()=>s});var n=r(99546);function s(e,t,r=()=>{}){const s=new TextDecoder("utf8");let a=0,i=0;for(;a<e.length;){const o=e.indexOf(10,a),c=-1===o?e.length:o,u=e.subarray(a,c),l=s.decode(u).trim();if(l&&!1===t(l,i))break;i++%1e4==0&&r(`Loading ${(0,n.getProgressDisplayStr)(a,e.length)}`),a=c+1}}},61503:(e,t,r)=>{r.r(t),r.d(t,{default:()=>y});var n=r(32598),s=r(46377),a=r(99546),i=r(99834),o=r(18340),c=r(66885);const u=["seq_name","source","featureType","start","end","score","strand","frame","attributes"];function l(e){return null===e?null:String(e).replace(/%([0-9A-Fa-f]{2})/g,(e,t)=>String.fromCharCode(parseInt(t,16)))}function f(e,t){return String(t).replace(e,e=>{let t=e.charCodeAt(0).toString(16).toUpperCase();return t.length<2&&(t=`0${t}`),`%${t}`})}function d(e){return f(/[\n;\r\t=%&,\x00-\x1f\x7f-\xff]/g,e)}function h(e){return f(/[\n\r\t%\x00-\x1f\x7f-\xff]/g,e)}const p=["-",".","+"];function m(e,t){const r=null===e.attributes||void 0===e.attributes?".":function(e){const t=[];return Object.keys(e).forEach(r=>{const n=e[r];let s;s=n.hasOwnProperty("toString")?d(n.toString()):Array.isArray(n.values)?n.values.map(d).join(","):Array.isArray(n)?n.map(d).join(","):d(n),t.push(`${d(r)} ${s}`)}),t.length?t.join("; ").concat(";"):"."}(e.attributes),n=[];for(let t=0;t<8;t+=1){const r=e[u[t]];n[t]=6===t?null==r?".":p[r+1]||r:null==r?".":h(String(r))}n[8]=r;const s=`${n.join("\t")}\n`;return t[s]?"":(t[s]=!0,s)}function b(e,t){if(Array.isArray(e))return e.map(e=>b(e,t)).join("");const r=[m(e,t)];return["child_features","derived_features"].forEach(n=>{e[n]&&r.push(...e[n].map(e=>b(e,t)))}),r.join("")}function _(e){return b(e,{})}const g={Parent:"child_features",Derives_from:"derived_features"};class v{constructor(e){const t=()=>{};Object.assign(this,{featureCallback:e.featureCallback||t,endCallback:e.endCallback||t,commentCallback:e.commentCallback||t,errorCallback:e.errorCallback||t,directiveCallback:e.directiveCallback||t,sequenceCallback:e.sequenceCallback||t,bufferSize:void 0===e.bufferSize?1e3:e.bufferSize,_underConstructionTopLevel:[],_underConstructionById:{},_completedReferences:{},_underConstructionOrphans:{},eof:!1,lineNumber:0})}addLine(e){if(this.eof)return;if(this.lineNumber+=1,/^\s*[^#\s>]/.test(e))return void this._bufferLine(e);const t=/^\s*(#+)(.*)/.exec(e);if(t){let[,r,n]=t;if(3===r.length)this._emitAllUnderConstructionFeatures();else if(2===r.length){const t=function(e){const t=/^\s*##\s*(\S+)\s*(.*)/.exec(e);if(!t)return null;const r=t[1];let n=t[2];const s={directive:r};if(n.length&&(n=n.replace(/\r?\n$/,""),s.value=n),"sequence-region"===r){const[e,t,r]=n.split(/\s+/,3);s.seq_id=e,s.start=t&&t.replace(/\D/g,""),s.end=r&&r.replace(/\D/g,"")}else if("genome-build"===r){const[e,t]=n.split(/\s+/,2);s.source=e,s.buildname=t}return s}(e);this._emitItem(t)}else n=n.replace(/\s*/,""),this._emitItem({comment:n})}else if(!/^\s*$/.test(e)){const t=e.replace(/\r?\n?$/g,"");throw new Error(`GTF parse error.  Cannot parse '${t}'.`)}}_emitItem(e){e[0]?this.featureCallback(e):e.directive?this.directiveCallback(e):e.comment&&this.commentCallback(e)}finish(){this._emitAllUnderConstructionFeatures(),this.endCallback()}_enforceBufferSizeLimit(e=0){const t=e=>{var r,n,s;(null===(s=null===(n=null===(r=null==e?void 0:e[0])||void 0===r?void 0:r.attributes)||void 0===n?void 0:n.ID)||void 0===s?void 0:s[0])&&(e[0].attributes.ID.forEach(e=>{delete this._underConstructionById[e],delete this._completedReferences[e]}),e.forEach(e=>{e.child_features&&e.child_features.forEach(e=>{t(e)}),e.derived_features&&e.derived_features.forEach(e=>{t(e)})}))};for(;this._underConstructionTopLevel.length+e>this.bufferSize;){const e=this._underConstructionTopLevel.shift();this._emitItem(e),t(e)}}_emitAllUnderConstructionFeatures(){if(this._underConstructionTopLevel.forEach(this._emitItem.bind(this)),this._underConstructionTopLevel=[],this._underConstructionById={},this._completedReferences={},Object.values(this._underConstructionOrphans).filter(e=>Object.keys(e).length).length)throw new Error(`some features reference other features that do not exist in the file (or in the same '###' scope). ${JSON.stringify(this._underConstructionOrphans)}`)}_bufferLine(e){const t=function(e){const t=e.split("\t").map(e=>"."===e?null:e);t[0]=l(t[0]),t[1]=l(t[1]),t[2]=l(t[2]),t[8]=function(e){if(!e||!e.length||"."===e)return{};const t={};return e.replace(/\r?\n$/,"").slice(0,-1).split(";").forEach(e=>{if(!e)return;const r=e.trim().split(" ");if(!r[1]||!r[1].length)return;r[0]=r[0].trim();let n=t[r[0].trim()];n||(n=[],t[r[0]]=n),n.push(...r[1].split(",").map(e=>e.trim()).map(l))}),t}(t[8]);const r={};for(let e=0;e<u.length;e+=1)r[u[e]]="."===t[e]?null:t[e];return null!==r.start&&(r.start=parseInt(r.start,10)),null!==r.end&&(r.end=parseInt(r.end,10)),null!==r.score&&(r.score=parseFloat(r.score,10)),null!=r.strand&&(r.strand=r.strand),r}(e);t.child_features=[],t.derived_features=[];const r=this.lineNumber,n="transcript"===t.featureType,s=n?t.attributes.transcript_id||[]:[r],a=n?[]:t.attributes.transcript_id||[],i=t.attributes.Derives_from||[];if(!s.length&&!a.length&&!i.length)return void this._emitItem([t]);let o;a.forEach(e=>{this._underConstructionById[e]||this._bufferLine(function(e){const t=JSON.parse(JSON.stringify(e));return t.featureType="transcript",_(t)}(t))}),s.forEach(e=>{const r=this._underConstructionById[e];r?(r.push(t),o=r):(o=[t],this._enforceBufferSizeLimit(1),a.length||i.length||this._underConstructionTopLevel.push(o),this._underConstructionById[e]=o,this._resolveReferencesTo(o,e))}),this._resolveReferencesFrom(o||[t],{Parent:a,Derives_from:i},s)}_resolveReferencesTo(e,t){const r=this._underConstructionOrphans[t];r&&Object.keys(r).forEach(t=>{const n=g[t]||t.toLowerCase();e.forEach(e=>{e[n].push(...r[t]),delete r[t]})})}_parseError(e){this.eof=!0,this.errorCallback(`${this.lineNumber}: ${e}`)}_resolveReferencesFrom(e,t,r){Object.entries(t).forEach(([t,n])=>{let s;n.forEach(n=>{const a=this._underConstructionById[n];var i,o;a?(o=e,(i=a)[0].start=Math.min(i[0].start,o[0].start),i[0].end=Math.max(i[0].end,o[0].end),s||(s=g[t]||t.toLowerCase()),r.filter(e=>function(e,t,r){let n=e[t];n||(n={},e[t]=n);const s=n[r]||!1;return n[r]=!0,s}(this._completedReferences,e,`${t},${n}`)).length||a.forEach(t=>{t[s].push(e)})):(this._underConstructionOrphans[n]||(this._underConstructionOrphans[n]={}),this._underConstructionOrphans[n][t]||(this._underConstructionOrphans[n][t]=[]),this._underConstructionOrphans[n][t].push(e))})})}}function C(e,t){const r={...e};r.start-=1,r.strand={"+":1,"-":-1,".":0,"?":void 0}[e.strand],r.phase=Number(e.frame),r.refName=e.seq_name,null===e.score&&(r.score=void 0),null===e.frame&&(r.score=void 0);const n=new Set(["start","end","seq_name","score","featureType","source","frame","strand"]);for(const t of Object.keys(e.attributes)){let s=t.toLowerCase();if(n.has(s)&&(s+="2"),e.attributes[t]){let n=e.attributes[t];Array.isArray(n)&&1===n.length&&(n=n[0].replaceAll(/^"|"$/g,"")),r[s]=n}}return r.refName=r.seq_name,r.type=r.featureType,e.child_features&&e.child_features.length>0&&(r.subfeatures=e.child_features.flatMap(e=>e.map(e=>C(e)))),r.child_features=void 0,r.data=void 0,r.derived_features=void 0,r._linehash=void 0,r.attributes=void 0,r.seq_name=void 0,r.featureType=void 0,r.frame=void 0,r.transcript_id&&(r.name=r.transcript_id),void 0!==t&&(r.uniqueId=t),r}class y extends s.BaseFeatureDataAdapter{calculatedIntervalTreeMap={};async loadDataP(e){const t=(0,i.openLocation)(this.getConf("gtfLocation"),this.pluginManager),r=await(0,a.fetchAndMaybeUnzip)(t,e),s=[],c={};(0,o.P)(r,e=>{if(e.startsWith("#"))s.push(e);else{if(e.startsWith(">"))return!1;{const t=e.indexOf("\t"),r=e.slice(0,t);c[r]||(c[r]=""),c[r]+=`${e}\n`}}return!0},e?.statusCallback);const u=Object.fromEntries(Object.entries(c).map(([e,t])=>[e,r=>{if(!this.calculatedIntervalTreeMap[e]){r?.("Parsing GTF data");const s=new n.Ay;for(const r of function(e){if(!e)return[];const t=[],r=new v({featureCallback:e=>t.push(e),errorCallback:e=>{throw e}});for(const t of e.split(/\r?\n/))r.addLine(t);return r.finish(),t}(t).flat().map((t,r)=>C(t,`${this.id}-${e}-${r}`)))s.insert([r.start,r.end],r);this.calculatedIntervalTreeMap[e]=s}return this.calculatedIntervalTreeMap[e]}]));return{header:s.join("\n"),intervalTreeMap:u}}async loadData(e={}){return this.gtfFeatures||(this.gtfFeatures=this.loadDataP(e).catch(e=>{throw this.gtfFeatures=void 0,e})),this.gtfFeatures}async getRefNames(e={}){const{intervalTreeMap:t}=await this.loadData(e);return Object.keys(t)}async getHeader(e={}){const{header:t}=await this.loadData(e);return t}getFeatures(e,t={}){return(0,c.ObservableCreate)(async r=>{try{await this.getFeaturesHelper({query:e,opts:t,observer:r,allowRedispatch:!0})}catch(e){r.error(e)}},t.stopToken)}async getFeaturesHelper({query:e,opts:t,observer:r,allowRedispatch:n,originalQuery:s=e}){const i=this.getConf("aggregateField"),{start:o,end:c,refName:u}=e,{intervalTreeMap:l}=await this.loadData(t),f=l[u]?.(t.statusCallback).search([o,c]);if(f){if(n&&f.length){let n=Number.POSITIVE_INFINITY,s=Number.NEGATIVE_INFINITY,a=!1;for(const e of f)e.start<n&&(n=e.start),e.end>s&&(s=e.end),e[i]&&(a=!0);if(a&&(s>e.end||n<e.start))return void await this.getFeaturesHelper({query:{...e,start:n-5e5,end:s+5e5},opts:t,observer:r,allowRedispatch:!1,originalQuery:e})}const o={};if(f.some(e=>void 0===e.uniqueId))throw new Error("found uniqueId undefined");for(const e of f){const t=e[i];o[t]||(o[t]=[]),t?o[t].push(e):r.next(new a.SimpleFeature({id:e.uniqueId,data:e}))}for(const[t,n]of Object.entries(o)){const i=(0,a.min)(n.map(e=>e.start)),o=(0,a.max)(n.map(e=>e.end));if((0,a.doesIntersect2)(i,o,s.start,s.end)){const{uniqueId:s,strand:c}=n[0];r.next(new a.SimpleFeature({id:`${s}-parent`,data:{type:"gene",subfeatures:n,strand:c,name:t,start:i,end:o,refName:e.refName}}))}}}r.complete()}}}}]);
//# sourceMappingURL=1503.9aec1b74.chunk.js.map