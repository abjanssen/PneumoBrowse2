{"version":3,"file":"static/js/9978.6755d8bc.chunk.js","mappings":"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","sources":["../../../plugins/variants/src/shared/drawAlleleCount.ts","../../../plugins/variants/src/shared/constants.ts","../../../plugins/variants/src/shared/drawPhased.ts","../../../plugins/variants/src/shared/util.ts","../../../plugins/variants/src/MultiLinearVariantRenderer/makeImageData.ts"],"sourcesContent":["import { colord } from '@jbrowse/core/util/colord'\n\nimport { f2 } from './constants'\n\nexport function getColorAlleleCount(\n  ref: number,\n  alt: number,\n  alt2: number,\n  uncalled: number,\n  total: number,\n  drawReference = true,\n) {\n  if (ref === total) {\n    // empty string is not defined, but signals no draw\n    return drawReference ? '#ccc' : ''\n  } else {\n    let a1\n    if (alt) {\n      a1 = colord(`hsl(200,50%,${80 - (alt / total) * 50}%)`)\n    }\n    if (alt2) {\n      const l = `hsla(0,100%,20%,${alt2 / total})`\n      // @ts-ignore\n      a1 = a1 ? a1.mix(l) : colord(l)\n    }\n    if (uncalled) {\n      const l = `hsl(50,50%,50%,${uncalled / total})`\n      // @ts-ignore\n      a1 = a1 ? a1.mix(l) : colord(l)\n    }\n    return a1?.toHex() || 'black'\n  }\n}\n\nexport function drawColorAlleleCount(\n  c: string,\n  ctx: CanvasRenderingContext2D,\n  x: number,\n  y: number,\n  w: number,\n  h: number,\n  featureType = '',\n  featureStrand?: number,\n  alpha = 1,\n) {\n  ctx.fillStyle = alpha !== 1 ? colord(c).alpha(alpha).toHex() : c\n  if (featureType === 'inversion') {\n    // draw triangle pointing to the right\n    if (featureStrand === 1) {\n      ctx.beginPath()\n      ctx.moveTo(x - f2, y - f2) // left top\n      ctx.lineTo(x - f2, y + h + f2) // left bottom\n      ctx.lineTo(x + w + f2, y + h / 2) // right middle\n      ctx.closePath()\n      ctx.fill()\n    } else {\n      // draw triangle pointing to the left\n      ctx.beginPath()\n      ctx.moveTo(x + w + f2, y - f2) // right top\n      ctx.lineTo(x + w + f2, y + h + f2) // right bottom\n      ctx.lineTo(x - f2, y + h / 2) // left middle\n      ctx.closePath()\n      ctx.fill()\n    }\n  } else {\n    ctx.fillRect(x - f2, y - f2, w + f2, h + f2)\n  }\n}\n","export const fudgeFactor = 0.6\nexport const f2 = fudgeFactor / 2\n","import { set1 } from '@jbrowse/core/ui/colors'\nimport { colord } from '@jbrowse/core/util/colord'\n\nimport { f2 } from './constants'\nimport { colorify } from './util'\n\nfunction getColorPhased(alleles: string[], HP: number, drawReference = true) {\n  const c = +alleles[HP]!\n  return c ? set1[c - 1] || 'black' : drawReference ? '#ccc' : undefined\n}\n\nfunction getColorPhasedWithPhaseSet(\n  alleles: string[],\n  HP: number,\n  PS: string,\n  drawReference = true,\n) {\n  const c = +alleles[HP]!\n  return c ? colorify(+PS) || 'black' : drawReference ? '#ccc' : undefined\n}\n\nexport function drawPhased(\n  alleles: string[],\n  ctx: CanvasRenderingContext2D,\n  x: number,\n  y: number,\n  w: number,\n  h: number,\n  HP: number,\n  PS?: string,\n  drawReference = true,\n  alpha = 1,\n) {\n  const c =\n    PS !== undefined\n      ? getColorPhasedWithPhaseSet(alleles, HP, PS, drawReference)\n      : getColorPhased(alleles, HP, drawReference)\n  if (c) {\n    ctx.fillStyle = alpha !== 1 ? colord(c).alpha(alpha).toHex() : c\n    ctx.fillRect(x - f2, y - f2, w + f2, h + f2)\n  }\n  return c\n}\n","// avoid drawing negative width features for SVG exports\nexport function fillRectCtx(\n  x: number,\n  y: number,\n  width: number,\n  height: number,\n  ctx: CanvasRenderingContext2D,\n  color?: string,\n) {\n  if (width < 0) {\n    x += width\n    width = -width\n  }\n  if (height < 0) {\n    y += height\n    height = -height\n  }\n\n  if (color) {\n    ctx.fillStyle = color\n  }\n  ctx.fillRect(x, y, width, height)\n}\n\nexport function colorify(n: number) {\n  return `hsl(${n % 255}, 50%, 50%)`\n}\n","import {\n  featureSpanPx,\n  forEachWithStopTokenCheck,\n  updateStatus,\n} from '@jbrowse/core/util'\nimport Flatbush from '@jbrowse/core/util/flatbush'\nimport { checkStopToken } from '@jbrowse/core/util/stopToken'\n\nimport { f2 } from '../shared/constants'\nimport {\n  drawColorAlleleCount,\n  getColorAlleleCount,\n} from '../shared/drawAlleleCount'\nimport { drawPhased } from '../shared/drawPhased'\nimport { getFeaturesThatPassMinorAlleleFrequencyFilter } from '../shared/minorAlleleFrequencyUtils'\n\nimport type { MultiRenderArgsDeserialized } from './types'\n\nexport async function makeImageData(\n  ctx: CanvasRenderingContext2D,\n  props: MultiRenderArgsDeserialized,\n) {\n  const {\n    scrollTop,\n    minorAlleleFrequencyFilter,\n    sources,\n    rowHeight,\n    features,\n    regions,\n    bpPerPx,\n    renderingMode,\n    stopToken,\n    lengthCutoffFilter,\n    referenceDrawingMode,\n  } = props\n  const region = regions[0]!\n  const { statusCallback = () => {} } = props\n  checkStopToken(stopToken)\n  const mafs = await updateStatus('Calculating stats', statusCallback, () =>\n    getFeaturesThatPassMinorAlleleFrequencyFilter({\n      stopToken,\n      features: features.values(),\n      minorAlleleFrequencyFilter,\n      lengthCutoffFilter,\n    }),\n  )\n  checkStopToken(stopToken)\n\n  const coords = [] as number[]\n  const items = [] as any[]\n  const colorCache = {} as Record<string, string | undefined>\n  await updateStatus('Drawing variants', statusCallback, () => {\n    forEachWithStopTokenCheck(\n      mafs,\n      stopToken,\n      ({ mostFrequentAlt, feature }) => {\n        const [leftPx, rightPx] = featureSpanPx(feature, region, bpPerPx)\n        const featureId = feature.id()\n        const bpLen = feature.get('end') - feature.get('start')\n        const w = Math.max(Math.round(rightPx - leftPx), 2)\n        const samp = feature.get('genotypes') as Record<string, string>\n        let y = -scrollTop\n\n        const s = sources.length\n        if (renderingMode === 'phased') {\n          for (let j = 0; j < s; j++) {\n            const { name, HP } = sources[j]!\n            const genotype = samp[name]\n            const x = Math.floor(leftPx)\n            const h = Math.max(rowHeight, 1)\n            if (genotype) {\n              const isPhased = genotype.includes('|')\n              if (isPhased) {\n                const alleles = genotype.split('|')\n                if (\n                  drawPhased(\n                    alleles,\n                    ctx,\n                    x,\n                    y,\n                    w,\n                    h,\n                    HP!,\n                    undefined,\n                    referenceDrawingMode === 'draw',\n                  )\n                ) {\n                  items.push({\n                    name,\n                    genotype,\n                    featureId,\n                    bpLen,\n                  })\n                  coords.push(x, y, x + w, y + h)\n                }\n              } else {\n                ctx.fillStyle = 'black'\n                ctx.fillRect(x - f2, y - f2, w + f2, h + f2)\n              }\n            }\n            y += rowHeight\n          }\n        } else {\n          for (let j = 0; j < s; j++) {\n            const { name } = sources[j]!\n            const genotype = samp[name]\n            const x = Math.floor(leftPx)\n            const h = Math.max(rowHeight, 1)\n            if (genotype) {\n              const cacheKey = `${genotype}:${mostFrequentAlt}`\n              let c = colorCache[cacheKey]\n              if (c === undefined) {\n                let alt = 0\n                let uncalled = 0\n                let alt2 = 0\n                let ref = 0\n                const alleles = genotype.split(/[/|]/)\n                const total = alleles.length\n\n                for (let i = 0; i < total; i++) {\n                  const allele = alleles[i]!\n                  if (allele === mostFrequentAlt) {\n                    alt++\n                  } else if (allele === '0') {\n                    ref++\n                  } else if (allele === '.') {\n                    uncalled++\n                  } else {\n                    alt2++\n                  }\n                }\n                c = getColorAlleleCount(\n                  ref,\n                  alt,\n                  alt2,\n                  uncalled,\n                  total,\n                  referenceDrawingMode === 'draw',\n                )\n                colorCache[cacheKey] = c\n              }\n              if (c) {\n                drawColorAlleleCount(\n                  c,\n                  ctx,\n                  x,\n                  y,\n                  w,\n                  h,\n                  feature.get('type'),\n                  feature.get('strand'),\n                  bpLen > 5 ? 0.75 : 1,\n                )\n\n                items.push({\n                  name,\n                  genotype,\n                  featureId,\n                  bpLen,\n                })\n                coords.push(x, y, x + w, y + h)\n              }\n            }\n            y += rowHeight\n          }\n        }\n      },\n    )\n  })\n\n  const flatbush = new Flatbush(Math.max(items.length, 1))\n  if (items.length) {\n    for (let i = 0; i < coords.length; i += 4) {\n      flatbush.add(coords[i]!, coords[i + 1]!, coords[i + 2], coords[i + 3])\n    }\n  } else {\n    // flatbush does not like 0 items\n    flatbush.add(0, 0)\n  }\n  flatbush.finish()\n  return {\n    flatbush: flatbush.data,\n    items,\n    featureGenotypeMap: Object.fromEntries(\n      mafs.map(({ feature }) => [\n        feature.id(),\n        {\n          alt: feature.get('ALT'),\n          ref: feature.get('REF'),\n          name: feature.get('name'),\n          description: feature.get('description'),\n          length: feature.get('end') - feature.get('start'),\n        },\n      ]),\n    ),\n  }\n}\n"],"names":["getColorAlleleCount","ref","alt","alt2","uncalled","total","drawReference","a1","colord","l","mix","toHex","drawColorAlleleCount","c","ctx","x","y","w","h","featureType","featureStrand","alpha","fillStyle","beginPath","moveTo","f2","lineTo","closePath","fill","fillRect","fudgeFactor","drawPhased","alleles","HP","PS","undefined","getColorPhasedWithPhaseSet","set1","getColorPhased","async","makeImageData","props","scrollTop","minorAlleleFrequencyFilter","sources","rowHeight","features","regions","bpPerPx","renderingMode","stopToken","lengthCutoffFilter","referenceDrawingMode","region","statusCallback","checkStopToken","mafs","updateStatus","getFeaturesThatPassMinorAlleleFrequencyFilter","values","coords","items","colorCache","forEachWithStopTokenCheck","mostFrequentAlt","feature","leftPx","rightPx","featureSpanPx","featureId","id","bpLen","get","Math","max","round","samp","s","length","j","name","genotype","floor","includes","split","push","cacheKey","i","allele","flatbush","Flatbush","add","finish","data","featureGenotypeMap","Object","fromEntries","map","description"],"sourceRoot":""}