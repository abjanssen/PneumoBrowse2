{"version":3,"file":"static/js/4144.aef68ddf.chunk.js","mappings":"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","sources":["../../../plugins/variants/src/shared/drawPhased.ts","../../../plugins/variants/src/shared/drawAlleleCount.ts","../../../plugins/variants/src/MultiLinearVariantRenderer/makeImageData.ts"],"sourcesContent":["import { set1 } from '@jbrowse/core/ui/colors'\nimport { colord } from '@jbrowse/core/util/colord'\n\nimport { REFERENCE_COLOR, UNPHASED_COLOR, f2 } from './constants.ts'\n\nfunction colorify(n: number) {\n  return `hsl(${n % 255}, 50%, 50%)`\n}\n\nexport function drawPhased(\n  alleles: string[],\n  ctx: CanvasRenderingContext2D,\n  x: number,\n  y: number,\n  w: number,\n  h: number,\n  HP: number,\n  PS?: string,\n  drawReference = true,\n  alpha = 1,\n  featureType = '',\n  featureStrand?: number,\n) {\n  const allele = +alleles[HP]!\n  const c = allele\n    ? PS !== undefined\n      ? colorify(+PS) || UNPHASED_COLOR\n      : set1[allele - 1] || UNPHASED_COLOR\n    : drawReference\n      ? REFERENCE_COLOR\n      : undefined\n  if (c) {\n    ctx.fillStyle = alpha !== 1 ? colord(c).alpha(alpha).toHex() : c\n    if (featureType === 'inversion') {\n      if (featureStrand === 1) {\n        ctx.beginPath()\n        ctx.moveTo(x - f2, y - f2)\n        ctx.lineTo(x - f2, y + h + f2)\n        ctx.lineTo(x + w + f2, y + h / 2)\n        ctx.closePath()\n        ctx.fill()\n      } else {\n        ctx.beginPath()\n        ctx.moveTo(x + w + f2, y - f2)\n        ctx.lineTo(x + w + f2, y + h + f2)\n        ctx.lineTo(x - f2, y + h / 2)\n        ctx.closePath()\n        ctx.fill()\n      }\n    } else if (featureType === 'insertion') {\n      const widthExtension = 3\n      ctx.beginPath()\n      ctx.moveTo(x - f2 - widthExtension, y - f2)\n      ctx.lineTo(x + w + f2 + widthExtension, y - f2)\n      ctx.lineTo(x + w / 2, y + h + f2)\n      ctx.closePath()\n      ctx.fill()\n    } else {\n      ctx.fillRect(x - f2, y - f2, w + f2, h + f2)\n    }\n  }\n  return c\n}\n","import { colord } from '@jbrowse/core/util/colord'\n\nimport {\n  ALT_COLOR_HUE,\n  ALT_COLOR_SATURATION,\n  NO_CALL_COLOR,\n  REFERENCE_COLOR,\n  f2,\n} from './constants.ts'\n\nexport function getAlleleColor(\n  genotype: string,\n  mostFrequentAlt: string,\n  colorCache: Record<string, string | undefined>,\n  splitCache: Record<string, string[]>,\n  drawRef: boolean,\n) {\n  const cacheKey = `${genotype}:${mostFrequentAlt}`\n  let c = colorCache[cacheKey]\n  if (c === undefined) {\n    let alt = 0\n    let uncalled = 0\n    let alt2 = 0\n    let ref = 0\n    const alleles =\n      splitCache[genotype] ?? (splitCache[genotype] = genotype.split(/[/|]/))\n    const total = alleles.length\n\n    for (let i = 0; i < total; i++) {\n      const allele = alleles[i]!\n      if (allele === mostFrequentAlt) {\n        alt++\n      } else if (allele === '0') {\n        ref++\n      } else if (allele === '.') {\n        uncalled++\n      } else {\n        alt2++\n      }\n    }\n    c = getColorAlleleCount(ref, alt, alt2, uncalled, total, drawRef)\n    colorCache[cacheKey] = c\n  }\n  return c\n}\n\nexport function getColorAlleleCount(\n  ref: number,\n  alt: number,\n  alt2: number,\n  uncalled: number,\n  total: number,\n  drawReference = true,\n) {\n  if (ref === total) {\n    return drawReference ? REFERENCE_COLOR : ''\n  }\n\n  if (!(alt || alt2 || uncalled)) {\n    return ''\n  }\n\n  let a1\n  if (alt) {\n    const lightness = 80 - (alt / total) * 50\n    a1 = colord(`hsl(${ALT_COLOR_HUE},${ALT_COLOR_SATURATION}%,${lightness}%)`)\n  }\n  if (alt2) {\n    const alpha = alt2 / total\n    const l = `hsla(0,100%,20%,${alpha})`\n    a1 = a1 ? a1.mix(l) : colord(l)\n  }\n  if (uncalled) {\n    const alpha = uncalled / total\n    const l = NO_CALL_COLOR.replace(')', `,${alpha})`).replace('hsl', 'hsla')\n    a1 = a1 ? a1.mix(l) : colord(l)\n  }\n  return a1?.toHex() || 'black'\n}\n\nexport function drawColorAlleleCount(\n  c: string,\n  ctx: CanvasRenderingContext2D,\n  x: number,\n  y: number,\n  w: number,\n  h: number,\n  featureType = '',\n  featureStrand?: number,\n  alpha = 1,\n) {\n  ctx.fillStyle = alpha !== 1 ? colord(c).alpha(alpha).toHex() : c\n  if (featureType === 'inversion') {\n    if (featureStrand === 1) {\n      ctx.beginPath()\n      ctx.moveTo(x - f2, y - f2)\n      ctx.lineTo(x - f2, y + h + f2)\n      ctx.lineTo(x + w + f2, y + h / 2)\n      ctx.closePath()\n      ctx.fill()\n    } else {\n      ctx.beginPath()\n      ctx.moveTo(x + w + f2, y - f2)\n      ctx.lineTo(x + w + f2, y + h + f2)\n      ctx.lineTo(x - f2, y + h / 2)\n      ctx.closePath()\n      ctx.fill()\n    }\n  } else if (featureType === 'insertion') {\n    const widthExtension = 3\n    ctx.beginPath()\n    ctx.moveTo(x - f2 - widthExtension, y - f2)\n    ctx.lineTo(x + w + f2 + widthExtension, y - f2)\n    ctx.lineTo(x + w / 2, y + h + f2)\n    ctx.closePath()\n    ctx.fill()\n  } else {\n    ctx.fillRect(x - f2, y - f2, w + f2, h + f2)\n  }\n}\n","import { featureSpanPx, updateStatus } from '@jbrowse/core/util'\nimport Flatbush from '@jbrowse/core/util/flatbush'\nimport { checkStopToken2 } from '@jbrowse/core/util/stopToken'\n\nimport { f2 } from '../shared/constants.ts'\nimport {\n  drawColorAlleleCount,\n  getAlleleColor,\n} from '../shared/drawAlleleCount.ts'\nimport { drawPhased } from '../shared/drawPhased.ts'\nimport { getFeaturesThatPassMinorAlleleFrequencyFilter } from '../shared/minorAlleleFrequencyUtils.ts'\n\nimport type { MultiRenderArgsDeserialized } from './types.ts'\nimport type { Source } from '../shared/types.ts'\nimport type { Feature, LastStopTokenCheck, Region } from '@jbrowse/core/util'\n\ninterface Maf {\n  feature: Feature\n  mostFrequentAlt: string\n}\n\ninterface DrawContext {\n  ctx: CanvasRenderingContext2D\n  sources: Source[]\n  region: Region\n  bpPerPx: number\n  startRow: number\n  endRow: number\n  h: number\n  drawH: number\n  scrollTop: number\n  splitCache: Record<string, string[]>\n  drawRef: boolean\n  genotypesCache: Map<string, Record<string, string>>\n  stopTokenCheck?: LastStopTokenCheck\n}\n\ninterface ItemData {\n  items: { name: string; genotype: string; featureId: string; bpLen: number }[]\n  coords: number[]\n}\n\nfunction drawPhasedMode(drawCtx: DrawContext, itemData: ItemData, mafs: Maf[]) {\n  const {\n    ctx,\n    sources,\n    region,\n    bpPerPx,\n    startRow,\n    endRow,\n    h,\n    drawH,\n    scrollTop,\n    splitCache,\n    drawRef,\n    genotypesCache,\n    stopTokenCheck,\n  } = drawCtx\n  const { items, coords } = itemData\n  for (const { feature } of mafs) {\n    const [leftPx, rightPx] = featureSpanPx(feature, region, bpPerPx)\n    const featureId = feature.id()\n    const bpLen = feature.get('end') - feature.get('start')\n    const w = Math.max(Math.round(rightPx - leftPx), 2)\n    const x = Math.floor(leftPx)\n    let samp = genotypesCache.get(featureId)\n    if (!samp) {\n      samp = feature.get('genotypes') as Record<string, string>\n      genotypesCache.set(featureId, samp)\n    }\n    const featureType = feature.get('type')\n    const featureStrand = feature.get('strand')\n    const alpha = bpLen > 5 ? 0.75 : 1\n\n    for (let j = startRow; j < endRow; j++) {\n      const y = j * h - scrollTop\n      const source = sources[j]!\n      const { name, HP, baseName } = source\n      const sampleName = baseName ?? name\n      const genotype = samp[sampleName]\n      if (genotype) {\n        const isPhased = genotype.includes('|')\n        if (isPhased) {\n          const alleles =\n            splitCache[genotype] ?? (splitCache[genotype] = genotype.split('|'))\n          if (\n            drawPhased(\n              alleles,\n              ctx,\n              x,\n              y,\n              w,\n              drawH,\n              HP!,\n              undefined,\n              drawRef,\n              alpha,\n              featureType,\n              featureStrand,\n            )\n          ) {\n            items.push({ name, genotype, featureId, bpLen })\n            coords.push(x, y, x + w, y + drawH)\n          }\n        } else {\n          ctx.fillStyle = 'black'\n          ctx.fillRect(x - f2, y - f2, w + f2, drawH + f2)\n        }\n      }\n    }\n    checkStopToken2(stopTokenCheck)\n  }\n}\n\nfunction drawAlleleCountMode(\n  drawCtx: DrawContext,\n  itemData: ItemData,\n  mafs: Maf[],\n  colorCache: Record<string, string | undefined>,\n) {\n  const {\n    ctx,\n    sources,\n    region,\n    bpPerPx,\n    startRow,\n    endRow,\n    h,\n    drawH,\n    scrollTop,\n    splitCache,\n    drawRef,\n    genotypesCache,\n    stopTokenCheck,\n  } = drawCtx\n  const { items, coords } = itemData\n  for (const { mostFrequentAlt, feature } of mafs) {\n    const [leftPx, rightPx] = featureSpanPx(feature, region, bpPerPx)\n    const featureId = feature.id()\n    const bpLen = feature.get('end') - feature.get('start')\n    const w = Math.max(Math.round(rightPx - leftPx), 2)\n    const x = Math.floor(leftPx)\n    let samp = genotypesCache.get(featureId)\n    if (!samp) {\n      samp = feature.get('genotypes') as Record<string, string>\n      genotypesCache.set(featureId, samp)\n    }\n    const featureType = feature.get('type')\n    const featureStrand = feature.get('strand')\n    const alpha = bpLen > 5 ? 0.75 : 1\n\n    for (let j = startRow; j < endRow; j++) {\n      const y = j * h - scrollTop\n      const { name } = sources[j]!\n      const genotype = samp[name]\n      if (genotype) {\n        const c = getAlleleColor(\n          genotype,\n          mostFrequentAlt,\n          colorCache,\n          splitCache,\n          drawRef,\n        )\n        if (c) {\n          drawColorAlleleCount(\n            c,\n            ctx,\n            x,\n            y,\n            w,\n            drawH,\n            featureType,\n            featureStrand,\n            alpha,\n          )\n          items.push({ name, genotype, featureId, bpLen })\n          coords.push(x, y, x + w, y + drawH)\n        }\n      }\n    }\n    checkStopToken2(stopTokenCheck)\n  }\n}\n\nexport async function makeImageData(\n  ctx: CanvasRenderingContext2D,\n  props: MultiRenderArgsDeserialized,\n) {\n  const {\n    scrollTop,\n    minorAlleleFrequencyFilter,\n    sources,\n    rowHeight,\n    height: canvasHeight,\n    features,\n    regions,\n    bpPerPx,\n    renderingMode,\n    stopTokenCheck,\n    lengthCutoffFilter,\n    referenceDrawingMode,\n    statusCallback = () => {},\n  } = props\n  const region = regions[0]!\n\n  const coords = [] as number[]\n  const items = [] as {\n    name: string\n    genotype: string\n    featureId: string\n    bpLen: number\n  }[]\n  const colorCache = {} as Record<string, string | undefined>\n  const splitCache = {} as Record<string, string[]>\n  const genotypesCache = new Map<string, Record<string, string>>()\n  const drawRef = referenceDrawingMode === 'draw'\n  const h = rowHeight\n  const drawH = Math.max(rowHeight, 1)\n  const startRow = Math.floor(scrollTop / h)\n  const endRow = Math.min(\n    sources.length,\n    Math.ceil((scrollTop + canvasHeight) / h),\n  )\n\n  const mafs = await updateStatus('Calculating stats', statusCallback, () =>\n    getFeaturesThatPassMinorAlleleFrequencyFilter({\n      stopTokenCheck,\n      features: features.values(),\n      minorAlleleFrequencyFilter,\n      lengthCutoffFilter,\n      genotypesCache,\n      splitCache,\n    }),\n  )\n\n  const drawCtx: DrawContext = {\n    ctx,\n    sources,\n    region,\n    bpPerPx,\n    startRow,\n    endRow,\n    h,\n    drawH,\n    scrollTop,\n    splitCache,\n    drawRef,\n    genotypesCache,\n    stopTokenCheck,\n  }\n  const itemData: ItemData = { items, coords }\n\n  await updateStatus('Drawing variants', statusCallback, () => {\n    if (renderingMode === 'phased') {\n      drawPhasedMode(drawCtx, itemData, mafs)\n    } else {\n      drawAlleleCountMode(drawCtx, itemData, mafs, colorCache)\n    }\n  })\n\n  const flatbush = new Flatbush(Math.max(items.length, 1))\n  if (items.length) {\n    for (let i = 0, l = coords.length; i < l; i += 4) {\n      flatbush.add(coords[i]!, coords[i + 1]!, coords[i + 2], coords[i + 3])\n    }\n  } else {\n    flatbush.add(0, 0)\n  }\n  flatbush.finish()\n\n  const featureGenotypeMap = {} as Record<\n    string,\n    {\n      alt: unknown\n      ref: unknown\n      name: unknown\n      description: unknown\n      length: number\n    }\n  >\n  for (const { feature } of mafs) {\n    const id = feature.id()\n    featureGenotypeMap[id] = {\n      alt: feature.get('ALT'),\n      ref: feature.get('REF'),\n      name: feature.get('name'),\n      description: feature.get('description'),\n      length: feature.get('end') - feature.get('start'),\n    }\n  }\n\n  return {\n    flatbush: flatbush.data,\n    items,\n    featureGenotypeMap,\n  }\n}\n"],"names":["drawPhased","alleles","ctx","x","y","w","h","HP","PS","drawReference","alpha","featureType","featureStrand","allele","c","undefined","UNPHASED_COLOR","set1","REFERENCE_COLOR","fillStyle","colord","toHex","beginPath","moveTo","f2","lineTo","closePath","fill","widthExtension","fillRect","getAlleleColor","genotype","mostFrequentAlt","colorCache","splitCache","drawRef","cacheKey","alt","uncalled","alt2","ref","split","total","length","i","a1","lightness","ALT_COLOR_HUE","ALT_COLOR_SATURATION","l","mix","NO_CALL_COLOR","replace","getColorAlleleCount","drawColorAlleleCount","async","makeImageData","props","scrollTop","minorAlleleFrequencyFilter","sources","rowHeight","height","canvasHeight","features","regions","bpPerPx","renderingMode","stopTokenCheck","lengthCutoffFilter","referenceDrawingMode","statusCallback","region","coords","items","genotypesCache","Map","drawH","Math","max","startRow","floor","endRow","min","ceil","mafs","updateStatus","getFeaturesThatPassMinorAlleleFrequencyFilter","values","drawCtx","itemData","feature","leftPx","rightPx","featureSpanPx","featureId","id","bpLen","get","round","samp","set","j","source","name","baseName","includes","push","checkStopToken2","drawPhasedMode","drawAlleleCountMode","flatbush","Flatbush","add","finish","featureGenotypeMap","description","data"],"ignoreList":[],"sourceRoot":""}