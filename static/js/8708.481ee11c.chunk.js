"use strict";(globalThis.webpackChunk_jbrowse_web=globalThis.webpackChunk_jbrowse_web||[]).push([[8708],{48708(e,t,r){r.d(t,{default:()=>f});var s=r(15522),a=r(90946),i=r(23886),n=r(47664),o=r(11931),h=r(25529),c=r(29458),d=r(13469),u=r(63692),l=r(89579);const g=new Uint8Array([77,73,68,78,83,72,80,61,88,63,63,63,63,63,63,63]);class m{constructor(e,t){this.record=e,this._store=t}get name(){return this.record.readName}get start(){return this.record.alignmentStart-1}get end(){return this.start+(this.record.lengthOnRef??1)}get score(){return this.record.mappingQuality}get flags(){return this.record.flags}get strand(){return this.record.isReverseComplemented()?-1:1}get qual(){return(this.record.qualityScores||[]).join(" ")}get qualRaw(){return this.record.qualityScores}get refName(){return this._store.refIdToName(this.record.sequenceId)}get pair_orientation(){return this.record.isPaired()?this.record.getPairOrientation():void 0}get template_length(){return this.record.templateLength||this.record.templateSize}get next_ref(){return this.record.mate?this._store.refIdToName(this.record.mate.sequenceId):void 0}get next_segment_position(){return this.record.mate?`${this._store.refIdToName(this.record.mate.sequenceId)}:${this.record.mate.alignmentStart}`:void 0}get is_paired(){return!!this.record.mate}get next_pos(){return this.record.mate?.alignmentStart}get tags(){const e=this._store.samHeader?.readGroups[this.record.readGroupId];return void 0!==e?{...this.record.tags,RG:e}:this.record.tags}get seq(){return this.record.getReadBases()}get NUMERIC_CIGAR(){return function(e,t,r){const s=[];let a=0,i=0,n=t,o=0,h=0;if(void 0!==e)for(let t=0,r=e.length;t<r;t++){const r=e[t],{code:c,refPos:d}=r,u=d-n;if(h+=u,n=d,o&&u&&(s.push(o<<4|1),o=0),i&&0!==a&&(s.push(i<<4|a),i=0),u&&(a=0,i+=u),"b"===c){const e=r.data.split(",").length;h+=e,n+=e,i+=e}else if("B"===c||"X"===c)h++,n++,i++;else if("D"===c||"N"===c){n+=r.data,i&&(s.push(i<<4|a),i=0);const e="D"===c?2:3;s.push(r.data<<4|e)}else if("I"===c||"S"===c){const e=r.data.length;h+=e,i&&(s.push(i<<4|a),i=0);const t="I"===c?1:4;s.push(e<<4|t)}else if("i"===c)i&&(s.push(i<<4|a),i=0),o++,h++;else if("P"===c||"H"===c){i&&(s.push(i<<4|a),i=0);const e="P"===c?6:5;s.push(r.data<<4|e)}}const c=r-h;return c&&(i&&0!==a&&(s.push(i<<4|a),i=0),a=0,i+=c),c&&o&&s.push(o<<4|1),i&&s.push(i<<4|a),s}(this.record.readFeatures,this.record.alignmentStart,this.record.readLength)}get CIGAR(){const e=this.NUMERIC_CIGAR;let t="";for(let r=0,s=e.length;r<s;r++){const s=e[r],a=s>>4,i=g[15&s];t+=a+d.sO[i]}return t}id(){return`${this._store.id}-${this.record.uniqueId}`}get(e){switch(e){case"mismatches":return this.mismatches;case"qual":return this.qual;case"CIGAR":return this.CIGAR;case"NUMERIC_CIGAR":return this.NUMERIC_CIGAR;default:return this.fields[e]}}parent(){}children(){}get mismatches(){const e=[];return this.forEachMismatch((t,r,s,a,i,n,o)=>{t===u.oq?e.push({type:"mismatch",start:r,length:s,base:a,qual:void 0!==i&&i>=0?i:void 0,altbase:void 0!==n&&n>0?d.sO[n]:void 0}):t===u.jm?e.push({type:"insertion",start:r,length:s,insertlen:o,insertedBases:a}):t===u.eC?e.push({type:"softclip",start:r,length:s,cliplen:o}):t===u.bU?e.push({type:"hardclip",start:r,length:s,cliplen:o}):e.push({type:2===t?"deletion":"skip",start:r,length:s})}),e}forEachMismatch(e){const t=this.record.readFeatures;if(!t)return;const r=this.start,s=this.qualRaw,a=!!s,i=t.length;let n=0,o=r,h="",c=0;for(let d=0;d<i;d++){const i=t[d],l=n-o;o=n,l&&c>0&&(e(u.jm,n,0,h,-1,0,c),h="",c=0),n=i.refPos-1-r;const{code:g}=i;if("X"===g){const t=i.ref?-33&i.ref.charCodeAt(0):0;e(u.oq,n,1,i.sub??"",a?s[i.pos-1]:-1,t,0)}else if("I"===g)e(u.jm,n,0,i.data,-1,0,i.data.length);else if("N"===g)e(u.D,n,i.data,"N",-1,0,0);else if("S"===g){const t=i.data.length;e(u.eC,n,1,`S${t}`,-1,0,t)}else"H"===g?e(u.bU,n,1,`H${i.data}`,-1,0,i.data):"D"===g?e(u.YX,n,i.data,"*",-1,0,0):"i"===g&&(h+=i.data,c++)}c>0&&e(u.jm,n,0,h,-1,0,c)}get fields(){return{start:this.start,name:this.name,end:this.end,score:this.score,strand:this.strand,template_length:this.template_length,flags:this.flags,tags:(0,l.ce)(this.tags),refName:this.refName,seq:this.seq,type:"match",pair_orientation:this.pair_orientation,next_ref:this.next_ref,next_pos:this.next_pos,next_segment_position:this.next_segment_position,uniqueId:this.id()}}toJSON(){return{...this.fields,CIGAR:this.CIGAR,qual:this.qual}}}(0,l.Kt)(m,"fields"),(0,l.Kt)(m,"CIGAR"),(0,l.Kt)(m,"NUMERIC_CIGAR"),(0,l.Kt)(m,"mismatches");class f extends a.L{ultraLongFeatureCache=new n.A({maxSize:500});seqIdToOriginalRefName=[];configure(){if(!this.configureResult){const e=this.getConf("cramLocation"),t=this.getConf("craiLocation");this.configureResult={cram:new s.bQ({cramFilehandle:(0,o.openLocation)(e,this.pluginManager),index:new s.Wb({filehandle:(0,o.openLocation)(t,this.pluginManager)}),seqFetch:async(e,t,r)=>{const s=await this.getSequenceAdapter();if(!s)throw new Error("no sequenceAdapter available");const a=this.refIdToOriginalName(e)||this.refIdToName(e);if(!a)throw new Error("unknown refName");return await s.getSequence({refName:a,start:t-1,end:r})??""},checkSequenceMD5:!1})}}return this.configureResult}async getSequenceAdapter(){const e=this.sequenceAdapterConfig;if(e&&this.getSubAdapter)return this.sequenceAdapterP??=this.getSubAdapter(e).then(e=>e.dataAdapter).catch(e=>{throw this.sequenceAdapterP=void 0,e}),this.sequenceAdapterP}async getHeader(e){const{cram:t}=this.configure();return t.cram.getHeaderText()}async setup(e){return this.setupP??=(async()=>{const{cram:e}=this.configure(),t=await e.cram.getSamHeader(),r=(0,l.cY)(t);return this.samHeader=r,{samHeader:r,cram:e}})().catch(e=>{throw this.setupP=void 0,this.configureResult=void 0,e}),this.setupP}async getRefNames(e){const{samHeader:t}=await this.setup(e);return t.idToName}refNameToId(e){return this.samHeader?.nameToId[e]}refIdToName(e){return this.samHeader?.idToName[e]}refIdToOriginalName(e){return this.seqIdToOriginalRefName[e]}getFeatures(e,t){const{stopToken:r,filterBy:s,statusCallback:a=()=>{}}=t||{},{refName:n,start:o,end:d,originalRefName:u}=e;return(0,h.ObservableCreate)(async e=>{const{cram:h,samHeader:g}=await this.setup(t),f=this.refNameToId(n);if(void 0===f)return console.warn("Unknown refName",n),void e.complete();let p;u&&(this.seqIdToOriginalRefName[f]=u);try{p=await(0,i.updateStatus)("Downloading alignments",a,()=>h.getRecordsForRange(f,o,d))}catch(e){throw this.setupP=void 0,this.configureResult=void 0,e}(0,c.SW)(r),await(0,i.updateStatus)("Processing alignments",a,()=>{const{flagInclude:t=0,flagExclude:r=0,tagFilter:a,readName:i}=s||{};for(const s of p)if(!(0,l.lE)(s.flags,t,r)&&!(a&&(0,l.Kl)("RG"===a.tag?g.readGroups[s.readGroupId]:s.tags[a.tag],a.value)||i&&s.readName!==i))if(s.readLength>5e3){const t=this.ultraLongFeatureCache.get(s.uniqueId);if(t)e.next(t);else{const t=new m(s,this);this.ultraLongFeatureCache.set(s.uniqueId,t),e.next(t)}}else e.next(new m(s,this));e.complete()})},r)}async getMultiRegionFeatureDensityStats(e){return{bytes:await this.bytesForRegions(e),fetchSizeLimit:this.getConf("fetchSizeLimit")}}async bytesForRegions(e){const{cram:t}=this.configure(),r=await Promise.all(e.map(e=>{const{refName:r,start:s,end:a}=e,i=this.refNameToId(r);return void 0!==i?t.index.getEntriesForRange(i,s,a):Promise.resolve([{sliceBytes:0}])}));return(0,i.sum)(r.flat().map(e=>e.sliceBytes))}}},13469(e,t,r){r.d(t,{A_:()=>m,C4:()=>d,El:()=>f,Tr:()=>l,a2:()=>o,aT:()=>n,hE:()=>i,hK:()=>a,hN:()=>h,oE:()=>u,og:()=>c,q7:()=>g,sO:()=>p,tQ:()=>I});var s=r(153);const a=0,i=1,n=2,o=3,h=4,c=5,d=7,u=8,l=129,g=389,m="=ACMGRSVTWYHKDBN",f=new Uint8Array([61,97,99,109,103,114,115,118,116,119,121,104,107,100,98,110]),p=Array.from({length:128},(e,t)=>String.fromCharCode(t));function I(e){return"string"==typeof e?(0,s.YJ)(e):e||[]}}}]);
//# sourceMappingURL=8708.481ee11c.chunk.js.map