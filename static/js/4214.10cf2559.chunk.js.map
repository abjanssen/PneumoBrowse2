{"version":3,"file":"static/js/4214.10cf2559.chunk.js","mappings":"mOAqCO,SAASA,EAAcC,IAiG5BC,EAAAA,EAAAA,aACED,GACAE,EAAAA,EAAAA,SACE,KACE,GAAIF,EAAKG,YACP,OAEF,MAAMC,GAAOC,EAAAA,EAAAA,mBAAkBL,GAC/B,IAAKI,EAAKE,YACR,OAEF,MAAM,cAAEC,GAAkBH,EACpBI,EAAUD,EAAcE,cAI9BT,EAAKU,SACLV,EAAKW,2BACLX,EAAKY,mBACLZ,EAAKa,mBACLb,EAAKc,eACLd,EAAKe,YACLf,EAAKgB,eACLhB,EAAKiB,YACLjB,EAAKkB,oBACLlB,EAAKmB,SAGDnB,EAAKiB,aACPjB,EAAKoB,iBAMHC,EAAAA,EAAAA,WAAU,IAAMrB,EAAKsB,QAAWd,EAAQe,QAnI5BC,WACpB,GAAIxB,EAAKG,YACP,OAGF,IAAKH,EAAKgB,eACR,OAEF,MAAMZ,GAAOC,EAAAA,EAAAA,mBAAkBL,IACzB,QAAEyB,EAAO,cAAElB,GAAkBH,EAC7BI,EAAUD,EAAcE,cAE9B,IAAKD,EAAQe,OACX,OAIF,GAAIE,EAAU,IACZ,OAKF,MAAM,cAAEC,GAAkB1B,EACpB2B,GAAcN,EAAAA,EAAAA,WAAU,IAAMrB,EAAK2B,eAEzC,IACE,MAAMC,GAAUC,EAAAA,EAAAA,YAAW7B,IACrB,WAAE8B,GAAeF,EACjBG,GAAeC,EAAAA,EAAAA,iBAAgBhC,GAE/BiC,GAAgBZ,EAAAA,EAAAA,WAAU,IAAMrB,EAAKkC,oBACvCD,IACFE,EAAAA,EAAAA,IAAcF,GAGhB,MAAMG,GAAYC,EAAAA,EAAAA,MAClBrC,EAAKsC,sBAAsBF,GAC3BpC,EAAKuC,YAAW,GAChBvC,EAAKwC,gBAAe,GAEpB,MAAMC,QAAgBX,EAAWY,KAC/BX,EACA,aACA,CACEY,UAAWZ,EACXa,aAAc,aACdpC,QAAS,IAAIA,GACbkB,gBACAD,UACAW,eACGT,GAEL,CACEkB,eAAiBC,KACXC,EAAAA,EAAAA,SAAQ/C,IACVA,EAAKgD,iBAAiBF,MAM1BL,EAAOQ,YACTjD,EAAKkD,sBAAsBT,EAAOQ,WAClCjD,EAAKmD,qBAAqB/C,EAAKgD,UAC/BpD,EAAKqD,oBAAoBjD,EAAKqB,UAGhCzB,EAAKsD,gBACHb,EAAOc,SACPd,EAAOe,OAAS,GAChBf,EAAOgB,QAAQC,MAAQ,GACvBjB,EAAOkB,UAAY,EACnBlB,EAAOmB,SAAW,EAClBnB,EAAOoB,GAAK,GAGd7D,EAAK8D,eAAerB,EAAOsB,aAE3B/D,EAAKgE,iBAAiBvB,EAAOwB,cAC/B,CAAE,MAAO3C,IACF4C,EAAAA,EAAAA,IAAiB5C,KACpB6C,QAAQ7C,MAAMA,IACVyB,EAAAA,EAAAA,SAAQ/C,IACVA,EAAKoE,SAAS9C,GAGpB,CAAE,SACIyB,EAAAA,EAAAA,SAAQ/C,KACVA,EAAKsC,2BAAsB+B,GAC3BrE,EAAKuC,YAAW,GAEpB,GA4CI+B,IAEF,CACEC,MAAO,IACPC,KAAM,sBAMZvE,EAAAA,EAAAA,aACED,GACAE,EAAAA,EAAAA,SACE,KACE,GAAIF,EAAKG,YACP,OAGF,KADaE,EAAAA,EAAAA,mBAAkBL,GACrBM,YACR,OAEF,MAAMmE,GAAUC,EAAAA,EAAAA,IAAoB1E,EAAK2E,IAAK3E,EAAK4E,qBAC/C7B,EAAAA,EAAAA,SAAQ/C,IACVA,EAAKwC,eAAeiC,IAGxB,CACEF,MAAO,IACPC,KAAM,oBAId,C","sources":["../../../plugins/variants/src/LDDisplay/afterAttach.ts"],"sourcesContent":["import {\n  getContainingView,\n  getRpcSessionId,\n  getSession,\n  isAbortException,\n} from '@jbrowse/core/util'\nimport { createStopToken, stopStopToken } from '@jbrowse/core/util/stopToken'\nimport { addDisposer, isAlive } from '@jbrowse/mobx-state-tree'\nimport { drawCanvasImageData } from '@jbrowse/plugin-linear-genome-view'\nimport { autorun, untracked } from 'mobx'\n\nimport type { SharedLDModel } from './shared.ts'\nimport type { LDFlatbushItem } from '../LDRenderer/types.ts'\nimport type { FilterStats, LDMatrixResult } from '../VariantRPC/getLDMatrix.ts'\nimport type { LinearGenomeViewModel } from '@jbrowse/plugin-linear-genome-view'\n\ntype LGV = LinearGenomeViewModel\n\ninterface RenderResult {\n  imageData?: ImageBitmap\n  flatbush?: ArrayBufferLike\n  items?: LDFlatbushItem[]\n  ldData?: {\n    snps: LDMatrixResult['snps']\n  }\n  filterStats?: FilterStats\n  recombination?: {\n    values: number[]\n    positions: number[]\n  }\n  maxScore?: number\n  yScalar?: number\n  w?: number\n  width: number\n  height: number\n}\n\nexport function doAfterAttach(self: SharedLDModel) {\n  const performRender = async () => {\n    if (self.isMinimized) {\n      return\n    }\n    // Skip rendering if LD triangle is hidden\n    if (!self.showLDTriangle) {\n      return\n    }\n    const view = getContainingView(self) as LGV\n    const { bpPerPx, dynamicBlocks } = view\n    const regions = dynamicBlocks.contentBlocks\n\n    if (!regions.length) {\n      return\n    }\n\n    // Don't render when zoomed out too far\n    if (bpPerPx > 1000) {\n      return\n    }\n\n    // Use untracked to prevent these from being tracked by the autorun\n    // We explicitly list what should trigger re-rendering above\n    const { adapterConfig } = self\n    const renderProps = untracked(() => self.renderProps())\n\n    try {\n      const session = getSession(self)\n      const { rpcManager } = session\n      const rpcSessionId = getRpcSessionId(self)\n\n      const previousToken = untracked(() => self.renderingStopToken)\n      if (previousToken) {\n        stopStopToken(previousToken)\n      }\n\n      const stopToken = createStopToken()\n      self.setRenderingStopToken(stopToken)\n      self.setLoading(true)\n      self.setCanvasDrawn(false)\n\n      const result = (await rpcManager.call(\n        rpcSessionId,\n        'CoreRender',\n        {\n          sessionId: rpcSessionId,\n          rendererType: 'LDRenderer',\n          regions: [...regions],\n          adapterConfig,\n          bpPerPx,\n          stopToken,\n          ...renderProps,\n        },\n        {\n          statusCallback: (msg: string) => {\n            if (isAlive(self)) {\n              self.setStatusMessage(msg)\n            }\n          },\n        },\n      )) as RenderResult\n\n      if (result.imageData) {\n        self.setRenderingImageData(result.imageData)\n        self.setLastDrawnOffsetPx(view.offsetPx)\n        self.setLastDrawnBpPerPx(view.bpPerPx)\n      }\n      // Store flatbush data for mouseover\n      self.setFlatbushData(\n        result.flatbush,\n        result.items ?? [],\n        result.ldData?.snps ?? [],\n        result.maxScore ?? 1,\n        result.yScalar ?? 1,\n        result.w ?? 0,\n      )\n      // Store filter stats\n      self.setFilterStats(result.filterStats)\n      // Store recombination data\n      self.setRecombination(result.recombination)\n    } catch (error) {\n      if (!isAbortException(error)) {\n        console.error(error)\n        if (isAlive(self)) {\n          self.setError(error)\n        }\n      }\n    } finally {\n      if (isAlive(self)) {\n        self.setRenderingStopToken(undefined)\n        self.setLoading(false)\n      }\n    }\n  }\n\n  // Autorun to trigger rendering when parameters change\n  addDisposer(\n    self,\n    autorun(\n      () => {\n        if (self.isMinimized) {\n          return\n        }\n        const view = getContainingView(self) as LGV\n        if (!view.initialized) {\n          return\n        }\n        const { dynamicBlocks } = view\n        const regions = dynamicBlocks.contentBlocks\n\n        /* eslint-disable @typescript-eslint/no-unused-expressions */\n        // access these to trigger autorun on changes\n        self.ldMetric\n        self.minorAlleleFrequencyFilter\n        self.lengthCutoffFilter\n        self.hweFilterThreshold\n        self.callRateFilter\n        self.colorScheme\n        self.showLDTriangle\n        self.fitToHeight\n        self.useGenomicPositions\n        self.signedLD\n        // When fitToHeight is true, also track ldCanvasHeight so resizing\n        // the display triggers a re-render\n        if (self.fitToHeight) {\n          self.ldCanvasHeight\n        }\n        // Note: lineZoneHeight, recombinationZoneHeight, and showRecombination\n        // are handled by CSS/React, not canvas rendering\n        /* eslint-enable @typescript-eslint/no-unused-expressions */\n\n        if (untracked(() => self.error) || !regions.length) {\n          return\n        }\n\n        // eslint-disable-next-line @typescript-eslint/no-floating-promises\n        performRender()\n      },\n      {\n        delay: 500,\n        name: 'LDDisplayRender',\n      },\n    ),\n  )\n\n  // Autorun to draw the canvas when imageData changes\n  addDisposer(\n    self,\n    autorun(\n      () => {\n        if (self.isMinimized) {\n          return\n        }\n        const view = getContainingView(self) as LGV\n        if (!view.initialized) {\n          return\n        }\n        const success = drawCanvasImageData(self.ref, self.renderingImageData)\n        if (isAlive(self)) {\n          self.setCanvasDrawn(success)\n        }\n      },\n      {\n        delay: 1000,\n        name: 'LDDisplayCanvas',\n      },\n    ),\n  )\n}\n"],"names":["doAfterAttach","self","addDisposer","autorun","isMinimized","view","getContainingView","initialized","dynamicBlocks","regions","contentBlocks","ldMetric","minorAlleleFrequencyFilter","lengthCutoffFilter","hweFilterThreshold","callRateFilter","colorScheme","showLDTriangle","fitToHeight","useGenomicPositions","signedLD","ldCanvasHeight","untracked","error","length","async","bpPerPx","adapterConfig","renderProps","session","getSession","rpcManager","rpcSessionId","getRpcSessionId","previousToken","renderingStopToken","stopStopToken","stopToken","createStopToken","setRenderingStopToken","setLoading","setCanvasDrawn","result","call","sessionId","rendererType","statusCallback","msg","isAlive","setStatusMessage","imageData","setRenderingImageData","setLastDrawnOffsetPx","offsetPx","setLastDrawnBpPerPx","setFlatbushData","flatbush","items","ldData","snps","maxScore","yScalar","w","setFilterStats","filterStats","setRecombination","recombination","isAbortException","console","setError","undefined","performRender","delay","name","success","drawCanvasImageData","ref","renderingImageData"],"ignoreList":[],"sourceRoot":""}