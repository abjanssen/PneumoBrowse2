{"version":3,"file":"static/js/8711.cd407228.chunk.js","mappings":"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","sources":["../../../plugins/wiggle/src/DensityRenderer/renderDensity.ts","../../../plugins/wiggle/src/drawDensity.ts"],"sourcesContent":["import { renderToAbstractCanvas, updateStatus } from '@jbrowse/core/util'\nimport { rpcResult } from '@jbrowse/core/util/librpc'\nimport { collectTransferables } from '@jbrowse/core/util/offscreenCanvasPonyfill'\n\nimport { drawDensity } from '../drawDensity.ts'\nimport { serializeWiggleFeature } from '../util.ts'\n\nimport type { RenderArgsDeserialized } from '../types.ts'\nimport type { Feature } from '@jbrowse/core/util'\n\nexport async function renderDensity(\n  renderProps: RenderArgsDeserialized,\n  features: Feature[],\n) {\n  const { height, regions, bpPerPx, statusCallback = () => {} } = renderProps\n\n  const region = regions[0]!\n  const width = (region.end - region.start) / bpPerPx\n\n  const { reducedFeatures, ...rest } = await updateStatus(\n    'Rendering plot',\n    statusCallback,\n    () =>\n      renderToAbstractCanvas(width, height, renderProps, ctx =>\n        drawDensity(ctx, { ...renderProps, features }),\n      ),\n  )\n\n  const serialized = {\n    ...rest,\n    features: reducedFeatures.map(serializeWiggleFeature),\n    height,\n    width,\n  }\n\n  return rpcResult(serialized, collectTransferables(rest))\n}\n","import { readConfObject } from '@jbrowse/core/configuration'\nimport {\n  checkStopToken2,\n  createStopTokenChecker,\n} from '@jbrowse/core/util/stopToken'\n\nimport { fillRectCtx, getScale } from './util.ts'\n\nimport type { ScaleOpts } from './util.ts'\nimport type { AnyConfigurationModel } from '@jbrowse/core/configuration'\nimport type { Feature, Region } from '@jbrowse/core/util'\nimport type {\n  LastStopTokenCheck,\n  StopToken,\n} from '@jbrowse/core/util/stopToken'\n\nconst fudgeFactor = 0.3\nconst clipHeight = 2\n\nexport function drawDensity(\n  ctx: CanvasRenderingContext2D,\n  props: {\n    features: Map<string, Feature> | Feature[]\n    regions: Region[]\n    bpPerPx: number\n    scaleOpts: ScaleOpts\n    height: number\n    ticks: { values: number[] }\n    displayCrossHatches: boolean\n    config: AnyConfigurationModel\n    stopToken?: StopToken\n    lastCheck?: LastStopTokenCheck\n  },\n) {\n  const {\n    features,\n    regions,\n    bpPerPx,\n    scaleOpts,\n    height,\n    config,\n    stopToken,\n    lastCheck = createStopTokenChecker(stopToken),\n  } = props\n  const region = regions[0]!\n  const regionStart = region.start\n  const regionEnd = region.end\n  const regionReversed = region.reversed\n  const inverseBpPerPx = 1 / bpPerPx\n\n  const pivot = readConfObject(config, 'bicolorPivot')\n  const pivotValue = readConfObject(config, 'bicolorPivotValue')\n  const negColor = readConfObject(config, 'negColor')\n  const posColor = readConfObject(config, 'posColor')\n  const color = readConfObject(config, 'color')\n  const clipColor = readConfObject(config, 'clipColor')\n  const crossing = pivot !== 'none' && scaleOpts.scaleType !== 'log'\n  const scale = getScale({\n    ...scaleOpts,\n    pivotValue: crossing ? pivotValue : undefined,\n    range: crossing ? [negColor, '#eee', posColor] : ['#eee', posColor],\n  })\n\n  const scale2 = getScale({ ...scaleOpts, range: [0, height] })\n  const cb =\n    color === '#f0f'\n      ? (_: Feature, score: number) => scale(score)\n      : (feature: Feature, score: number) =>\n          readConfObject(config, 'color', { feature, score })\n  const domain = scale2.domain()\n  const niceMin = domain[0]!\n  const niceMax = domain[1]!\n\n  let prevLeftPx = Number.NEGATIVE_INFINITY\n  let hasClipping = false\n  const reducedFeatures = []\n  for (const feature of features.values()) {\n    checkStopToken2(lastCheck)\n    const fStart = feature.get('start')\n    const fEnd = feature.get('end')\n    const leftPx = regionReversed\n      ? (regionEnd - fEnd) * inverseBpPerPx\n      : (fStart - regionStart) * inverseBpPerPx\n    const rightPx = regionReversed\n      ? (regionEnd - fStart) * inverseBpPerPx\n      : (fEnd - regionStart) * inverseBpPerPx\n\n    // create reduced features, avoiding multiple features per px\n    if (Math.floor(leftPx) !== Math.floor(prevLeftPx) || rightPx - leftPx > 1) {\n      reducedFeatures.push(feature)\n      prevLeftPx = leftPx\n    }\n    const score = feature.get('score')\n    hasClipping = hasClipping || score > niceMax || score < niceMin\n    const w = rightPx - leftPx + fudgeFactor\n    if (score >= scaleOpts.domain[0]!) {\n      ctx.fillStyle = cb(feature, score)\n      ctx.fillRect(leftPx, 0, w, height)\n    } else {\n      ctx.fillStyle = '#eee'\n      ctx.fillRect(leftPx, 0, w, height)\n    }\n  }\n\n  // second pass: draw clipping\n  // avoid persisting the red fillstyle with save/restore\n  ctx.save()\n  if (hasClipping) {\n    ctx.fillStyle = clipColor\n    for (const feature of features.values()) {\n      checkStopToken2(lastCheck)\n      const fStart = feature.get('start')\n      const fEnd = feature.get('end')\n      const leftPx = regionReversed\n        ? (regionEnd - fEnd) * inverseBpPerPx\n        : (fStart - regionStart) * inverseBpPerPx\n      const rightPx = regionReversed\n        ? (regionEnd - fStart) * inverseBpPerPx\n        : (fEnd - regionStart) * inverseBpPerPx\n      const w = rightPx - leftPx + fudgeFactor\n      const score = feature.get('score')\n      if (score > niceMax) {\n        fillRectCtx(leftPx, 0, w, clipHeight, ctx)\n      } else if (score < niceMin && scaleOpts.scaleType !== 'log') {\n        fillRectCtx(leftPx, 0, w, clipHeight, ctx)\n      }\n    }\n  }\n  ctx.restore()\n\n  return {\n    reducedFeatures,\n  }\n}\n"],"names":["async","renderDensity","renderProps","features","height","regions","bpPerPx","statusCallback","region","width","end","start","reducedFeatures","rest","updateStatus","renderToAbstractCanvas","ctx","drawDensity","serialized","map","serializeWiggleFeature","rpcResult","collectTransferables","props","scaleOpts","config","stopToken","lastCheck","createStopTokenChecker","regionStart","regionEnd","regionReversed","reversed","inverseBpPerPx","pivot","readConfObject","pivotValue","negColor","posColor","color","clipColor","crossing","scaleType","scale","getScale","undefined","range","cb","_","score","feature","domain","niceMin","niceMax","prevLeftPx","Number","NEGATIVE_INFINITY","hasClipping","values","checkStopToken2","fStart","get","fEnd","leftPx","rightPx","Math","floor","push","w","fillStyle","fillRect","save","fillRectCtx","restore"],"ignoreList":[],"sourceRoot":""}