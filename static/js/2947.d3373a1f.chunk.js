"use strict";(globalThis.webpackChunk_jbrowse_web=globalThis.webpackChunk_jbrowse_web||[]).push([[2947],{10420:(t,e,n)=>{n.d(e,{Z:()=>r});var s=n(99546),o=n(94026);function r(t,e,n){const r=-1===n?(0,s.revcom)(e):e,i=t.split(";"),a=[];for(const t of i){if(""===t)continue;const e=t.split(","),s=e[0],i=o.k.exec(s);if(!i)throw new Error(`bad format for MM tag: "${t}"`);const[,c,f,p]=i,d=p.split(/(\d+|.)/);"-"===f&&(console.warn("unsupported negative strand modifications"),a.push({type:"unsupported",positions:[],base:c,strand:f}));for(const t of d){if(""===t)continue;let s=0;const o=[];for(let t=1,i=e.length;t<i;t++){let i=+e[t];do{"N"!==c&&c!==r[s]||i--,s++}while(i>=0&&s<r.length);if(-1===n){const t=r.length-s;t>=0&&o.unshift(t)}else o.push(s-1)}a.push({type:t,base:c,strand:f,positions:o})}}return a}},52947:(t,e,n)=>{n.r(e),n.d(e,{default:()=>S});var s=n(46377),o=n(66885),r=n(6434),i=n(44728),a=n(82088),c=n(86576),f=n(99546),p=n(37347);function d({feature:t,bins:e,region:n}){const s=t.get("start"),o=t.get("end"),r=t.get("strand"),i=n.end-n.start;for(let t=s;t<o+1;t++){const s=t-n.start;s>=0&&s<i&&(void 0===e[s]&&(e[s]={depth:0,readsCounted:0,ref:{probabilities:[],entryDepth:0,"-1":0,0:0,1:0},snps:{},mods:{},nonmods:{},delskips:{},noncov:{}}),t!==o&&(e[s].depth++,e[s].readsCounted++,e[s].ref.entryDepth++,e[s].ref[r]++))}}function u(t){return l(t.type)?1:t.length}function l(t){return"softclip"===t||"hardclip"===t||"insertion"===t}function h(t,e,n,s){let o=t[n][s];void 0===o&&(o=t[n][s]={entryDepth:0,probabilities:[],"-1":0,0:0,1:0}),o.entryDepth++,o[e]++}function g(t,e,n,s,o){let r=t[n][s];void 0===r&&(r=t[n][s]={entryDepth:0,probabilities:[],"-1":0,0:0,1:0}),r.entryDepth++,r.probabilities.push(o),r[e]++}function b({feature:t,region:e,bins:n,skipmap:s}){const o=t.get("start"),r=t.get("strand"),i=t.get("mismatches")??[];for(const a of i){const i=o+a.start,c=u(a),f=i+c;for(let t=i;t<i+c;t++){const s=t-e.start;if(s>=0&&s<n.length){const t=n[s],{base:e,altbase:o,type:i}=a,c=l(i);"deletion"===i||"skip"===i?(h(t,r,"delskips",i),t.depth--):c?h(t,r,"noncov",i):(h(t,r,"snps",e),t.ref.entryDepth--,t.ref[r]--,t.refbase=o)}}if("skip"===a.type){const e=t.get("tags"),n=e?.XS||e?.TS,o=e?.ts,a="+"===n?1:"-"===n?-1:("+"===o?1:"-"===n?-1:0)*r,c=`${i}_${f}_${a}`;void 0===s[c]&&(s[c]={feature:t,start:i,end:f,strand:r,effectiveStrand:a,score:0}),s[c].score++}}}var m=n(59509);function y({feature:t,colorBy:e,region:n,bins:s,regionSequence:o}){const r=t.get("start"),i=t.get("strand"),a=t.get("end"),c=e?.modifications?.twoColor,p=e?.modifications?.isolatedModification;(0,m.r)(t)?.forEach(({allProbs:t,prob:e,type:d},u)=>{if(p&&d!==p)return;const l=u+r-n.start;if(l>=0&&l<s.length&&u+r<a){void 0===s[l]&&(s[l]={depth:0,readsCounted:0,snps:{},ref:{probabilities:[],entryDepth:0,"-1":0,0:0,1:0},mods:{},nonmods:{},delskips:{},noncov:{}});const n=1-(0,f.sum)(t),r=s[l];r.refbase=o[l],c&&n>(0,f.max)(t)?g(r,i,"nonmods",`nonmod_${d}`,n):g(r,i,"mods",`mod_${d}`,e)}u++})}var w=n(95805),v=n(69276);function M({feature:t,region:e,bins:n,regionSequence:s}){const o=t.get("start"),r=t.get("end"),i=t.get("strand"),a=t.get("seq"),c=t.get("mismatches")??[],p=s.toLowerCase();if(a){const s=(0,w.parseCigar)(t.get("CIGAR")),{methBins:a,methProbs:d}=(0,v.P)(t,s),u=c.filter(t=>"deletion"===t.type);for(let t=0;t<r-o;t++){const s=t+o,r=p[s-e.start+1],c=p[s-e.start+2];if("c"===r&&"g"===c){const r=n[s-e.start],c=n[s-e.start+1],p=a[t],l=a[t+1],h=d[t],b=d[t+1];p&&(void 0===h||h>.5)||l&&(void 0===b||b>.5)?(r&&(g(r,i,"mods","cpg_meth",h||0),r.ref.entryDepth--,r.ref[i]--),c&&(g(c,i,"mods","cpg_meth",b||0),c.ref.entryDepth--,c.ref[i]--)):(r&&(u.some(t=>(0,f.doesIntersect2)(s,s+1,t.start+o,t.start+o+t.length))||(g(r,i,"nonmods","cpg_unmeth",1-(h||0)),r.ref.entryDepth--,r.ref[i]--)),c&&(u.some(t=>(0,f.doesIntersect2)(s+1,s+2,t.start+o,t.start+o+t.length))||(g(c,i,"nonmods","cpg_unmeth",1-(b||0)),c.ref.entryDepth--,c.ref[i]--)))}}}}class S extends s.BaseFeatureDataAdapter{async configure(){const t=this.getConf("subadapter"),e=t.sequenceAdapter,n=await(this.getSubAdapter?.(t)),s=e?await(this.getSubAdapter?.(e)):void 0;if(!n)throw new Error("Failed to get subadapter");return{subadapter:n.dataAdapter,sequenceAdapter:s?.dataAdapter}}async fetchSequence(t){const{sequenceAdapter:e}=await this.configure();if(e)return(0,c.Iw)(t,e)}getFeatures(t,e={}){return(0,o.ObservableCreate)(async n=>{const{subadapter:s}=await this.configure(),o=await(0,i._)(s.getFeatures(t,e).pipe((0,a.$)())),{bins:c,skipmap:u}=await async function({fetchSequence:t,features:e,region:n,opts:s}){const{stopToken:o,colorBy:r}=s,i={},a=[],c=Math.max(0,n.start-1),u=n.start-c;let l=performance.now();for(const s of e)performance.now()-l>400&&((0,p.SW)(o),l=performance.now()),d({feature:s,bins:a,region:n}),"modifications"===r?.type?y({feature:s,colorBy:r,bins:a,region:n,regionSequence:(await t({...n,start:c,end:n.end+1})||"").slice(u)}):"methylation"===r?.type&&M({feature:s,bins:a,region:n,regionSequence:await t({...n,start:c,end:n.end+1})||""}),b({feature:s,skipmap:i,bins:a,region:n});for(const t of a)t&&(t.mods=Object.fromEntries(Object.entries(t.mods).map(([t,e])=>[t,{...e,avgProbability:e.probabilities.length?(0,f.sum)(e.probabilities)/e.probabilities.length:void 0}])),t.nonmods=Object.fromEntries(Object.entries(t.nonmods).map(([t,e])=>[t,{...e,avgProbability:e.probabilities.length?(0,f.sum)(e.probabilities)/e.probabilities.length:void 0}])));return{bins:a,skipmap:i}}({features:o,region:t,opts:e,fetchSequence:t=>this.fetchSequence(t)});let l=0;for(const e of c){if(e){const s=t.start+l;n.next(new r.A({id:`${this.id}-${s}`,data:{score:e.depth,snpinfo:e,start:s,end:s+1,refName:t.refName}}))}l++}for(const[t,e]of Object.entries(u))n.next(new r.A({id:t,data:{type:"skip",start:e.start,end:e.end,strand:e.strand,score:e.score,effectiveStrand:e.effectiveStrand}}));n.complete()},e.stopToken)}async getMultiRegionFeatureDensityStats(t,e){const{subadapter:n}=await this.configure();return n.getMultiRegionFeatureDensityStats(t,e)}async getRefNames(t={}){const{subadapter:e}=await this.configure();return e.getRefNames(t)}}},59509:(t,e,n)=>{n.d(e,{r:()=>c});var s=n(95805),o=n(49256),r=n(10420),i=n(60515),a=n(86576);function c(t,e){const n=t.get("strand"),c=t.get("seq"),f=(0,a.c$)(t,"MM","Mm")||"",p=e||(0,s.parseCigar)(t.get("CIGAR"));if(c){const e=(0,r.Z)(f,c,n),s=(0,i.Y)(t),a=[];let d=0;for(const{type:t,positions:r}of e){for(const{ref:e,idx:i}of(0,o.h)(p,r)){const o=s?.[d+(-1===n?r.length-1-i:i)]||0;if(a[e]){const n=a[e];a[e]={allProbs:[...n.allProbs,o],prob:Math.max(n.prob,o),type:n.prob>o?n.type:t}}else a[e]={type:t,prob:o,allProbs:[o]}}d+=r.length}return a}}},60515:(t,e,n)=>{n.d(e,{Y:()=>o});var s=n(86576);function o(t){const e=(0,s.c$)(t,"ML","Ml")||[];if(e){const t=[];if("string"==typeof e){const n=e.split(",");for(let e=0,s=n.length;e<s;e++)t.push(+n[e]/255)}else for(let n=0,s=e.length;n<s;n++)t.push(e[n]/255);return t}{const e=(0,s.c$)(t,"MP","Mp");if(e){const t=[];for(let n=0,s=e.length;n<s;n++){const s=e.charCodeAt(n)-33;t.push(Math.min(1,s/50))}return t}return}}},69276:(t,e,n)=>{n.d(e,{P:()=>a});var s=n(49256),o=n(10420),r=n(60515),i=n(86576);function a(t,e){const n=t.get("start"),a=t.get("end"),c=t.get("strand"),f=a-n,p=(0,i.c$)(t,"MM","Mm")||"",d=[],u=[],l=[],h=[],g=t.get("seq");if(g){const n=(0,r.Y)(t),i=(0,o.Z)(p,g,c);let a=0;for(const{type:t,positions:o}of i){for(const{ref:r,idx:i}of(0,s.h)(e,o)){if(r<0||r>=f)continue;const e=a+(-1===c?o.length-1-i:i),s=n?.[e]||0;"m"===t?(d[r]=1,l[r]=s):"h"===t&&(u[r]=1,h[r]=s)}a+=o.length}}return{methBins:d,hydroxyMethBins:u,methProbs:l,hydroxyMethProbs:h}}}}]);
//# sourceMappingURL=2947.d3373a1f.chunk.js.map