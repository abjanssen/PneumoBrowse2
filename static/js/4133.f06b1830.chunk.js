"use strict";(globalThis.webpackChunk_jbrowse_web=globalThis.webpackChunk_jbrowse_web||[]).push([[4133],{47046:(t,e,r)=>{r.d(e,{A:()=>a});class s{}class n{constructor(){this.signals=new Set,this.abortController=new AbortController}addSignal(t=new s){if(this.signal.aborted)throw new Error("cannot add a signal, already aborted!");this.signals.add(t),t.aborted?this.handleAborted(t):"function"==typeof t.addEventListener&&t.addEventListener("abort",(()=>{this.handleAborted(t)}))}handleAborted(t){this.signals.delete(t),0===this.signals.size&&this.abortController.abort()}get signal(){return this.abortController.signal}abort(){this.abortController.abort()}}class i{constructor(){this.callbacks=new Set}addCallback(t=()=>{}){this.callbacks.add(t),t(this.currentMessage)}callback(t){this.currentMessage=t;for(const e of this.callbacks)e(t)}}class a{constructor({fill:t,cache:e}){if("function"!=typeof t)throw new TypeError("must pass a fill function");if("object"!=typeof e)throw new TypeError("must pass a cache object");if("function"!=typeof e.get||"function"!=typeof e.set||"function"!=typeof e.delete)throw new TypeError("cache must implement get(key), set(key, val), and and delete(key)");this.cache=e,this.fillCallback=t}static isAbortException(t){return"AbortError"===t.name||"ERR_ABORTED"===t.code||"AbortError: aborted"===t.message||"Error: aborted"===t.message}evict(t,e){this.cache.get(t)===e&&this.cache.delete(t)}fill(t,e,r,s){const a=new n,o=new i;o.addCallback(s);const h={aborter:a,promise:this.fillCallback(e,a.signal,(t=>{o.callback(t)})),settled:!1,statusReporter:o,get aborted(){return this.aborter.signal.aborted}};h.aborter.addSignal(r),h.aborter.signal.addEventListener("abort",(()=>{h.settled||this.evict(t,h)})),h.promise.then((()=>{h.settled=!0}),(()=>{h.settled=!0,this.evict(t,h)})).catch((t=>{throw console.error(t),t})),this.cache.set(t,h)}static checkSinglePromise(t,e){function r(){if(null==e?void 0:e.aborted)throw Object.assign(new Error("aborted"),{code:"ERR_ABORTED"})}return t.then((t=>(r(),t)),(t=>{throw r(),t}))}has(t){return this.cache.has(t)}get(t,e,r,s){if(!r&&e instanceof AbortSignal)throw new TypeError("second get argument appears to be an AbortSignal, perhaps you meant to pass `null` for the fill data?");const n=this.cache.get(t);return n?n.aborted&&!n.settled?(this.evict(t,n),this.get(t,e,r,s)):n.settled?n.promise:(n.aborter.addSignal(r),n.statusReporter.addCallback(s),a.checkSinglePromise(n.promise,r)):(this.fill(t,e,r,s),a.checkSinglePromise(this.cache.get(t).promise,r))}delete(t){const e=this.cache.get(t);e&&(e.settled||e.aborter.abort(),this.cache.delete(t))}clear(){const t=this.cache.keys();let e=0;for(let r=t.next();!r.done;r=t.next())this.delete(r.value),e+=1;return e}}},34133:(t,e,r)=>{r.d(e,{j9:()=>P,Wg:()=>A});class s{constructor(t,e){this.blockPosition=t,this.dataPosition=e}toString(){return`${this.blockPosition}:${this.dataPosition}`}compareTo(t){return this.blockPosition-t.blockPosition||this.dataPosition-t.dataPosition}static min(...t){let e,r=0;for(;!e;r+=1)e=t[r];for(;r<t.length;r+=1)e.compareTo(t[r])>0&&(e=t[r]);return e}}function n(t,e=0,r=!1){if(r)throw new Error("big-endian virtual file offsets not implemented");return new s(1099511627776*t[e+7]+4294967296*t[e+6]+16777216*t[e+5]+65536*t[e+4]+256*t[e+3]+t[e+2],t[e+1]<<8|t[e])}class i{constructor(t,e,r,s){this.minv=t,this.maxv=e,this.bin=r,this._fetchedSize=s}toUniqueString(){return`${this.minv.toString()}..${this.maxv.toString()} (bin ${this.bin}, fetchedSize ${this.fetchedSize()})`}toString(){return this.toUniqueString()}compareTo(t){return this.minv.compareTo(t.minv)||this.maxv.compareTo(t.maxv)||this.bin-t.bin}fetchedSize(){return void 0!==this._fetchedSize?this._fetchedSize:this.maxv.blockPosition+65536-this.minv.blockPosition}}var a=r(59086),o=r.n(a);function h(t){return new Promise((e=>setTimeout(e,t)))}function c(t,e){const r=[];let s;if(0===t.length)return t;t.sort(((t,e)=>{const r=t.minv.blockPosition-e.minv.blockPosition;return 0===r?t.minv.dataPosition-e.minv.dataPosition:r}));for(const a of t)(!e||a.maxv.compareTo(e)>0)&&(void 0===s?(r.push(a),s=a):(n=s,(i=a).minv.blockPosition-n.maxv.blockPosition<65e3&&i.maxv.blockPosition-n.minv.blockPosition<5e6?a.maxv.compareTo(s.maxv)>0&&(s.maxv=a.maxv):(r.push(a),s=a)));var n,i;return r}function l(t,e){return{lineCount:function(t){if(t.greaterThan(Number.MAX_SAFE_INTEGER)||t.lessThan(Number.MIN_SAFE_INTEGER))throw new Error("integer overflow");return t.toNumber()}(o().fromBytesLE(Array.prototype.slice.call(t,e,e+8),!0))}}function d(t,e){return t?t.compareTo(e)>0?e:t:e}function f(t,e=t=>t){let r=0,s=0;const n=[],i={};for(let a=0;a<t.length;a+=1)if(!t[a]){if(s<a){let o=t.toString("utf8",s,a);o=e(o),n[r]=o,i[o]=r}s=a+1,r+=1}return{refNameToId:i,refIdToName:n}}class u{constructor({filehandle:t,renameRefSeq:e=t=>t}){this.filehandle=t,this.renameRefSeq=e}}class g extends u{async lineCount(t,e){var r,s;return(null===(s=null===(r=(await this.parse(e)).indices[t])||void 0===r?void 0:r.stats)||void 0===s?void 0:s.lineCount)||0}async _parse(t){const e=await this.filehandle.readFile(t);if(21578050!==e.readUInt32LE(0))throw new Error("Not a BAI file");const r=e.readInt32LE(4);let s,a=8;const o=new Array(r);for(let t=0;t<r;t++){const r=e.readInt32LE(a);let h;a+=4;const c={};for(let t=0;t<r;t+=1){const t=e.readUInt32LE(a);if(a+=4,37450===t)a+=4,h=l(e,a+16),a+=32;else{if(t>37450)throw new Error("bai index contains too many bins, please use CSI");{const r=e.readInt32LE(a);a+=4;const o=new Array(r);for(let h=0;h<r;h++){const r=n(e,a);a+=8;const c=n(e,a);a+=8,s=d(s,r),o[h]=new i(r,c,t)}c[t]=o}}}const f=e.readInt32LE(a);a+=4;const u=new Array(f);for(let t=0;t<f;t++){const r=n(e,a);a+=8,s=d(s,r),u[t]=r}o[t]={binIndex:c,linearIndex:u,stats:h}}return{bai:!0,firstDataLine:s,maxBlockSize:65536,indices:o,refCount:r}}async indexCov(t,e,r,s={}){const n=16384,i=void 0!==e,a=(await this.parse(s)).indices[t];if(!a)return[];const{linearIndex:o=[],stats:h}=a;if(0===o.length)return[];const c=void 0===r?(o.length-1)*n:(l=r)-l%n+16384;var l;const d=void 0===e?0:function(t){return t-t%16384}(e),f=new Array(i?(c-d)/n:o.length-1),u=o[o.length-1].blockPosition;if(c>(o.length-1)*n)throw new Error("query outside of range of linear index");let g=o[d/n].blockPosition;for(let t=d/n,e=0;t<c/n;t++,e++)f[e]={score:o[t+1].blockPosition-g,start:t*n,end:t*n+n},g=o[t+1].blockPosition;return f.map((t=>({...t,score:t.score*((null==h?void 0:h.lineCount)||0)/u})))}async blocksForRange(t,e,r,s={}){e<0&&(e=0);const n=await this.parse(s);if(!n)return[];const i=n.indices[t];if(!i)return[];const a=(h=r,[[0,0],[1+((o=e)>>26),1+((h-=1)>>26)],[9+(o>>23),9+(h>>23)],[73+(o>>20),73+(h>>20)],[585+(o>>17),585+(h>>17)],[4681+(o>>14),4681+(h>>14)]]);var o,h;const l=[];for(const[t,e]of a)for(let r=t;r<=e;r++)if(i.binIndex[r]){const t=i.binIndex[r];for(const e of t)l.push(e)}const d=i.linearIndex.length;let f;const u=Math.min(e>>14,d-1),g=Math.min(r>>14,d-1);for(let t=u;t<=g;++t){const e=i.linearIndex[t];e&&(!f||e.compareTo(f)<0)&&(f=e)}return c(l,f)}async parse(t={}){return this.setupP||(this.setupP=this._parse(t).catch((t=>{throw this.setupP=void 0,t}))),this.setupP}async hasRefSeq(t,e={}){var r;return!!(null===(r=(await this.parse(e)).indices[t])||void 0===r?void 0:r.binIndex)}}var b=r(35451),m=r(91454),p=r(7706),w=r(45834),_=r(47046),y=r(16308),v=r.n(y);function E(t,e){return Math.floor(t/2**e)}class x extends u{constructor(){super(...arguments),this.maxBinNumber=0,this.depth=0,this.minShift=0}async lineCount(t,e){var r,s;return(null===(s=null===(r=(await this.parse(e)).indices[t])||void 0===r?void 0:r.stats)||void 0===s?void 0:s.lineCount)||0}async indexCov(){return[]}parseAuxData(t,e){const r=t.readInt32LE(e),s=65536&r?"zero-based-half-open":"1-based-closed",n={0:"generic",1:"SAM",2:"VCF"}[15&r];if(!n)throw new Error(`invalid Tabix preset format flags ${r}`);const i={ref:t.readInt32LE(e+4),start:t.readInt32LE(e+8),end:t.readInt32LE(e+12)},a=t.readInt32LE(e+16),o=a?String.fromCharCode(a):"",h=t.readInt32LE(e+20),c=t.readInt32LE(e+24);return{columnNumbers:i,coordinateType:s,metaValue:a,metaChar:o,skipLines:h,format:n,formatFlags:r,...f(t.subarray(e+28,e+28+c),this.renameRefSeq)}}async _parse(t){const e=await this.filehandle.readFile(t),r=await(0,p.unzip)(e);let s;if(21582659===r.readUInt32LE(0))s=1;else{if(38359875!==r.readUInt32LE(0))throw new Error("Not a CSI file");s=2}this.minShift=r.readInt32LE(4),this.depth=r.readInt32LE(8),this.maxBinNumber=((1<<3*(this.depth+1))-1)/7;const a=r.readInt32LE(12),o=a>=30?this.parseAuxData(r,16):void 0,h=r.readInt32LE(16+a);let c,f=16+a+4;const u=new Array(h);for(let t=0;t<h;t++){const e=r.readInt32LE(f);f+=4;const s={};let a;for(let t=0;t<e;t++){const t=r.readUInt32LE(f);if(f+=4,t>this.maxBinNumber)a=l(r,f+28),f+=44;else{c=d(c,n(r,f)),f+=8;const e=r.readInt32LE(f);f+=4;const a=new Array(e);for(let s=0;s<e;s+=1){const e=n(r,f);f+=8;const o=n(r,f);f+=8,c=d(c,e),a[s]=new i(e,o,t)}s[t]=a}}u[t]={binIndex:s,stats:a}}return{csiVersion:s,firstDataLine:c,indices:u,refCount:h,csi:!0,maxBlockSize:65536,...o}}async blocksForRange(t,e,r,n={}){e<0&&(e=0);const i=await this.parse(n),a=null==i?void 0:i.indices[t];if(!a)return[];const o=this.reg2bins(e,r);if(0===o.length)return[];const h=[];for(const[t,e]of o)for(let r=t;r<=e;r++)if(a.binIndex[r]){const t=a.binIndex[r];for(const e of t)h.push(e)}return c(h,new s(0,0))}reg2bins(t,e){(t-=1)<1&&(t=1),e>2**50&&(e=2**34),e-=1;let r=0,s=0,n=this.minShift+3*this.depth;const i=[];for(;r<=this.depth;n-=3,s+=1*2**(3*r),r+=1){const r=s+E(t,n),a=s+E(e,n);if(a-r+i.length>this.maxBinNumber)throw new Error(`query ${t}-${e} is too large for current binning scheme (shift ${this.minShift}, depth ${this.depth}), try a smaller query or a coarser index binning scheme`);i.push([r,a])}return i}async parse(t={}){return this.setupP||(this.setupP=this._parse(t).catch((t=>{throw this.setupP=void 0,t}))),this.setupP}async hasRefSeq(t,e={}){var r;return!!(null===(r=(await this.parse(e)).indices[t])||void 0===r?void 0:r.binIndex)}}const I="=ACMGRSVTWYHKDBN".split(""),k="MIDNSHP=X???????".split("");class S{constructor(t){this.data={},this._tagList=[],this._allTagsParsed=!1;const{bytes:e,fileOffset:r}=t,{byteArray:s,start:n}=e;this.data={start:s.readInt32LE(n+8)},this.bytes=e,this._id=r,this._refID=s.readInt32LE(n+4),this.flags=(4294901760&s.readInt32LE(n+16))>>16}get(t){return this[t]?(this.data[t]||(this.data[t]=this[t]()),this.data[t]):this._get(t.toLowerCase())}end(){return this.get("start")+this.get("length_on_ref")}seq_id(){return this._refID}_get(t){return t in this.data||(this.data[t]=this._parseTag(t)),this.data[t]}_tags(){this._parseAllTags();let t=["seq"];this.isSegmentUnmapped()||t.push("start","end","strand","score","qual","MQ","CIGAR","length_on_ref","template_length"),this.isPaired()&&t.push("next_segment_position","pair_orientation"),t=t.concat(this._tagList||[]);for(const e of Object.keys(this.data))e.startsWith("_")||"next_seq_id"===e||t.push(e);const e={};return t.filter((t=>{if(t in this.data&&void 0===this.data[t]||"CG"===t||"cg"===t)return!1;const r=t.toLowerCase(),s=e[r];return e[r]=!0,!s}))}parent(){}children(){return this.get("subfeatures")}id(){return this._id}mq(){const t=(65280&this.get("_bin_mq_nl"))>>8;return 255===t?void 0:t}score(){return this.get("mq")}qual(){var t;return null===(t=this.qualRaw())||void 0===t?void 0:t.join(" ")}qualRaw(){if(this.isSegmentUnmapped())return;const{start:t,byteArray:e}=this.bytes,r=t+36+this.get("_l_read_name")+4*this.get("_n_cigar_op")+this.get("_seq_bytes"),s=this.get("seq_length");return e.subarray(r,r+s)}strand(){return this.isReverseComplemented()?-1:1}multi_segment_next_segment_strand(){if(!this.isMateUnmapped())return this.isMateReverseComplemented()?-1:1}name(){return this.get("_read_name")}_read_name(){const t=this.get("_l_read_name"),{byteArray:e,start:r}=this.bytes;return e.toString("ascii",r+36,r+36+t-1)}_parseTag(t){if(this._allTagsParsed)return;const{byteArray:e,start:r}=this.bytes;let s=this._tagOffset||r+36+this.get("_l_read_name")+4*this.get("_n_cigar_op")+this.get("_seq_bytes")+this.get("seq_length");const n=this.bytes.end;let i;for(;s<n&&i!==t;){const r=String.fromCharCode(e[s],e[s+1]);i=r.toLowerCase();const a=String.fromCharCode(e[s+2]);let o;switch(s+=3,a){case"A":o=String.fromCharCode(e[s]),s+=1;break;case"i":o=e.readInt32LE(s),s+=4;break;case"I":o=e.readUInt32LE(s),s+=4;break;case"c":o=e.readInt8(s),s+=1;break;case"C":o=e.readUInt8(s),s+=1;break;case"s":o=e.readInt16LE(s),s+=2;break;case"S":o=e.readUInt16LE(s),s+=2;break;case"f":o=e.readFloatLE(s),s+=4;break;case"Z":case"H":for(o="";s<=n;){const t=e[s++];if(0===t)break;o+=String.fromCharCode(t)}break;case"B":{o="";const t=e[s++],n=String.fromCharCode(t),i=e.readInt32LE(s);if(s+=4,"i"===n)if("CG"===r)for(let t=0;t<i;t++){const t=e.readInt32LE(s);o+=(t>>4)+k[15&t],s+=4}else for(let t=0;t<i;t++)o+=e.readInt32LE(s),t+1<i&&(o+=","),s+=4;if("I"===n)if("CG"===r)for(let t=0;t<i;t++){const t=e.readUInt32LE(s);o+=(t>>4)+k[15&t],s+=4}else for(let t=0;t<i;t++)o+=e.readUInt32LE(s),t+1<i&&(o+=","),s+=4;if("s"===n)for(let t=0;t<i;t++)o+=e.readInt16LE(s),t+1<i&&(o+=","),s+=2;if("S"===n)for(let t=0;t<i;t++)o+=e.readUInt16LE(s),t+1<i&&(o+=","),s+=2;if("c"===n)for(let t=0;t<i;t++)o+=e.readInt8(s),t+1<i&&(o+=","),s+=1;if("C"===n)for(let t=0;t<i;t++)o+=e.readUInt8(s),t+1<i&&(o+=","),s+=1;if("f"===n)for(let t=0;t<i;t++)o+=e.readFloatLE(s),t+1<i&&(o+=","),s+=4;break}default:console.warn(`Unknown BAM tag type '${a}', tags may be incomplete`),o=void 0,s=n}if(this._tagOffset=s,this._tagList.push(r),i===t)return o;this.data[i]=o}this._allTagsParsed=!0}_parseAllTags(){this._parseTag("")}_parseCigar(t){return t.match(/\d+\D/g).map((t=>[/\D/.exec(t)[0].toUpperCase(),Number.parseInt(t,10)]))}isPaired(){return!!(1&this.flags)}isProperlyPaired(){return!!(2&this.flags)}isSegmentUnmapped(){return!!(4&this.flags)}isMateUnmapped(){return!!(8&this.flags)}isReverseComplemented(){return!!(16&this.flags)}isMateReverseComplemented(){return!!(32&this.flags)}isRead1(){return!!(64&this.flags)}isRead2(){return!!(128&this.flags)}isSecondary(){return!!(256&this.flags)}isFailedQc(){return!!(512&this.flags)}isDuplicate(){return!!(1024&this.flags)}isSupplementary(){return!!(2048&this.flags)}cigar(){if(this.isSegmentUnmapped())return;const{byteArray:t,start:e}=this.bytes,r=this.get("_n_cigar_op");let s=e+36+this.get("_l_read_name");const n=this.get("seq_length");let i="",a=0,o=t.readInt32LE(s),h=o>>4,c=k[15&o];if("S"===c&&h===n)return s+=4,o=t.readInt32LE(s),h=o>>4,c=k[15&o],"N"!==c&&console.warn("CG tag with no N tag"),this.data.length_on_ref=h,this.get("CG");for(let e=0;e<r;++e)o=t.readInt32LE(s),h=o>>4,c=k[15&o],i+=h+c,"H"!==c&&"S"!==c&&"I"!==c&&(a+=h),s+=4;return this.data.length_on_ref=a,i}length_on_ref(){return this.data.length_on_ref||this.get("cigar"),this.data.length_on_ref}_n_cigar_op(){return 65535&this.get("_flag_nc")}_l_read_name(){return 255&this.get("_bin_mq_nl")}_seq_bytes(){return this.get("seq_length")+1>>1}getReadBases(){return this.seq()}seq(){const{byteArray:t,start:e}=this.bytes,r=e+36+this.get("_l_read_name")+4*this.get("_n_cigar_op"),s=this.get("_seq_bytes"),n=this.get("seq_length");let i="",a=0;for(let e=0;e<s;++e){const s=t[r+e];i+=I[(240&s)>>4],a++,a<n&&(i+=I[15&s],a++)}return i}getPairOrientation(){if(!this.isSegmentUnmapped()&&!this.isMateUnmapped()&&this._refID===this._next_refid()){const t=this.isReverseComplemented()?"R":"F",e=this.isMateReverseComplemented()?"R":"F";let r=" ",s=" ";this.isRead1()?(r="1",s="2"):this.isRead2()&&(r="2",s="1");const n=[];return this.template_length()>0?(n[0]=t,n[1]=r,n[2]=e,n[3]=s):(n[2]=t,n[3]=r,n[0]=e,n[1]=s),n.join("")}return""}_bin_mq_nl(){return this.bytes.byteArray.readInt32LE(this.bytes.start+12)}_flag_nc(){return this.bytes.byteArray.readInt32LE(this.bytes.start+16)}seq_length(){return this.bytes.byteArray.readInt32LE(this.bytes.start+20)}_next_refid(){return this.bytes.byteArray.readInt32LE(this.bytes.start+24)}_next_pos(){return this.bytes.byteArray.readInt32LE(this.bytes.start+28)}template_length(){return this.bytes.byteArray.readInt32LE(this.bytes.start+32)}toJSON(){const t={};for(const e of Object.keys(this))e.startsWith("_")||"bytes"===e||(t[e]=this[e]);return t}}function C(t){const e=t.split(/\r?\n/),r=[];for(const t of e){const[e,...s]=t.split(/\t/);e&&r.push({tag:e.slice(1),data:s.map((t=>{const e=t.indexOf(":");return{tag:t.slice(0,e),value:t.slice(e+1)}}))})}return r}const T=21840194;class L{read(){throw new Error("never called")}stat(){throw new Error("never called")}readFile(){throw new Error("never called")}close(){throw new Error("never called")}}class P{constructor({bamFilehandle:t,bamPath:e,bamUrl:r,baiPath:s,baiFilehandle:n,baiUrl:i,csiPath:a,csiFilehandle:o,csiUrl:h,htsget:c,yieldThreadTime:l=100,renameRefSeqs:d=t=>t}){if(this.htsget=!1,this.featureCache=new _.A({cache:new(v())({maxSize:50}),fill:async(t,e)=>{const{chunk:r,opts:s}=t,{data:n,cpositions:i,dpositions:a}=await this._readChunk({chunk:r,opts:{...s,signal:e}});return this.readBamFeatures(n,i,a,r)}}),this.renameRefSeq=d,t)this.bam=t;else if(e)this.bam=new w.EY(e);else if(r)this.bam=new w.Tx(r);else{if(!c)throw new Error("unable to initialize bam");this.htsget=!0,this.bam=new L}if(o)this.index=new x({filehandle:o});else if(a)this.index=new x({filehandle:new w.EY(a)});else if(h)this.index=new x({filehandle:new w.Tx(h)});else if(n)this.index=new g({filehandle:n});else if(s)this.index=new g({filehandle:new w.EY(s)});else if(i)this.index=new g({filehandle:new w.Tx(i)});else if(e)this.index=new g({filehandle:new w.EY(`${e}.bai`)});else if(r)this.index=new g({filehandle:new w.Tx(`${r}.bai`)});else{if(!c)throw new Error("unable to infer index format");this.htsget=!0}this.yieldThreadTime=l}async getHeaderPre(t){const e=function(t={}){return"aborted"in t?{signal:t}:t}(t);if(!this.index)return;const r=await this.index.parse(e),s=r.firstDataLine?r.firstDataLine.blockPosition+65535:void 0;let n;if(s){const t=s+65536,r=await this.bam.read(b.Buffer.alloc(t),0,t,0,e);if(!r.bytesRead)throw new Error("Error reading header");n=r.buffer.subarray(0,Math.min(r.bytesRead,s))}else n=await this.bam.readFile(e);const i=await(0,p.unzip)(n);if(i.readInt32LE(0)!==T)throw new Error("Not a BAM file");const a=i.readInt32LE(4);this.header=i.toString("utf8",8,8+a);const{chrToIndex:o,indexToChr:h}=await this._readRefSeqs(a+8,65535,e);return this.chrToIndex=o,this.indexToChr=h,C(this.header)}getHeader(t){return this.headerP||(this.headerP=this.getHeaderPre(t).catch((t=>{throw this.headerP=void 0,t}))),this.headerP}async getHeaderText(t={}){return await this.getHeader(t),this.header}async _readRefSeqs(t,e,r){if(t>e)return this._readRefSeqs(t,2*e,r);const s=e+65536,{bytesRead:n,buffer:i}=await this.bam.read(b.Buffer.alloc(s),0,e,0,r);if(!n)throw new Error("Error reading refseqs from header");const a=await(0,p.unzip)(i.subarray(0,Math.min(n,e))),o=a.readInt32LE(t);let h=t+4;const c={},l=[];for(let s=0;s<o;s+=1){const n=a.readInt32LE(h),i=this.renameRefSeq(a.toString("utf8",h+4,h+4+n-1)),o=a.readInt32LE(h+n+4);if(c[i]=s,l.push({refName:i,length:o}),h=h+8+n,h>a.length)return console.warn(`BAM header is very big.  Re-fetching ${e} bytes.`),this._readRefSeqs(t,2*e,r)}return{chrToIndex:c,indexToChr:l}}async getRecordsForRange(t,e,r,s){return async function(t){let e=[];for await(const r of t)e=e.concat(r);return e}(this.streamRecordsForRange(t,e,r,s))}async*streamRecordsForRange(t,e,r,s){var n;await this.getHeader(s);const i=null===(n=this.chrToIndex)||void 0===n?void 0:n[t];if(void 0!==i&&this.index){const t=await this.index.blocksForRange(i,e-1,r,s);yield*this._fetchChunkFeatures(t,i,e,r,s)}else yield[]}async*_fetchChunkFeatures(t,e,r,s,n={}){const{viewAsPairs:i}=n,a=[];let o=!1;for(const i of t){const t=await this.featureCache.get(i.toString(),{chunk:i,opts:n},n.signal),h=[];for(const n of t)if(n.seq_id()===e){if(n.get("start")>=s){o=!0;break}n.get("end")>=r&&h.push(n)}if(a.push(h),yield h,o)break}(function(t){if(t&&t.aborted){if("undefined"==typeof DOMException){const t=new Error("aborted");throw t.code="ERR_ABORTED",t}throw new DOMException("aborted","AbortError")}})(n.signal),i&&(yield this.fetchPairs(e,a,n))}async fetchPairs(t,e,r){const{pairAcrossChr:s,maxInsertSize:n=2e5}=r,i={},a={};e.map((t=>{const e={};for(const r of t){const t=r.name(),s=r.id();e[t]||(e[t]=0),e[t]++,a[s]=1}for(const[t,r]of Object.entries(e))1===r&&(i[t]=!0)}));const o=[];e.map((e=>{for(const a of e){const e=a.name(),h=a.get("start"),c=a._next_pos(),l=a._next_refid();this.index&&i[e]&&(s||l===t&&Math.abs(h-c)<n)&&o.push(this.index.blocksForRange(l,c,c+1,r))}}));const h=new Map,c=await Promise.all(o);for(const t of c.flat())h.has(t.toString())||h.set(t.toString(),t);return(await Promise.all([...h.values()].map((async t=>{const{data:e,cpositions:s,dpositions:n,chunk:o}=await this._readChunk({chunk:t,opts:r}),h=[];for(const t of await this.readBamFeatures(e,s,n,o))i[t.get("name")]&&!a[t.id()]&&h.push(t);return h})))).flat()}async _readRegion(t,e,r={}){const{bytesRead:s,buffer:n}=await this.bam.read(b.Buffer.alloc(e),0,e,t,r);return n.subarray(0,Math.min(s,e))}async _readChunk({chunk:t,opts:e}){const r=await this._readRegion(t.minv.blockPosition,t.fetchedSize(),e),{buffer:s,cpositions:n,dpositions:i}=await(0,p.i2)(r,t);return{data:s,cpositions:n,dpositions:i,chunk:t}}async readBamFeatures(t,e,r,s){let n=0;const i=[];let a=0,o=+Date.now();for(;n+4<t.length;){const c=n+4+t.readInt32LE(n)-1;if(r){for(;n+s.minv.dataPosition>=r[a++];);a--}if(c<t.length){const l=new S({bytes:{byteArray:t,start:n,end:c},fileOffset:e.length>0?256*e[a]+(n-r[a])+s.minv.dataPosition+1:m.A.signed(t.slice(n,c))});i.push(l),this.yieldThreadTime&&+Date.now()-o>this.yieldThreadTime&&(await h(1),o=+Date.now())}n=c+1}return i}async hasRefSeq(t){var e,r;const s=null===(e=this.chrToIndex)||void 0===e?void 0:e[t];return void 0!==s&&(null===(r=this.index)||void 0===r?void 0:r.hasRefSeq(s))}async lineCount(t){var e;const r=null===(e=this.chrToIndex)||void 0===e?void 0:e[t];return void 0!==r&&this.index?this.index.lineCount(r):0}async indexCov(t,e,r){var s;if(!this.index)return[];await this.index.parse();const n=null===(s=this.chrToIndex)||void 0===s?void 0:s[t];return void 0===n?[]:this.index.indexCov(n,e,r)}async blocksForRange(t,e,r,s){var n;if(!this.index)return[];await this.index.parse();const i=null===(n=this.chrToIndex)||void 0===n?void 0:n[t];return void 0===i?[]:this.index.blocksForRange(i,e,r,s)}}async function R(t,e){const r=await Promise.all(t.map((async t=>{const{url:r,headers:s}=t;if(r.startsWith("data:"))return b.Buffer.from(r.split(",")[1],"base64");{const{referer:t,...n}=s,i=await fetch(r,{...e,headers:{...null==e?void 0:e.headers,...n}});if(!i.ok)throw new Error(`HTTP ${i.status} fetching ${r}: ${await i.text()}`);return b.Buffer.from(await i.arrayBuffer())}})));return b.Buffer.concat(await Promise.all(r.map((t=>(0,p.unzip)(t)))))}class A extends P{constructor(t){super({htsget:!0}),this.baseUrl=t.baseUrl,this.trackId=t.trackId}async*streamRecordsForRange(t,e,r,s){var n;const i=`${this.baseUrl}/${this.trackId}?referenceName=${t}&start=${e}&end=${r}&format=BAM`,a=null===(n=this.chrToIndex)||void 0===n?void 0:n[t];if(void 0===a)yield[];else{const n=await fetch(i,{...s});if(!n.ok)throw new Error(`HTTP ${n.status} fetching ${i}: ${await n.text()}`);const o=await n.json(),h=await R(o.htsget.urls.slice(1),s);yield*this._fetchChunkFeatures([{buffer:h,_fetchedSize:void 0,bin:0,compareTo:()=>0,toUniqueString:()=>`${t}_${e}_${r}`,fetchedSize:()=>0,minv:{dataPosition:0,blockPosition:0,compareTo:()=>0},maxv:{dataPosition:Number.MAX_SAFE_INTEGER,blockPosition:0,compareTo:()=>0},toString:()=>`${t}_${e}_${r}`}],a,e,r,s)}}async _readChunk({chunk:t}){if(!t.buffer)throw new Error("expected chunk.buffer in htsget");return{data:t.buffer,cpositions:[],dpositions:[],chunk:t}}async getHeader(t={}){const e=`${this.baseUrl}/${this.trackId}?referenceName=na&class=header`,r=await fetch(e,t);if(!r.ok)throw new Error(`HTTP ${r.status} fetching ${e}: ${await r.text()}`);const s=await r.json(),n=await R(s.htsget.urls,t);if(n.readInt32LE(0)!==T)throw new Error("Not a BAM file");const i=n.readInt32LE(4),a=C(n.toString("utf8",8,8+i)),o=[],h={},c=a.filter((t=>"SQ"===t.tag));for(const[t,e]of c.entries()){let r="",s=0;for(const t of e.data)"SN"===t.tag?r=t.value:"LN"===t.tag&&(s=+t.value);h[r]=t,o[t]={refName:r,length:s}}return this.chrToIndex=h,this.indexToChr=o,a}}}}]);
//# sourceMappingURL=4133.f06b1830.chunk.js.map