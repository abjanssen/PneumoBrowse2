{"version":3,"file":"static/js/1822.738b8027.chunk.js","mappings":"2MAiBA,SAASA,EAAYC,GACnB,MAAMC,EAAWD,EAAIE,MAAMF,EAAIG,YAAY,KAAO,GAClD,OAAOF,EAASC,MAAM,EAAGD,EAASE,YAAY,KAChD,CAuCe,MAAMC,UAA2BC,EAAAA,uBAC9C,oBAA6B,CAC3B,gBACA,gBACA,kBAGF,iBAAaC,GACX,MAAMC,EAAgBC,KAAKD,cAC3B,IAAKA,EACH,MAAM,IAAIE,MAAM,8BAElB,IAAIC,EAAWF,KAAKG,QAAQ,eAiC5B,OAhCKD,GAAUE,SAEbF,EADgBF,KAAKG,QAAQ,WACVE,IAAIC,IAAS,CAC9BC,KAAM,gBACNC,OAAQjB,EAAYe,GACpBG,eAAgB,CACdjB,IAAKc,aAUOI,QAAQC,IACxBT,EAASG,IAAIO,UACX,MAAMC,SAAqBd,EAAce,IACtCD,YACGL,EACJM,EAAKN,QACLM,EAAKC,MApEf,SAAsCC,GACpC,IAEE,GAAoB,kBAAhBA,EAAOT,MAA4BS,EAAOP,eAAgB,CAC5D,MAAMQ,EAAWD,EAAOP,eACxB,GAAI,QAASQ,GAAYA,EAASzB,IAChC,OAAOD,EAAY0B,EAASzB,KAE9B,GAAI,cAAeyB,GAAYA,EAASC,UACtC,OAAO3B,EAAY0B,EAASC,WAE9B,GAAI,SAAUD,GAAYA,EAASE,KAAM,CACvC,MAAMA,EAAOF,EAASE,KACtB,OAAOA,EAAKJ,KAAOxB,EAAY4B,EAAKJ,WAAQK,CAC9C,CACF,CAGA,MACF,CAAE,MAAOC,GACP,MACF,CACF,CA+CUC,CAA6BR,IAC7BD,EAAYU,GACd,MAAO,IACFT,EACHD,cACAL,YAKR,CAGA,iBAAagB,CAAYC,GACvB,MAAMC,QAAiB1B,KAAKF,cACtB6B,QAAiBjB,QAAQC,IAC7Be,EAASrB,IAAIuB,GAAKA,EAAEf,YAAYW,YAAYC,KAE9C,MAAO,IAAI,IAAII,IAAIF,EAASG,QAC9B,CAEA,oBAAaC,CAAeN,GAC1B,MAAMC,QAAiB1B,KAAKF,cACtBkC,SACGtB,QAAQC,IAEbe,EAASrB,IAAI4B,GAAOA,EAAIpB,YAAYkB,iBAAiBN,MAEvDS,OAAOC,KAAOA,GAChB,MAAO,CACLC,UAAUC,EAAAA,EAAAA,KAAIL,EAAM3B,IAAIiC,GAAKA,EAAEF,WAC/BG,UAAUC,EAAAA,EAAAA,KAAIR,EAAM3B,IAAIiC,GAAKA,EAAEC,WAEnC,CAEOE,WAAAA,CAAYC,EAAgBjB,EAAsB,CAAC,GACxD,OAAOkB,EAAAA,EAAAA,kBAA0B/B,UAC/B,MAAMc,QAAiB1B,KAAKF,eAC5B8C,EAAAA,EAAAA,MACKlB,EAASrB,IAAI4B,GACdA,EAAIpB,YAAY4B,YAAYC,EAAQjB,GAAMoB,MACxCxC,EAAAA,EAAAA,GAAIyC,GAEFA,EAAEC,IAAI,UACFD,EACA,IAAIE,EAAAA,cAAc,IACbF,EAAEG,SACLC,SAAU,GAAGjB,EAAIzB,UAAUsC,EAAEvB,OAC7Bf,OAAQyB,EAAIzB,aAKxB2C,UAAUC,IACX3B,EAAK4B,UACV,CAGA,uCAAMC,CAAkCC,GACtC,MAAO,CACLC,eAAgB,EAEpB,CAIA,gBAAMC,CAAWF,GAEf,aADuBvD,KAAKF,eACZO,IAAI,EAAGE,OAAME,iBAAgBI,iBAAgB6C,MACpD,IACFA,EACH3C,KAAM2C,EAAKlD,SAGjB,E","sources":["../../../plugins/wiggle/src/MultiWiggleAdapter/MultiWiggleAdapter.ts"],"sourcesContent":["import { BaseFeatureDataAdapter } from '@jbrowse/core/data_adapters/BaseAdapter'\nimport { SimpleFeature, max, min } from '@jbrowse/core/util'\nimport { ObservableCreate } from '@jbrowse/core/util/rxjs'\nimport { merge } from 'rxjs'\nimport { map } from 'rxjs/operators'\n\nimport type { BaseOptions } from '@jbrowse/core/data_adapters/BaseAdapter'\nimport type { Feature } from '@jbrowse/core/util'\nimport type {\n  AugmentedRegion as Region,\n  FileLocation,\n} from '@jbrowse/core/util/types'\n\ninterface WiggleOptions extends BaseOptions {\n  resolution?: number\n}\n\nfunction getFilename(uri: string) {\n  const filename = uri.slice(uri.lastIndexOf('/') + 1)\n  return filename.slice(0, filename.lastIndexOf('.'))\n}\n\n/**\n * Extract filename from a config, only works for BigWigAdapter\n * Could try to generalize across more adapter types potentially\n */\nfunction getFilenameFromAdapterConfig(config: any) {\n  try {\n    // Handle BigWigAdapter specifically\n    if (config.type === 'BigWigAdapter' && config.bigWigLocation) {\n      const location = config.bigWigLocation as FileLocation\n      if ('uri' in location && location.uri) {\n        return getFilename(location.uri)\n      }\n      if ('localPath' in location && location.localPath) {\n        return getFilename(location.localPath)\n      }\n      if ('blob' in location && location.blob) {\n        const blob = location.blob as File\n        return blob.name ? getFilename(blob.name) : undefined\n      }\n    }\n\n    // Fallback for other adapter types or locations\n    return undefined\n  } catch (e) {\n    return undefined\n  }\n}\n\ninterface AdapterEntry {\n  dataAdapter: BaseFeatureDataAdapter\n  source: string\n  name: string\n  [key: string]: unknown\n}\n\ntype MaybeStats = { scoreMin: number; scoreMax: number } | undefined\n\nexport default class MultiWiggleAdapter extends BaseFeatureDataAdapter {\n  public static capabilities = [\n    'hasResolution',\n    'hasLocalStats',\n    'hasGlobalStats',\n  ]\n\n  public async getAdapters(): Promise<AdapterEntry[]> {\n    const getSubAdapter = this.getSubAdapter\n    if (!getSubAdapter) {\n      throw new Error('no getSubAdapter available')\n    }\n    let subConfs = this.getConf('subadapters')\n    if (!subConfs?.length) {\n      const entries = this.getConf('bigWigs') as string[]\n      subConfs = entries.map(entry => ({\n        type: 'BigWigAdapter',\n        source: getFilename(entry),\n        bigWigLocation: {\n          uri: entry,\n        },\n      }))\n    }\n\n    // There was confusion about whether source or name was required, and\n    // effort to remove one or the other was thwarted. Adapters like\n    // BigWigAdapter, even in the BigWigAdapter configSchema.ts, use a 'source'\n    // field though, while the word 'name' still allowed in the config too. To\n    // solve, we made name===source\n    const ret = await Promise.all(\n      subConfs.map(async (conf: any) => {\n        const dataAdapter = (await getSubAdapter(conf))\n          .dataAdapter as BaseFeatureDataAdapter\n        const source =\n          conf.source ||\n          conf.name ||\n          getFilenameFromAdapterConfig(conf) ||\n          dataAdapter.id\n        return {\n          ...conf,\n          dataAdapter,\n          source,\n        }\n      }),\n    )\n    return ret\n  }\n\n  // note: can't really have dis-agreeing refNames\n  public async getRefNames(opts?: BaseOptions) {\n    const adapters = await this.getAdapters()\n    const allNames = await Promise.all(\n      adapters.map(a => a.dataAdapter.getRefNames(opts)),\n    )\n    return [...new Set(allNames.flat())]\n  }\n\n  public async getGlobalStats(opts?: BaseOptions) {\n    const adapters = await this.getAdapters()\n    const stats = (\n      (await Promise.all(\n        // @ts-expect-error\n        adapters.map(adp => adp.dataAdapter.getGlobalStats?.(opts)),\n      )) as MaybeStats[]\n    ).filter(f => !!f)\n    return {\n      scoreMin: min(stats.map(s => s.scoreMin)),\n      scoreMax: max(stats.map(s => s.scoreMax)),\n    }\n  }\n\n  public getFeatures(region: Region, opts: WiggleOptions = {}) {\n    return ObservableCreate<Feature>(async observer => {\n      const adapters = await this.getAdapters()\n      merge(\n        ...adapters.map(adp =>\n          adp.dataAdapter.getFeatures(region, opts).pipe(\n            map(p =>\n              // add source field if it does not exist\n              p.get('source')\n                ? p\n                : new SimpleFeature({\n                    ...p.toJSON(),\n                    uniqueId: `${adp.source}-${p.id()}`,\n                    source: adp.source,\n                  }),\n            ),\n          ),\n        ),\n      ).subscribe(observer)\n    }, opts.stopToken)\n  }\n\n  // always render bigwig instead of calculating a feature density for it\n  async getMultiRegionFeatureDensityStats(_regions: Region[]) {\n    return {\n      featureDensity: 0,\n    }\n  }\n\n  // in another adapter type, this could be dynamic depending on region or\n  // something, but it is static for this particular multi-wiggle adapter type\n  async getSources(_regions: Region[]) {\n    const adapters = await this.getAdapters()\n    return adapters.map(({ type, bigWigLocation, dataAdapter, ...rest }) => {\n      return {\n        ...rest,\n        name: rest.source,\n      }\n    })\n  }\n}\n"],"names":["getFilename","uri","filename","slice","lastIndexOf","MultiWiggleAdapter","BaseFeatureDataAdapter","getAdapters","getSubAdapter","this","Error","subConfs","getConf","length","map","entry","type","source","bigWigLocation","Promise","all","async","dataAdapter","conf","name","config","location","localPath","blob","undefined","e","getFilenameFromAdapterConfig","id","getRefNames","opts","adapters","allNames","a","Set","flat","getGlobalStats","stats","adp","filter","f","scoreMin","min","s","scoreMax","max","getFeatures","region","ObservableCreate","merge","pipe","p","get","SimpleFeature","toJSON","uniqueId","subscribe","observer","stopToken","getMultiRegionFeatureDensityStats","_regions","featureDensity","getSources","rest"],"sourceRoot":""}