"use strict";(globalThis.webpackChunk_jbrowse_web=globalThis.webpackChunk_jbrowse_web||[]).push([[107],{107(e,t,s){s.d(t,{default:()=>p});var r=s(28651),a=s(48455),i=s(77251),n=s(37759),o=s(33624),c=s(86618),h=s(52901);const d={77:0,73:1,68:2,78:3,83:4,72:5,80:6,61:7,88:8};var u=s(35702),l=s(54257),g=s(47354);const f=new Uint8Array([77,73,68,78,83,72,80,61,88,63,63,63,63,63,63,63]);class m{constructor(e,t){this.record=e,this._store=t}get name(){return this.record.readName}get start(){return this.record.alignmentStart-1}get end(){return this.start+(this.record.lengthOnRef??1)}get score(){return this.record.mappingQuality}get flags(){return this.record.flags}get strand(){return this.record.isReverseComplemented()?-1:1}get qual(){return(this.record.qualityScores||[]).join(" ")}get qualRaw(){return this.record.qualityScores}get refName(){return this._store.refIdToName(this.record.sequenceId)}get pair_orientation(){return this.record.isPaired()?this.record.getPairOrientation():void 0}get template_length(){return this.record.templateLength||this.record.templateSize}get next_ref(){return this.record.mate?this._store.refIdToName(this.record.mate.sequenceId):void 0}get next_segment_position(){return this.record.mate?`${this._store.refIdToName(this.record.mate.sequenceId)}:${this.record.mate.alignmentStart}`:void 0}get is_paired(){return!!this.record.mate}get next_pos(){return this.record.mate?.alignmentStart}get tags(){const e=this._store.samHeader?.readGroups[this.record.readGroupId];return void 0!==e?{...this.record.tags,RG:e}:this.record.tags}get seq(){return this.record.getReadBases()}get NUMERIC_CIGAR(){return function(e,t,s){const r=[];let a=77,i=0,n=t,o=0,c=0;if(void 0!==e)for(let t=0,s=e.length;t<s;t++){const{code:s,refPos:h,data:u}=e[t],l=h-n;if(c+=l,n=h,o&&l){const e=d[73];r.push(o<<4|e),o=0}if(i&&77!==a){const e=d[a];r.push(i<<4|e),i=0}l&&(a=77,i+=l);const g=s.charCodeAt(0);if(98===g){const e=u.split(",").length;c+=e,n+=e,i+=e}else if(66===g||88===g)c++,n++,i++;else if(68===g||78===g){if(n+=u,i){const e=d[a];r.push(i<<4|e),i=0}const e=d[g];r.push(u<<4|e)}else if(73===g||83===g){const e=u.length;if(c+=e,i){const e=d[a];r.push(i<<4|e),i=0}const t=d[g];r.push(e<<4|t)}else if(105===g){if(i){const e=d[a];r.push(i<<4|e),i=0}o++,c++}else if(80===g||72===g){if(i){const e=d[a];r.push(i<<4|e),i=0}const e=d[g];r.push(u<<4|e)}}const h=s-c;if(h){if(i&&77!==a){const e=d[a];r.push(i<<4|e),i=0}a=77,i+=h}if(h&&o){const e=d[73];r.push(o<<4|e)}if(i){const e=d[a];r.push(i<<4|e)}return r}(this.record.readFeatures,this.record.alignmentStart,this.record.readLength)}get CIGAR(){const e=this.NUMERIC_CIGAR;let t="";for(let s=0,r=e.length;s<r;s++){const r=e[s],a=r>>4,i=f[15&r];t+=a+u.sO[i]}return t}id(){return`${this._store.id}-${this.record.uniqueId}`}get(e){switch(e){case"mismatches":return this.mismatches;case"qual":return this.qual;case"CIGAR":return this.CIGAR;case"NUMERIC_CIGAR":return this.NUMERIC_CIGAR;default:return this.fields[e]}}parent(){}children(){}get mismatches(){const e=[];return this.forEachMismatch((t,s,r,a,i,n,o)=>{t===l.oq?e.push({type:"mismatch",start:s,length:r,base:a,qual:void 0!==i&&i>=0?i:void 0,altbase:void 0!==n&&n>0?u.sO[n]:void 0}):t===l.jm?e.push({type:"insertion",start:s,length:r,insertlen:o,insertedBases:a}):t===l.eC?e.push({type:"softclip",start:s,length:r,cliplen:o}):t===l.bU?e.push({type:"hardclip",start:s,length:r,cliplen:o}):e.push({type:2===t?"deletion":"skip",start:s,length:r})}),e}forEachMismatch(e){const t=this.record.readFeatures;if(!t)return;const s=this.start,r=this.qualRaw,a=!!r,i=t.length;let n=0,o=s,c="",h=0;for(let d=0;d<i;d++){const i=t[d],u=n-o;o=n,u&&h>0&&(e(l.jm,n,0,c,-1,0,h),c="",h=0),n=i.refPos-1-s;const g=i.code.charCodeAt(0);if(88===g){const t=i.ref?-33&i.ref.charCodeAt(0):0;e(l.oq,n,1,i.sub,a?r[i.pos-1]:-1,t,0)}else if(73===g)e(l.jm,n,0,i.data,-1,0,i.data.length);else if(78===g)e(l.D,n,i.data,"N",-1,0,0);else if(83===g){const t=i.data.length;e(l.eC,n,1,`S${t}`,-1,0,t)}else 72===g?e(l.bU,n,1,`H${i.data}`,-1,0,i.data):68===g?e(l.YX,n,i.data,"*",-1,0,0):105===g&&(c+=i.data,h++)}h>0&&e(l.jm,n,0,c,-1,0,h)}get fields(){return{start:this.start,name:this.name,end:this.end,score:this.score,strand:this.strand,template_length:this.template_length,flags:this.flags,tags:(0,g.ce)(this.tags),refName:this.refName,seq:this.seq,type:"match",pair_orientation:this.pair_orientation,next_ref:this.next_ref,next_pos:this.next_pos,next_segment_position:this.next_segment_position,uniqueId:this.id()}}toJSON(){return{...this.fields,CIGAR:this.CIGAR,qual:this.qual}}}(0,g.Kt)(m,"fields"),(0,g.Kt)(m,"CIGAR"),(0,g.Kt)(m,"NUMERIC_CIGAR"),(0,g.Kt)(m,"mismatches");class p extends a.L{ultraLongFeatureCache=new n.A({maxSize:500});seqIdToOriginalRefName=[];configure(){if(!this.configureResult){const e=this.getConf("cramLocation"),t=this.getConf("craiLocation");this.configureResult={cram:new r.bQ({cramFilehandle:(0,o.openLocation)(e,this.pluginManager),index:new r.Wb({filehandle:(0,o.openLocation)(t,this.pluginManager)}),seqFetch:async(e,t,s)=>{const r=await this.getSequenceAdapter();if(!r)throw new Error("no sequenceAdapter available");const a=this.refIdToOriginalName(e)||this.refIdToName(e);if(!a)throw new Error("unknown refName");return await r.getSequence({refName:a,start:t-1,end:s})??""},checkSequenceMD5:!1})}}return this.configureResult}async getSequenceAdapter(){const e=this.sequenceAdapterConfig;if(e&&this.getSubAdapter)return this.sequenceAdapterP??=this.getSubAdapter(e).then(e=>e.dataAdapter).catch(e=>{throw this.sequenceAdapterP=void 0,e}),this.sequenceAdapterP}async getHeader(e){const{cram:t}=this.configure();return t.cram.getHeaderText()}async setup(e){return this.setupP??=(async()=>{const{cram:e}=this.configure(),t=await e.cram.getSamHeader(),s=(0,g.cY)(t);return this.samHeader=s,{samHeader:s,cram:e}})().catch(e=>{throw this.setupP=void 0,this.configureResult=void 0,e}),this.setupP}async getRefNames(e){const{samHeader:t}=await this.setup(e);return t.idToName}refNameToId(e){return this.samHeader?.nameToId[e]}refIdToName(e){return this.samHeader?.idToName[e]}refIdToOriginalName(e){return this.seqIdToOriginalRefName[e]}getFeatures(e,t){const{stopToken:s,filterBy:r,statusCallback:a=()=>{}}=t||{},{refName:n,start:o,end:d,originalRefName:u}=e;return(0,c.ObservableCreate)(async e=>{const{cram:c,samHeader:l}=await this.setup(t),f=this.refNameToId(n);if(void 0===f)return console.warn("Unknown refName",n),void e.complete();let p;u&&(this.seqIdToOriginalRefName[f]=u);try{p=await(0,i.updateStatus)("Downloading alignments",a,()=>c.getRecordsForRange(f,o,d))}catch(e){throw this.setupP=void 0,this.configureResult=void 0,e}(0,h.SW)(s),await(0,i.updateStatus)("Processing alignments",a,()=>{const{flagInclude:t=0,flagExclude:s=0,tagFilter:a,readName:i}=r||{};for(const r of p)if(!(0,g.lE)(r.flags,t,s)&&!(a&&(0,g.Kl)("RG"===a.tag?l.readGroups[r.readGroupId]:r.tags[a.tag],a.value)||i&&r.readName!==i))if(r.readLength>5e3){const t=this.ultraLongFeatureCache.get(r.uniqueId);if(t)e.next(t);else{const t=new m(r,this);this.ultraLongFeatureCache.set(r.uniqueId,t),e.next(t)}}else e.next(new m(r,this));e.complete()})},s)}async getMultiRegionFeatureDensityStats(e){return{bytes:await this.bytesForRegions(e),fetchSizeLimit:this.getConf("fetchSizeLimit")}}async bytesForRegions(e){const{cram:t}=this.configure(),s=await Promise.all(e.map(e=>{const{refName:s,start:r,end:a}=e,i=this.refNameToId(s);return void 0!==i?t.index.getEntriesForRange(i,r,a):Promise.resolve([{sliceBytes:0}])}));return(0,i.sum)(s.flat().map(e=>e.sliceBytes))}}},35702(e,t,s){s.d(t,{A_:()=>f,C4:()=>d,El:()=>m,Tr:()=>l,a2:()=>o,aT:()=>n,hE:()=>i,hK:()=>a,hN:()=>c,oE:()=>u,og:()=>h,q7:()=>g,sO:()=>p,tQ:()=>I});var r=s(35635);const a=0,i=1,n=2,o=3,c=4,h=5,d=7,u=8,l=129,g=389,f="=ACMGRSVTWYHKDBN",m=new Uint8Array([61,97,99,109,103,114,115,118,116,119,121,104,107,100,98,110]),p=Array.from({length:128},(e,t)=>String.fromCharCode(t));function I(e){return"string"==typeof e?(0,r.YJ)(e):e||[]}}}]);
//# sourceMappingURL=107.30568380.chunk.js.map