"use strict";(globalThis.webpackChunk_jbrowse_web=globalThis.webpackChunk_jbrowse_web||[]).push([[3928],{43928(t,e,n){n.d(e,{executeRenderLinearReadArcsDisplay:()=>B});var a=n(38433),r=n(77251),o=n(61132),s=n(83640),i=n(26931),c=n(83090),g=n(68589),d=n(16876),l=n(52901),f=n(99226),u=n(96852),h=n(10596),p=n(35635),m=n(5248);function w(t){return 2*Math.random()*t-t}function x(t,e,n,a){t.strokeStyle=a,t.beginPath(),t.moveTo(e,0),t.lineTo(e,n),t.stroke()}function S(t){return{refName:t.get("refName"),start:t.get("start"),end:t.get("end"),strand:t.get("strand"),tlen:t.get("template_length"),pair_orientation:t.get("pair_orientation"),next_ref:t.get("next_ref")}}function b(t){return{refName:t.get("refName"),start:t.get("start"),end:t.get("end"),strand:t.get("strand")}}function k(t){return"get"in t?t.get("clipLengthAtStartOfRead"):t.clipLengthAtStartOfRead}function y(t){return"get"in t?S(t):t}function v(t){return"get"in t?b(t):t}var P=n(15391),A=n(47354);function R(t,e,n){const a=-1===t.strand;return e?a?t.start:t.end:n?a?t.end:t.start:a?t.start:t.end}function T(t){const{ctx:e,height:n,chainData:a,colorBy:r,drawInter:o,drawLongRange:s,lineWidth:i,jitter:c,view:g,offsetPx:d,stopToken:f}=t,{chains:u,stats:h}=a,T=r.type,_=(0,A.dv)(a);function B(t,a,r){const s=t.strand,l=a.strand,f=R(t,_,!1),u=R(a,_,!0),p=g.bpToPx({refName:t.refName,coord:f})?.offsetPx,m=g.bpToPx({refName:a.refName,coord:u})?.offsetPx;if(void 0!==p&&void 0!==m){const a=(m-p)/2,o=Math.abs(a),g=p-d,f=m-d,u=o>1e4;e.strokeStyle=function(t){const{longRange:e,drawArcInsteadOfBezier:n,hasPaired:a,colorByType:r,k1:o,s1:s,s2:i,absrad:c,stats:g}=t;return e&&n?"red":a?"insertSizeAndOrientation"===r?(0,P.sY)(o,g)[0]:"orientation"===r?(0,P.DW)(o)[0]:"insertSize"===r?(0,P.L9)(o,g)?.[0]||"grey":"gradient"===r?`hsl(${10*Math.log10(c)},50%,50%)`:"grey":"orientation"===r||"insertSizeAndOrientation"===r?-1===s&&1===i?"navy":1===s&&-1===i?"green":"grey":"gradient"===r?`hsl(${10*Math.log10(c)},50%,50%)`:"grey"}({longRange:r,drawArcInsteadOfBezier:u,hasPaired:_,colorByType:T,k1:t,s1:s,s2:l,absrad:o,stats:h});const S=Math.min(n+w(c),o);o<1?(e.fillStyle=e.strokeStyle,e.fillRect(g,0,f-g,Math.max(o,i))):r&&o>1e5?(x(e,g+w(c),n,"red"),x(e,f+w(c),n,"red")):r&&u?(e.moveTo(g,0),e.beginPath(),e.arc(g+a+w(c),0,o,0,Math.PI),e.stroke()):function(t,e,n,a,r){t.beginPath(),t.moveTo(e,0),t.bezierCurveTo(e+w(r),a,n,a,n+w(r),0),t.stroke()}(e,g,g+2*a,S,c)}else p&&o&&x(e,p-d,n,"purple")}function N(t){B(S(t),function(t){const e=(t.get("flags")||0)&m.KS?-1:1;return{refName:t.get("next_ref")||"",start:t.get("next_pos")||0,end:t.get("next_pos")||0,strand:e}}(t),!0)}function M(t){const e=[t,...(0,p.Cu)((0,p.bH)(t,"SA"),t.id(),t.get("strand"),t.get("name"))].toSorted((t,e)=>k(t)-k(e));for(let t=0,n=e.length;t<n-1;t++)B(y(e[t]),v(e[t+1]),!0)}function W(t){const e=_?function(t){const e=[];for(const n of t){const t=n.get("flags");t&m.fs||t&m.q3||e.push(n)}return e}(t):function(t){const e=[];for(const n of t)n.get("flags")&m.ap||e.push(n);return e.sort((t,e)=>t.get("clipLengthAtStartOfRead")-e.get("clipLengthAtStartOfRead")),e}(t);for(let t=0,n=e.length;t<n-1;t++)B(S(e[t]),b(e[t+1]),!1)}e.lineWidth=i;const L=(0,l.jL)(f);for(const t of u){if(1===t.length&&s){const e=t[0],n=e.get("flags")&m.q3;_&&!n?N(e):M(e)}else W(t);(0,l.As)(L)}}var _=n(50219);async function B({pluginManager:t,args:e}){const{sessionId:n,view:p,adapterConfig:m,sequenceAdapter:w,colorBy:x,drawInter:S,drawLongRange:b,lineWidth:k,jitter:y,height:v,highResolutionScaling:P,exportSVG:A,statusCallback:R=()=>{},stopToken:B}=e,N=g.A.create(p);p.width&&N.setVolatileWidth(p.width);const{offsetPx:M}=N,W=N.staticBlocks.totalWidthPx,L=N.staticBlocks.contentBlocks,O={...(0,f.getSnapshot)(N),width:N.width,staticBlocks:N.staticBlocks,bpToPx(t){const e=(0,c.eB)({self:this,refName:t.refName,coord:t.coord});return void 0!==e?{offsetPx:e.offsetPx,index:e.index}:void 0}},C=(await(0,a.cK)(t,n,m)).dataAdapter;w&&!C.sequenceAdapterConfig&&C.setSequenceAdapterConfig(w);const I=await(0,r.updateStatus)("Fetching alignments",R,()=>(0,u._)(C.getFeaturesInMultipleRegions(L,e).pipe((0,h.$)())));(0,l.SW)(B);const{chains:j,stats:q}=await(0,r.updateStatus)("Processing alignments",R,async()=>{const t=(0,o.Q)(I,t=>t.id()),e=t.filter(t=>{const e=t.get("flags");return!!(2&e)&&!(256&e||2048&e)});let n;if(e.length){const t=e.filter(t=>{const e=t.get("template_length");return 0!==e&&!Number.isNaN(e)});if(t.length>0){const e=t.map(t=>Math.abs(t.get("template_length")));n={...(0,_.W)(e),max:(0,r.max)(e),min:(0,r.min)(e)}}}return{chains:Object.values((0,r.groupBy)(t,t=>t.get("name"))),stats:n}}),z={chains:j,stats:q};(0,l.SW)(B);const D={highResolutionScaling:P,exportSVG:A},V=await(0,r.updateStatus)("Rendering arcs",R,()=>(0,s.u)(W,v,D,t=>{T({ctx:t,width:W,height:v,chainData:z,colorBy:x,drawInter:S,drawLongRange:b,lineWidth:k,jitter:y,view:O,offsetPx:M,stopToken:B})})),$={...V,offsetPx:M};return(0,d.lk)($,(0,i.X)(V))}},50219(t,e,n){n.d(e,{W:()=>r});var a=n(77251);function r(t){const e=t.length,n=(0,a.sum)(t);let r=0;for(let n=0;n<e;n++){const e=t[n];r+=e*e}const o=n/e,s=Math.sqrt((e*r-n*n)/(e*e));return{upper:o+3*s,lower:o-3*s,avg:o,sd:s}}}}]);
//# sourceMappingURL=3928.99cb8e27.chunk.js.map