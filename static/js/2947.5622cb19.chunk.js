"use strict";(globalThis.webpackChunk_jbrowse_web=globalThis.webpackChunk_jbrowse_web||[]).push([[2947],{52947:(e,t,s)=>{s.r(t),s.d(t,{default:()=>k});var n=s(46377),r=s(66885),o=s(6434),a=s(44728),i=s(82088),c=s(86576),f=s(99546),p=s(37347);function d({feature:e,bins:t,region:s}){const n=e.get("start"),r=e.get("end"),o=e.get("strand"),a=s.end-s.start;for(let e=n;e<r+1;e++){const n=e-s.start;n>=0&&n<a&&(void 0===t[n]&&(t[n]={depth:0,readsCounted:0,ref:{probabilities:[],entryDepth:0,"-1":0,0:0,1:0},snps:{},mods:{},nonmods:{},delskips:{},noncov:{}}),e!==r&&(t[n].depth++,t[n].readsCounted++,t[n].ref.entryDepth++,t[n].ref[o]++))}}function u(e){return b(e.type)?1:e.length}function b(e){return"softclip"===e||"hardclip"===e||"insertion"===e}function g(e,t,s,n){let r=e[s][n];void 0===r&&(r=e[s][n]={entryDepth:0,probabilities:[],"-1":0,0:0,1:0}),r.entryDepth++,r[t]++}function l(e,t,s,n,r){let o=e[s][n];void 0===o&&(o=e[s][n]={entryDepth:0,probabilities:[],"-1":0,0:0,1:0}),o.entryDepth++,o.probabilities.push(r),o[t]++}function h({feature:e,region:t,bins:s,skipmap:n}){const r=e.get("start"),o=e.get("strand"),a=e.get("mismatches")??[];for(const i of a){const a=r+i.start,c=u(i),f=a+c;for(let e=a;e<a+c;e++){const n=e-t.start;if(n>=0&&n<s.length){const e=s[n],{base:t,altbase:r,type:a}=i,c=b(a);"deletion"===a||"skip"===a?(g(e,o,"delskips",a),e.depth--):c?g(e,o,"noncov",a):(g(e,o,"snps",t),e.ref.entryDepth--,e.ref[o]--,e.refbase=r)}}if("skip"===i.type){const t=e.get("tags"),s=t?.XS||t?.TS,r=t?.ts,i="+"===s?1:"-"===s?-1:("+"===r?1:"-"===s?-1:0)*o,c=`${a}_${f}_${i}`;void 0===n[c]&&(n[c]={feature:e,start:a,end:f,strand:o,effectiveStrand:i,score:0}),n[c].score++}}}var m=s(59509);function y({feature:e,colorBy:t,region:s,bins:n,regionSequence:r}){const o=e.get("start"),a=e.get("strand"),i=e.get("end"),c=t?.modifications?.twoColor,p=t?.modifications?.isolatedModification,d=(0,m.r)(e);if(d){let e=0;for(const{type:t,prob:u,allProbs:b}of d){if(p&&t!==p)return;const d=e+o-s.start;if(d>=0&&d<n.length&&e+o<i){void 0===n[d]&&(n[d]={depth:0,readsCounted:0,snps:{},ref:{probabilities:[],entryDepth:0,"-1":0,0:0,1:0},mods:{},nonmods:{},delskips:{},noncov:{}});const e=1-(0,f.sum)(b),s=n[d];s.refbase=r[d],c&&e>(0,f.max)(b)?l(s,a,"nonmods",`nonmod_${t}`,e):l(s,a,"mods",`mod_${t}`,u)}e++}}}var w=s(95805),v=s(93092);function S({feature:e,region:t,bins:s,regionSequence:n}){const r=e.get("start"),o=e.get("end"),a=e.get("strand"),i=e.get("seq"),c=e.get("mismatches")??[],p=n.toLowerCase();if(i){const n=(0,w.parseCigar)(e.get("CIGAR")),{methBins:i,methProbs:d}=(0,v.Ps)(e,n),u=c.filter((e=>"deletion"===e.type));for(let e=0;e<o-r;e++){const n=e+r,o=p[n-t.start+1],c=p[n-t.start+2];if("c"===o&&"g"===c){const o=s[n-t.start],c=s[n-t.start+1],p=i[e],b=i[e+1],g=d[e],h=d[e+1];p&&(void 0===g||g>.5)||b&&(void 0===h||h>.5)?(o&&(l(o,a,"mods","cpg_meth",g||0),o.ref.entryDepth--,o.ref[a]--),c&&(l(c,a,"mods","cpg_meth",h||0),c.ref.entryDepth--,c.ref[a]--)):(o&&(u.some((e=>(0,f.doesIntersect2)(n,n+1,e.start+r,e.start+r+e.length)))||(l(o,a,"nonmods","cpg_unmeth",1-(g||0)),o.ref.entryDepth--,o.ref[a]--)),c&&(u.some((e=>(0,f.doesIntersect2)(n+1,n+2,e.start+r,e.start+r+e.length)))||(l(c,a,"nonmods","cpg_unmeth",1-(h||0)),c.ref.entryDepth--,c.ref[a]--)))}}}}class k extends n.BaseFeatureDataAdapter{async configure(){const e=this.getConf("subadapter"),t=e.sequenceAdapter,s=await(this.getSubAdapter?.(e)),n=t?await(this.getSubAdapter?.(t)):void 0;if(!s)throw new Error("Failed to get subadapter");return{subadapter:s.dataAdapter,sequenceAdapter:n?.dataAdapter}}async fetchSequence(e){const{sequenceAdapter:t}=await this.configure();if(t)return(0,c.Iw)(e,t)}getFeatures(e,t={}){return(0,r.ObservableCreate)((async s=>{const{subadapter:n}=await this.configure(),r=await(0,a._)(n.getFeatures(e,t).pipe((0,i.$)())),{bins:c,skipmap:u}=await async function({fetchSequence:e,features:t,region:s,opts:n}){const{stopToken:r,colorBy:o}=n,a={},i=[],c=Math.max(0,s.start-1),u=s.start-c;let b=performance.now();for(const n of t)performance.now()-b>400&&((0,p.SW)(r),b=performance.now()),d({feature:n,bins:i,region:s}),"modifications"===o?.type?y({feature:n,colorBy:o,bins:i,region:s,regionSequence:(await e({...s,start:c,end:s.end+1})||"").slice(u)}):"methylation"===o?.type&&S({feature:n,bins:i,region:s,regionSequence:await e({...s,start:c,end:s.end+1})||""}),h({feature:n,skipmap:a,bins:i,region:s});for(const e of i)e&&(e.mods=Object.fromEntries(Object.entries(e.mods).map((([e,t])=>[e,{...t,avgProbability:t.probabilities.length?(0,f.sum)(t.probabilities)/t.probabilities.length:void 0}]))),e.nonmods=Object.fromEntries(Object.entries(e.nonmods).map((([e,t])=>[e,{...t,avgProbability:t.probabilities.length?(0,f.sum)(t.probabilities)/t.probabilities.length:void 0}]))));return{bins:i,skipmap:a}}({features:r,region:e,opts:t,fetchSequence:e=>this.fetchSequence(e)});let b=0;for(const t of c){if(t){const n=e.start+b;s.next(new o.A({id:`${this.id}-${n}`,data:{score:t.depth,snpinfo:t,start:n,end:n+1,refName:e.refName}}))}b++}for(const[e,t]of Object.entries(u))s.next(new o.A({id:e,data:{type:"skip",start:t.start,end:t.end,strand:t.strand,score:t.score,effectiveStrand:t.effectiveStrand}}));s.complete()}),t.stopToken)}async getMultiRegionFeatureDensityStats(e,t){const{subadapter:s}=await this.configure();return s.getMultiRegionFeatureDensityStats(e,t)}async getRefNames(e={}){const{subadapter:t}=await this.configure();return t.getRefNames(e)}freeResources(){}}},59509:(e,t,s)=>{s.d(t,{r:()=>i});var n=s(95805),r=s(49256),o=s(93092),a=s(86576);function i(e,t){const s=e.get("strand"),i=e.get("seq"),c=(0,a.c$)(e,"MM","Mm")||"",f=t||(0,n.parseCigar)(e.get("CIGAR"));if(i){const t=(0,o.Z1)(c,i,s),n=(0,o.Yj)(e),a=[];let p=0;for(const{type:e,positions:o}of t){for(const{ref:t,idx:i}of(0,r.h)(f,o)){const r=n?.[p+(-1===s?o.length-1-i:i)]||0;if(a[t]){const s=a[t];a[t]={allProbs:[...s.allProbs,r],prob:Math.max(s.prob,r),type:s.prob>r?s.type:e}}else a[t]={type:e,prob:r,allProbs:[r]}}p+=o.length}return a}}}}]);
//# sourceMappingURL=2947.5622cb19.chunk.js.map