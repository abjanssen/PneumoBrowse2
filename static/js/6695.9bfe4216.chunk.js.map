{"version":3,"file":"static/js/6695.9bfe4216.chunk.js","mappings":"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","sources":["webpack://@jbrowse/web/../../plugins/variants/src/MultiLinearVariantRenderer/makeImageData.ts","webpack://@jbrowse/web/../../plugins/variants/src/shared/drawAlleleCount.ts","webpack://@jbrowse/web/../../plugins/variants/src/shared/drawPhased.ts"],"sourcesContent":["import { featureSpanPx, updateStatus } from '@jbrowse/core/util'\nimport Flatbush from '@jbrowse/core/util/flatbush'\nimport { checkStopToken2 } from '@jbrowse/core/util/stopToken'\n\nimport { f2 } from '../shared/constants.ts'\nimport {\n  drawColorAlleleCount,\n  getAlleleColor,\n} from '../shared/drawAlleleCount.ts'\nimport { drawPhased } from '../shared/drawPhased.ts'\nimport { getFeaturesThatPassMinorAlleleFrequencyFilter } from '../shared/minorAlleleFrequencyUtils.ts'\n\nimport type { MultiRenderArgsDeserialized } from './types.ts'\nimport type { Source } from '../shared/types.ts'\nimport type { Feature, LastStopTokenCheck, Region } from '@jbrowse/core/util'\n\ninterface Maf {\n  feature: Feature\n  mostFrequentAlt: string\n}\n\ninterface DrawContext {\n  ctx: CanvasRenderingContext2D\n  sources: Source[]\n  region: Region\n  bpPerPx: number\n  startRow: number\n  endRow: number\n  h: number\n  drawH: number\n  scrollTop: number\n  splitCache: Record<string, string[]>\n  drawRef: boolean\n  genotypesCache: Map<string, Record<string, string>>\n  stopTokenCheck?: LastStopTokenCheck\n}\n\ninterface ItemData {\n  items: { name: string; genotype: string; featureId: string; bpLen: number }[]\n  coords: number[]\n}\n\nfunction drawPhasedMode(drawCtx: DrawContext, itemData: ItemData, mafs: Maf[]) {\n  const {\n    ctx,\n    sources,\n    region,\n    bpPerPx,\n    startRow,\n    endRow,\n    h,\n    drawH,\n    scrollTop,\n    splitCache,\n    drawRef,\n    genotypesCache,\n    stopTokenCheck,\n  } = drawCtx\n  const { items, coords } = itemData\n  for (const { feature } of mafs) {\n    const [leftPx, rightPx] = featureSpanPx(feature, region, bpPerPx)\n    const featureId = feature.id()\n    const bpLen = feature.get('end') - feature.get('start')\n    const w = Math.max(Math.round(rightPx - leftPx), 2)\n    const x = Math.floor(leftPx)\n    let samp = genotypesCache.get(featureId)\n    if (!samp) {\n      samp = feature.get('genotypes') as Record<string, string>\n      genotypesCache.set(featureId, samp)\n    }\n    const featureType = feature.get('type')\n    const featureStrand = feature.get('strand')\n    const alpha = bpLen > 5 ? 0.75 : 1\n\n    for (let j = startRow; j < endRow; j++) {\n      const y = j * h - scrollTop\n      const source = sources[j]!\n      const { name, HP, baseName } = source\n      const sampleName = baseName ?? name\n      const genotype = samp[sampleName]\n      if (genotype) {\n        const isPhased = genotype.includes('|')\n        if (isPhased) {\n          const alleles =\n            splitCache[genotype] ?? (splitCache[genotype] = genotype.split('|'))\n          if (\n            drawPhased(\n              alleles,\n              ctx,\n              x,\n              y,\n              w,\n              drawH,\n              HP!,\n              undefined,\n              drawRef,\n              alpha,\n              featureType,\n              featureStrand,\n            )\n          ) {\n            items.push({ name, genotype, featureId, bpLen })\n            coords.push(x, y, x + w, y + drawH)\n          }\n        } else {\n          ctx.fillStyle = 'black'\n          ctx.fillRect(x - f2, y - f2, w + f2, drawH + f2)\n        }\n      }\n    }\n    checkStopToken2(stopTokenCheck)\n  }\n}\n\nfunction drawAlleleCountMode(\n  drawCtx: DrawContext,\n  itemData: ItemData,\n  mafs: Maf[],\n  colorCache: Record<string, string | undefined>,\n) {\n  const {\n    ctx,\n    sources,\n    region,\n    bpPerPx,\n    startRow,\n    endRow,\n    h,\n    drawH,\n    scrollTop,\n    splitCache,\n    drawRef,\n    genotypesCache,\n    stopTokenCheck,\n  } = drawCtx\n  const { items, coords } = itemData\n  for (const { mostFrequentAlt, feature } of mafs) {\n    const [leftPx, rightPx] = featureSpanPx(feature, region, bpPerPx)\n    const featureId = feature.id()\n    const bpLen = feature.get('end') - feature.get('start')\n    const w = Math.max(Math.round(rightPx - leftPx), 2)\n    const x = Math.floor(leftPx)\n    let samp = genotypesCache.get(featureId)\n    if (!samp) {\n      samp = feature.get('genotypes') as Record<string, string>\n      genotypesCache.set(featureId, samp)\n    }\n    const featureType = feature.get('type')\n    const featureStrand = feature.get('strand')\n    const alpha = bpLen > 5 ? 0.75 : 1\n\n    for (let j = startRow; j < endRow; j++) {\n      const y = j * h - scrollTop\n      const { name } = sources[j]!\n      const genotype = samp[name]\n      if (genotype) {\n        const c = getAlleleColor(\n          genotype,\n          mostFrequentAlt,\n          colorCache,\n          splitCache,\n          drawRef,\n        )\n        if (c) {\n          drawColorAlleleCount(\n            c,\n            ctx,\n            x,\n            y,\n            w,\n            drawH,\n            featureType,\n            featureStrand,\n            alpha,\n          )\n          items.push({ name, genotype, featureId, bpLen })\n          coords.push(x, y, x + w, y + drawH)\n        }\n      }\n    }\n    checkStopToken2(stopTokenCheck)\n  }\n}\n\nexport async function makeImageData(\n  ctx: CanvasRenderingContext2D,\n  props: MultiRenderArgsDeserialized,\n) {\n  const {\n    scrollTop,\n    minorAlleleFrequencyFilter,\n    sources,\n    rowHeight,\n    height: canvasHeight,\n    features,\n    regions,\n    bpPerPx,\n    renderingMode,\n    stopTokenCheck,\n    lengthCutoffFilter,\n    referenceDrawingMode,\n    statusCallback = () => {},\n  } = props\n  const region = regions[0]!\n\n  const coords = [] as number[]\n  const items = [] as {\n    name: string\n    genotype: string\n    featureId: string\n    bpLen: number\n  }[]\n  const colorCache = {} as Record<string, string | undefined>\n  const splitCache = {} as Record<string, string[]>\n  const genotypesCache = new Map<string, Record<string, string>>()\n  const drawRef = referenceDrawingMode === 'draw'\n  const h = rowHeight\n  const drawH = Math.max(rowHeight, 1)\n  const startRow = Math.floor(scrollTop / h)\n  const endRow = Math.min(\n    sources.length,\n    Math.ceil((scrollTop + canvasHeight) / h),\n  )\n\n  const mafs = await updateStatus('Calculating stats', statusCallback, () =>\n    getFeaturesThatPassMinorAlleleFrequencyFilter({\n      stopTokenCheck,\n      features: features.values(),\n      minorAlleleFrequencyFilter,\n      lengthCutoffFilter,\n      genotypesCache,\n      splitCache,\n    }),\n  )\n\n  const drawCtx: DrawContext = {\n    ctx,\n    sources,\n    region,\n    bpPerPx,\n    startRow,\n    endRow,\n    h,\n    drawH,\n    scrollTop,\n    splitCache,\n    drawRef,\n    genotypesCache,\n    stopTokenCheck,\n  }\n  const itemData: ItemData = { items, coords }\n\n  await updateStatus('Drawing variants', statusCallback, () => {\n    if (renderingMode === 'phased') {\n      drawPhasedMode(drawCtx, itemData, mafs)\n    } else {\n      drawAlleleCountMode(drawCtx, itemData, mafs, colorCache)\n    }\n  })\n\n  const flatbush = new Flatbush(Math.max(items.length, 1))\n  if (items.length) {\n    for (let i = 0, l = coords.length; i < l; i += 4) {\n      flatbush.add(coords[i]!, coords[i + 1]!, coords[i + 2], coords[i + 3])\n    }\n  } else {\n    flatbush.add(0, 0)\n  }\n  flatbush.finish()\n\n  const featureGenotypeMap = {} as Record<\n    string,\n    {\n      alt: unknown\n      ref: unknown\n      name: unknown\n      description: unknown\n      length: number\n    }\n  >\n  for (const { feature } of mafs) {\n    const id = feature.id()\n    featureGenotypeMap[id] = {\n      alt: feature.get('ALT'),\n      ref: feature.get('REF'),\n      name: feature.get('name'),\n      description: feature.get('description'),\n      length: feature.get('end') - feature.get('start'),\n    }\n  }\n\n  return {\n    flatbush: flatbush.data,\n    items,\n    featureGenotypeMap,\n  }\n}\n","import { colord } from '@jbrowse/core/util/colord'\n\nimport {\n  ALT_COLOR_HUE,\n  ALT_COLOR_SATURATION,\n  NO_CALL_COLOR,\n  REFERENCE_COLOR,\n  f2,\n} from './constants.ts'\n\nexport function getAlleleColor(\n  genotype: string,\n  mostFrequentAlt: string,\n  colorCache: Record<string, string | undefined>,\n  splitCache: Record<string, string[]>,\n  drawRef: boolean,\n) {\n  const cacheKey = `${genotype}:${mostFrequentAlt}`\n  let c = colorCache[cacheKey]\n  if (c === undefined) {\n    let alt = 0\n    let uncalled = 0\n    let alt2 = 0\n    let ref = 0\n    const alleles =\n      splitCache[genotype] ?? (splitCache[genotype] = genotype.split(/[/|]/))\n    const total = alleles.length\n\n    for (let i = 0; i < total; i++) {\n      const allele = alleles[i]!\n      if (allele === mostFrequentAlt) {\n        alt++\n      } else if (allele === '0') {\n        ref++\n      } else if (allele === '.') {\n        uncalled++\n      } else {\n        alt2++\n      }\n    }\n    c = getColorAlleleCount(ref, alt, alt2, uncalled, total, drawRef)\n    colorCache[cacheKey] = c\n  }\n  return c\n}\n\nexport function getColorAlleleCount(\n  ref: number,\n  alt: number,\n  alt2: number,\n  uncalled: number,\n  total: number,\n  drawReference = true,\n) {\n  if (ref === total) {\n    return drawReference ? REFERENCE_COLOR : ''\n  }\n\n  if (!(alt || alt2 || uncalled)) {\n    return ''\n  }\n\n  let a1\n  if (alt) {\n    const lightness = 80 - (alt / total) * 50\n    a1 = colord(`hsl(${ALT_COLOR_HUE},${ALT_COLOR_SATURATION}%,${lightness}%)`)\n  }\n  if (alt2) {\n    const alpha = alt2 / total\n    const l = `hsla(0,100%,20%,${alpha})`\n    a1 = a1 ? a1.mix(l) : colord(l)\n  }\n  if (uncalled) {\n    const alpha = uncalled / total\n    const l = NO_CALL_COLOR.replace(')', `,${alpha})`).replace('hsl', 'hsla')\n    a1 = a1 ? a1.mix(l) : colord(l)\n  }\n  return a1?.toHex() || 'black'\n}\n\nexport function drawColorAlleleCount(\n  c: string,\n  ctx: CanvasRenderingContext2D,\n  x: number,\n  y: number,\n  w: number,\n  h: number,\n  featureType = '',\n  featureStrand?: number,\n  alpha = 1,\n) {\n  ctx.fillStyle = alpha !== 1 ? colord(c).alpha(alpha).toHex() : c\n  if (featureType === 'inversion') {\n    if (featureStrand === 1) {\n      ctx.beginPath()\n      ctx.moveTo(x - f2, y - f2)\n      ctx.lineTo(x - f2, y + h + f2)\n      ctx.lineTo(x + w + f2, y + h / 2)\n      ctx.closePath()\n      ctx.fill()\n    } else {\n      ctx.beginPath()\n      ctx.moveTo(x + w + f2, y - f2)\n      ctx.lineTo(x + w + f2, y + h + f2)\n      ctx.lineTo(x - f2, y + h / 2)\n      ctx.closePath()\n      ctx.fill()\n    }\n  } else if (featureType === 'insertion') {\n    const widthExtension = 3\n    ctx.beginPath()\n    ctx.moveTo(x - f2 - widthExtension, y - f2)\n    ctx.lineTo(x + w + f2 + widthExtension, y - f2)\n    ctx.lineTo(x + w / 2, y + h + f2)\n    ctx.closePath()\n    ctx.fill()\n  } else {\n    ctx.fillRect(x - f2, y - f2, w + f2, h + f2)\n  }\n}\n","import { set1 } from '@jbrowse/core/ui/colors'\nimport { colord } from '@jbrowse/core/util/colord'\n\nimport { REFERENCE_COLOR, UNPHASED_COLOR, f2 } from './constants.ts'\n\nfunction colorify(n: number) {\n  return `hsl(${n % 255}, 50%, 50%)`\n}\n\nexport function drawPhased(\n  alleles: string[],\n  ctx: CanvasRenderingContext2D,\n  x: number,\n  y: number,\n  w: number,\n  h: number,\n  HP: number,\n  PS?: string,\n  drawReference = true,\n  alpha = 1,\n  featureType = '',\n  featureStrand?: number,\n) {\n  const allele = +alleles[HP]!\n  const c = allele\n    ? PS !== undefined\n      ? colorify(+PS) || UNPHASED_COLOR\n      : set1[allele - 1] || UNPHASED_COLOR\n    : drawReference\n      ? REFERENCE_COLOR\n      : undefined\n  if (c) {\n    ctx.fillStyle = alpha !== 1 ? colord(c).alpha(alpha).toHex() : c\n    if (featureType === 'inversion') {\n      if (featureStrand === 1) {\n        ctx.beginPath()\n        ctx.moveTo(x - f2, y - f2)\n        ctx.lineTo(x - f2, y + h + f2)\n        ctx.lineTo(x + w + f2, y + h / 2)\n        ctx.closePath()\n        ctx.fill()\n      } else {\n        ctx.beginPath()\n        ctx.moveTo(x + w + f2, y - f2)\n        ctx.lineTo(x + w + f2, y + h + f2)\n        ctx.lineTo(x - f2, y + h / 2)\n        ctx.closePath()\n        ctx.fill()\n      }\n    } else if (featureType === 'insertion') {\n      const widthExtension = 3\n      ctx.beginPath()\n      ctx.moveTo(x - f2 - widthExtension, y - f2)\n      ctx.lineTo(x + w + f2 + widthExtension, y - f2)\n      ctx.lineTo(x + w / 2, y + h + f2)\n      ctx.closePath()\n      ctx.fill()\n    } else {\n      ctx.fillRect(x - f2, y - f2, w + f2, h + f2)\n    }\n  }\n  return c\n}\n"],"names":["async","makeImageData","ctx","props","scrollTop","minorAlleleFrequencyFilter","sources","rowHeight","height","canvasHeight","features","regions","bpPerPx","renderingMode","stopTokenCheck","lengthCutoffFilter","referenceDrawingMode","statusCallback","region","coords","items","colorCache","splitCache","genotypesCache","Map","drawRef","h","drawH","Math","max","startRow","floor","endRow","min","length","ceil","mafs","updateStatus","getFeaturesThatPassMinorAlleleFrequencyFilter","values","drawCtx","itemData","feature","leftPx","rightPx","featureSpanPx","featureId","id","bpLen","get","w","round","x","samp","set","featureType","featureStrand","alpha","j","y","source","name","HP","baseName","genotype","includes","alleles","split","drawPhased","undefined","push","fillStyle","fillRect","f2","checkStopToken2","drawPhasedMode","mostFrequentAlt","c","getAlleleColor","drawColorAlleleCount","drawAlleleCountMode","flatbush","Flatbush","i","l","add","finish","featureGenotypeMap","alt","ref","description","data","cacheKey","uncalled","alt2","total","allele","drawReference","REFERENCE_COLOR","a1","lightness","colord","ALT_COLOR_HUE","ALT_COLOR_SATURATION","mix","NO_CALL_COLOR","replace","toHex","getColorAlleleCount","beginPath","moveTo","lineTo","closePath","fill","widthExtension","PS","UNPHASED_COLOR","set1"],"sourceRoot":""}