{"version":3,"file":"static/js/6479.c658fae6.chunk.js","mappings":"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","sources":["../../../plugins/variants/src/PlinkLDAdapter/PlinkLDTabixAdapter.ts"],"sourcesContent":["import { TabixIndexedFile } from '@gmod/tabix'\nimport { BaseAdapter } from '@jbrowse/core/data_adapters/BaseAdapter'\nimport { updateStatus } from '@jbrowse/core/util'\nimport { openLocation } from '@jbrowse/core/util/io'\n\nimport type { PlinkLDHeader, PlinkLDRecord } from './types.ts'\nimport type { BaseOptions } from '@jbrowse/core/data_adapters/BaseAdapter'\nimport type { NoAssemblyRegion } from '@jbrowse/core/util/types'\n\nexport default class PlinkLDTabixAdapter extends BaseAdapter {\n  private configured?: Promise<{\n    ld: TabixIndexedFile\n    header: PlinkLDHeader\n  }>\n\n  private async configurePre(_opts?: BaseOptions) {\n    const ldLocation = this.getConf('ldLocation')\n    const location = this.getConf(['index', 'location'])\n    const indexType = this.getConf(['index', 'indexType'])\n\n    const filehandle = openLocation(ldLocation, this.pluginManager)\n    const isCSI = indexType === 'CSI'\n    const ld = new TabixIndexedFile({\n      filehandle,\n      csiFilehandle: isCSI\n        ? openLocation(location, this.pluginManager)\n        : undefined,\n      tbiFilehandle: !isCSI\n        ? openLocation(location, this.pluginManager)\n        : undefined,\n      chunkCacheSize: 50 * 2 ** 20,\n    })\n\n    // Parse the header line to determine column positions\n    const headerLine = await ld.getHeader()\n    const header = this.parseHeader(headerLine)\n\n    return { ld, header }\n  }\n\n  private parseHeader(headerLine: string): PlinkLDHeader {\n    // PLINK header looks like: CHR_A BP_A SNP_A CHR_B BP_B SNP_B R2\n    // With optional: DP, MAF_A, MAF_B, PHASE\n    const columns = headerLine.trim().split(/\\s+/)\n\n    const findIdx = (names: string[]) => {\n      for (const name of names) {\n        const idx = columns.indexOf(name)\n        if (idx !== -1) {\n          return idx\n        }\n      }\n      return -1\n    }\n\n    const chrAIdx = findIdx(['CHR_A', 'CHR1'])\n    const bpAIdx = findIdx(['BP_A', 'BP1', 'POS_A', 'POS1'])\n    const snpAIdx = findIdx(['SNP_A', 'SNP1', 'ID_A', 'ID1'])\n    const chrBIdx = findIdx(['CHR_B', 'CHR2'])\n    const bpBIdx = findIdx(['BP_B', 'BP2', 'POS_B', 'POS2'])\n    const snpBIdx = findIdx(['SNP_B', 'SNP2', 'ID_B', 'ID2'])\n    const r2Idx = findIdx(['R2', 'R^2', 'RSQ'])\n    const dprimeIdx = findIdx(['DP', 'DPRIME', \"D'\"])\n    const mafAIdx = findIdx(['MAF_A', 'MAF1'])\n    const mafBIdx = findIdx(['MAF_B', 'MAF2'])\n\n    if (chrAIdx === -1 || bpAIdx === -1 || chrBIdx === -1 || bpBIdx === -1) {\n      throw new Error(\n        `Invalid PLINK LD header. Expected columns CHR_A, BP_A, CHR_B, BP_B. Got: ${columns.join(', ')}`,\n      )\n    }\n\n    if (r2Idx === -1 && dprimeIdx === -1) {\n      throw new Error(\n        `Invalid PLINK LD header. Expected at least R2 or DP column. Got: ${columns.join(', ')}`,\n      )\n    }\n\n    return {\n      columns,\n      hasR2: r2Idx !== -1,\n      hasDprime: dprimeIdx !== -1,\n      hasMafA: mafAIdx !== -1,\n      hasMafB: mafBIdx !== -1,\n      chrAIdx,\n      bpAIdx,\n      snpAIdx,\n      chrBIdx,\n      bpBIdx,\n      snpBIdx,\n      r2Idx,\n      dprimeIdx,\n      mafAIdx,\n      mafBIdx,\n    }\n  }\n\n  protected async configurePre2() {\n    if (!this.configured) {\n      this.configured = this.configurePre().catch((e: unknown) => {\n        this.configured = undefined\n        throw e\n      })\n    }\n    return this.configured\n  }\n\n  async configure(opts?: BaseOptions) {\n    const { statusCallback = () => {} } = opts || {}\n    return updateStatus('Downloading index', statusCallback, () =>\n      this.configurePre2(),\n    )\n  }\n\n  public async getRefNames(opts: BaseOptions = {}) {\n    const { ld } = await this.configure(opts)\n    return ld.getReferenceSequenceNames(opts)\n  }\n\n  async getHeader(opts?: BaseOptions) {\n    const { header } = await this.configure(opts)\n    return header\n  }\n\n  /**\n   * Get LD records where the first SNP (A) falls within the query region.\n   * Caller should additionally filter for snpB being in region if needed.\n   */\n  public async getLDRecords(\n    query: NoAssemblyRegion,\n    opts: BaseOptions = {},\n  ): Promise<PlinkLDRecord[]> {\n    const { refName, start, end } = query\n    const { ld, header } = await this.configure(opts)\n\n    const records: PlinkLDRecord[] = []\n\n    await ld.getLines(refName, start, end, {\n      lineCallback: (line: string) => {\n        const record = this.parseLine(line, header)\n        if (record) {\n          records.push(record)\n        }\n      },\n      ...opts,\n    })\n\n    return records\n  }\n\n  /**\n   * Get LD records where BOTH SNPs fall within the query region.\n   * This is what's needed for the LD triangle display.\n   */\n  public async getLDRecordsInRegion(\n    query: NoAssemblyRegion,\n    opts: BaseOptions = {},\n  ): Promise<PlinkLDRecord[]> {\n    const { refName, start, end } = query\n    const records = await this.getLDRecords(query, opts)\n\n    // Filter for pairs where both SNPs are in the region\n    return records.filter(\n      r =>\n        r.chrB === refName &&\n        r.bpB >= start &&\n        r.bpB <= end &&\n        r.chrA === refName &&\n        r.bpA >= start &&\n        r.bpA <= end,\n    )\n  }\n\n  private parseLine(line: string, header: PlinkLDHeader): PlinkLDRecord | null {\n    const fields = line.trim().split(/\\s+/)\n\n    const chrA = fields[header.chrAIdx]\n    const bpA = Number.parseInt(fields[header.bpAIdx] ?? '', 10)\n    const snpA = header.snpAIdx >= 0 ? fields[header.snpAIdx] : `${chrA}:${bpA}`\n    const chrB = fields[header.chrBIdx]\n    const bpB = Number.parseInt(fields[header.bpBIdx] ?? '', 10)\n    const snpB = header.snpBIdx >= 0 ? fields[header.snpBIdx] : `${chrB}:${bpB}`\n\n    if (!chrA || !chrB || Number.isNaN(bpA) || Number.isNaN(bpB)) {\n      return null\n    }\n\n    const r2 =\n      header.r2Idx >= 0\n        ? Number.parseFloat(fields[header.r2Idx] ?? '')\n        : undefined\n    const dprime =\n      header.dprimeIdx >= 0\n        ? Number.parseFloat(fields[header.dprimeIdx] ?? '')\n        : undefined\n    const mafA =\n      header.mafAIdx >= 0\n        ? Number.parseFloat(fields[header.mafAIdx] ?? '')\n        : undefined\n    const mafB =\n      header.mafBIdx >= 0\n        ? Number.parseFloat(fields[header.mafBIdx] ?? '')\n        : undefined\n\n    return {\n      chrA,\n      bpA,\n      snpA: snpA ?? `${chrA}:${bpA}`,\n      chrB,\n      bpB,\n      snpB: snpB ?? `${chrB}:${bpB}`,\n      r2: r2 ?? 0,\n      dprime,\n      mafA,\n      mafB,\n    }\n  }\n\n  public freeResources(): void {\n    // nothing to free\n  }\n}\n"],"names":["PlinkLDTabixAdapter","BaseAdapter","configurePre","_opts","ldLocation","this","getConf","location","indexType","filehandle","openLocation","pluginManager","isCSI","ld","TabixIndexedFile","csiFilehandle","undefined","tbiFilehandle","chunkCacheSize","headerLine","getHeader","header","parseHeader","columns","trim","split","findIdx","names","name","idx","indexOf","chrAIdx","bpAIdx","snpAIdx","chrBIdx","bpBIdx","snpBIdx","r2Idx","dprimeIdx","mafAIdx","mafBIdx","Error","join","hasR2","hasDprime","hasMafA","hasMafB","configurePre2","configured","catch","e","configure","opts","statusCallback","updateStatus","getRefNames","getReferenceSequenceNames","getLDRecords","query","refName","start","end","records","getLines","lineCallback","line","record","parseLine","push","getLDRecordsInRegion","filter","r","chrB","bpB","chrA","bpA","fields","Number","parseInt","snpA","snpB","isNaN","r2","parseFloat","dprime","mafA","mafB","freeResources"],"ignoreList":[],"sourceRoot":""}