{"version":3,"file":"static/js/9865.63ee09e1.chunk.js","mappings":"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","sources":["webpack://@jbrowse/web/../../plugins/gccontent/src/GCContentAdapter/GCContentAdapter.ts"],"sourcesContent":["import { BaseFeatureDataAdapter } from '@jbrowse/core/data_adapters/BaseAdapter'\nimport { SimpleFeature, updateStatus } from '@jbrowse/core/util'\nimport { ObservableCreate } from '@jbrowse/core/util/rxjs'\nimport { checkStopToken } from '@jbrowse/core/util/stopToken'\n\nimport type {\n  BaseOptions,\n  BaseSequenceAdapter,\n} from '@jbrowse/core/data_adapters/BaseAdapter'\nimport type { Feature, Region } from '@jbrowse/core/util'\n\nexport default class GCContentAdapter extends BaseFeatureDataAdapter {\n  private gcMode = 'content'\n\n  public static capabilities = ['hasLocalStats']\n\n  public async configure() {\n    const adapter = await this.getSubAdapter?.(this.getConf('sequenceAdapter'))\n    if (!adapter) {\n      throw new Error('Error getting subadapter')\n    }\n    return adapter.dataAdapter as BaseSequenceAdapter\n  }\n\n  public async getRefNames(opts?: BaseOptions) {\n    const adapter = await this.configure()\n    return adapter.getRefNames(opts)\n  }\n\n  private async calculateGCContent(\n    query: Region,\n    opts?: BaseOptions,\n  ): Promise<{ starts: number[]; ends: number[]; scores: number[] }> {\n    const { statusCallback = () => {}, stopToken } = opts || {}\n    const sequenceAdapter = await this.configure()\n    const windowSize = this.getConf('windowSize')\n    const windowDelta = this.getConf('windowDelta')\n    const halfWindowSize = windowSize === 1 ? 1 : Math.ceil(windowSize / 2)\n    const isWindowSizeOneBp = windowSize === 1\n\n    const qs = Math.max(\n      0,\n      Math.floor((query.start - halfWindowSize) / windowSize) * windowSize,\n    )\n    const qe = Math.ceil((query.end + halfWindowSize) / windowSize) * windowSize\n\n    if (qe < 0 || qs > qe) {\n      return { starts: [], ends: [], scores: [] }\n    }\n\n    const residues =\n      (await sequenceAdapter.getSequence(\n        {\n          ...query,\n          start: qs,\n          end: qe,\n        },\n        opts,\n      )) ?? ''\n\n    return updateStatus('Calculating GC', statusCallback, () => {\n      const starts: number[] = []\n      const ends: number[] = []\n      const scores: number[] = []\n\n      // Initialize the first window\n      let nc = 0\n      let ng = 0\n      let len = 0\n      let start = performance.now()\n\n      // Calculate initial window\n      const startIdx = halfWindowSize\n      for (\n        let j = startIdx - halfWindowSize;\n        j < startIdx + halfWindowSize;\n        j++\n      ) {\n        const letter = residues[j]\n        if (letter === 'c' || letter === 'C') {\n          nc++\n        } else if (letter === 'g' || letter === 'G') {\n          ng++\n        }\n        if (letter !== 'N') {\n          len++\n        }\n      }\n\n      for (\n        let i = halfWindowSize;\n        i < residues.length - halfWindowSize;\n        i += windowDelta\n      ) {\n        if (performance.now() - start > 400) {\n          checkStopToken(stopToken)\n          start = performance.now()\n        }\n\n        // For windowSize === 1, just get the single character\n        if (isWindowSizeOneBp) {\n          const letter = residues[i]\n          nc = letter === 'c' || letter === 'C' ? 1 : 0\n          ng = letter === 'g' || letter === 'G' ? 1 : 0\n          len = letter !== 'N' ? 1 : 0\n        } else if (i > halfWindowSize) {\n          // Rolling window: remove characters that are no longer in window\n          // and add new characters that entered the window\n          const prevStart = i - windowDelta - halfWindowSize\n          const prevEnd = i - windowDelta + halfWindowSize\n          const currStart = i - halfWindowSize\n          const currEnd = i + halfWindowSize\n\n          // Remove old characters\n          for (let j = prevStart; j < Math.min(prevEnd, currStart); j++) {\n            if (j >= 0 && j < residues.length) {\n              const letter = residues[j]\n              if (letter === 'c' || letter === 'C') {\n                nc--\n              } else if (letter === 'g' || letter === 'G') {\n                ng--\n              }\n              if (letter !== 'N') {\n                len--\n              }\n            }\n          }\n\n          // Add new characters\n          for (let j = Math.max(prevEnd, currStart); j < currEnd; j++) {\n            if (j >= 0 && j < residues.length) {\n              const letter = residues[j]\n              if (letter === 'c' || letter === 'C') {\n                nc++\n              } else if (letter === 'g' || letter === 'G') {\n                ng++\n              }\n              if (letter !== 'N') {\n                len++\n              }\n            }\n          }\n        }\n\n        const pos = qs\n        const score =\n          this.gcMode === 'content'\n            ? (ng + nc) / (len || 1)\n            : this.gcMode === 'skew'\n              ? (ng - nc) / (ng + nc || 1)\n              : 0\n\n        starts.push(pos + i)\n        ends.push(pos + i + windowDelta)\n        scores.push(score)\n      }\n\n      return { starts, ends, scores }\n    })\n  }\n\n  public getFeatures(query: Region, opts?: BaseOptions) {\n    return ObservableCreate<Feature>(async observer => {\n      const result = await this.calculateGCContent(query, opts)\n\n      for (let i = 0; i < result.starts.length; i++) {\n        observer.next(\n          new SimpleFeature({\n            uniqueId: `${this.id}_${result.starts[i]}`,\n            refName: query.refName,\n            start: result.starts[i]!,\n            end: result.ends[i]!,\n            score: result.scores[i],\n          }),\n        )\n      }\n\n      observer.complete()\n    })\n  }\n}\n"],"names":["GCContentAdapter","BaseFeatureDataAdapter","gcMode","configure","adapter","this","getSubAdapter","getConf","Error","dataAdapter","getRefNames","opts","calculateGCContent","query","statusCallback","stopToken","sequenceAdapter","windowSize","windowDelta","halfWindowSize","Math","ceil","isWindowSizeOneBp","qs","max","floor","start","qe","end","starts","ends","scores","residues","getSequence","updateStatus","nc","ng","len","performance","now","startIdx","j","letter","i","length","checkStopToken","prevEnd","currStart","currEnd","min","pos","score","push","getFeatures","ObservableCreate","async","result","observer","next","SimpleFeature","uniqueId","id","refName","complete"],"sourceRoot":""}