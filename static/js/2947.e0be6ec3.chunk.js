"use strict";(globalThis.webpackChunk_jbrowse_web=globalThis.webpackChunk_jbrowse_web||[]).push([[2947],{10420:(t,e,n)=>{n.d(e,{Z:()=>o});var s=n(99546),r=n(94026);function o(t,e,n){const o=-1===n?(0,s.revcom)(e):e,i=o.length,a=t.split(";"),c=[];for(const t of a){if(""===t)continue;const e=t.split(","),s=e[0],a=r.k.exec(s);if(!a)throw new Error(`bad format for MM tag: "${t}"`);const[,f,p,d]=a,l=d.split(/(\d+|.)/);for(const t of l){if(""===t)continue;const s=e.length;let r=0;const a=-1===n?new Array(s-1):[];let d=-1===n?s-2:0;for(let t=1;t<s;t++){let s=+e[t];do{"N"!==f&&f!==o[r]||s--,r++}while(s>=0&&r<i);if(-1===n){const t=i-r;t>=0&&(a[d--]=t)}else a[d++]=r-1}const l=-1===n?a.slice(d+1):a;c.push({type:t,base:f,strand:p,positions:l})}}return c}},52947:(t,e,n)=>{n.d(e,{default:()=>S});var s=n(46377),r=n(66885),o=n(6434),i=n(44728),a=n(82088),c=n(86576),f=n(99546),p=n(37347);function d({feature:t,bins:e,region:n}){const s=t.get("start"),r=t.get("end"),o=t.get("strand"),i=n.end-n.start;for(let t=s;t<r+1;t++){const s=t-n.start;s>=0&&s<i&&(void 0===e[s]&&(e[s]={depth:0,readsCounted:0,ref:{probabilities:[],entryDepth:0,"-1":0,0:0,1:0},snps:{},mods:{},nonmods:{},delskips:{},noncov:{}}),t!==r&&(e[s].depth++,e[s].readsCounted++,e[s].ref.entryDepth++,e[s].ref[o]++))}}function l(t){return u(t.type)?1:t.length}function u(t){return"softclip"===t||"hardclip"===t||"insertion"===t}function g(t,e,n,s){let r=t[n][s];void 0===r&&(r=t[n][s]={entryDepth:0,probabilities:[],"-1":0,0:0,1:0}),r.entryDepth++,r[e]++}function h(t,e,n,s,r){let o=t[n][s];void 0===o&&(o=t[n][s]={entryDepth:0,probabilities:[],"-1":0,0:0,1:0}),o.entryDepth++,o.probabilities.push(r),o[e]++}function b({feature:t,region:e,bins:n,skipmap:s}){const r=t.get("start"),o=t.get("strand"),i=t.get("mismatches")??[];for(const a of i){const i=r+a.start,c=l(a),f=i+c;for(let t=i;t<i+c;t++){const s=t-e.start;if(s>=0&&s<n.length){const t=n[s],{base:e,altbase:r,type:i}=a,c=u(i);"deletion"===i||"skip"===i?(g(t,o,"delskips",i),t.depth--):c?g(t,o,"noncov",i):(g(t,o,"snps",e),t.ref.entryDepth--,t.ref[o]--,t.refbase=r)}}if("skip"===a.type){const e=t.get("tags"),n=e?.XS||e?.TS,r=e?.ts,a="+"===n?1:"-"===n?-1:("+"===r?1:"-"===n?-1:0)*o,c=`${i}_${f}_${a}`;void 0===s[c]&&(s[c]={feature:t,start:i,end:f,strand:o,effectiveStrand:a,score:0}),s[c].score++}}}var m=n(95805),y=n(59509);function w({feature:t,colorBy:e,region:n,bins:s,regionSequence:r}){const o=t.get("start"),i=t.get("strand"),a=t.get("end"),c=e?.modifications?.twoColor,p=e?.modifications?.isolatedModification,d=t.get("seq"),l=(e?.modifications?.threshold??10)/100;if(!d)return;const u=(0,m.parseCigar)(t.get("CIGAR"));(0,y.r)(t,u)?.forEach(({allProbs:t,prob:e,type:d},u)=>{if(p&&d!==p)return;if(e<l)return;const g=u+o-n.start;if(g>=0&&g<s.length&&u+o<a){void 0===s[g]&&(s[g]={depth:0,readsCounted:0,snps:{},ref:{probabilities:[],entryDepth:0,"-1":0,0:0,1:0},mods:{},nonmods:{},delskips:{},noncov:{}});const n=s[g];n.refbase=r[g];const o=1-(0,f.sum)(t);c&&o>(0,f.max)(t)?h(n,i,"nonmods",`nonmod_${d}`,o):h(n,i,"mods",`mod_${d}`,e)}})}var v=n(69276);function M({feature:t,region:e,bins:n,regionSequence:s}){const r=t.get("start"),o=t.get("end"),i=t.get("strand"),a=t.get("seq"),c=t.get("mismatches")??[],p=s.toLowerCase();if(a){const s=(0,m.parseCigar)(t.get("CIGAR")),{methBins:a,methProbs:d}=(0,v.P)(t,s),l=c.filter(t=>"deletion"===t.type);for(let t=0;t<o-r;t++){const s=t+r,o=p[s-e.start+1],c=p[s-e.start+2];if("c"===o&&"g"===c){const o=n[s-e.start],c=n[s-e.start+1],p=a[t],u=a[t+1],g=d[t],b=d[t+1];p&&(void 0===g||g>.5)||u&&(void 0===b||b>.5)?(o&&(h(o,i,"mods","cpg_meth",g||0),o.ref.entryDepth--,o.ref[i]--),c&&(h(c,i,"mods","cpg_meth",b||0),c.ref.entryDepth--,c.ref[i]--)):(o&&(l.some(t=>(0,f.doesIntersect2)(s,s+1,t.start+r,t.start+r+t.length))||(h(o,i,"nonmods","cpg_unmeth",1-(g||0)),o.ref.entryDepth--,o.ref[i]--)),c&&(l.some(t=>(0,f.doesIntersect2)(s+1,s+2,t.start+r,t.start+r+t.length))||(h(c,i,"nonmods","cpg_unmeth",1-(b||0)),c.ref.entryDepth--,c.ref[i]--)))}}}}class S extends s.BaseFeatureDataAdapter{async configure(){const t=this.getConf("subadapter"),e=t.sequenceAdapter,n=await(this.getSubAdapter?.(t)),s=e?await(this.getSubAdapter?.(e)):void 0;if(!n)throw new Error("Failed to get subadapter");return{subadapter:n.dataAdapter,sequenceAdapter:s?.dataAdapter}}async fetchSequence(t){const{sequenceAdapter:e}=await this.configure();if(e)return(0,c.Iw)(t,e)}getFeatures(t,e={}){return(0,r.ObservableCreate)(async n=>{const{subadapter:s}=await this.configure(),r=await(0,i._)(s.getFeatures(t,e).pipe((0,a.$)())),{bins:c,skipmap:l}=await async function({fetchSequence:t,features:e,region:n,opts:s}){const{stopToken:r,colorBy:o}=s,i={},a=[],c=Math.max(0,n.start-1),l=n.start-c;let u,g=performance.now();for(const s of e)performance.now()-g>400&&((0,p.SW)(r),g=performance.now()),d({feature:s,bins:a,region:n}),"modifications"===o?.type?(u??=await t({...n,start:c,end:n.end+1})||"",w({feature:s,colorBy:o,bins:a,region:n,regionSequence:u.slice(l)})):"methylation"===o?.type&&(u??=await t({...n,start:c,end:n.end+1})||"",M({feature:s,bins:a,region:n,regionSequence:u})),b({feature:s,skipmap:i,bins:a,region:n});for(const t of a)t&&(t.mods=Object.fromEntries(Object.entries(t.mods).map(([t,e])=>[t,{...e,avgProbability:e.probabilities.length?(0,f.sum)(e.probabilities)/e.probabilities.length:void 0}])),t.nonmods=Object.fromEntries(Object.entries(t.nonmods).map(([t,e])=>[t,{...e,avgProbability:e.probabilities.length?(0,f.sum)(e.probabilities)/e.probabilities.length:void 0}])));return{bins:a,skipmap:i}}({features:r,region:t,opts:e,fetchSequence:t=>this.fetchSequence(t)});let u=0;for(const e of c){if(e){const s=t.start+u;n.next(new o.A({id:`${this.id}-${s}`,data:{score:e.depth,snpinfo:e,start:s,end:s+1,refName:t.refName}}))}u++}for(const[t,e]of Object.entries(l))n.next(new o.A({id:t,data:{type:"skip",start:e.start,end:e.end,strand:e.strand,score:e.score,effectiveStrand:e.effectiveStrand}}));n.complete()},e.stopToken)}async getMultiRegionFeatureDensityStats(t,e){const{subadapter:n}=await this.configure();return n.getMultiRegionFeatureDensityStats(t,e)}async getRefNames(t={}){const{subadapter:e}=await this.configure();return e.getRefNames(t)}}},59509:(t,e,n)=>{n.d(e,{r:()=>c});var s=n(95805),r=n(49256),o=n(10420),i=n(60515),a=n(86576);function c(t,e){const n=t.get("strand"),c=t.get("seq"),f=(0,a.c$)(t,"MM","Mm")||"",p=e||(0,s.parseCigar)(t.get("CIGAR"));if(c){const e=(0,o.Z)(f,c,n),s=(0,i.Y)(t),a=[];let d=0;for(const{type:t,positions:o}of e){for(const{ref:e,idx:i}of(0,r.h)(p,o)){const r=s?.[d+(-1===n?o.length-1-i:i)]||0;if(a[e]){const n=a[e];a[e]={allProbs:[...n.allProbs,r],prob:Math.max(n.prob,r),type:n.prob>r?n.type:t}}else a[e]={type:t,prob:r,allProbs:[r]}}d+=o.length}return a}}},60515:(t,e,n)=>{n.d(e,{Y:()=>r});var s=n(86576);function r(t){const e=(0,s.c$)(t,"ML","Ml")||[];if(e){const t=[];if("string"==typeof e){const n=e.split(",");for(let e=0,s=n.length;e<s;e++)t.push(+n[e]/255)}else for(let n=0,s=e.length;n<s;n++)t.push(e[n]/255);return t}{const e=(0,s.c$)(t,"MP","Mp");if(e){const t=[];for(let n=0,s=e.length;n<s;n++){const s=e.charCodeAt(n)-33;t.push(Math.min(1,s/50))}return t}return}}},69276:(t,e,n)=>{n.d(e,{P:()=>a});var s=n(49256),r=n(10420),o=n(60515),i=n(86576);function a(t,e){const n=t.get("start"),a=t.get("end"),c=t.get("strand"),f=a-n,p=(0,i.c$)(t,"MM","Mm")||"",d=[],l=[],u=[],g=[],h=t.get("seq");if(h){const n=(0,o.Y)(t),i=(0,r.Z)(p,h,c);let a=0;for(const{type:t,positions:r}of i){for(const{ref:o,idx:i}of(0,s.h)(e,r)){if(o<0||o>=f)continue;const e=a+(-1===c?r.length-1-i:i),s=n?.[e]||0;"m"===t?(d[o]=1,u[o]=s):"h"===t&&(l[o]=1,g[o]=s)}a+=r.length}}return{methBins:d,hydroxyMethBins:l,methProbs:u,hydroxyMethProbs:g}}}}]);
//# sourceMappingURL=2947.e0be6ec3.chunk.js.map