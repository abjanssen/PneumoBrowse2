{"version":3,"file":"static/js/9615.66d44f1c.chunk.js","mappings":"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","sources":["../../../plugins/variants/src/PlinkLDAdapter/PlinkLDAdapter.ts"],"sourcesContent":["import { BaseAdapter } from '@jbrowse/core/data_adapters/BaseAdapter'\nimport { fetchAndMaybeUnzipText, updateStatus } from '@jbrowse/core/util'\n\nimport type { PlinkLDHeader, PlinkLDRecord } from './types.ts'\nimport type { BaseOptions } from '@jbrowse/core/data_adapters/BaseAdapter'\nimport type { NoAssemblyRegion } from '@jbrowse/core/util/types'\n\nexport default class PlinkLDAdapter extends BaseAdapter {\n  private configured?: Promise<{\n    records: PlinkLDRecord[]\n    header: PlinkLDHeader\n    refNames: string[]\n  }>\n\n  private async configurePre(opts?: BaseOptions) {\n    const ldLocation = this.getConf('ldLocation')\n    const text = await fetchAndMaybeUnzipText(ldLocation, opts)\n    const lines = text.split('\\n').filter(line => line.trim())\n    if (lines.length === 0) {\n      throw new Error('Empty LD file')\n    }\n\n    const header = this.parseHeader(lines[0]!)\n\n    const records: PlinkLDRecord[] = []\n    const refNamesSet = new Set<string>()\n\n    for (let i = 1; i < lines.length; i++) {\n      const record = this.parseLine(lines[i]!, header)\n      if (record) {\n        records.push(record)\n        refNamesSet.add(record.chrA)\n        refNamesSet.add(record.chrB)\n      }\n    }\n\n    const refNames = [...refNamesSet].sort()\n    return { records, header, refNames }\n  }\n\n  private parseHeader(headerLine: string): PlinkLDHeader {\n    // PLINK header looks like: CHR_A BP_A SNP_A CHR_B BP_B SNP_B R2\n    // With optional: DP, MAF_A, MAF_B, PHASE\n    const columns = headerLine.trim().split(/\\s+/)\n\n    const findIdx = (names: string[]) => {\n      for (const name of names) {\n        const idx = columns.indexOf(name)\n        if (idx !== -1) {\n          return idx\n        }\n      }\n      return -1\n    }\n\n    const chrAIdx = findIdx(['CHR_A', 'CHR1'])\n    const bpAIdx = findIdx(['BP_A', 'BP1', 'POS_A', 'POS1'])\n    const snpAIdx = findIdx(['SNP_A', 'SNP1', 'ID_A', 'ID1'])\n    const chrBIdx = findIdx(['CHR_B', 'CHR2'])\n    const bpBIdx = findIdx(['BP_B', 'BP2', 'POS_B', 'POS2'])\n    const snpBIdx = findIdx(['SNP_B', 'SNP2', 'ID_B', 'ID2'])\n    const r2Idx = findIdx(['R2', 'R^2', 'RSQ'])\n    const dprimeIdx = findIdx(['DP', 'DPRIME', \"D'\"])\n    const mafAIdx = findIdx(['MAF_A', 'MAF1'])\n    const mafBIdx = findIdx(['MAF_B', 'MAF2'])\n\n    if (chrAIdx === -1 || bpAIdx === -1 || chrBIdx === -1 || bpBIdx === -1) {\n      throw new Error(\n        `Invalid PLINK LD header. Expected columns CHR_A, BP_A, CHR_B, BP_B. Got: ${columns.join(', ')}`,\n      )\n    }\n\n    if (r2Idx === -1 && dprimeIdx === -1) {\n      throw new Error(\n        `Invalid PLINK LD header. Expected at least R2 or DP column. Got: ${columns.join(', ')}`,\n      )\n    }\n\n    return {\n      columns,\n      hasR2: r2Idx !== -1,\n      hasDprime: dprimeIdx !== -1,\n      hasMafA: mafAIdx !== -1,\n      hasMafB: mafBIdx !== -1,\n      chrAIdx,\n      bpAIdx,\n      snpAIdx,\n      chrBIdx,\n      bpBIdx,\n      snpBIdx,\n      r2Idx,\n      dprimeIdx,\n      mafAIdx,\n      mafBIdx,\n    }\n  }\n\n  protected async configurePre2(opts?: BaseOptions) {\n    if (!this.configured) {\n      this.configured = this.configurePre(opts).catch((e: unknown) => {\n        this.configured = undefined\n        throw e\n      })\n    }\n    return this.configured\n  }\n\n  async configure(opts?: BaseOptions) {\n    const { statusCallback = () => {} } = opts || {}\n    return updateStatus('Loading LD data', statusCallback, () =>\n      this.configurePre2(opts),\n    )\n  }\n\n  public async getRefNames(opts: BaseOptions = {}) {\n    const { refNames } = await this.configure(opts)\n    return refNames\n  }\n\n  async getHeader(opts?: BaseOptions) {\n    const { header } = await this.configure(opts)\n    return header\n  }\n\n  /**\n   * Get LD records where the first SNP (A) falls within the query region.\n   * Caller should additionally filter for snpB being in region if needed.\n   */\n  public async getLDRecords(\n    query: NoAssemblyRegion,\n    opts: BaseOptions = {},\n  ): Promise<PlinkLDRecord[]> {\n    const { refName, start, end } = query\n    const { records } = await this.configure(opts)\n\n    const filtered = records.filter(\n      r => r.chrA === refName && r.bpA >= start && r.bpA <= end,\n    )\n\n    return filtered\n  }\n\n  /**\n   * Get LD records where BOTH SNPs fall within the query region.\n   * This is what's needed for the LD triangle display.\n   */\n  public async getLDRecordsInRegion(\n    query: NoAssemblyRegion,\n    opts: BaseOptions = {},\n  ): Promise<PlinkLDRecord[]> {\n    const { refName, start, end } = query\n    const records = await this.getLDRecords(query, opts)\n\n    // Filter for pairs where both SNPs are in the region\n    const filtered = records.filter(\n      r =>\n        r.chrB === refName &&\n        r.bpB >= start &&\n        r.bpB <= end &&\n        r.chrA === refName &&\n        r.bpA >= start &&\n        r.bpA <= end,\n    )\n\n    return filtered\n  }\n\n  private parseLine(line: string, header: PlinkLDHeader): PlinkLDRecord | null {\n    const fields = line.trim().split(/\\s+/)\n\n    const chrA = fields[header.chrAIdx]\n    const bpA = Number.parseInt(fields[header.bpAIdx] ?? '', 10)\n    const snpA = header.snpAIdx >= 0 ? fields[header.snpAIdx] : `${chrA}:${bpA}`\n    const chrB = fields[header.chrBIdx]\n    const bpB = Number.parseInt(fields[header.bpBIdx] ?? '', 10)\n    const snpB = header.snpBIdx >= 0 ? fields[header.snpBIdx] : `${chrB}:${bpB}`\n\n    if (!chrA || !chrB || Number.isNaN(bpA) || Number.isNaN(bpB)) {\n      return null\n    }\n\n    const r2 =\n      header.r2Idx >= 0\n        ? Number.parseFloat(fields[header.r2Idx] ?? '')\n        : undefined\n    const dprime =\n      header.dprimeIdx >= 0\n        ? Number.parseFloat(fields[header.dprimeIdx] ?? '')\n        : undefined\n    const mafA =\n      header.mafAIdx >= 0\n        ? Number.parseFloat(fields[header.mafAIdx] ?? '')\n        : undefined\n    const mafB =\n      header.mafBIdx >= 0\n        ? Number.parseFloat(fields[header.mafBIdx] ?? '')\n        : undefined\n\n    return {\n      chrA,\n      bpA,\n      snpA: snpA ?? `${chrA}:${bpA}`,\n      chrB,\n      bpB,\n      snpB: snpB ?? `${chrB}:${bpB}`,\n      r2: r2 ?? 0,\n      dprime,\n      mafA,\n      mafB,\n    }\n  }\n\n  public freeResources(): void {\n    // nothing to free\n  }\n}\n"],"names":["PlinkLDAdapter","BaseAdapter","configurePre","opts","ldLocation","this","getConf","lines","fetchAndMaybeUnzipText","split","filter","line","trim","length","Error","header","parseHeader","records","refNamesSet","Set","i","record","parseLine","push","add","chrA","chrB","refNames","sort","headerLine","columns","findIdx","names","name","idx","indexOf","chrAIdx","bpAIdx","snpAIdx","chrBIdx","bpBIdx","snpBIdx","r2Idx","dprimeIdx","mafAIdx","mafBIdx","join","hasR2","hasDprime","hasMafA","hasMafB","configurePre2","configured","catch","e","undefined","configure","statusCallback","updateStatus","getRefNames","getHeader","getLDRecords","query","refName","start","end","r","bpA","getLDRecordsInRegion","bpB","fields","Number","parseInt","snpA","snpB","isNaN","r2","parseFloat","dprime","mafA","mafB","freeResources"],"ignoreList":[],"sourceRoot":""}