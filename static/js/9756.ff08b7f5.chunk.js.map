{"version":3,"file":"static/js/9756.ff08b7f5.chunk.js","mappings":"6NAUe,MAAMA,UAAyBC,EAAAA,uBACpCC,OAAS,UAEjB,oBAA6B,CAAC,iBAE9B,eAAaC,GACX,MAAMC,QAAgBC,KAAKC,gBAAgBD,KAAKE,QAAQ,qBACxD,IAAKH,EACH,MAAM,IAAII,MAAM,4BAElB,OAAOJ,EAAQK,WACjB,CAEA,iBAAaC,CAAYC,GAEvB,aADsBN,KAAKF,aACZO,YAAYC,EAC7B,CAEOC,WAAAA,CAAYC,EAAeF,GAChC,MAAM,eAAEG,EAAiBA,OAAQ,UAAEC,GAAcJ,GAAQ,CAAC,EAC1D,OAAOK,EAAAA,EAAAA,mBAA0BC,UAC/B,MAAMC,QAAwBb,KAAKF,YAC7BgB,EAAad,KAAKE,QAAQ,cAC1Ba,EAAcf,KAAKE,QAAQ,eAC3Bc,EAAoB,IAAfF,EAAmB,EAAIA,EAAa,EACzCG,EAAmB,IAAfH,EAEV,IAAMI,MAAOC,EAAYC,IAAKC,GAAab,EAI3C,GAHAW,EAAaG,KAAKC,IAAI,EAAGJ,EAAaH,GACtCK,GAAYL,EAERK,EAAW,GAAKF,EAAaE,EAE/B,YADAG,EAASC,WAIX,MAAMC,QAAcC,EAAAA,EAAAA,GAClBd,EACGN,YACC,IACKC,EACHU,MAAOC,EACPC,IAAKC,GAEPf,GAEDsB,MAAKC,EAAAA,EAAAA,OAEJC,EAAWJ,EAAM,IAAIK,IAAI,QAAU,GAEzC,IAAIb,EAAQc,YAAYC,YAClBC,EAAAA,EAAAA,cAAa,iBAAkBzB,GAAgB,KACnD,IAAK,IAAI0B,EAAInB,EAAImB,EAAIL,EAASM,OAASpB,EAAImB,GAAKpB,EAAa,CACvDiB,YAAYC,MAAQf,EAAQ,OAC9BmB,EAAAA,EAAAA,IAAe3B,GACfQ,EAAQc,YAAYC,OAEtB,MAAMK,EAAIrB,EAAIa,EAASK,GAAKL,EAASS,MAAMJ,EAAInB,EAAImB,EAAInB,GACvD,IAAIwB,EAAK,EACLC,EAAK,EACLC,EAAM,EACV,IAAK,MAAMC,KAAUL,EACJ,MAAXK,GAA6B,MAAXA,EACpBH,IACoB,MAAXG,GAA6B,MAAXA,GAC3BF,IAEa,MAAXE,GACFD,IAGJ,MAAME,EAAMzB,EACN0B,EACY,YAAhB7C,KAAKH,QACA4C,EAAKD,IAAOE,GAAO,GACJ,SAAhB1C,KAAKH,QACF4C,EAAKD,IAAOC,EAAKD,GAAM,GACxB,EAERhB,EAASsB,KACP,IAAIC,EAAAA,cAAc,CAChBC,SAAU,GAAGhD,KAAKiD,MAAML,EAAMT,IAC9Be,QAAS1C,EAAM0C,QACfhC,MAAO0B,EAAMT,EACbf,IAAKwB,EAAMT,EAAIpB,EACf8B,UAGN,KAGFrB,EAASC,UAAU,GAEvB,CAOO0B,aAAAA,GAAiC,E","sources":["../../../plugins/gccontent/src/GCContentAdapter/GCContentAdapter.ts"],"sourcesContent":["import { BaseFeatureDataAdapter } from '@jbrowse/core/data_adapters/BaseAdapter'\nimport { SimpleFeature, updateStatus } from '@jbrowse/core/util'\nimport { ObservableCreate } from '@jbrowse/core/util/rxjs'\nimport { checkStopToken } from '@jbrowse/core/util/stopToken'\nimport { firstValueFrom } from 'rxjs'\nimport { toArray } from 'rxjs/operators'\n\nimport type { BaseOptions } from '@jbrowse/core/data_adapters/BaseAdapter'\nimport type { Feature, Region } from '@jbrowse/core/util'\n\nexport default class GCContentAdapter extends BaseFeatureDataAdapter {\n  private gcMode = 'content'\n\n  public static capabilities = ['hasLocalStats']\n\n  public async configure() {\n    const adapter = await this.getSubAdapter?.(this.getConf('sequenceAdapter'))\n    if (!adapter) {\n      throw new Error('Error getting subadapter')\n    }\n    return adapter.dataAdapter as BaseFeatureDataAdapter\n  }\n\n  public async getRefNames(opts?: BaseOptions) {\n    const adapter = await this.configure()\n    return adapter.getRefNames(opts)\n  }\n\n  public getFeatures(query: Region, opts?: BaseOptions) {\n    const { statusCallback = () => {}, stopToken } = opts || {}\n    return ObservableCreate<Feature>(async observer => {\n      const sequenceAdapter = await this.configure()\n      const windowSize = this.getConf('windowSize')\n      const windowDelta = this.getConf('windowDelta')\n      const hw = windowSize === 1 ? 1 : windowSize / 2 // Half the window size\n      const f = windowSize === 1\n\n      let { start: queryStart, end: queryEnd } = query\n      queryStart = Math.max(0, queryStart - hw)\n      queryEnd += hw\n\n      if (queryEnd < 0 || queryStart > queryEnd) {\n        observer.complete()\n        return\n      }\n\n      const feats = await firstValueFrom(\n        sequenceAdapter\n          .getFeatures(\n            {\n              ...query,\n              start: queryStart,\n              end: queryEnd,\n            },\n            opts,\n          )\n          .pipe(toArray()),\n      )\n      const residues = feats[0]?.get('seq') || ''\n\n      let start = performance.now()\n      await updateStatus('Calculating GC', statusCallback, () => {\n        for (let i = hw; i < residues.length - hw; i += windowDelta) {\n          if (performance.now() - start > 400) {\n            checkStopToken(stopToken)\n            start = performance.now()\n          }\n          const r = f ? residues[i] : residues.slice(i - hw, i + hw)\n          let nc = 0\n          let ng = 0\n          let len = 0\n          for (const letter of r) {\n            if (letter === 'c' || letter === 'C') {\n              nc++\n            } else if (letter === 'g' || letter === 'G') {\n              ng++\n            }\n            if (letter !== 'N') {\n              len++\n            }\n          }\n          const pos = queryStart\n          const score =\n            this.gcMode === 'content'\n              ? (ng + nc) / (len || 1)\n              : this.gcMode === 'skew'\n                ? (ng - nc) / (ng + nc || 1)\n                : 0\n\n          observer.next(\n            new SimpleFeature({\n              uniqueId: `${this.id}_${pos + i}`,\n              refName: query.refName,\n              start: pos + i,\n              end: pos + i + windowDelta,\n              score,\n            }),\n          )\n        }\n      })\n\n      observer.complete()\n    })\n  }\n\n  /**\n   * called to provide a hint that data tied to a certain region\n   * will not be needed for the foreseeable future and can be purged\n   * from caches, etc\n   */\n  public freeResources(/* { region } */) {}\n}\n"],"names":["GCContentAdapter","BaseFeatureDataAdapter","gcMode","configure","adapter","this","getSubAdapter","getConf","Error","dataAdapter","getRefNames","opts","getFeatures","query","statusCallback","stopToken","ObservableCreate","async","sequenceAdapter","windowSize","windowDelta","hw","f","start","queryStart","end","queryEnd","Math","max","observer","complete","feats","firstValueFrom","pipe","toArray","residues","get","performance","now","updateStatus","i","length","checkStopToken","r","slice","nc","ng","len","letter","pos","score","next","SimpleFeature","uniqueId","id","refName","freeResources"],"sourceRoot":""}