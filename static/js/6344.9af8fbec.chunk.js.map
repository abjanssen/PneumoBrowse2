{"version":3,"file":"static/js/6344.9af8fbec.chunk.js","mappings":"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","sources":["../../../plugins/hic/src/HicAdapter/HicFilehandle.ts","../../../plugins/hic/src/HicAdapter/HicAdapter.ts"],"sourcesContent":["import { openLocation } from '@jbrowse/core/util/io'\n\nimport type PluginManager from '@jbrowse/core/PluginManager'\nimport type { FileLocation } from '@jbrowse/core/util'\nimport type { GenericFilehandle } from 'generic-filehandle2'\n\nclass HicFilehandle {\n  constructor(private filehandle: GenericFilehandle) {}\n\n  async read(position: number, length: number) {\n    const buffer = await this.filehandle.read(length, position)\n    return buffer.buffer.slice(\n      buffer.byteOffset,\n      buffer.byteOffset + buffer.byteLength,\n    )\n  }\n}\n\nexport function openHicFilehandle(\n  location: FileLocation,\n  pluginManager?: PluginManager,\n) {\n  return new HicFilehandle(openLocation(location, pluginManager))\n}\n","import { BaseFeatureDataAdapter } from '@jbrowse/core/data_adapters/BaseAdapter'\nimport { updateStatus } from '@jbrowse/core/util'\nimport { ObservableCreate } from '@jbrowse/core/util/rxjs'\nimport HicStraw from 'hic-straw'\n\nimport { openHicFilehandle } from './HicFilehandle.ts'\n\nimport type PluginManager from '@jbrowse/core/PluginManager'\nimport type { AnyConfigurationModel } from '@jbrowse/core/configuration'\nimport type { BaseOptions } from '@jbrowse/core/data_adapters/BaseAdapter'\nimport type { getSubAdapterType } from '@jbrowse/core/data_adapters/dataAdapterCache'\nimport type { Region } from '@jbrowse/core/util/types'\n\ninterface ContactRecord {\n  bin1: number\n  bin2: number\n  counts: number\n}\n\nexport interface MultiRegionContactRecord {\n  bin1: number\n  bin2: number\n  counts: number\n  region1Idx: number\n  region2Idx: number\n}\n\ninterface HicMetadata {\n  chromosomes: {\n    name: string\n    size: number\n    index: number\n  }[]\n  resolutions: number[]\n}\ninterface Ref {\n  chr: string\n  start: number\n  end: number\n}\n\ninterface HicOptions extends BaseOptions {\n  resolution?: number\n  bpPerPx?: number\n  normalization?: string\n}\n\ninterface HicParser {\n  getContactRecords: (\n    normalize: string,\n    ref: Ref,\n    ref2: Ref,\n    units: string,\n    binsize: number,\n  ) => Promise<ContactRecord[]>\n  getMetaData: () => Promise<HicMetadata>\n  hicFile: {\n    init: () => Promise<void>\n    masterIndex: Record<string, { start: number; size: number }>\n  }\n}\n\nexport default class HicAdapter extends BaseFeatureDataAdapter {\n  private hic: HicParser\n\n  public constructor(\n    config: AnyConfigurationModel,\n    getSubAdapter?: getSubAdapterType,\n    pluginManager?: PluginManager,\n  ) {\n    super(config, getSubAdapter, pluginManager)\n    this.hic = new HicStraw({\n      file: openHicFilehandle(this.getConf('hicLocation'), this.pluginManager),\n    })\n  }\n\n  private async setup(opts?: BaseOptions) {\n    const { statusCallback = () => {} } = opts || {}\n    return updateStatus('Downloading .hic header', statusCallback, () =>\n      this.hic.getMetaData(),\n    )\n  }\n\n  public async getHeader(opts?: BaseOptions) {\n    const { chromosomes, ...rest } = await this.setup(opts)\n    // @ts-expect-error\n    const norms = await this.hic.getNormalizationOptions()\n\n    await this.hic.hicFile.init()\n    const { masterIndex } = this.hic.hicFile\n    const hasInterChromosomalData = Object.keys(masterIndex).some(key => {\n      const [idx1, idx2] = key.split('_')\n      return idx1 !== idx2\n    })\n\n    return { ...rest, norms, hasInterChromosomalData }\n  }\n\n  async getRefNames(opts?: BaseOptions) {\n    const metadata = await this.setup(opts)\n    return metadata.chromosomes.map(chr => chr.name)\n  }\n\n  async getResolution(res: number, opts?: BaseOptions) {\n    const { resolutions } = await this.setup(opts)\n    const resolutionMultiplier = this.getConf('resolutionMultiplier')\n    let chosenResolution = resolutions.at(-1)!\n    for (let i = resolutions.length - 1; i >= 0; i -= 1) {\n      const r = resolutions[i]!\n      if (r <= 2 * res * resolutionMultiplier) {\n        chosenResolution = r\n      }\n    }\n    return chosenResolution\n  }\n\n  getFeatures(region: Region, opts: HicOptions = {}) {\n    return ObservableCreate<ContactRecord>(async observer => {\n      const { refName: chr, start, end } = region\n      const {\n        resolution,\n        normalization = 'KR',\n        bpPerPx = 1,\n        statusCallback = () => {},\n      } = opts\n      const res = await this.getResolution(bpPerPx / (resolution || 1000), opts)\n\n      await updateStatus('Downloading .hic data', statusCallback, async () => {\n        const records = await this.hic.getContactRecords(\n          normalization,\n          { start, chr, end },\n          { start, chr, end },\n          'BP',\n          res,\n        )\n        for (const record of records) {\n          observer.next(record)\n        }\n      })\n      observer.complete()\n    }, opts.stopToken) as any\n  }\n\n  /**\n   * Get contact records between all pairs of regions.\n   * This enables rendering Hi-C data across multiple chromosomes/regions.\n   */\n  async getMultiRegionContactRecords(\n    regions: Region[],\n    opts: HicOptions = {},\n  ): Promise<MultiRegionContactRecord[]> {\n    const {\n      resolution,\n      normalization = 'KR',\n      bpPerPx = 1,\n      statusCallback = () => {},\n    } = opts\n\n    const res = await this.getResolution(bpPerPx / (resolution || 1000), opts)\n\n    const allRecords: MultiRegionContactRecord[] = []\n\n    await updateStatus('Downloading .hic data', statusCallback, async () => {\n      // Query contacts between all pairs of regions (including self-contacts)\n      for (let i = 0; i < regions.length; i++) {\n        for (let j = i; j < regions.length; j++) {\n          const region1 = regions[i]!\n          const region2 = regions[j]!\n\n          const records = await this.hic.getContactRecords(\n            normalization,\n            { chr: region1.refName, start: region1.start, end: region1.end },\n            { chr: region2.refName, start: region2.start, end: region2.end },\n            'BP',\n            res,\n          )\n\n          for (const { bin1, bin2, counts } of records) {\n            allRecords.push({\n              bin1,\n              bin2,\n              counts,\n              region1Idx: i,\n              region2Idx: j,\n            })\n          }\n        }\n      }\n    })\n\n    return allRecords\n  }\n\n  // don't do feature stats estimation, similar to bigwigadapter\n  async getMultiRegionFeatureDensityStats(_regions: Region[]) {\n    return {\n      featureDensity: 0,\n    }\n  }\n}\n"],"names":["HicFilehandle","constructor","filehandle","read","position","length","buffer","this","slice","byteOffset","byteLength","openHicFilehandle","location","pluginManager","openLocation","HicAdapter","BaseFeatureDataAdapter","config","getSubAdapter","super","hic","HicStraw","file","getConf","setup","opts","statusCallback","updateStatus","getMetaData","getHeader","chromosomes","rest","norms","getNormalizationOptions","hicFile","init","masterIndex","hasInterChromosomalData","Object","keys","some","key","idx1","idx2","split","getRefNames","map","chr","name","getResolution","res","resolutions","resolutionMultiplier","chosenResolution","at","i","r","getFeatures","region","ObservableCreate","async","refName","start","end","resolution","normalization","bpPerPx","records","getContactRecords","record","observer","next","complete","stopToken","getMultiRegionContactRecords","regions","allRecords","j","region1","region2","bin1","bin2","counts","push","region1Idx","region2Idx","getMultiRegionFeatureDensityStats","_regions","featureDensity"],"ignoreList":[],"sourceRoot":""}