"use strict";(globalThis.webpackChunk_jbrowse_web=globalThis.webpackChunk_jbrowse_web||[]).push([[8955],{48955(t,e,r){r.d(e,{makeImageData:()=>k});var o=r(11259),n=r(38433),s=r(17868),a=r(83640),c=r(57141),i=r(52901);function l({feature:t,layout:e,showSoftClip:r,heightPx:o,displayMode:n}){let s=t.get("start"),a=t.get("end");if(r){const e=t.get("mismatches");if(e)for(const t of e)if("softclip"===t.type){const e=t.cliplen;0===t.start?s-=e:a+=e}}"compact"===n&&(o/=3);const c=e.addRect(t.id(),s,a,o,t);return null===c?null:{feature:t,topPx:"collapse"===n?0:c,heightPx:o}}var f=r(25978);var h=r(35702),g=r(15391),d=r(86470);function p({colorType:t,tag:e,feature:r,config:n,defaultColor:s,colorTagMap:a}){switch(t){case"insertSize":return function(t){return t.get("is_paired")&&t.get("refName")!==t.get("next_ref")?"#555":`hsl(${Math.abs(t.get("template_length"))/10},50%,50%)`}(r);case"strand":return function(t){return-1===t.get("strand")?"#8F8FD8":"#EC8B8B"}(r);case"mappingQuality":return function(t){return`hsl(${t.get("score")},50%,50%)`}(r);case"pairOrientation":return function(t,e){return g.pf[function(t,e){const r=(0,o.QZ)(e,"orientationType");return{LR:"color_pair_lr",RR:"color_pair_rr",RL:"color_pair_rl",LL:"color_pair_ll"}[d.il[r][t.get("pair_orientation")]]}(t,e)||"color_nostrand"]}(r,n);case"stranded":return function(t){return g.pf[function(t){const e=t.get("flags"),r=t.get("strand");if(1&e){const o=64&e?-1:1;return 2&e?r*o===1?"color_rev_strand":"color_fwd_strand":8&e?r*o===1?"color_rev_missing_mate":"color_fwd_missing_mate":t.get("refName")===t.get("next_ref")?r*o===1?"color_rev_strand_not_proper":"color_fwd_strand_not_proper":1===r?"color_fwd_diff_chr":"color_rev_diff_chr"}return"color_unknown"}(t)]}(r);case"xs":case"tag":{const t=r.get("tags"),o=t?t[e]:r.get(e);return"XS"===e||"TS"===e?"-"===o?g.pf.color_rev_strand:"+"===o?g.pf.color_fwd_strand:g.pf.color_nostrand:"ts"===e?"-"===o?-1===r.get("strand")?g.pf.color_fwd_strand:g.pf.color_rev_strand:"+"===o?-1===r.get("strand")?g.pf.color_rev_strand:g.pf.color_fwd_strand:g.pf.color_nostrand:a[o]||g.pf.color_nostrand}case"insertSizeAndPairOrientation":break;case"modifications":case"methylation":return 16&r.get("flags")?"#c8dcc8":"#c8c8c8";default:return s?"lightgrey":(0,o.QZ)(n,"color",{feature:r})}}var u=r(47354);function m(t,e,r,o,n,s){t.beginPath(),t.moveTo(e,o),t.lineTo(e,o+n),t.lineTo(r,o+n),t.lineTo(r+u.Fz,s),t.lineTo(r,o),t.closePath(),t.fill()}function y(t,e,r,o,n,s){t.beginPath(),t.moveTo(e-u.Fz,s),t.lineTo(e,o+n),t.lineTo(r,o+n),t.lineTo(r,o),t.lineTo(e,o),t.closePath(),t.fill()}var x=r(19598),_=r(65118);const b=(0,x.M)("red"),P=(0,x.M)("blue"),M=(0,x.M)("pink"),C=(0,x.M)("purple");var v=r(20253);const w=Array.from({length:256},(t,e)=>`hsl(${255===e?150:1.5*e},55%,50%)`);function S(t,e,r){for(let r=0,o=t.coords.length;r<o;r++)e.push(t.coords[r]);for(let e=0,o=t.items.length;e<o;e++)r.push(t.items[e])}function T({ctx:t,feat:e,renderArgs:r,colorMap:o,colorContrastMap:n,charWidth:s,charHeight:a,defaultColor:c,canvasWidth:i}){const l=[],f=[],{config:g,bpPerPx:d,regions:x,colorBy:T,colorTagMap:R={}}=r,{tag:A="",type:k=""}=T||{},{feature:W}=e,I=x[0],Q=p({feature:W,config:g,tag:A,defaultColor:c,colorType:k,colorTagMap:R}),B=(0,h.tQ)(W.get("NUMERIC_CIGAR")||W.get("CIGAR"));switch(function({ctx:t,feat:e,renderArgs:r,canvasWidth:o,color:n,cigarOps:s}){const{regions:a,bpPerPx:c}=r,{heightPx:i,topPx:l,feature:f}=e,g=a[0],d=g.start,p=g.end,u=g.reversed,x=1/c,_=f.get("start"),b=f.get("end"),P=g.reversed?-1:1,M=f.get("strand")*P,C=c<10&&i>5;t.fillStyle=n;let v=!1;for(let t=0,e=s.length;t<e;t++)if((15&s[t])===h.a2){v=!0;break}if(v){const e=l+i/2;if(1===M){let r=0,n=_;const a=s.length;for(let e=0;e<a;e++){const a=s[e],c=a>>4,f=15&a;if(1<<f&h.q7)r+=c;else if(f===h.a2){if(r){const e=n+r,s=u?(p-e)*x:(n-d)*x,a=(u?(p-n)*x:(e-d)*x)-s;s+a>0&&s<o&&t.fillRect(s,l,a,i)}n+=r+c,r=0}}if(r){const s=n+r,a=u?(p-s)*x:(n-d)*x,c=u?(p-n)*x:(s-d)*x;if(C)m(t,a,c,l,i,e);else{const e=c-a;a+e>0&&a<o&&t.fillRect(a,l,e,i)}}}else if(-1===M){let r=0,n=b;for(let e=s.length-1;e>=0;e--){const a=s[e],c=a>>4,f=15&a;if(1<<f&h.q7)r+=c;else if(f===h.a2){if(r){const e=n-r,s=u?(p-n)*x:(e-d)*x,a=(u?(p-e)*x:(n-d)*x)-s;s+a>0&&s<o&&t.fillRect(s,l,a,i)}n-=r+c,r=0}}if(r){const s=n-r,a=u?(p-n)*x:(s-d)*x,c=u?(p-s)*x:(n-d)*x;if(C)y(t,a,c,l,i,e);else{const e=c-a;a+e>0&&a<o&&t.fillRect(a,l,e,i)}}}}else{const e=u?(p-b)*x:(_-d)*x,r=u?(p-_)*x:(b-d)*x,n=l+i/2;if(C)-1===M?y(t,e,r,l,i,n):m(t,e,r,l,i,n);else{const n=r-e;e+n>0&&e<o&&t.fillRect(e,l,n,i)}}}({ctx:t,feat:e,renderArgs:r,canvasWidth:i,color:Q,cigarOps:B}),k){case"perBaseQuality":!function({ctx:t,feat:e,region:r,bpPerPx:o,cigarOps:n}){const{feature:s,topPx:a,heightPx:c}=e,i=(s.get("qual")||"").split(" ").map(t=>+t),l=1/o,f=l,g=s.get("start");let d=0,p=0;const u=r.start,m=r.end,y=r.reversed;for(let e=0,r=n.length;e<r;e++){const r=n[e],o=r>>4,s=15&r;if(s===h.hN||s===h.hE)d+=o;else if(s===h.aT||s===h.a2)p+=o;else if(s===h.hK||s===h.oE||s===h.C4){const e=g+p,r=e+o;if(e>=m)break;if(r>u){const r=Math.max(0,u-e),n=Math.min(o,m-e);for(let o=r;o<n;o++){const r=i[d+o],n=e+o,s=y?(m-n-1)*l:(n-u)*l;t.fillStyle=w[r]||w[0],t.fillRect(s,a,f+.5,c)}}d+=o,p+=o}}}({ctx:t,feat:e,region:I,bpPerPx:d,cigarOps:B});break;case"perBaseLettering":!function({ctx:t,feat:e,region:r,bpPerPx:o,colorMap:n,colorContrastMap:s,charWidth:a,charHeight:c,canvasWidth:i,cigarOps:l}){const f=c-2,{feature:g,topPx:d,heightPx:p}=e,u=g.get("seq"),m=1/o,y=m,x=g.get("start");let _=0,b=0;if(!u)return;const P=r.start,M=r.end,C=r.reversed;for(let e=0,r=l.length;e<r;e++){const r=l[e],o=r>>4,c=15&r;if(c===h.hN||c===h.hE)_+=o;else if(c===h.aT||c===h.a2)b+=o;else if(c===h.hK||c===h.oE||c===h.C4){const e=x+b,r=e+o;if(e>=M)break;if(r>P){const r=Math.max(0,P-e),c=Math.min(o,M-e);for(let o=r;o<c;o++){const r=u[_+o],c=e+o,l=C?(M-c-1)*m:(c-P)*m;if(t.fillStyle=n[r],t.fillRect(l,d,y+.5,p),y>=a&&p>=f){const e=l+(y-a)/2+1,o=d+p,n=s[r];e>=0&&e<=i&&n&&(t.fillStyle=n,t.fillText(r,e,o))}}}_+=o,b+=o}}}({ctx:t,feat:e,region:I,bpPerPx:d,colorMap:o,colorContrastMap:n,charWidth:s,charHeight:a,canvasWidth:i,cigarOps:B});break;case"modifications":S((0,v.k)({ctx:t,feat:e,region:I,bpPerPx:d,renderArgs:r,cigarOps:B}),f,l);break;case"methylation":S(function({ctx:t,feat:e,region:r,bpPerPx:o,renderArgs:n,cigarOps:s}){const a=[],c=[],{regionSequence:i}=n,{feature:l,topPx:f,heightPx:h}=e,g=f+h;if(!i)throw new Error("region sequence required for methylation");if(!l.get("seq"))return{items:a,coords:c};const d=l.get("start"),p=l.get("end"),{methBins:m,methProbs:y,hydroxyMethBins:x,hydroxyMethProbs:v}=(0,_.P)(l,s),w=(0,u.hn)(l,d);function S(t){if(m[t]){const e=y[t]||0;return{color:(e>.5?b.alpha(2*(e-.5)):P.alpha(1-2*e)).toHslString(),prob:e,type:"m (5mC)"}}if(x[t]){const e=v[t]||0;return{color:(e>.5?M.alpha(2*(e-.5)):C.alpha(1-2*e)).toHslString(),prob:e,type:"h (5hmC)"}}}const T=r.start,R=r.end,A=r.reversed,k=1/o,W=i.toLowerCase();function I(e,r,o,n){const s=A?(R-r)*k:(e-T)*k,i=A?(R-e)*k:(r-T)*k,l=i-s+.5;if(t.fillStyle=o?.color||"blue",t.fillRect(s,f,l,h),i-s>=.2){const t=o?.prob??0,r=o?.type??"unmethylated",l=w.get(e);a.push({type:"modification",info:`${n} ${r} (${(100*t).toFixed(1)}%)`,modType:"methylation",probability:t,start:e,mismatch:l}),c.push(s,f,i,g)}}const Q=Math.max(0,T-d),B=Math.min(p-d,R-d);for(let t=Q;t<B;t++){const e=t+d,r=W[e-T+1],n=W[e-T+2];if("c"===r&&"g"===n){const r=S(t),n=S(t+1);o>2?I(e,e+2,r||n,"CpG"):(I(e,e+1,r,"CpG C"),I(e+1,e+2,n,"CpG G"))}}return{items:a,coords:c}}({ctx:t,feat:e,region:I,bpPerPx:d,renderArgs:r,cigarOps:B}),f,l)}return{coords:f,items:l}}var R=r(74721);function A({ctx:t,feat:e,renderArgs:r,config:n,theme:s,colorMap:a,canvasWidth:c}){const{feature:i,topPx:l,heightPx:f}=e,{regions:g,bpPerPx:d}=r,p=g[0],m=(0,o.QZ)(n,"minSubfeatureWidth"),y=i.get("mismatches"),x=i.get("seq"),{charWidth:_,charHeight:b}=(0,u.Sr)();if(!x||!y)return;const P=b-2;let M=0,C=0;const v=i.get("NUMERIC_CIGAR")||i.get("CIGAR"),w=(0,h.tQ)(v),S=i.get("start"),T=p.start,R=p.end,A=p.reversed,k=1/d;for(let e=0,r=w.length;e<r;e++){const r=w[e],o=r>>4,n=15&r;if(n===h.hN){const r=S-(0===e?o:0)+C;if(r+o>T&&r<R){const e=Math.max(0,T-r),n=Math.min(o,R-r);for(let o=e;o<n;o++){const e=x[M+o],n=r+o,i=A?(R-n-1)*k:(n-T)*k,h=A?(R-n)*k:(n+1-T)*k,g=Math.max(m,h-i),d=a[e]||"#000000";if(t.fillStyle=d,t.fillRect(i,l,g,f),g>=_&&f>=P){const r=i+(g-_)/2+1,o=l+f,n=s.palette.getContrastText(d);r>=0&&r<=c&&n&&(t.fillStyle=n,t.fillText(e,r,o))}}}M+=o}else n===h.a2?C+=o:n===h.hK||n===h.C4||n===h.oE?(C+=o,M+=o):n===h.aT?C+=o:n===h.hE&&(M+=o)}}async function k({width:t,renderArgs:e,pluginManager:r}){const{statusCallback:h=()=>{},features:g}=e;h("Creating layout");const{layoutRecords:d,height:p}=function(t){const{layout:e,features:r,sortedBy:n,config:s,showSoftClip:a,regions:c}=t,i=c[0],h=n?.type&&i.start===n.pos,g=h?function(t,e){const r=[],o=[],{pos:n,type:s}=e;let a;for(const e of t.values()){a||(a=e);const t=e.get("start"),s=e.get("end");(0,f.R6)(n-1,n,t,s)?r.push(e):o.push(e)}const c=!!a&&a.get("tags");switch(s){case"Start location":r.sort((t,e)=>t.get("start")-e.get("start"));break;case"tag":{const t=e.tag,o=(t,e)=>c?t.get("tags")[e]:t.get(e);r[0]&&"string"==typeof o(r[0],t)?r.sort((e,r)=>o(r,t).localeCompare(o(e,t))):r.sort((e,r)=>(o(r,t)||0)-(o(e,t)||0));break}case"Base pair":{const t=new Map;for(const e of r){const r=e.get("mismatches"),o=e.get("start");for(const s of r){const r=o+s.start+1,a="insertion"===s.type||"softclip"===s.type?0:s.length;n>=r&&n<r+a&&t.set(e.id(),s)}}r.sort((e,r)=>{const o=t.get(e.id()),n=t.get(r.id()),s="mismatch"===o?.type?o.base.toUpperCase():"deletion"===o?.type?"*":void 0,a="mismatch"===n?.type?n.base.toUpperCase():"deletion"===n?.type?"*":void 0;return s===a&&"*"===s?(n?.length??0)-(o?.length??0):(a?a.charCodeAt(0):0)-(s?s.charCodeAt(0):0)});break}case"Read strand":r.sort((t,e)=>t.get("strand")<=e.get("strand")?1:-1)}const i=new Map;for(const t of r)i.set(t.id(),t);for(const t of o)i.set(t.id(),t);return i}(r,n):r,d=(0,o.QZ)(s,"height"),p=(0,o.QZ)(s,"displayMode"),u=h?[...g.values()]:[...g.values()].sort((t,e)=>t.get("start")-e.get("start")),m=[];for(const t of u){const r=l({feature:t,layout:e,showSoftClip:a,heightPx:d,displayMode:p});r&&m.push(r)}return{layoutRecords:m,height:Math.max(e.getTotalHeight(),1)}}(e);h("Fetching sequence");const m=await async function(t,e){const{colorBy:r,features:o,sessionId:s,regions:a,adapterConfig:c}=t;if("methylation"!==r?.type||!o.size)return;const{dataAdapter:i}=await(0,n.cK)(e,s,c),l=i.sequenceAdapterConfig;if(!l)return;const{dataAdapter:f}=await(0,n.cK)(e,s,l),h=a[0];return f.getSequence({...h,refName:h.originalRefName||h.refName,start:Math.max(0,h.start-1),end:h.end+1})}(e,r);h("Rendering alignments");const y=await(0,a.u)(t,p,e,r=>function({ctx:t,layoutRecords:e,canvasWidth:r,renderArgs:n}){const{stopTokenCheck:a,config:l,showSoftClip:f,colorBy:h,theme:g}=n,d=(0,o.QZ)(l,"mismatchAlpha"),p=(0,o.QZ)(l,"minSubfeatureWidth"),m=(0,o.QZ)(l,"largeInsertionIndicatorScale"),y=(0,o.QZ)(l,"hideSmallIndels"),x=(0,o.QZ)(l,"hideMismatches"),_=(0,o.QZ)(l,"hideLargeIndels"),b="#f0f"===(0,o.QZ)(l,"color"),P=(0,s.createJBrowseTheme)(g),M=(0,u.LI)(P),C=(0,u._7)(P);(0,u.Hh)(t);const{charWidth:v,charHeight:w}=(0,u.Sr)(),S=(0,u.B$)(h?.type),k=(0,u.P9)(),W=[],I=[];for(const o of e){const e=T({ctx:t,feat:o,renderArgs:n,defaultColor:b,colorMap:M,colorContrastMap:C,charWidth:v,charHeight:w,canvasWidth:r});for(let t=0,r=e.coords.length;t<r;t++)W.push(e.coords[t]);for(let t=0,r=e.items.length;t<r;t++)I.push(e.items[t]);const s=(0,R.Y)({ctx:t,feat:o,bpPerPx:n.bpPerPx,regions:n.regions,hideSmallIndels:y,hideMismatches:x,hideLargeIndels:_,mismatchAlpha:d,drawSNPsMuted:S,drawIndels:k,largeInsertionIndicatorScale:m,minSubfeatureWidth:p,charWidth:v,charHeight:w,colorMap:M,colorContrastMap:C,canvasWidth:r});for(let t=0,e=s.coords.length;t<e;t++)W.push(s.coords[t]);for(let t=0,e=s.items.length;t<e;t++)I.push(s.items[t]);f&&A({ctx:t,feat:o,renderArgs:n,colorMap:M,config:l,theme:P,canvasWidth:r}),(0,i.As)(a)}const Q=new c.A(Math.max(I.length,1));if(W.length)for(let t=0;t<W.length;t+=4)Q.add(W[t],W[t+1],W[t+2],W[t+3]);else Q.add(0,0);return Q.finish(),{flatbush:Q.data,items:I}}({ctx:r,layoutRecords:d,canvasWidth:t,renderArgs:{...e,regionSequence:m}})),x={};for(const[t,e]of g){const r=e.get("name");r&&(x[t]=r)}return{result:y,height:p,featureNames:x}}},65118(t,e,r){r.d(e,{P:()=>c});var o=r(77602),n=r(64521),s=r(69558),a=r(86470);function c(t,e){const r=t.get("start"),c=t.get("end"),i=t.get("strand"),l=c-r,f=(0,a.c$)(t,"MM","Mm")||"",h=[],g=[],d=[],p=[],u=t.get("seq");if(u){const r=(0,n.Y)(t),a=(0,o.Z)(f,u,i);let c=0;for(const{type:t,positions:o}of a){for(const{ref:n,idx:a}of(0,s.h)(e,o)){if(n<0||n>=l)continue;const e=c+(-1===i?o.length-1-a:a),s=r?.[e]||0;"m"===t?(h[n]=1,d[n]=s):"h"===t&&(g[n]=1,p[n]=s)}c+=o.length}}return{methBins:h,hydroxyMethBins:g,methProbs:d,hydroxyMethProbs:p}}}}]);
//# sourceMappingURL=8955.487ea7f8.chunk.js.map