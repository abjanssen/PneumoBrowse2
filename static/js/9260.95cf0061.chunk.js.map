{"version":3,"file":"static/js/9260.95cf0061.chunk.js","mappings":"qOAiCA,MA8GA,GA9G8BA,EAAAA,EAAAA,UAAS,SAA+BC,GAcpE,MAAM,SACJC,EAAQ,MACRC,EAAK,aACLC,EAAY,mBACZC,EAAkB,YAClBC,EAAW,cACXC,GACEN,EACEO,GAAMC,EAAAA,EAAAA,QAAuB,MAC7BC,GAAiBD,EAAAA,EAAAA,aAA2BE,GAC5CC,GAAYC,EAAAA,EAAAA,SAAQ,IAAMC,EAAAA,EAASC,KAAKb,GAAW,CAACA,IAEpDc,GAAuBC,EAAAA,EAAAA,aAC3B,CAACC,EAAsBC,KACrB,IAAKX,EAAIY,QACP,OAEF,MAAMC,EAAOb,EAAIY,QAAQE,wBACnBC,EAAUL,EAAeG,EAAKG,KAK9BC,EAJUN,EAAeE,EAAKK,IAIJnB,EAC1BoB,EAAIf,EAAUgB,OAClBL,EACAE,EACAF,EAAU,EACVE,EAAgB,GAElB,GAAIE,EAAEE,OAAQ,CACZ,MAAMC,EC9EP,SAAmBC,EAAkBC,GAC1C,IACIC,EADAC,EAAMC,IAEV,IAAK,MAAMC,KAASL,EAAK,CACvB,MAAMM,EAAML,EAAGI,GAEXC,EAAMH,IACRA,EAAMG,EACNJ,EAAaG,EAEjB,CACA,OAAOH,CACT,CDkEoBK,CAAOX,EAAGY,GAAOpC,EAAMoC,IAAMC,OAAS,IAC5C,MAAEA,EAAK,SAAEC,EAAQ,UAAEC,KAAcC,GAASxC,EAAM2B,IAAQ,CAAC,EACzDc,OACUjC,IAAd+B,EAA0BrC,EAAmBqC,QAAa/B,EAC5D,GAAIiC,GAAOH,EAAU,CACnB,MAAM,IAAEjC,EAAG,IAAEqC,EAAG,KAAEC,EAAI,YAAEC,EAAW,OAAElB,GAAWe,EAEhD,MAAO,IACFD,EACHF,WACAO,SAJcC,EAAAA,EAAAA,IAAoBR,EAAUjC,EAAKqC,GAKjDK,YAAaJ,EACbC,YAAaF,EAAIhB,QAAU,EAAI,uBAAyBkB,EACxDlB,QAAQsB,EAAAA,EAAAA,iBAAgBtB,GAE5B,CACF,GAGF,CAACjB,EAAWT,EAAOE,EAAoBE,IAGnC6C,GAAkBnC,EAAAA,EAAAA,aACrBoC,IACC,MAAMC,EAAStC,EAAqBqC,EAAEE,QAASF,EAAEG,SAC3CC,EAAMH,EAAS,GAAGA,EAAOR,QAAQQ,EAAOb,gBAAa9B,EACvD8C,IAAQ/C,EAAeU,UACzBV,EAAeU,QAAUqC,EACzBrD,EAAasD,qBAAqBJ,KAGtC,CAACtC,EAAsBZ,IAGnBuD,GAAmB1C,EAAAA,EAAAA,aAAY,UACJN,IAA3BD,EAAeU,UACjBV,EAAeU,aAAUT,EACzBP,EAAasD,0BAAqB/C,KAEnC,CAACP,IAEJ,OACEwD,EAAAA,EAAAA,KAAA,OACEpD,IAAKA,EACLqD,YAAaT,EACbU,aAAcH,EACdI,WAAYJ,EACZK,MAAO,CACLC,SAAU,UACVC,SAAU,WACVC,OAAQ7D,GACR8D,UAEFR,EAAAA,EAAAA,KAACS,EAAAA,EAAiB,IACZpE,EACJ+D,MAAO,CACLE,SAAU,WACV1C,KAAM,EACNE,IAAKnB,MAKf,E,6EExIA,MAAM+D,EAAqB,OAE3B,SAASC,EAAW1B,GAClB,OACEA,EAAI2B,SAAS,MACb3B,EAAI2B,SAAS,MACb3B,EAAI4B,WAAW,MACf5B,EAAI6B,SAAS,IAEjB,CAEA,SAASC,EAAW9B,GAClB,OAAOA,EAAI4B,WAAW,MAAQF,EAAW1B,EAC3C,CAMA,MAAM+B,EAAsC,CAC1C,QAAS,WACT,QAAS,YACT,QAAS,cACT,QAAS,YACT,WAAY,uBACZ,QAAS,wBACT,QAAS,gBACT,eAAgB,qBAChB,YAAa,mBACb,MAAO,oBAGF,SAASC,EACdrE,EACAqC,EACAiC,GAEA,IAAKjC,GAAsB,IAAfA,EAAIhB,OACd,MAAO,CAAC,SAAU,0BAGpB,MAAMkD,EAAUlC,EAAImC,IAAIC,GAO1B,SAAmBpC,EAAarC,EAAasE,GAE3C,GAAIjC,EAAI4B,WAAW,KACjB,OAAOS,EAAWrC,EAAKiC,IAAW,UAIpC,GAAIP,EAAW1B,KAAQsC,EAAAA,EAAAA,GAActC,GACnC,MAAO,WAGT,MAAMuC,EAAS5E,EAAIqB,OACbwD,EAASxC,EAAIhB,OAEnB,OAAe,IAAXuD,GAA2B,IAAXC,EACX,MACED,IAAWC,EAjDxB,SAAqB7E,EAAaqC,GAChC,OAAOrC,EAAI8E,MAAM,IAAIC,UAAUC,KAAK,MAAQ3C,CAC9C,CAgDW4C,CAAYjF,EAAKqC,GAAO,YAAc,eAEtCuC,EAASC,EAAS,YAAc,UAE3C,CA5B+BK,CAAUT,EAAGzE,EAAKsE,IACzCa,EAAgB,IAAI,IAAIC,IAAIb,IAC5BhC,EA4BR,SAAgCvC,EAAaqF,GAC3C,GAAIA,EAAKC,MAAMnB,GACb,OAAOkB,EAAKL,KAAK,KAGnB,MAAMJ,EAAS5E,EAAIqB,OAEnB,MAAO,GAAGrB,EAAIqB,OAAS,IAAKsB,EAAAA,EAAAA,iBAAgBiC,GAAU5E,QAAUqF,EAAKb,IAAIC,GAAMA,EAAEpD,OAAS,IAAKsB,EAAAA,EAAAA,iBAAgB8B,EAAEpD,QAAUoD,GAAIO,KAAK,MACtI,CApCsBO,CAAuBvF,EAAKqC,GAEhD,MAAO,CAAC8C,EAAcH,KAAK,KAAMzC,EACnC,CAmCA,SAASmC,EAAWrC,EAAaiC,GAC/B,GAAIF,EAAY/B,GACd,OAAO+B,EAAY/B,GAErB,GAAIiC,EAAOkB,YAAY,MAAOnD,GAC5B,MAAO,mBAGT,MAAMoD,EAAQpD,EAAIqD,MAAM,GAAI,GAAGZ,MAAM,KACrC,OAAOW,EAAMpE,OAAS,EAClBqD,EAAW,IAAIe,EAAMC,MAAM,GAAI,GAAGV,KAAK,QAASV,QAChDnE,CACN,CAWO,SAASwF,EAAe3F,EAAaqC,GAC1C,GAAI8B,EAAW9B,IAAwB,IAAfrC,EAAIqB,QAA+B,IAAfgB,EAAIhB,OAC9C,OAAOgB,EAGT,MAAMuC,EAAS5E,EAAIqB,OACbwD,EAASxC,EAAIhB,OAGnB,OAFeuD,EAAS,GAAKC,EAAS,EAGlC,IAAGlC,EAAAA,EAAAA,iBAAgBiC,UAAcjC,EAAAA,EAAAA,iBAAgBkC,KACjD,GAAG7E,QAAUqC,GACnB,CAEO,SAASI,EACdR,EACAjC,EACAqC,GAEA,OAAOJ,EACJ6C,MAAMhB,GACNU,IAAIoB,GACG,MAANA,EACI,IACO,KAANA,EACC,OAAO5F,EAAIqB,OAAS,GAAKrB,GAAM2C,EAAAA,EAAAA,iBAAgB3C,EAAIqB,WACnDsE,EAAe3F,EAAKqC,GAAKuD,EAAI,IAAM,KAE1CZ,KAAK/C,EAAS+B,SAAS,KAAO,IAAM,IACzC,C","sources":["../../../plugins/variants/src/MultiLinearVariantRenderer/components/MultiLinearVariantRendering.tsx","../../../plugins/variants/src/MultiLinearVariantRenderer/components/util.ts","../../../plugins/variants/src/VcfFeature/util.ts"],"sourcesContent":["import { useCallback, useMemo, useRef } from 'react'\n\nimport { PrerenderedCanvas } from '@jbrowse/core/ui'\nimport { getBpDisplayStr } from '@jbrowse/core/util'\nimport Flatbush from '@jbrowse/core/util/flatbush'\nimport { observer } from 'mobx-react'\n\nimport { minElt } from './util.ts'\nimport { makeSimpleAltString } from '../../VcfFeature/util.ts'\n\nimport type { Source } from '../../shared/types.ts'\nimport type { Feature } from '@jbrowse/core/util'\nimport type { Region } from '@jbrowse/core/util/types'\n\ninterface Item {\n  name: string\n  genotype: string\n  featureId: string\n  bpLen: number\n}\n\ninterface MinimizedVariantRecord {\n  alt: string[]\n  ref: string\n  name: string\n  description: string\n  length: number\n}\n\ninterface MultiVariantDisplayModel {\n  setHoveredGenotype?: (genotype?: Record<string, unknown>) => void\n}\n\nconst MultiVariantRendering = observer(function MultiVariantRendering(props: {\n  regions: Region[]\n  features: Map<string, Feature>\n  bpPerPx: number\n  width: number\n  height: number\n  sources: Source[]\n  origScrollTop: number\n  featureGenotypeMap: Record<string, MinimizedVariantRecord>\n  totalHeight: number\n  flatbush: any\n  items: Item[]\n  displayModel: MultiVariantDisplayModel\n}) {\n  const {\n    flatbush,\n    items,\n    displayModel,\n    featureGenotypeMap,\n    totalHeight,\n    origScrollTop,\n  } = props\n  const ref = useRef<HTMLDivElement>(null)\n  const lastHoveredRef = useRef<string | undefined>(undefined)\n  const flatbush2 = useMemo(() => Flatbush.from(flatbush), [flatbush])\n\n  const getFeatureUnderMouse = useCallback(\n    (eventClientX: number, eventClientY: number) => {\n      if (!ref.current) {\n        return\n      }\n      const rect = ref.current.getBoundingClientRect()\n      const offsetX = eventClientX - rect.left\n      const offsetY = eventClientY - rect.top\n\n      // Canvas is positioned at top=origScrollTop, so adjust mouse position\n      // relative to canvas top for Flatbush lookup\n      const canvasOffsetY = offsetY - origScrollTop\n      const x = flatbush2.search(\n        offsetX,\n        canvasOffsetY,\n        offsetX + 1,\n        canvasOffsetY + 1,\n      )\n      if (x.length) {\n        const res = minElt(x, idx => items[idx]?.bpLen ?? 0)!\n        const { bpLen, genotype, featureId, ...rest } = items[res] ?? {}\n        const ret =\n          featureId !== undefined ? featureGenotypeMap[featureId] : undefined\n        if (ret && genotype) {\n          const { ref, alt, name, description, length } = ret\n          const alleles = makeSimpleAltString(genotype, ref, alt)\n          return {\n            ...rest,\n            genotype,\n            alleles,\n            featureName: name,\n            description: alt.length >= 3 ? 'multiple ALT alleles' : description,\n            length: getBpDisplayStr(length),\n          }\n        }\n      }\n      return undefined\n    },\n    [flatbush2, items, featureGenotypeMap, origScrollTop],\n  )\n\n  const handleMouseMove = useCallback(\n    (e: React.MouseEvent) => {\n      const result = getFeatureUnderMouse(e.clientX, e.clientY)\n      const key = result ? `${result.name}:${result.genotype}` : undefined\n      if (key !== lastHoveredRef.current) {\n        lastHoveredRef.current = key\n        displayModel.setHoveredGenotype?.(result)\n      }\n    },\n    [getFeatureUnderMouse, displayModel],\n  )\n\n  const handleMouseLeave = useCallback(() => {\n    if (lastHoveredRef.current !== undefined) {\n      lastHoveredRef.current = undefined\n      displayModel.setHoveredGenotype?.(undefined)\n    }\n  }, [displayModel])\n\n  return (\n    <div\n      ref={ref}\n      onMouseMove={handleMouseMove}\n      onMouseLeave={handleMouseLeave}\n      onMouseOut={handleMouseLeave}\n      style={{\n        overflow: 'visible',\n        position: 'relative',\n        height: totalHeight,\n      }}\n    >\n      <PrerenderedCanvas\n        {...props}\n        style={{\n          position: 'absolute',\n          left: 0,\n          top: origScrollTop,\n        }}\n      />\n    </div>\n  )\n})\n\nexport default MultiVariantRendering\n","export function minElt<T>(arr: Iterable<T>, cb: (arg: T) => number) {\n  let min = Infinity\n  let minElement: T | undefined\n  for (const entry of arr) {\n    const val = cb(entry)\n\n    if (val < min) {\n      min = val\n      minElement = entry\n    }\n  }\n  return minElement\n}\n","import { parseBreakend } from '@gmod/vcf'\nimport { getBpDisplayStr } from '@jbrowse/core/util'\n\nimport type VCF from '@gmod/vcf'\n\nconst genotypeDelimRegex = /[/|]/\n\nfunction isBreakend(alt: string) {\n  return (\n    alt.includes('[') ||\n    alt.includes(']') ||\n    alt.startsWith('.') ||\n    alt.endsWith('.')\n  )\n}\n\nfunction isSymbolic(alt: string) {\n  return alt.startsWith('<') || isBreakend(alt)\n}\n\nfunction isInversion(ref: string, alt: string) {\n  return ref.split('').reverse().join('') === alt\n}\n\nconst altTypeToSO: Record<string, string> = {\n  '<DEL>': 'deletion',\n  '<INS>': 'insertion',\n  '<DUP>': 'duplication',\n  '<INV>': 'inversion',\n  '<INVDUP>': 'inverted_duplication',\n  '<CNV>': 'copy_number_variation',\n  '<TRA>': 'translocation',\n  '<DUP:TANDEM>': 'tandem_duplication',\n  '<NON_REF>': 'sequence_variant',\n  '<*>': 'sequence_variant',\n}\n\nexport function getSOTermAndDescription(\n  ref: string,\n  alt: string[] | undefined,\n  parser: VCF,\n): string[] {\n  if (!alt || alt.length === 0) {\n    return ['remark', 'no alternative alleles']\n  }\n\n  const soTerms = alt.map(a => getSOTerm(a, ref, parser))\n  const uniqueSoTerms = [...new Set(soTerms)]\n  const description = formatGroupDescription(ref, alt)\n\n  return [uniqueSoTerms.join(','), description]\n}\n\nfunction getSOTerm(alt: string, ref: string, parser: VCF): string {\n  // Symbolic alleles\n  if (alt.startsWith('<')) {\n    return findSOTerm(alt, parser) ?? 'variant'\n  }\n\n  // Breakends\n  if (isBreakend(alt) && parseBreakend(alt)) {\n    return 'breakend'\n  }\n\n  const lenRef = ref.length\n  const lenAlt = alt.length\n\n  if (lenRef === 1 && lenAlt === 1) {\n    return 'SNV'\n  } else if (lenRef === lenAlt) {\n    return isInversion(ref, alt) ? 'inversion' : 'substitution'\n  } else {\n    return lenRef < lenAlt ? 'insertion' : 'deletion'\n  }\n}\n\nfunction formatGroupDescription(ref: string, alts: string[]): string {\n  if (alts.every(isSymbolic)) {\n    return alts.join(',')\n  }\n\n  const lenRef = ref.length\n\n  return `${ref.length > 10 ? getBpDisplayStr(lenRef) : ref} -> ${alts.map(a => (a.length > 10 ? getBpDisplayStr(a.length) : a)).join(',')}`\n}\n\nfunction findSOTerm(alt: string, parser: VCF): string | undefined {\n  if (altTypeToSO[alt]) {\n    return altTypeToSO[alt]\n  }\n  if (parser.getMetadata('ALT', alt)) {\n    return 'sequence_variant'\n  }\n  // Try parent term by stripping last component, e.g. '<INS:ME>' -> '<INS>'\n  const parts = alt.slice(1, -1).split(':')\n  return parts.length > 1\n    ? findSOTerm(`<${parts.slice(0, -1).join(':')}>`, parser)\n    : undefined\n}\n\nexport function getSOAndDescFromAltDefs(alt: string, parser: VCF): string[] {\n  if (!alt.startsWith('<')) {\n    return []\n  }\n\n  const soTerm = findSOTerm(alt, parser)\n  return [soTerm ?? 'variant', alt]\n}\n\nexport function getMinimalDesc(ref: string, alt: string) {\n  if (isSymbolic(alt) || (ref.length === 1 && alt.length === 1)) {\n    return alt\n  }\n\n  const lenRef = ref.length\n  const lenAlt = alt.length\n  const isLong = lenRef > 5 || lenAlt > 5\n\n  return isLong\n    ? `${getBpDisplayStr(lenRef)} -> ${getBpDisplayStr(lenAlt)}`\n    : `${ref} -> ${alt}`\n}\n\nexport function makeSimpleAltString(\n  genotype: string,\n  ref: string,\n  alt: string[],\n) {\n  return genotype\n    .split(genotypeDelimRegex)\n    .map(r =>\n      r === '.'\n        ? '.'\n        : +r === 0\n          ? `ref(${ref.length < 10 ? ref : getBpDisplayStr(ref.length)})`\n          : getMinimalDesc(ref, alt[+r - 1] || ''),\n    )\n    .join(genotype.includes('|') ? '|' : '/')\n}\n"],"names":["observer","props","flatbush","items","displayModel","featureGenotypeMap","totalHeight","origScrollTop","ref","useRef","lastHoveredRef","undefined","flatbush2","useMemo","Flatbush","from","getFeatureUnderMouse","useCallback","eventClientX","eventClientY","current","rect","getBoundingClientRect","offsetX","left","canvasOffsetY","top","x","search","length","res","arr","cb","minElement","min","Infinity","entry","val","minElt","idx","bpLen","genotype","featureId","rest","ret","alt","name","description","alleles","makeSimpleAltString","featureName","getBpDisplayStr","handleMouseMove","e","result","clientX","clientY","key","setHoveredGenotype","handleMouseLeave","_jsx","onMouseMove","onMouseLeave","onMouseOut","style","overflow","position","height","children","PrerenderedCanvas","genotypeDelimRegex","isBreakend","includes","startsWith","endsWith","isSymbolic","altTypeToSO","getSOTermAndDescription","parser","soTerms","map","a","findSOTerm","parseBreakend","lenRef","lenAlt","split","reverse","join","isInversion","getSOTerm","uniqueSoTerms","Set","alts","every","formatGroupDescription","getMetadata","parts","slice","getMinimalDesc","r"],"ignoreList":[],"sourceRoot":""}