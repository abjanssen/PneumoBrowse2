{"version":3,"file":"static/js/1792.15937d0b.chunk.js","mappings":"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","sources":["webpack://@jbrowse/web/../../plugins/linear-genome-view/src/BaseLinearDisplay/SVGLegend.tsx","webpack://@jbrowse/web/../../plugins/linear-genome-view/src/BaseLinearDisplay/models/SvgFloatingLabels.tsx","webpack://@jbrowse/web/../../plugins/linear-genome-view/src/LinearGenomeView/SVGErrorBox.tsx","webpack://@jbrowse/web/../../plugins/linear-genome-view/src/BaseLinearDisplay/renderSvg.tsx"],"sourcesContent":["import { measureText } from '@jbrowse/core/util'\n\nimport type { LegendItem } from './components/FloatingLegend.tsx'\n\nconst LEGEND_FONT_SIZE = 10\nconst LEGEND_BOX_SIZE = 12\nconst LEGEND_PADDING = 3\n\nexport default function SVGLegend({\n  items,\n  width,\n  legendAreaWidth,\n}: {\n  items: LegendItem[]\n  width: number\n  legendAreaWidth?: number\n}) {\n  if (items.length === 0) {\n    return null\n  }\n\n  const itemHeight = LEGEND_BOX_SIZE + 2\n  const legendHeight = items.length * itemHeight + LEGEND_PADDING * 2\n\n  // Calculate legend width based on longest label\n  const maxLabelWidth = Math.max(\n    ...items.map(item => measureText(item.label, LEGEND_FONT_SIZE)),\n  )\n  const legendWidth = LEGEND_BOX_SIZE + 8 + maxLabelWidth + LEGEND_PADDING * 2\n\n  // If legendAreaWidth is provided, position legend to the right of the figure\n  // Otherwise, position it inside the figure area (top-right corner)\n  const x = legendAreaWidth ? width + 10 : width - legendWidth - 10\n  const y = 10\n\n  return (\n    <g transform={`translate(${x}, ${y})`}>\n      <rect\n        x={0}\n        y={0}\n        width={legendWidth}\n        height={legendHeight}\n        fill=\"rgba(255,255,255,0.9)\"\n        stroke=\"#ccc\"\n        strokeWidth={1}\n        rx={4}\n      />\n      {items.map((item, idx) => (\n        <g\n          key={`legend-${idx}`}\n          transform={`translate(${LEGEND_PADDING}, ${LEGEND_PADDING + idx * itemHeight})`}\n        >\n          {item.color ? (\n            <rect\n              x={0}\n              y={0}\n              width={LEGEND_BOX_SIZE}\n              height={LEGEND_BOX_SIZE}\n              fill={item.color}\n            />\n          ) : null}\n          <text\n            x={LEGEND_BOX_SIZE + 6}\n            y={LEGEND_BOX_SIZE - 2}\n            fontSize={LEGEND_FONT_SIZE}\n            fill=\"black\"\n          >\n            {item.label}\n          </text>\n        </g>\n      ))}\n    </g>\n  )\n}\n","import {\n  type FeatureLabelData,\n  calculateFloatingLabelPosition,\n} from '../components/util.ts'\n\ninterface Props {\n  featureLabels: Map<string, FeatureLabelData>\n  offsetPx: number\n  viewWidth: number\n}\n\nexport function SvgFloatingLabels({\n  featureLabels,\n  offsetPx,\n  viewWidth,\n}: Props) {\n  const elements: React.ReactElement[] = []\n\n  for (const [\n    key,\n    { leftPx, topPx, totalFeatureHeight, floatingLabels, featureWidth },\n  ] of featureLabels.entries()) {\n    const featureVisualBottom = topPx + totalFeatureHeight\n    const featureRightPx = leftPx + featureWidth\n\n    for (const [\n      i,\n      { text, relativeY, color, textWidth, isOverlay },\n    ] of floatingLabels.entries()) {\n      const y = featureVisualBottom + relativeY\n      const x = calculateFloatingLabelPosition(\n        leftPx,\n        featureRightPx,\n        textWidth,\n        offsetPx,\n      )\n\n      if (x < 0 || x > viewWidth) {\n        continue\n      }\n\n      const fontSize = 11\n      elements.push(\n        <g key={`${key}-${i}`} transform={`translate(${x}, ${y})`}>\n          {isOverlay ? (\n            <rect\n              x={-1}\n              y={0}\n              width={textWidth + 2}\n              height={fontSize + 1}\n              fill=\"rgba(255, 255, 255, 0.8)\"\n            />\n          ) : null}\n          <text\n            x={0}\n            y={fontSize}\n            fontSize={fontSize}\n            fill={color}\n            style={{ pointerEvents: 'none' }}\n          >\n            {text}\n          </text>\n        </g>,\n      )\n    }\n  }\n\n  return <>{elements}</>\n}\n","export function ErrorBox({\n  error,\n  width,\n  height,\n}: {\n  error: unknown\n  width: number\n  height: number\n}) {\n  return (\n    <>\n      <rect x={0} y={0} width={width} height={height} fill=\"#ffdddd\" />\n      <text x={10} y={height / 2} fill=\"#cc0000\" fontSize={14}>\n        {`${error}`}\n      </text>\n    </>\n  )\n}\n","import { Fragment } from 'react'\n\nimport { createJBrowseTheme } from '@jbrowse/core/ui'\nimport {\n  ReactRendering,\n  getContainingView,\n  getSession,\n} from '@jbrowse/core/util'\nimport CompositeMap from '@jbrowse/core/util/compositeMap'\n\nimport SVGLegend from './SVGLegend.tsx'\nimport {\n  collectLayoutsFromRenderings,\n  deduplicateFeatureLabels,\n} from './components/util.ts'\nimport { SvgFloatingLabels } from './models/SvgFloatingLabels.tsx'\nimport BlockState, {\n  renderBlockData,\n} from './models/serverSideRenderedBlock.ts'\nimport { getId } from './models/util.ts'\nimport { ErrorBox } from '../LinearGenomeView/SVGErrorBox.tsx'\n\nimport type { BaseLinearDisplayModel } from './model.ts'\nimport type { ExportSvgDisplayOptions, LayoutRecord } from './types.ts'\nimport type { LinearGenomeViewModel } from '../LinearGenomeView/index.ts'\n\nexport async function renderBaseLinearDisplaySvg(\n  self: BaseLinearDisplayModel,\n  opts: ExportSvgDisplayOptions,\n) {\n  const { height, id } = self\n  const { overrideHeight } = opts\n  const view = getContainingView(self) as LinearGenomeViewModel\n  const { offsetPx: viewOffsetPx, roundedDynamicBlocks, width } = view\n\n  if (self.error) {\n    return <ErrorBox error={self.error} width={width} height={height} />\n  }\n\n  const renderings = await Promise.all(\n    roundedDynamicBlocks.map(async block => {\n      const blockState = BlockState.create({\n        key: block.key,\n        region: block,\n      })\n\n      // regionCannotBeRendered can return jsx so look for plaintext\n      // version, or just get the default if none available\n      const cannotBeRenderedReason =\n        self.regionCannotBeRenderedText(block) ||\n        self.regionCannotBeRendered(block)\n\n      if (cannotBeRenderedReason) {\n        return [\n          block,\n          {\n            reactElement: (\n              <>\n                <rect x={0} y={0} width={width} height={20} fill=\"#aaa\" />\n                <text x={0} y={15}>\n                  {cannotBeRenderedReason}\n                </text>\n              </>\n            ),\n          },\n        ] as const\n      }\n\n      const {\n        rpcManager,\n        renderArgs,\n        renderProps,\n        renderingProps,\n        rendererType,\n      } = renderBlockData(blockState, self)\n\n      return [\n        block,\n        await rendererType.renderInClient(rpcManager, {\n          ...renderArgs,\n          ...renderProps,\n          renderingProps,\n          exportSVG: opts,\n          theme: opts.theme || renderProps.theme,\n        }),\n      ] as const\n    }),\n  )\n\n  // Collect layout data from the renderings for floating labels\n  // This is needed because in standalone SVG export (e.g., jbrowse-img),\n  // the model's blockState is not populated with rendering results\n  const layoutMaps = collectLayoutsFromRenderings(renderings)\n  const layoutFeatures = new CompositeMap<string, LayoutRecord>(layoutMaps)\n\n  // Calculate floating label data using the rendering results\n  const { assemblyManager } = getSession(self)\n  const { offsetPx, bpPerPx } = view\n  const assemblyName = view.assemblyNames[0]\n  const assembly = assemblyName ? assemblyManager.get(assemblyName) : undefined\n  const featureLabels = deduplicateFeatureLabels(\n    layoutFeatures,\n    view,\n    assembly,\n    bpPerPx,\n  )\n\n  // Create a clip path ID for the labels that covers the entire view\n  const labelsClipId = getId(id, 'labels')\n\n  // Get legend items if legend is enabled\n  const theme = createJBrowseTheme(opts.theme)\n  const legendItems = self.showLegend ? self.legendItems(theme) : []\n\n  return (\n    <>\n      {renderings.map(([block, rendering], index) => {\n        const { offsetPx, widthPx } = block\n        const offset = offsetPx - viewOffsetPx\n        const clipid = getId(id, index)\n\n        return (\n          <Fragment key={`frag-${index}`}>\n            <defs>\n              <clipPath id={clipid}>\n                <rect\n                  x={0}\n                  y={0}\n                  width={widthPx}\n                  height={overrideHeight || height}\n                />\n              </clipPath>\n            </defs>\n            <g transform={`translate(${offset} 0)`}>\n              <g clipPath={`url(#${clipid})`}>\n                <ReactRendering rendering={rendering} />\n              </g>\n            </g>\n          </Fragment>\n        )\n      })}\n      {/* Render floating labels with clipping */}\n      <defs>\n        <clipPath id={labelsClipId}>\n          <rect x={0} y={0} width={width} height={overrideHeight || height} />\n        </clipPath>\n      </defs>\n      <g clipPath={`url(#${labelsClipId})`}>\n        <SvgFloatingLabels\n          featureLabels={featureLabels}\n          offsetPx={offsetPx}\n          viewWidth={width}\n        />\n      </g>\n      {legendItems.length > 0 ? (\n        <SVGLegend\n          items={legendItems}\n          width={width}\n          legendAreaWidth={opts.legendWidth}\n        />\n      ) : null}\n    </>\n  )\n}\n"],"names":["SVGLegend","t0","$","_c","items","width","legendAreaWidth","length","legendHeight","LEGEND_BOX_SIZE","LEGEND_PADDING","t1","Math","max","map","_temp","legendWidth","t2","t3","t4","t5","_jsx","x","y","fill","stroke","strokeWidth","rx","Symbol","for","item_0","idx","_jsxs","transform","children","item","color","LEGEND_FONT_SIZE","label","measureText","SvgFloatingLabels","featureLabels","offsetPx","viewWidth","elements","key","leftPx","topPx","totalFeatureHeight","floatingLabels","featureWidth","entries","featureVisualBottom","featureRightPx","i","text","relativeY","textWidth","isOverlay","calculateFloatingLabelPosition","fontSize","push","height","style","pointerEvents","_Fragment","ErrorBox","error","async","renderBaseLinearDisplaySvg","self","opts","id","overrideHeight","view","getContainingView","viewOffsetPx","roundedDynamicBlocks","renderings","Promise","all","blockState","BlockState","create","block","region","cannotBeRenderedReason","regionCannotBeRenderedText","regionCannotBeRendered","reactElement","rpcManager","renderArgs","renderProps","renderingProps","rendererType","renderBlockData","renderInClient","exportSVG","theme","layoutMaps","collectLayoutsFromRenderings","layoutFeatures","CompositeMap","assemblyManager","getSession","bpPerPx","assemblyName","assemblyNames","assembly","get","undefined","deduplicateFeatureLabels","labelsClipId","getId","createJBrowseTheme","legendItems","showLegend","rendering","index","widthPx","offset","clipid","Fragment","clipPath","ReactRendering"],"sourceRoot":""}