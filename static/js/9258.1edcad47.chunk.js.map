{"version":3,"file":"static/js/9258.1edcad47.chunk.js","mappings":"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","sources":["webpack://@jbrowse/web/../../node_modules/.pnpm/@gmod+trix@3.0.10/node_modules/@gmod/trix/src/util.ts","webpack://@jbrowse/web/../../node_modules/.pnpm/@gmod+trix@3.0.10/node_modules/@gmod/trix/src/index.ts","webpack://@jbrowse/web/../../node_modules/.pnpm/@gmod+trix@3.0.10/node_modules/@gmod/trix/src/dedupe.ts","webpack://@jbrowse/web/../../plugins/trix/src/TrixTextSearchAdapter/TrixTextSearchAdapter.ts"],"sourcesContent":["export function sum(array: Uint8Array[]) {\n  let total = 0\n  for (const entry of array) {\n    total += entry.length\n  }\n  return total\n}\nexport function concatUint8Array(args: Uint8Array[]) {\n  const mergedArray = new Uint8Array(sum(args))\n  let offset = 0\n  for (const entry of args) {\n    mergedArray.set(entry, offset)\n    offset += entry.length\n  }\n  return mergedArray\n}\n","import { dedupe } from './dedupe.ts'\nimport { concatUint8Array } from './util.ts'\n\nimport type { GenericFilehandle } from 'generic-filehandle2'\n\nconst CHUNK_SIZE = 65536\n\n// this is the number of hex characters to use for the address in ixixx, see\n// https://github.com/GMOD/ixixx-js/blob/master/src/index.ts#L182\nconst ADDRESS_SIZE = 10\n\nexport default class Trix {\n  private decoder = new TextDecoder('utf8')\n  private indexCache?: readonly (readonly [string, number])[]\n  private ixFileSize?: number\n\n  constructor(\n    public ixxFile: GenericFilehandle,\n    public ixFile: GenericFilehandle,\n    public maxResults = 20,\n  ) {}\n\n  private async getIxFileSize(opts?: { signal?: AbortSignal }) {\n    if (this.ixFileSize !== undefined) {\n      return this.ixFileSize\n    }\n    try {\n      // @ts-expect-error\n      const stat = await this.ixFile.stat(opts)\n      this.ixFileSize = stat.size\n      return this.ixFileSize\n    } catch {\n      return undefined\n    }\n  }\n\n  async search(searchString: string, opts?: { signal?: AbortSignal }) {\n    let resultArr = [] as [string, string][]\n    const searchWords = searchString.split(' ')\n    const firstWord = searchWords[0]\n\n    // validate that we have a non-empty search term\n    if (firstWord) {\n      const searchWord = firstWord.toLowerCase()\n      const res = await this.getBuffer(searchWord, opts)\n\n      let { end, buffer } = res\n      const { fileSize } = res\n      let done = false\n      // eslint-disable-next-line @typescript-eslint/no-unnecessary-condition\n      while (!done) {\n        const str = this.decoder.decode(buffer)\n\n        // slice to lastIndexOf('\\n') to make sure we get complete records\n        // since the buffer fetch could get halfway into a record\n        const lines = str\n          .slice(0, str.lastIndexOf('\\n'))\n          .split('\\n')\n          .filter(Boolean)\n\n        const hits2 = [] as string[]\n        for (const line of lines) {\n          const word = line.split(' ')[0]\n\n          if (word.startsWith(searchWord)) {\n            hits2.push(line)\n          } else if (word > searchWord) {\n            // we are done scanning if we are lexicographically greater than\n            // the search string\n            done = true\n          }\n        }\n        const hits = hits2.flatMap(line => {\n          const [term, ...parts] = line.split(' ')\n          return parts\n            .filter(Boolean)\n            .map(elt => [term, elt.split(',')[0]] as [string, string])\n        })\n\n        resultArr = resultArr.concat(hits)\n\n        // if we are done or have filled up maxResults, break\n        if (done || resultArr.length >= this.maxResults) {\n          break\n        }\n\n        // avoid reading past end of file\n        if (fileSize !== undefined && end >= fileSize) {\n          break\n        }\n\n        // fetch more data, clamping to file size if known\n        let bytesToRead = CHUNK_SIZE\n        if (fileSize !== undefined) {\n          bytesToRead = Math.min(CHUNK_SIZE, fileSize - end)\n        }\n        const res2 = await this.ixFile.read(bytesToRead, end, opts)\n        if (res2.length === 0) {\n          break\n        }\n        buffer = concatUint8Array([buffer, res2])\n        end += res2.length\n      }\n    }\n\n    // de-duplicate results based on the detail column (resultArr[1])\n    return dedupe(resultArr, elt => elt[1]).slice(0, this.maxResults)\n  }\n\n  private async getIndex(opts?: { signal?: AbortSignal }) {\n    if (this.indexCache) {\n      return this.indexCache\n    }\n    const file = await this.ixxFile.readFile({\n      encoding: 'utf8',\n      ...opts,\n    })\n    const result = file\n      .split('\\n')\n      .filter(Boolean)\n      .map(line => {\n        const p = line.length - ADDRESS_SIZE\n        const prefix = line.slice(0, p)\n        const posStr = line.slice(p)\n        const pos = Number.parseInt(posStr, 16)\n        return [prefix, pos] as const\n      })\n    this.indexCache = result\n    return result\n  }\n\n  private async getBuffer(searchWord: string, opts?: { signal?: AbortSignal }) {\n    let start = 0\n    let end = CHUNK_SIZE\n    const indexes = await this.getIndex(opts)\n    for (const [key, value] of indexes) {\n      const trimmedKey = key.slice(0, searchWord.length)\n      if (trimmedKey < searchWord) {\n        start = value\n        end = value + CHUNK_SIZE\n      }\n    }\n\n    const fileSize = await this.getIxFileSize(opts)\n    if (fileSize !== undefined) {\n      end = Math.min(end, fileSize)\n    }\n\n    const buffer = await this.ixFile.read(end - start, start, opts)\n    return { buffer, end, fileSize }\n  }\n}\n","type Hasher<T> = (input: T) => string\n\n// from https://github.com/seriousManual/dedupe/blob/master/LICENSE\nexport function dedupe<T>(list: T[], hasher: Hasher<T> = JSON.stringify) {\n  const clone: T[] = []\n  const lookup = new Set<string>()\n\n  for (const entry of list) {\n    const hashed = hasher(entry)\n\n    if (!lookup.has(hashed)) {\n      clone.push(entry)\n      lookup.add(hashed)\n    }\n  }\n\n  return clone\n}\n","import Trix from '@gmod/trix'\nimport BaseResult from '@jbrowse/core/TextSearch/BaseResults'\nimport { readConfObject } from '@jbrowse/core/configuration'\nimport { BaseAdapter } from '@jbrowse/core/data_adapters/BaseAdapter'\nimport { openLocation } from '@jbrowse/core/util/io'\n\nimport type PluginManager from '@jbrowse/core/PluginManager'\nimport type { AnyConfigurationModel } from '@jbrowse/core/configuration'\nimport type {\n  BaseTextSearchAdapter,\n  BaseTextSearchArgs,\n} from '@jbrowse/core/data_adapters/BaseAdapter'\nimport type { getSubAdapterType } from '@jbrowse/core/data_adapters/dataAdapterCache'\n\nfunction decodeURIComponentNoThrow(uri: string) {\n  try {\n    return decodeURIComponent(uri)\n  } catch (e) {\n    // avoid throwing exception on a failure to decode URI component\n    return uri\n  }\n}\n\nfunction shorten(str: string, term: string, w = 15) {\n  const tidx = str.toLowerCase().indexOf(term)\n\n  return str.length < 40\n    ? str\n    : (Math.max(0, tidx - w) > 0 ? '...' : '') +\n        str.slice(Math.max(0, tidx - w), tidx + term.length + w).trim() +\n        (tidx + term.length < str.length ? '...' : '')\n}\n\nexport default class TrixTextSearchAdapter\n  extends BaseAdapter\n  implements BaseTextSearchAdapter\n{\n  indexingAttributes?: string[]\n  trixJs: Trix\n  tracksNames?: string[]\n\n  constructor(\n    config: AnyConfigurationModel,\n    getSubAdapter?: getSubAdapterType,\n    pluginManager?: PluginManager,\n  ) {\n    super(config, getSubAdapter, pluginManager)\n    const ixFilePath = readConfObject(config, 'ixFilePath')\n    const ixxFilePath = readConfObject(config, 'ixxFilePath')\n\n    if (!ixFilePath) {\n      throw new Error('must provide out.ix')\n    }\n    if (!ixxFilePath) {\n      throw new Error('must provide out.ixx')\n    }\n    this.trixJs = new Trix(\n      openLocation(ixxFilePath, pluginManager),\n      openLocation(ixFilePath, pluginManager),\n      1500,\n    )\n  }\n\n  /**\n   * Returns list of results\n   * @param args - search options/arguments include: search query\n   * limit of results to return, searchType...prefix | full | exact\", etc.\n   */\n  async searchIndex(args: BaseTextSearchArgs) {\n    const query = args.queryString.toLowerCase()\n    const strs = query.split(' ')\n    const results = await this.trixJs.search(query)\n    const formatted = results\n      // if multi-word search try to filter out relevant items\n      .filter(([, data]) =>\n        strs.every(r =>\n          decodeURIComponentNoThrow(data).toLowerCase().includes(r),\n        ),\n      )\n      .map(([term, data]) => {\n        const result = JSON.parse(data.replaceAll('|', ',')) as string[]\n        const [loc, trackId, ...rest] = result.map(record =>\n          decodeURIComponentNoThrow(record),\n        )\n\n        const labelFieldIdx = rest.findIndex(elt => !!elt)\n        const contextIdx = rest\n          .map(elt => elt.toLowerCase())\n          .findIndex(f => f.includes(term.toLowerCase()))\n\n        const labelField = rest[labelFieldIdx]!\n        const contextField = rest[contextIdx]!\n        const context =\n          contextIdx !== -1 ? shorten(contextField, term) : undefined\n        const label = shorten(labelField, term)\n\n        const displayString =\n          !context || label.toLowerCase() === context.toLowerCase()\n            ? label\n            : `${label} (${context})`\n\n        return new BaseResult({\n          locString: loc,\n          label: labelField,\n          displayString,\n          matchedObject: result.map(record => decodeURIComponent(record)),\n          trackId,\n        })\n      })\n\n    return args.searchType === 'exact'\n      ? formatted.filter(\n          r => r.getLabel().toLowerCase() === args.queryString.toLowerCase(),\n        )\n      : formatted\n  }\n}\n"],"names":["concatUint8Array","args","mergedArray","Uint8Array","array","total","entry","length","sum","offset","set","CHUNK_SIZE","Trix","ixxFile","ixFile","maxResults","decoder","TextDecoder","indexCache","ixFileSize","constructor","getIxFileSize","opts","undefined","this","stat","size","search","searchString","resultArr","firstWord","split","searchWord","toLowerCase","res","getBuffer","end","buffer","fileSize","done","str","decode","lines","slice","lastIndexOf","filter","Boolean","hits2","line","word","startsWith","push","hits","flatMap","term","parts","map","elt","concat","bytesToRead","Math","min","res2","read","list","hasher","JSON","stringify","clone","lookup","Set","hashed","has","add","dedupe","getIndex","result","readFile","encoding","p","prefix","posStr","Number","parseInt","start","indexes","key","value","decodeURIComponentNoThrow","uri","decodeURIComponent","e","shorten","w","tidx","indexOf","max","trim","TrixTextSearchAdapter","BaseAdapter","config","getSubAdapter","pluginManager","super","ixFilePath","readConfObject","ixxFilePath","Error","trixJs","openLocation","searchIndex","query","queryString","strs","formatted","data","every","r","includes","parse","replaceAll","loc","trackId","rest","record","labelFieldIdx","findIndex","contextIdx","f","labelField","contextField","context","label","displayString","BaseResult","locString","matchedObject","searchType","getLabel"],"sourceRoot":""}