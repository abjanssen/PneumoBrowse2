{"version":3,"file":"static/js/6736.27b8989e.chunk.js","mappings":"8PAUOA,eAAeC,GAA6B,cACjDC,EAAa,KACbC,IAkBA,MAAM,cAAEC,EAAa,WAAEC,GAAeF,EAChCG,EACc,WAAlBF,GAA8BC,QChB3BL,gBAAuC,cAC5CE,EAAa,KACbC,IAgBA,MAAM,QACJI,EAAO,2BACPC,EAA0B,QAC1BC,EAAO,cACPC,EAAa,UACbC,EAAS,mBACTC,EAAkB,UAClBC,EAAS,WACTR,GACEF,EACEW,GAAYC,EAAAA,EAAAA,IAAuBF,GAEnCG,SADgBC,EAAAA,EAAAA,IAAWf,EAAeS,EAAWD,IAC/BM,YAEtBE,EAAO,CAAC,EACRC,EAAa,CAAC,EAEpB,IAAK,MAAM,KAAEC,KAAUb,EAAS,CAC9B,MAAMc,EAAOhB,EAAWe,GAClBE,EAASD,GAAME,WAAa,EAClC,IAAK,IAAIC,EAAK,EAAGA,EAAKF,EAAQE,IAC5BN,EAAK,GAAGE,OAAUI,KAAQ,EAE9B,CAEA,MAAMC,GAAOC,EAAAA,EAAAA,IAA8C,CACzDlB,6BACAI,qBACAE,YACAK,aACAQ,eAAgBC,EAAAA,EAAAA,GACdZ,EAAYa,6BAA6BpB,EAASN,GAAM2B,MAAKC,EAAAA,EAAAA,SAIjE,IAAK,MAAM,QAAEC,KAAaP,EAAM,CAC9B,MAAMQ,EAAYD,EAAQE,IAAI,aAC9B,IAAK,MAAM,KAAEd,KAAUb,EAAS,CAC9B,MAAM4B,EAAMF,EAAUb,GAChBC,EAAOhB,EAAWe,GAClBE,EAASD,GAAME,WAAa,EAGlC,GAFiBY,EAAIC,SAAS,KAEhB,CACZ,MAAMC,EAAUlB,EAAWgB,KAAShB,EAAWgB,GAAOA,EAAIG,MAAM,MAChE,IAAK,IAAId,EAAK,EAAGA,EAAKF,EAAQE,IAAM,CAClC,MAAMe,EAASF,EAAQb,GACjBgB,EAAmB,MAAXD,QAA6BE,IAAXF,GAAwB,GAAKA,EAC7DrB,EAAK,GAAGE,OAAUI,KAAOkB,KAAKF,EAChC,CACF,MACE,IAAK,IAAIhB,EAAK,EAAGA,EAAKF,EAAQE,IAC5BN,EAAK,GAAGE,OAAUI,KAAOkB,MAAM,EAGrC,EACAC,EAAAA,EAAAA,IAAgB7B,EAClB,CACA,OAAOI,CACT,CD5Dc0B,CAAwB,CAC5B1C,gBACAC,KAAM,IAAKA,EAAME,sBAEbwC,EAAAA,EAAAA,GAAkB,CAAE3C,gBAAeC,SACzC2C,EAAeC,OAAOC,KAAK1C,GAC3B2C,QAAeC,EAAAA,EAAAA,GAAY,CAC/BC,KAAMJ,OAAOK,OAAO9C,GACpBwC,eACAjC,UAAWV,EAAKU,UAChBwC,WAAYlD,EAAKmD,iBAEnB,MAAO,CACLC,MAAON,EAAOM,MACdC,MAAMC,EAAAA,EAAAA,IAASR,EAAOO,MAE1B,C","sources":["../../../plugins/variants/src/VariantRPC/executeClusterGenotypeMatrix.ts","../../../plugins/variants/src/VariantRPC/getPhasedGenotypeMatrix.ts"],"sourcesContent":["import { clusterData, toNewick } from '@gmod/hclust'\n\nimport { getGenotypeMatrix } from './getGenotypeMatrix.ts'\nimport { getPhasedGenotypeMatrix } from './getPhasedGenotypeMatrix.ts'\n\nimport type { SampleInfo, Source } from '../shared/types.ts'\nimport type PluginManager from '@jbrowse/core/PluginManager'\nimport type { AnyConfigurationModel } from '@jbrowse/core/configuration'\nimport type { Region, StopToken } from '@jbrowse/core/util'\n\nexport async function executeClusterGenotypeMatrix({\n  pluginManager,\n  args,\n}: {\n  pluginManager: PluginManager\n  args: {\n    adapterConfig: AnyConfigurationModel\n    stopToken?: StopToken\n    sessionId: string\n    headers?: Record<string, string>\n    regions: Region[]\n    bpPerPx: number\n    minorAlleleFrequencyFilter: number\n    lengthCutoffFilter: number\n    statusCallback: (arg: string) => void\n    sources: Source[]\n    renderingMode?: string\n    sampleInfo?: Record<string, SampleInfo>\n  }\n}) {\n  const { renderingMode, sampleInfo } = args\n  const matrix =\n    renderingMode === 'phased' && sampleInfo\n      ? await getPhasedGenotypeMatrix({\n          pluginManager,\n          args: { ...args, sampleInfo },\n        })\n      : await getGenotypeMatrix({ pluginManager, args })\n  const sampleLabels = Object.keys(matrix)\n  const result = await clusterData({\n    data: Object.values(matrix),\n    sampleLabels,\n    stopToken: args.stopToken,\n    onProgress: args.statusCallback,\n  })\n  return {\n    order: result.order,\n    tree: toNewick(result.tree),\n  }\n}\n","import { getAdapter } from '@jbrowse/core/data_adapters/dataAdapterCache'\nimport {\n  checkStopToken2,\n  createStopTokenChecker,\n} from '@jbrowse/core/util/stopToken'\nimport { firstValueFrom, toArray } from 'rxjs'\n\nimport { getFeaturesThatPassMinorAlleleFrequencyFilter } from '../shared/minorAlleleFrequencyUtils.ts'\n\nimport type { SampleInfo, Source } from '../shared/types.ts'\nimport type PluginManager from '@jbrowse/core/PluginManager'\nimport type { AnyConfigurationModel } from '@jbrowse/core/configuration'\nimport type { BaseFeatureDataAdapter } from '@jbrowse/core/data_adapters/BaseAdapter'\nimport type { Region } from '@jbrowse/core/util'\nimport type { StopToken } from '@jbrowse/core/util/stopToken'\n\nexport async function getPhasedGenotypeMatrix({\n  pluginManager,\n  args,\n}: {\n  pluginManager: PluginManager\n  args: {\n    adapterConfig: AnyConfigurationModel\n    stopToken?: StopToken\n    sessionId: string\n    headers?: Record<string, string>\n    regions: Region[]\n    sources: Source[]\n    bpPerPx: number\n    minorAlleleFrequencyFilter: number\n    lengthCutoffFilter: number\n    sampleInfo: Record<string, SampleInfo>\n  }\n}) {\n  const {\n    sources,\n    minorAlleleFrequencyFilter,\n    regions,\n    adapterConfig,\n    sessionId,\n    lengthCutoffFilter,\n    stopToken,\n    sampleInfo,\n  } = args\n  const lastCheck = createStopTokenChecker(stopToken)\n  const adapter = await getAdapter(pluginManager, sessionId, adapterConfig)\n  const dataAdapter = adapter.dataAdapter as BaseFeatureDataAdapter\n\n  const rows = {} as Record<string, number[]>\n  const splitCache = {} as Record<string, string[]>\n\n  for (const { name } of sources) {\n    const info = sampleInfo[name]\n    const ploidy = info?.maxPloidy ?? 2\n    for (let hp = 0; hp < ploidy; hp++) {\n      rows[`${name} HP${hp}`] = []\n    }\n  }\n\n  const mafs = getFeaturesThatPassMinorAlleleFrequencyFilter({\n    minorAlleleFrequencyFilter,\n    lengthCutoffFilter,\n    lastCheck,\n    splitCache,\n    features: await firstValueFrom(\n      dataAdapter.getFeaturesInMultipleRegions(regions, args).pipe(toArray()),\n    ),\n  })\n\n  for (const { feature } of mafs) {\n    const genotypes = feature.get('genotypes') as Record<string, string>\n    for (const { name } of sources) {\n      const val = genotypes[name]!\n      const info = sampleInfo[name]\n      const ploidy = info?.maxPloidy ?? 2\n      const isPhased = val.includes('|')\n\n      if (isPhased) {\n        const alleles = splitCache[val] ?? (splitCache[val] = val.split('|'))\n        for (let hp = 0; hp < ploidy; hp++) {\n          const allele = alleles[hp]\n          const value = allele === '.' || allele === undefined ? -1 : +allele\n          rows[`${name} HP${hp}`]!.push(value)\n        }\n      } else {\n        for (let hp = 0; hp < ploidy; hp++) {\n          rows[`${name} HP${hp}`]!.push(-1)\n        }\n      }\n    }\n    checkStopToken2(lastCheck)\n  }\n  return rows\n}\n"],"names":["async","executeClusterGenotypeMatrix","pluginManager","args","renderingMode","sampleInfo","matrix","sources","minorAlleleFrequencyFilter","regions","adapterConfig","sessionId","lengthCutoffFilter","stopToken","lastCheck","createStopTokenChecker","dataAdapter","getAdapter","rows","splitCache","name","info","ploidy","maxPloidy","hp","mafs","getFeaturesThatPassMinorAlleleFrequencyFilter","features","firstValueFrom","getFeaturesInMultipleRegions","pipe","toArray","feature","genotypes","get","val","includes","alleles","split","allele","value","undefined","push","checkStopToken2","getPhasedGenotypeMatrix","getGenotypeMatrix","sampleLabels","Object","keys","result","clusterData","data","values","onProgress","statusCallback","order","tree","toNewick"],"ignoreList":[],"sourceRoot":""}