{"version":3,"file":"static/js/1217.1ec97fc3.chunk.js","mappings":"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","sources":["webpack://@jbrowse/web/../../plugins/alignments/src/shared/arcUtils.ts","webpack://@jbrowse/web/../../plugins/alignments/src/RenderLinearReadArcsDisplayRPC/drawFeatsRPC.ts","webpack://@jbrowse/web/../../plugins/alignments/src/RenderLinearReadArcsDisplayRPC/executeRenderLinearReadArcsDisplay.ts","webpack://@jbrowse/web/../../plugins/alignments/src/shared/insertSizeStats.ts"],"sourcesContent":["import {\n  SAM_FLAG_MATE_REVERSE,\n  SAM_FLAG_MATE_UNMAPPED,\n  SAM_FLAG_SECONDARY,\n  SAM_FLAG_SUPPLEMENTARY,\n} from './samFlags.ts'\n\nimport type { Feature } from '@jbrowse/core/util'\n\nexport interface CoreFeat {\n  strand: number\n  refName: string\n  start: number\n  end: number\n  tlen?: number\n  pair_orientation?: string\n  next_ref?: string\n}\n\nexport function jitter(n: number) {\n  return Math.random() * 2 * n - n\n}\n\nexport function drawVerticalLine(\n  ctx: CanvasRenderingContext2D,\n  x: number,\n  height: number,\n  color: string,\n) {\n  ctx.strokeStyle = color\n  ctx.beginPath()\n  ctx.moveTo(x, 0)\n  ctx.lineTo(x, height)\n  ctx.stroke()\n}\n\nexport function extractCoreFeat(f: Feature): CoreFeat {\n  return {\n    refName: f.get('refName'),\n    start: f.get('start'),\n    end: f.get('end'),\n    strand: f.get('strand'),\n    tlen: f.get('template_length'),\n    pair_orientation: f.get('pair_orientation'),\n    next_ref: f.get('next_ref'),\n  }\n}\n\nexport function extractCoreFeatBasic(f: Feature): CoreFeat {\n  return {\n    refName: f.get('refName'),\n    start: f.get('start'),\n    end: f.get('end'),\n    strand: f.get('strand'),\n  }\n}\n\nexport function getStrandRelativeFirstClipLength(f: Feature | CoreFeat) {\n  return 'get' in f\n    ? f.get('clipLengthAtStartOfRead')\n    : (f as CoreFeat & { clipLengthAtStartOfRead: number })\n        .clipLengthAtStartOfRead\n}\n\nexport function toCoreFeat(f: Feature | CoreFeat): CoreFeat {\n  return 'get' in f ? extractCoreFeat(f) : f\n}\n\nexport function toCoreFeatBasic(f: Feature | CoreFeat): CoreFeat {\n  return 'get' in f ? extractCoreFeatBasic(f) : f\n}\n\nexport function getMateInfo(f: Feature): CoreFeat {\n  const flags = f.get('flags') || 0\n  const mateStrand = flags & SAM_FLAG_MATE_REVERSE ? -1 : 1\n  return {\n    refName: f.get('next_ref') || '',\n    start: f.get('next_pos') || 0,\n    end: f.get('next_pos') || 0,\n    strand: mateStrand,\n  }\n}\n\nexport function filterPairedChain(chain: Feature[]) {\n  const result: Feature[] = []\n  for (const f of chain) {\n    const flags = f.get('flags')\n    // Filter out supplementary and mate unmapped\n    if (\n      !(flags & SAM_FLAG_SUPPLEMENTARY) &&\n      !(flags & SAM_FLAG_MATE_UNMAPPED)\n    ) {\n      result.push(f)\n    }\n  }\n  return result\n}\n\nexport function filterAndSortLongReadChain(chain: Feature[]) {\n  const filtered: Feature[] = []\n  for (const f of chain) {\n    // Filter out secondary alignments\n    if (!(f.get('flags') & SAM_FLAG_SECONDARY)) {\n      filtered.push(f)\n    }\n  }\n  filtered.sort(\n    (a, b) =>\n      a.get('clipLengthAtStartOfRead') - b.get('clipLengthAtStartOfRead'),\n  )\n  return filtered\n}\n","import { checkStopToken2 } from '@jbrowse/core/util/stopToken'\n\nimport { featurizeSA, getTag } from '../MismatchParser/index.ts'\nimport {\n  type CoreFeat,\n  drawVerticalLine,\n  extractCoreFeat,\n  extractCoreFeatBasic,\n  filterAndSortLongReadChain,\n  filterPairedChain,\n  getMateInfo,\n  getStrandRelativeFirstClipLength,\n  jitter,\n  toCoreFeat,\n  toCoreFeatBasic,\n} from '../shared/arcUtils.ts'\nimport {\n  getPairedInsertSizeAndOrientationColor,\n  getPairedInsertSizeColor,\n  getPairedOrientationColor,\n} from '../shared/color.ts'\nimport { SAM_FLAG_MATE_UNMAPPED } from '../shared/samFlags.ts'\nimport { hasPairedReads } from '../shared/util.ts'\n\nimport type { ChainData, ChainStats, ColorBy } from '../shared/types.ts'\nimport type { Feature, LastStopTokenCheck } from '@jbrowse/core/util'\n\n// Arc rendering thresholds\nconst ARC_VS_BEZIER_THRESHOLD = 10_000\nconst VERTICAL_LINE_THRESHOLD = 100_000\nconst GRADIENT_HSL_SATURATION = 50\nconst GRADIENT_HSL_LIGHTNESS = 50\n\ninterface DrawFeatsRPCParams {\n  ctx: CanvasRenderingContext2D\n  width: number\n  height: number\n  chainData: ChainData\n  colorBy: ColorBy\n  drawInter: boolean\n  drawLongRange: boolean\n  lineWidth: number\n  jitter: number\n  view: {\n    bpToPx: (arg: {\n      refName: string\n      coord: number\n    }) => { offsetPx: number } | undefined\n  }\n  offsetPx: number\n  stopTokenCheck?: LastStopTokenCheck\n}\n\n/**\n * Get the arc endpoint coordinate based on strand direction.\n * For forward strand (+1), use the end position.\n * For reverse strand (-1), use the start position.\n */\nfunction getArcEndpoint(\n  feat: CoreFeat,\n  isPairedEnd: boolean,\n  isMate: boolean,\n): number {\n  const isReverse = feat.strand === -1\n  if (isPairedEnd) {\n    return isReverse ? feat.start : feat.end\n  }\n  // For long reads, the second feature uses opposite logic\n  return isMate\n    ? isReverse\n      ? feat.end\n      : feat.start\n    : isReverse\n      ? feat.start\n      : feat.end\n}\n\n/**\n * Get the stroke color for an arc based on color mode and read type.\n */\nfunction getArcStrokeColor(params: {\n  longRange: boolean\n  drawArcInsteadOfBezier: boolean\n  hasPaired: boolean\n  colorByType: string\n  k1: CoreFeat\n  s1: number\n  s2: number\n  absrad: number\n  stats?: ChainStats\n}): string {\n  const {\n    longRange,\n    drawArcInsteadOfBezier,\n    hasPaired,\n    colorByType,\n    k1,\n    s1,\n    s2,\n    absrad,\n    stats,\n  } = params\n\n  // Long range arcs drawn as actual arcs (not bezier) are red\n  if (longRange && drawArcInsteadOfBezier) {\n    return 'red'\n  }\n\n  // Paired-end read coloring\n  if (hasPaired) {\n    if (colorByType === 'insertSizeAndOrientation') {\n      return getPairedInsertSizeAndOrientationColor(k1, stats)[0]\n    }\n    if (colorByType === 'orientation') {\n      return getPairedOrientationColor(k1)[0]\n    }\n    if (colorByType === 'insertSize') {\n      return getPairedInsertSizeColor(k1, stats)?.[0] || 'grey'\n    }\n    if (colorByType === 'gradient') {\n      return `hsl(${Math.log10(absrad) * 10},${GRADIENT_HSL_SATURATION}%,${GRADIENT_HSL_LIGHTNESS}%)`\n    }\n    return 'grey'\n  }\n\n  // Long-read coloring\n  if (\n    colorByType === 'orientation' ||\n    colorByType === 'insertSizeAndOrientation'\n  ) {\n    if (s1 === -1 && s2 === 1) {\n      return 'navy'\n    }\n    if (s1 === 1 && s2 === -1) {\n      return 'green'\n    }\n    return 'grey'\n  }\n  if (colorByType === 'gradient') {\n    return `hsl(${Math.log10(absrad) * 10},${GRADIENT_HSL_SATURATION}%,${GRADIENT_HSL_LIGHTNESS}%)`\n  }\n  return 'grey'\n}\n\n/**\n * Draw a bezier curve arc between two points.\n */\nfunction drawBezierArc(\n  ctx: CanvasRenderingContext2D,\n  startX: number,\n  endX: number,\n  destY: number,\n  jitterVal: number,\n) {\n  ctx.beginPath()\n  ctx.moveTo(startX, 0)\n  ctx.bezierCurveTo(\n    startX + jitter(jitterVal),\n    destY,\n    endX,\n    destY,\n    endX + jitter(jitterVal),\n    0,\n  )\n  ctx.stroke()\n}\n\nexport function drawFeatsRPC(params: DrawFeatsRPCParams) {\n  const {\n    ctx,\n    height,\n    chainData,\n    colorBy,\n    drawInter,\n    drawLongRange,\n    lineWidth,\n    jitter: jitterVal,\n    view,\n    offsetPx,\n    stopTokenCheck,\n  } = params\n\n  const { chains, stats } = chainData\n  const colorByType = colorBy.type\n  const hasPaired = hasPairedReads(chainData)\n\n  ctx.lineWidth = lineWidth\n\n  function draw(k1: CoreFeat, k2: CoreFeat, longRange: boolean) {\n    const s1 = k1.strand\n    const s2 = k2.strand\n\n    const p1 = getArcEndpoint(k1, hasPaired, false)\n    const p2 = getArcEndpoint(k2, hasPaired, true)\n\n    const r1 = view.bpToPx({ refName: k1.refName, coord: p1 })?.offsetPx\n    const r2 = view.bpToPx({ refName: k2.refName, coord: p2 })?.offsetPx\n\n    if (r1 !== undefined && r2 !== undefined) {\n      const radius = (r2 - r1) / 2\n      const absrad = Math.abs(radius)\n      const p = r1 - offsetPx\n      const pEnd = r2 - offsetPx\n      const drawArcInsteadOfBezier = absrad > ARC_VS_BEZIER_THRESHOLD\n\n      ctx.strokeStyle = getArcStrokeColor({\n        longRange,\n        drawArcInsteadOfBezier,\n        hasPaired,\n        colorByType,\n        k1,\n        s1,\n        s2,\n        absrad,\n        stats,\n      })\n\n      const destY = Math.min(height + jitter(jitterVal), absrad)\n\n      if (absrad < 1) {\n        // Very small arcs - draw a simple rectangle\n        ctx.fillStyle = ctx.strokeStyle\n        ctx.fillRect(p, 0, pEnd - p, Math.max(absrad, lineWidth))\n      } else if (longRange && absrad > VERTICAL_LINE_THRESHOLD) {\n        // Very large arcs - draw vertical lines instead\n        drawVerticalLine(ctx, p + jitter(jitterVal), height, 'red')\n        drawVerticalLine(ctx, pEnd + jitter(jitterVal), height, 'red')\n      } else if (longRange && drawArcInsteadOfBezier) {\n        // Large arcs - use actual arc for better rendering\n        ctx.moveTo(p, 0)\n        ctx.beginPath()\n        ctx.arc(p + radius + jitter(jitterVal), 0, absrad, 0, Math.PI)\n        ctx.stroke()\n      } else {\n        // Normal arcs - use bezier curve\n        drawBezierArc(ctx, p, p + radius * 2, destY, jitterVal)\n      }\n    } else if (r1 && drawInter) {\n      drawVerticalLine(ctx, r1 - offsetPx, height, 'purple')\n    }\n  }\n\n  function drawSingletonPairedEnd(f: Feature) {\n    draw(extractCoreFeat(f), getMateInfo(f), true)\n  }\n\n  function drawSingletonLongRead(f: Feature) {\n    const allFeatures = [\n      f,\n      ...featurizeSA(getTag(f, 'SA'), f.id(), f.get('strand'), f.get('name')),\n    ].toSorted(\n      (a, b) =>\n        getStrandRelativeFirstClipLength(a) -\n        getStrandRelativeFirstClipLength(b),\n    )\n\n    for (let i = 0, len = allFeatures.length; i < len - 1; i++) {\n      draw(\n        toCoreFeat(allFeatures[i]!),\n        toCoreFeatBasic(allFeatures[i + 1]!),\n        true,\n      )\n    }\n  }\n\n  function drawMultiFeatureChain(chain: Feature[]) {\n    const filtered = hasPaired\n      ? filterPairedChain(chain)\n      : filterAndSortLongReadChain(chain)\n\n    for (let i = 0, len = filtered.length; i < len - 1; i++) {\n      draw(\n        extractCoreFeat(filtered[i]!),\n        extractCoreFeatBasic(filtered[i + 1]!),\n        false,\n      )\n    }\n  }\n\n  for (const chain of chains) {\n    if (chain.length === 1 && drawLongRange) {\n      const f = chain[0]!\n      const isMateUnmapped = f.get('flags') & SAM_FLAG_MATE_UNMAPPED\n\n      if (hasPaired && !isMateUnmapped) {\n        drawSingletonPairedEnd(f)\n      } else {\n        drawSingletonLongRead(f)\n      }\n    } else {\n      drawMultiFeatureChain(chain)\n    }\n    checkStopToken2(stopTokenCheck)\n  }\n}\n","import { getAdapter } from '@jbrowse/core/data_adapters/dataAdapterCache'\nimport {\n  collectTransferables,\n  dedupe,\n  groupBy,\n  max,\n  min,\n  renderToAbstractCanvas,\n  updateStatus,\n} from '@jbrowse/core/util'\nimport { bpToPx } from '@jbrowse/core/util/Base1DUtils'\nimport Base1DView from '@jbrowse/core/util/Base1DViewModel'\nimport { rpcResult } from '@jbrowse/core/util/librpc'\nimport {\n  checkStopToken2,\n  createStopTokenChecker,\n} from '@jbrowse/core/util/stopToken'\nimport { getSnapshot } from '@jbrowse/mobx-state-tree'\nimport { firstValueFrom } from 'rxjs'\nimport { toArray } from 'rxjs/operators'\n\nimport { drawFeatsRPC } from './drawFeatsRPC.ts'\nimport { getInsertSizeStats } from '../shared/insertSizeStats.ts'\n\nimport type { RenderLinearReadArcsDisplayArgs } from './RenderLinearReadArcsDisplay.ts'\nimport type PluginManager from '@jbrowse/core/PluginManager'\nimport type { BaseFeatureDataAdapter } from '@jbrowse/core/data_adapters/BaseAdapter'\n\ninterface RenderToAbstractCanvasOptions {\n  exportSVG?: { rasterizeLayers?: boolean; scale?: number }\n  highResolutionScaling?: number\n}\n\nexport async function executeRenderLinearReadArcsDisplay({\n  pluginManager,\n  args,\n}: {\n  pluginManager: PluginManager\n  args: RenderLinearReadArcsDisplayArgs\n}) {\n  const {\n    sessionId,\n    view: viewSnapshot,\n    adapterConfig,\n    sequenceAdapter,\n    colorBy,\n    drawInter,\n    drawLongRange,\n    lineWidth,\n    jitter,\n    height,\n    highResolutionScaling,\n    exportSVG,\n    statusCallback = () => {},\n    stopToken,\n  } = args\n\n  const stopTokenCheck = createStopTokenChecker(stopToken)\n\n  // Recreate the view from the snapshot (displayedRegions already have renamed refNames)\n  const view = Base1DView.create(viewSnapshot)\n  // Set the volatile width which is not part of the snapshot\n  if (viewSnapshot.width) {\n    view.setVolatileWidth(viewSnapshot.width)\n  }\n\n  // Extract properties from the recreated view\n  const { offsetPx } = view\n  const width = view.staticBlocks.totalWidthPx\n  // contentBlocks are derived from displayedRegions, so they have correct refNames\n  const regions = view.staticBlocks.contentBlocks\n\n  // Create a snapshot from the live view including computed properties\n  // staticBlocks is a getter so must be included explicitly\n  const snap = getSnapshot(view)\n  const viewSnap = {\n    ...snap,\n    width: view.width,\n    staticBlocks: view.staticBlocks,\n    bpToPx(arg: { refName: string; coord: number }) {\n      const res = bpToPx({\n        self: this,\n        refName: arg.refName,\n        coord: arg.coord,\n      })\n      return res !== undefined\n        ? { offsetPx: res.offsetPx, index: res.index }\n        : undefined\n    },\n  }\n\n  // Fetch chainData directly in the RPC to avoid serializing features from main thread\n  const dataAdapter = (\n    await getAdapter(pluginManager, sessionId, adapterConfig)\n  ).dataAdapter as BaseFeatureDataAdapter\n\n  // Set sequenceAdapterConfig on the adapter for CRAM files that need it\n  if (sequenceAdapter && !dataAdapter.sequenceAdapterConfig) {\n    dataAdapter.setSequenceAdapterConfig(sequenceAdapter)\n  }\n\n  const featuresArray = await updateStatus(\n    'Fetching alignments',\n    statusCallback,\n    () =>\n      firstValueFrom(\n        dataAdapter.getFeaturesInMultipleRegions(regions, args).pipe(toArray()),\n      ),\n  )\n\n  // Check stop token after fetching features\n  checkStopToken2(stopTokenCheck)\n\n  // Process chain data with status updates\n  const { chains, stats } = await updateStatus(\n    'Processing alignments',\n    statusCallback,\n    async () => {\n      // Dedupe features by ID while preserving full Feature objects\n      const deduped = dedupe(featuresArray, f => f.id())\n\n      // For stats calculation, only use reads with proper paired flag (flag 2)\n      const filtered = deduped.filter(f => {\n        const flags = f.get('flags')\n        // Only keep reads mapped in proper pair (flag 2)\n        if (!(flags & 2)) {\n          return false\n        }\n        // Skip secondary and supplementary alignments\n        if (flags & 256 || flags & 2048) {\n          return false\n        }\n        return true\n      })\n      let statsResult\n      if (filtered.length) {\n        // Filter out features without valid TLEN values\n        const validTlenFeatures = filtered.filter(f => {\n          const tlen = f.get('template_length')\n          return tlen !== 0 && !Number.isNaN(tlen)\n        })\n        if (validTlenFeatures.length > 0) {\n          const tlens = validTlenFeatures.map(f =>\n            Math.abs(f.get('template_length')),\n          )\n          const insertSizeStats = getInsertSizeStats(tlens)\n          statsResult = {\n            ...insertSizeStats,\n            max: max(tlens),\n            min: min(tlens),\n          }\n        }\n      }\n\n      const chainsResult = Object.values(groupBy(deduped, f => f.get('name')))\n      return {\n        chains: chainsResult,\n        stats: statsResult,\n      }\n    },\n  )\n\n  const chainData = {\n    chains,\n    stats,\n  }\n\n  // Check stop token after processing chain data\n  checkStopToken2(stopTokenCheck)\n\n  const renderOpts: RenderToAbstractCanvasOptions = {\n    highResolutionScaling,\n    exportSVG,\n  }\n\n  // Render using renderToAbstractCanvas\n  const result = await updateStatus('Rendering arcs', statusCallback, () =>\n    renderToAbstractCanvas(width, height, renderOpts, ctx => {\n      // Call drawFeatsRPC with all necessary parameters\n      drawFeatsRPC({\n        ctx,\n        width,\n        height,\n        chainData,\n        colorBy,\n        drawInter,\n        drawLongRange,\n        lineWidth,\n        jitter,\n        view: viewSnap,\n        offsetPx,\n        stopTokenCheck,\n      })\n      return undefined\n    }),\n  )\n\n  // Include the offsetPx in the result so the main thread can position the\n  // canvas correctly\n  const serialized = { ...result, offsetPx }\n  return rpcResult(serialized, collectTransferables(result))\n}\n","import { sum } from '@jbrowse/core/util'\n\nimport type { ReducedFeature } from './types.ts'\n\nexport function getInsertSizeStats(filtered: number[]) {\n  const len = filtered.length\n  const s = sum(filtered)\n  let sumSquared = 0\n  for (let i = 0; i < len; i++) {\n    const elt = filtered[i]!\n    sumSquared += elt * elt\n  }\n  const avg = s / len\n  const sd = Math.sqrt((len * sumSquared - s * s) / (len * len))\n  const upper = avg + 3 * sd\n  const lower = avg - 3 * sd\n  return {\n    upper,\n    lower,\n    avg,\n    sd,\n  }\n}\n\nexport function filterForPairs(features: ReducedFeature[]) {\n  return features.filter(\n    f => f.flags & 2 && !(f.flags & 256) && !(f.flags & 2048),\n  )\n}\n"],"names":["jitter","n","Math","random","drawVerticalLine","ctx","x","height","color","strokeStyle","beginPath","moveTo","lineTo","stroke","extractCoreFeat","f","refName","get","start","end","strand","tlen","pair_orientation","next_ref","extractCoreFeatBasic","getStrandRelativeFirstClipLength","clipLengthAtStartOfRead","toCoreFeat","toCoreFeatBasic","getArcEndpoint","feat","isPairedEnd","isMate","isReverse","drawFeatsRPC","params","chainData","colorBy","drawInter","drawLongRange","lineWidth","jitterVal","view","offsetPx","stopTokenCheck","chains","stats","colorByType","type","hasPaired","hasPairedReads","draw","k1","k2","longRange","s1","s2","p1","p2","r1","bpToPx","coord","r2","undefined","radius","absrad","abs","p","pEnd","drawArcInsteadOfBezier","getPairedInsertSizeAndOrientationColor","getPairedOrientationColor","getPairedInsertSizeColor","log10","getArcStrokeColor","destY","min","fillStyle","fillRect","max","arc","PI","startX","endX","bezierCurveTo","drawBezierArc","drawSingletonPairedEnd","mateStrand","SAM_FLAG_MATE_REVERSE","getMateInfo","drawSingletonLongRead","allFeatures","featurizeSA","getTag","id","toSorted","a","b","i","len","length","drawMultiFeatureChain","chain","filtered","result","flags","SAM_FLAG_SUPPLEMENTARY","SAM_FLAG_MATE_UNMAPPED","push","filterPairedChain","SAM_FLAG_SECONDARY","sort","filterAndSortLongReadChain","isMateUnmapped","checkStopToken2","async","executeRenderLinearReadArcsDisplay","pluginManager","args","sessionId","viewSnapshot","adapterConfig","sequenceAdapter","highResolutionScaling","exportSVG","statusCallback","stopToken","createStopTokenChecker","Base1DView","create","width","setVolatileWidth","staticBlocks","totalWidthPx","regions","contentBlocks","viewSnap","getSnapshot","arg","res","self","this","index","dataAdapter","getAdapter","sequenceAdapterConfig","setSequenceAdapterConfig","featuresArray","updateStatus","firstValueFrom","getFeaturesInMultipleRegions","pipe","toArray","deduped","dedupe","filter","statsResult","validTlenFeatures","Number","isNaN","tlens","map","getInsertSizeStats","Object","values","groupBy","renderOpts","renderToAbstractCanvas","serialized","rpcResult","collectTransferables","s","sum","sumSquared","elt","avg","sd","sqrt","upper","lower"],"sourceRoot":""}