"use strict";(globalThis.webpackChunk_jbrowse_web=globalThis.webpackChunk_jbrowse_web||[]).push([[456],{63637(e,t,s){s.d(t,{A:()=>r});class a{}class n{constructor(){this.signals=new Set,this.abortController=new AbortController}addSignal(e=new a){if(this.signal.aborted)throw new Error("cannot add a signal, already aborted!");this.signals.add(e),e.aborted?this.handleAborted(e):"function"==typeof e.addEventListener&&e.addEventListener("abort",()=>{this.handleAborted(e)})}handleAborted(e){this.signals.delete(e),0===this.signals.size&&this.abortController.abort()}get signal(){return this.abortController.signal}abort(){this.abortController.abort()}}class i{constructor(){this.callbacks=new Set}addCallback(e=()=>{}){this.callbacks.add(e),this.currentMessage&&e(this.currentMessage)}callback(e){this.currentMessage=e;for(const t of this.callbacks)t(e)}}class r{constructor({fill:e,cache:t}){if("function"!=typeof e)throw new TypeError("must pass a fill function");if("object"!=typeof t)throw new TypeError("must pass a cache object");if("function"!=typeof t.get||"function"!=typeof t.set||"function"!=typeof t.delete)throw new TypeError("cache must implement get(key), set(key, val), and and delete(key)");this.cache=t,this.fillCallback=e}static isAbortException(e){return"AbortError"===e.name||"ERR_ABORTED"===e.code||"AbortError: aborted"===e.message||"Error: aborted"===e.message}evict(e,t){this.cache.get(e)===t&&this.cache.delete(e)}fill(e,t,s,a){const r=new n,o=new i;o.addCallback(a);const c={aborter:r,promise:this.fillCallback(t,r.signal,e=>{o.callback(e)}),settled:!1,statusReporter:o,get aborted(){return this.aborter.signal.aborted}};c.aborter.addSignal(s),c.aborter.signal.addEventListener("abort",()=>{c.settled||this.evict(e,c)}),c.promise.then(()=>{c.settled=!0},()=>{c.settled=!0,this.evict(e,c)}).catch(e=>{throw console.error(e),e}),this.cache.set(e,c)}static checkSinglePromise(e,t){function s(){if(t?.aborted)throw Object.assign(new Error("aborted"),{code:"ERR_ABORTED"})}return e.then(e=>(s(),e),e=>{throw s(),e})}has(e){return this.cache.has(e)}get(e,t,s,a){if(!s&&t instanceof AbortSignal)throw new TypeError("second get argument appears to be an AbortSignal, perhaps you meant to pass `null` for the fill data?");const n=this.cache.get(e);return n?n.aborted&&!n.settled?(this.evict(e,n),this.get(e,t,s,a)):n.settled?n.promise:(n.aborter.addSignal(s),n.statusReporter.addCallback(a),r.checkSinglePromise(n.promise,s)):(this.fill(e,t,s,a),r.checkSinglePromise(this.cache.get(e).promise,s))}delete(e){const t=this.cache.get(e);t&&(t.settled||t.aborter.abort(),this.cache.delete(e))}clear(){const e=this.cache.keys();let t=0;for(let s=e.next();!s.done;s=e.next())this.delete(s.value),t+=1;return t}}},79681(e,t,s){s.d(t,{tP:()=>o,BL:()=>r});var a=s(85299),n=s(53221);function i(e,t,s,a){return e+t*Math.floor(a/s)+a%s}class r{constructor({fasta:e,fai:t,path:s,faiPath:a}){if(e)this.fasta=e;else{if(!s)throw new Error("Need to pass filehandle for fasta or path to localfile");this.fasta=new n.EY(s)}if(t)this.fai=t;else if(a)this.fai=new n.EY(a);else{if(!s)throw new Error("Need to pass filehandle for  or path to localfile");this.fai=new n.EY(`${s}.fai`)}}async _getIndexes(e){return this.indexes||(this.indexes=async function(e,t={}){const s=new TextDecoder("utf8").decode(await e.readFile(t)),a=[],n=[],i=[],r=[],o=[],c={};let l=0;const h=s.length;let d=0;for(;l<h;){let e=s.indexOf("\n",l);-1===e&&(e=h);let t=s.slice(l,e);if(t.endsWith("\r")&&(t=t.slice(0,-1)),t=t.trim(),l=e+1,0===t.length)continue;const f=t.indexOf("\t"),u=t.indexOf("\t",f+1),g=t.indexOf("\t",u+1),p=t.indexOf("\t",g+1),w=t.slice(0,f);if(w.startsWith(">"))throw new Error("found > in sequence name, might have supplied FASTA file for the FASTA index");a.push(w),i.push(+t.slice(f+1,u)),n.push(+t.slice(u+1,g)),r.push(+t.slice(g+1,p)),o.push(+t.slice(p+1)),c[w]=d,d++}return{names:a,nameToIndex:c,offsets:n,lengths:i,lineLengths:r,lineBytes:o}}(this.fai,e).catch(e=>{throw this.indexes=void 0,e})),this.indexes}async getSequenceNames(e){return(await this._getIndexes(e)).names}async getSequenceSizes(e){const t=await this._getIndexes(e);if(!t.sizesCache){const e={};for(let s=0;s<t.names.length;s++)e[t.names[s]]=t.lengths[s];t.sizesCache=e}return t.sizesCache}async getSequenceSize(e,t){const s=await this._getIndexes(t),a=s.nameToIndex[e];return void 0!==a?s.lengths[a]:void 0}async hasReferenceSequence(e,t){return void 0!==(await this._getIndexes(t)).nameToIndex[e]}async getResiduesByName(e,t,s,a){const n=await this._getIndexes(a),i=n.nameToIndex[e];if(void 0!==i)return this._fetchFromIndex(n.offsets[i],n.lineBytes[i],n.lineLengths[i],n.lengths[i],t,s,a)}async getSequence(e,t,s,a){return this.getResiduesByName(e,t,s,a)}async _fetchFromIndex(e,t,s,a,n=0,r,o){let c=r;if(n<0)throw new TypeError("regionStart cannot be less than 0");if((void 0===c||c>a)&&(c=a),n>=c)return"";const l=i(e,t,s,n),h=i(e,t,s,c)-l,d=new TextDecoder("utf8").decode(await this.fasta.read(h,l,o)).replace(/\s+/g,"");if(/[^\x20-\x7e]/.test(d.slice(0,1e3)))throw new Error("Non-ASCII characters detected in sequence. The file may be gzip compressed. Use BgzipIndexedFasta for bgzip files, or decompress the file.");return d}}class o extends r{constructor({fasta:e,path:t,fai:s,faiPath:i,gzi:r,gziPath:o}){super({fasta:e,path:t,fai:s,faiPath:i}),e&&r?this.fasta=new a.sG({filehandle:e,gziFilehandle:r}):t&&o&&(this.fasta=new a.sG({filehandle:new n.EY(t),gziFilehandle:new n.EY(o)}))}}},80456(e,t,s){s.d(t,{default:()=>f});var a=s(63637),n=s(79681),i=s(36592),r=s(77251),o=s(53155),c=s(37759),l=s(33624),h=s(86618),d=s(52901);class f extends i.Q{seqCache=new a.A({cache:new c.A({maxSize:200}),fill:async e=>{const{refName:t,start:s,end:a,fasta:n}=e;return n.getSequence(t,s,a)}});async getRefNames(e){const{fasta:t}=await this.setup();return t.getSequenceNames()}async getRegions(e){const{fasta:t}=await this.setup(),s=await t.getSequenceSizes();return Object.keys(s).map(e=>({refName:e,start:0,end:s[e]}))}async setupPre(){const e=this.getConf("fastaLocation"),t=this.getConf("faiLocation");return{fasta:new n.BL({fasta:(0,l.openLocation)(e,this.pluginManager),fai:(0,l.openLocation)(t,this.pluginManager)})}}async getHeader(){const e=this.getConf("metadataLocation");return""===e.uri||"/path/to/fa.metadata.yaml"===e.uri?null:(0,l.openLocation)(e,this.pluginManager).readFile("utf8")}async setup(){return this.setupP||(this.setupP=this.setupPre().catch(e=>{throw this.setupP=void 0,e})),this.setupP}getFeatures(e,t){const{statusCallback:s=()=>{},stopToken:a}=t||{},{refName:n,start:i,end:c}=e;return(0,h.ObservableCreate)(async e=>{await(0,r.updateStatus2)("Downloading sequence",s,a,async()=>{const{fasta:t}=await this.setup(),s=await t.getSequenceSize(n),r=Math.min(s||0,c),l=128e3,h=i-i%l,f=c+(l-c%l),u=[];for(let e=h;e<f;e+=l){const s={refName:n,start:e,end:e+l};u.push(this.seqCache.get(`${n}-${e}-${s.end}`,{...s,fasta:t}))}(0,d.SW)(a);const g=await Promise.all(u),p=c-i,w=g.join("").slice(i-h,i-h+p);w&&e.next(new o.A({id:`${n}-${i}-${r}`,data:{refName:n,start:i,end:r,seq:w}}))}),e.complete()})}}}}]);
//# sourceMappingURL=456.23b900d0.chunk.js.map